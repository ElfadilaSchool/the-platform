<!DOCTYPE html>
<html lang="fr">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title data-translate="nav.task_management">Task Management - HR Operations Platform</title>
	<link rel="stylesheet" href="tailwind.css">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="style.css">
	<style>
		.tab-active {
			border-bottom: 2px solid #3b82f6;
			color: #3b82f6;
		}

		/* Ensure Font Awesome icons are visible */
		.fas, .far, .fab {
			display: inline-block !important;
			font-style: normal !important;
			font-variant: normal !important;
			text-rendering: auto !important;
			line-height: 1 !important;
		}

		/* Specific fixes for table icons */
		table .fas, table .far, table .fab {
			display: inline-block !important;
			font-family: "Font Awesome 6 Free" !important;
			font-weight: 900 !important;
			visibility: visible !important;
			opacity: 1 !important;
		}

		/* Fallback for icons that might not load */
		.fa-tasks::before { content: "ðŸ“‹" !important; }
		.fa-exclamation-triangle::before { content: "âš ï¸" !important; }
		.fa-eye::before { content: "ðŸ‘ï¸" !important; }
		.fa-pen::before { content: "âœï¸" !important; }
		.fa-calendar::before { content: "ðŸ“…" !important; }
		.fa-user::before { content: "ðŸ‘¤" !important; }
		.fa-arrow-up::before { content: "â¬†ï¸" !important; }
		.fa-arrow-down::before { content: "â¬‡ï¸" !important; }
		.fa-flag::before { content: "ðŸš©" !important; }
		.fa-exclamation::before { content: "â—" !important; }
		.fa-info-circle::before { content: "â„¹ï¸" !important; }

		/* Keep toast styles as they are useful */
		.toast-container {
			position: fixed;
			top: 16px;
			right: 16px;
			z-index: 9999;
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.toast {
			display: flex;
			align-items: flex-start;
			gap: 10px;
			min-width: 260px;
			max-width: 380px;
			padding: 12px 14px;
			border-radius: 12px;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
			border: 1px solid rgba(0, 0, 0, 0.06);
			background: #ffffff;
			animation: toast-in 200ms ease-out;
		}

		.toast-title {
			font-weight: 600;
			color: #0f172a;
			font-size: 14px;
		}

		.toast-body {
			color: #334155;
			font-size: 13px;
			margin-top: 2px;
		}

		.toast-success {
			border-color: #86efac;
			background: linear-gradient(0deg, #f0fdf4 0%, #ffffff 100%);
		}

		.toast-error {
			border-color: #fecaca;
			background: linear-gradient(0deg, #fef2f2 0%, #ffffff 100%);
		}

		.toast-icon {
			width: 28px;
			height: 28px;
			border-radius: 8px;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
		}

		.toast-success .toast-icon {
			background: #22c55e;
			color: #ffffff;
		}

		.toast-error .toast-icon {
			background: #ef4444;
			color: #ffffff;
		}

		.toast-close {
			margin-left: auto;
			color: #94a3b8;
			cursor: pointer;
			border: none;
			background: transparent;
			padding: 4px;
			border-radius: 6px;
		}

		.toast-close:hover {
			background: rgba(15, 23, 42, 0.06);
			color: #475569;
		}

		.toast-progress {
			height: 3px;
			background: rgba(0, 0, 0, 0.06);
			border-radius: 999px;
			overflow: hidden;
			margin-top: 10px;
		}

		.toast-progress>span {
			display: block;
			height: 100%;
			background: currentColor;
			transform-origin: left;
			animation: toast-progress 3.2s linear forwards;
		}

		.toast-success .toast-progress>span {
			color: #22c55e;
		}

		.toast-error .toast-progress>span {
			color: #ef4444;
		}

		@keyframes toast-in {
			from {
				opacity: 0;
				transform: translateY(-8px) scale(0.98);
			}

			to {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		@keyframes toast-out {
			from {
				opacity: 1;
				transform: translateY(0) scale(1);
			}

			to {
				opacity: 0;
				transform: translateY(-8px) scale(0.98);
			}
		}

		@keyframes toast-progress {
			from {
				transform: scaleX(1);
			}

			to {
				transform: scaleX(0);
			}
		}

		/* Card styles matching timetable-library theme */
		.stat-card,
		.stat-card-2,
		.stat-card-3,
		.stat-card-4 {
			background: linear-gradient(#ffffff, #ffffff),
				linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
			border: 1px solid transparent;
			border-radius: 1rem;
			background-origin: border-box;
			background-clip: padding-box, border-box;
			color: #0f172a;
		}

		.card-hover {
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.card-hover:hover {
			transform: translateY(-4px);
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
		}

		/* Timetable-library theme styles */
		.modal-backdrop {
			backdrop-filter: blur(4px);
		}

		/* Enhanced Timetable Card Styling */
		.timetable-card {
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			border: 2px solid rgba(148, 163, 184, 0.15);
			border-radius: 20px;
			background: #ffffff;
			box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
			overflow: hidden;
		}

		.timetable-card:hover {
			transform: translateY(-4px);
			box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
			border-color: #3B82F6;
		}

		/* ========================================
	   DIRECTOR TASK MODAL - ENHANCED STYLES
	   Matching timetable-library.html aesthetic
	   ======================================== */

		/* Modal Shell & Backdrop */
		.modal-backdrop {
			backdrop-filter: blur(4px);
		}

		.modal-shell {
			background: #ffffff;
			border-radius: 24px;
			box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(148, 163, 184, 0.1);
			overflow: hidden;
			border: 1px solid rgba(148, 163, 184, 0.15);
			animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			display: flex;
			flex-direction: column;
			max-height: 90vh;
		}

		.modal-header-standard {
			padding: 1.75rem 2rem;
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			border-bottom: 2px solid rgba(148, 163, 184, 0.1);
			display: flex;
			align-items: center;
			justify-content: space-between;
			position: relative;
			z-index: 10;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
		}

		.modal-header-title {
			font-size: 1.5rem;
			font-weight: 800;
			color: #0f172a;
			letter-spacing: -0.025em;
		}

		.modal-header-close {
			width: 2.5rem;
			height: 2.5rem;
			border-radius: 0.75rem;
			background: #f8fafc;
			color: #64748b;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
			border: 1px solid #e2e8f0;
		}

		.modal-header-close:hover {
			background: #f1f5f9;
			color: #0f172a;
			transform: rotate(90deg);
		}

		@keyframes modalFadeIn {
			from {
				opacity: 0;
				transform: scale(0.95) translateY(20px);
			}

			to {
				opacity: 1;
				transform: scale(1) translateY(0);
			}
		}

		/* Modal Header Gradient - Deprecated, using Standard Header instead */
		.modal-header-gradient {
			display: none;
		}

		.modal-header-gradient::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.2), transparent 60%);
			pointer-events: none;
		}

		/* Modal Hero Section */
		.dir-modal-hero {
			position: relative;
			z-index: 1;
		}

		.dir-modal-hero-meta {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
			gap: 16px;
			margin-top: 24px;
		}

		.dir-modal-metric {
			background: rgba(255, 255, 255, 0.15);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.25);
			border-radius: 16px;
			padding: 18px;
			display: flex;
			flex-direction: column;
			gap: 8px;
			transition: all 0.3s ease;
		}

		.dir-modal-metric:hover {
			background: rgba(255, 255, 255, 0.25);
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
		}

		.dir-modal-metric p {
			font-size: 0.7rem;
			text-transform: uppercase;
			letter-spacing: 0.1em;
			color: rgba(255, 255, 255, 0.85);
			font-weight: 600;
			margin: 0;
		}

		.dir-modal-metric-number {
			font-size: 2.5rem;
			font-weight: 800;
			color: white;
			line-height: 1;
		}

		.dir-modal-metric-foot {
			display: flex;
			align-items: center;
			justify-content: space-between;
			font-size: 0.75rem;
			color: rgba(255, 255, 255, 0.9);
		}

		.dir-modal-metric--accent {
			grid-column: 1 / -1;
			background: rgba(255, 255, 255, 0.2);
		}

		.dir-modal-pagination {
			display: flex;
			align-items: center;
			gap: 12px;
			margin-top: 12px;
		}

		.dir-modal-pill {
			background: rgba(15, 23, 42, 0.25);
			border: 1px solid rgba(255, 255, 255, 0.3);
			color: white;
			padding: 6px 12px;
			border-radius: 999px;
			font-size: 0.75rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.dir-modal-pill:hover {
			background: rgba(15, 23, 42, 0.4);
			border-color: rgba(255, 255, 255, 0.5);
		}

		/* Modal Layout */


		/* ========================================
		   PREMIUM FORM STYLING - Timetable-Inspired
		   ======================================== */
		.dir-modal-form {
			padding: 0;
			margin-top: 16px;
		}

		.form-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 20px;
		}

		@media (max-width: 640px) {
			.form-grid {
				grid-template-columns: 1fr;
			}
		}

		.input-field {
			display: flex;
			flex-direction: column;
			gap: 10px;
			position: relative;
		}

		.input-field label {
			font-size: 0.8rem;
			font-weight: 700;
			color: #1e293b;
			text-transform: uppercase;
			letter-spacing: 0.08em;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.input-field label::before {
			content: '';
			width: 4px;
			height: 4px;
			background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
			border-radius: 50%;
		}

		.input-field input[type="text"],
		.input-field input[type="date"],
		.input-field select,
		.input-field textarea {
			width: 100%;
			padding: 1rem 1.25rem;
			border: 2px solid #e2e8f0;
			border-radius: 14px;
			font-size: 0.95rem;
			font-weight: 500;
			color: #0f172a;
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			outline: none;
			box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
		}

		.input-field input[type="text"]:hover,
		.input-field input[type="date"]:hover,
		.input-field select:hover,
		.input-field textarea:hover {
			border-color: #cbd5e1;
			box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
		}

		.input-field input:focus,
		.input-field select:focus,
		.input-field textarea:focus {
			border-color: #3b82f6;
			box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12), 0 4px 16px rgba(59, 130, 246, 0.15);
			background: #ffffff;
			transform: translateY(-1px);
		}

		.input-field textarea {
			resize: vertical;
			min-height: 120px;
			font-family: inherit;
			line-height: 1.6;
		}

		.input-field select {
			cursor: pointer;
			appearance: none;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: left 1rem center;
			background-size: 1.25rem;
			padding-left: 2.75rem;
		}

		[dir="rtl"] .input-field select {
			background-position: right 1rem center;
			padding-left: 1.25rem;
			padding-right: 2.75rem;
		}

		/* Premium Section Card Styling */
		.dir-modal-section {
			background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
			border-radius: 24px;
			padding: 2rem;
			border: 2px solid rgba(148, 163, 184, 0.15);
			box-shadow: 0 4px 20px rgba(15, 23, 42, 0.04), 0 1px 3px rgba(15, 23, 42, 0.02);
			transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
			overflow: hidden;
		}

		.dir-modal-section::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 4px;
			background: linear-gradient(90deg, #3b82f6 0%, #6366f1 50%, #8b5cf6 100%);
			border-radius: 24px 24px 0 0;
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.dir-modal-section:hover {
			transform: translateY(-4px);
			box-shadow: 0 20px 40px rgba(59, 130, 246, 0.12), 0 8px 16px rgba(15, 23, 42, 0.06);
			border-color: rgba(59, 130, 246, 0.3);
		}

		.dir-modal-section:hover::before {
			opacity: 1;
		}

		/* Enhanced Section Header */
		.dir-modal-section-head {
			display: flex;
			flex-direction: column;
			gap: 8px;
			margin-bottom: 28px;
			padding-bottom: 20px;
			border-bottom: 2px solid transparent;
			background: linear-gradient(90deg, #e2e8f0 0%, transparent 100%) no-repeat bottom;
			background-size: 100% 2px;
			position: relative;
		}

		.dir-modal-section-eyebrow {
			font-size: 0.85rem;
			text-transform: uppercase;
			letter-spacing: 0.1em;
			color: #3b82f6;
			font-weight: 700;
			margin-bottom: 8px;
			background: transparent;
			padding: 0;
			border-radius: 0;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			width: fit-content;
			box-shadow: none;
		}

		.dir-modal-section-eyebrow::before {
			content: 'âœ¦';
			font-size: 0.7rem;
			color: #3b82f6;
		}

		.dir-modal-section-title {
			font-size: 1.5rem;
			font-weight: 700;
			color: #1e293b;
			margin: 0;
			line-height: 1.4;
			max-width: 100%;
			overflow-wrap: break-word;
			background: none;
			-webkit-background-clip: unset;
			-webkit-text-fill-color: #1e293b;
			background-clip: unset;
		}

		/* Premium Tabs - Timetable Inspired */
		.director-tab {
			border-radius: 16px;
			padding: 14px 28px;
			border: 2px solid rgba(148, 163, 184, 0.2);
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			color: #475569;
			font-weight: 700;
			font-size: 0.9rem;
			display: inline-flex;
			align-items: center;
			gap: 10px;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
			position: relative;
			overflow: hidden;
		}

		.director-tab::before {
			content: '';
			position: absolute;
			inset: 0;
			background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.director-tab:hover {
			background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
			color: #3b82f6;
			border-color: rgba(59, 130, 246, 0.3);
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
		}

		.director-tab:hover::before {
			opacity: 1;
		}

		.director-tab.active {
			background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
			color: white;
			border-color: transparent;
			box-shadow: 0 8px 25px rgba(59, 130, 246, 0.35), 0 4px 12px rgba(99, 102, 241, 0.2);
			transform: translateY(-2px);
		}

		.director-tab.active i {
			color: rgba(255, 255, 255, 0.9);
		}

		.director-tab i {
			font-size: 1rem;
			transition: all 0.3s ease;
		}

		/* Premium Buttons - Timetable Inspired */
		.btn-primary {
			background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
			color: white;
			padding: 14px 32px;
			border-radius: 14px;
			font-weight: 700;
			font-size: 0.95rem;
			border: none;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(99, 102, 241, 0.2);
			text-transform: capitalize;
			letter-spacing: 0.03em;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
			position: relative;
			overflow: hidden;
		}

		.btn-primary::before {
			content: '';
			position: absolute;
			top: 0;
			left: -100%;
			width: 100%;
			height: 100%;
			background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
			transition: left 0.5s ease;
		}

		.btn-primary:hover::before {
			left: 100%;
		}

		.btn-primary:hover {
			transform: translateY(-3px) scale(1.02);
			box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4), 0 6px 16px rgba(99, 102, 241, 0.25);
			filter: brightness(1.05);
		}

		.btn-primary:active {
			transform: translateY(0) scale(0.98);
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
		}

		.btn-primary i {
			font-size: 1rem;
		}

		.btn-secondary {
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			color: #475569;
			padding: 14px 32px;
			border-radius: 14px;
			font-weight: 600;
			font-size: 0.95rem;
			border: 2px solid rgba(148, 163, 184, 0.25);
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
			box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
		}

		.btn-secondary:hover {
			background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
			border-color: #94a3b8;
			color: #1e293b;
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
		}

		.btn-secondary:active {
			transform: translateY(0);
			box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
		}

		.btn-secondary i {
			font-size: 0.95rem;
			color: #64748b;
		}

		.modal-actions {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 16px;
			padding-top: 24px;
			margin-top: 24px;
			border-top: 2px solid rgba(148, 163, 184, 0.1);
			background: linear-gradient(180deg, transparent 0%, rgba(248, 250, 252, 0.8) 100%);
		}

		/* Premium Assignee Section - Timetable Inspired */
		.dir-assignee-actions {
			display: flex;
			flex-direction: column;
			gap: 16px;
			margin-top: 20px;
		}

		.dir-selected-chips {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			margin-top: 16px;
			padding: 20px;
			background: linear-gradient(135deg, rgba(59, 130, 246, 0.06) 0%, rgba(99, 102, 241, 0.04) 100%);
			border-radius: 18px;
			border: 2px dashed rgba(59, 130, 246, 0.25);
			transition: all 0.3s ease;
			min-height: 60px;
		}

		.dir-selected-chips:hover {
			border-color: rgba(59, 130, 246, 0.4);
			background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(99, 102, 241, 0.06) 100%);
		}

		.dir-selected-chips.hidden {
			display: none;
		}

		/* Individual Chip Styling */
		.dir-selected-chips .assignee-chip,
		.assignee-chip {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 8px 14px;
			background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
			border: 1px solid rgba(59, 130, 246, 0.2);
			border-radius: 25px;
			font-size: 0.85rem;
			font-weight: 600;
			color: #334155;
			box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
			transition: all 0.2s ease;
			cursor: default;
		}

		.assignee-chip:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(59, 130, 246, 0.15);
			border-color: rgba(59, 130, 246, 0.4);
		}

		.assignee-chip .chip-remove {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: 20px;
			height: 20px;
			background: rgba(239, 68, 68, 0.1);
			border-radius: 50%;
			color: #dc2626;
			font-size: 0.7rem;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.assignee-chip .chip-remove:hover {
			background: #ef4444;
			color: white;
			transform: scale(1.1);
		}

		.dir-assignee-note {
			font-size: 0.8rem;
			color: #64748b;
			margin-top: 12px;
			line-height: 1.6;
			font-style: italic;
			padding: 12px 16px;
			background: linear-gradient(135deg, rgba(148, 163, 184, 0.08) 0%, rgba(148, 163, 184, 0.04) 100%);
			border-radius: 12px;
			border-left: 3px solid #94a3b8;
		}

		/* ========================================
		   PREMIUM TARGET SELECTION - Instruction Cards
		   ======================================== */
		.instruction-target-section {
			margin-top: 24px;
			padding: 20px;
			background: linear-gradient(135deg, rgba(59, 130, 246, 0.04) 0%, rgba(99, 102, 241, 0.03) 100%);
			border-radius: 20px;
			border: 2px solid rgba(59, 130, 246, 0.12);
		}

		.instruction-target-label {
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 0.12em;
			color: #3b82f6;
			font-weight: 700;
			margin-bottom: 16px;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.instruction-target-label i {
			font-size: 0.9rem;
		}

		.target-options-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 12px;
		}

		@media (max-width: 768px) {
			.target-options-grid {
				grid-template-columns: 1fr;
			}
		}

		.target-option-card {
			position: relative;
			display: flex;
			align-items: center;
			justify-content: flex-start;
			padding: 12px 16px;
			background: #ffffff;
			border: 1px solid #e2e8f0;
			border-radius: 12px;
			cursor: pointer;
			transition: all 0.2s ease;
			text-align: right;
			gap: 12px;
			min-height: 60px;
		}

		.target-option-card:hover {
			background: #f8fafc;
			border-color: #3b82f6;
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
		}

		.target-option-card.selected {
			background: #3b82f6;
			border-color: #3b82f6;
			box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
			transform: translateY(-1px);
		}

		.target-option-card.selected .target-option-icon {
			background: rgba(255, 255, 255, 0.2);
			color: white;
		}

		.target-option-card.selected .target-option-title,
		.target-option-card.selected .target-option-desc {
			color: white;
		}

		.target-option-card input[type="radio"],
		.target-option-card input[type="checkbox"] {
			position: absolute;
			opacity: 0;
			width: 0;
			height: 0;
		}

		.target-option-icon {
			width: 36px;
			height: 36px;
			border-radius: 8px;
			background: rgba(59, 130, 246, 0.1);
			display: flex;
			align-items: center;
			justify-content: center;
			margin-bottom: 0;
			color: #3b82f6;
			font-size: 1rem;
			transition: all 0.2s ease;
			flex-shrink: 0;
		}

		.target-option-title {
			font-size: 0.9rem;
			font-weight: 600;
			color: #1e293b;
			margin-bottom: 2px;
			transition: color 0.2s ease;
			line-height: 1.3;
		}

		.target-option-desc {
			font-size: 0.8rem;
			color: #64748b;
			transition: color 0.2s ease;
			line-height: 1.2;
		}

		.target-option-card .check-indicator {
			position: absolute;
			top: 8px;
			left: 8px;
			width: 20px;
			height: 20px;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.2);
			display: flex;
			align-items: center;
			justify-content: center;
			opacity: 0;
			transform: scale(0.5);
			transition: all 0.2s ease;
		}

		[dir="rtl"] .target-option-card .check-indicator {
			right: auto;
			left: 10px;
		}

		.target-option-card.selected .check-indicator {
			opacity: 1;
			transform: scale(1);
			background: rgba(255, 255, 255, 0.25);
		}

		.target-option-card .check-indicator i {
			color: white;
			font-size: 0.7rem;
		}

		/* Custom Scrollbar */
		.custom-scrollbar::-webkit-scrollbar {
			width: 8px;
			height: 8px;
		}

		.custom-scrollbar::-webkit-scrollbar-track {
			background: #f1f5f9;
			border-radius: 4px;
		}

		.custom-scrollbar::-webkit-scrollbar-thumb {
			background: #cbd5e1;
			border-radius: 4px;
		}

		.custom-scrollbar::-webkit-scrollbar-thumb:hover {
			background: #94a3b8;
		}

		/* RTL Support for Arabic */
		[dir="rtl"] .dir-modal-layout {
			direction: rtl;
		}

		[dir="rtl"] .input-field {
			text-align: right;
		}

		[dir="rtl"] .modal-actions {
			justify-content: flex-start;
		}

		.rtl-flex {
			flex-direction: row-reverse;
		}

		/* Integrated sidebar picker styles */
		.dir-modal-side {
			border-left: 1px solid #e2e8f0;
			background: #f8fafc;
			flex-shrink: 0;
			display: flex;
			flex-direction: column;
		}

		.dir-modal-section-head {
			padding-bottom: 1rem;
			margin-bottom: 1.25rem;
			border-bottom: 1px solid #e2e8f0;
		}

		.dir-modal-section-eyebrow {
			font-size: 0.75rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			color: #6366f1;
		}

		.dir-modal-section-title {
			font-size: 1.125rem;
			font-weight: 800;
			color: #1e293b;
			line-height: 1.3;
		}

		.assignee-picker-card {
			margin-bottom: 1rem;
			background: #fff;
			border: 2px solid rgba(148, 163, 184, 0.15);
			border-radius: 16px;
			overflow: hidden;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 2px 8px rgba(15, 23, 42, 0.03);
		}

		.assignee-picker-card:hover {
			border-color: rgba(59, 130, 246, 0.3);
			box-shadow: 0 8px 24px rgba(59, 130, 246, 0.08);
			transform: translateY(-2px);
		}

		.assignee-picker-card-head {
			padding: 0.875rem 1.125rem;
			background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
			border-bottom: 1px solid rgba(148, 163, 184, 0.1);
			display: flex;
			align-items: center;
			justify-content: space-between;
			transition: all 0.2s ease;
		}

		.assignee-picker-card:hover .assignee-picker-card-head {
			background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
		}

		.assignee-picker-card-title {
			display: flex;
			align-items: center;
			gap: 8px;
			font-weight: 700;
			color: #334155;
			font-size: 0.875rem;
			cursor: pointer;
		}

		.assignee-picker-pill {
			font-size: 0.75rem;
			font-weight: 700;
			color: #475569;
			background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
			padding: 4px 10px;
			border-radius: 999px;
			display: flex;
			align-items: center;
			gap: 5px;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
		}

		.assignee-picker-resp {
			padding: 0.75rem 1rem;
			background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
			border-bottom: 1px solid rgba(148, 163, 184, 0.15);
			transition: all 0.2s ease;
		}

		.assignee-picker-resp:hover {
			background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
		}

		.assignee-picker-resp label,
		.assignee-picker-resp-main {
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 0.875rem;
			font-weight: 600;
			color: #334155;
			cursor: pointer;
			user-select: none;
			-webkit-user-select: none;
		}

		.assignee-picker-resp-label {
			font-weight: 700;
			color: #334155;
		}

		.assignee-picker-resp-name {
			color: #64748b;
			font-weight: 500;
		}

		[dir="rtl"] .assignee-picker-resp-main,
		body.dir-lang-ar .assignee-picker-resp-main {
			flex-direction: row-reverse;
			text-align: right;
		}

		.assignee-picker-resp input[type="checkbox"] {
			width: 18px;
			height: 18px;
			min-width: 18px;
			min-height: 18px;
			border-radius: 6px;
			border: 2px solid #cbd5e1;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			accent-color: #3b82f6;
			flex-shrink: 0;
			-webkit-appearance: auto;
			appearance: auto;
			pointer-events: auto;
			position: relative;
			z-index: 1;
		}

		.assignee-picker-resp input[type="checkbox"]:hover {
			border-color: #3b82f6;
			transform: scale(1.1);
		}

		.assignee-picker-resp input[type="checkbox"]:checked {
			background-color: #3b82f6;
			border-color: #3b82f6;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
		}

		.assignee-picker-subtoggle {
			margin-top: 8px;
			margin-left: 28px;
			font-size: 0.75rem !important;
			color: #6366f1 !important;
			font-weight: 600 !important;
			cursor: pointer;
			user-select: none;
			-webkit-user-select: none;
			transition: all 0.2s ease;
		}

		.assignee-picker-subtoggle:hover {
			color: #4f46e5 !important;
		}

		.assignee-picker-subtoggle input[type="checkbox"] {
			width: 16px;
			height: 16px;
			border-radius: 4px;
			border: 2px solid #cbd5e1;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			accent-color: #6366f1;
			flex-shrink: 0;
		}

		.assignee-picker-subtoggle input[type="checkbox"]:hover {
			border-color: #6366f1;
			transform: scale(1.1);
		}

		.assignee-picker-subtoggle input[type="checkbox"]:checked {
			background-color: #6366f1;
			border-color: #6366f1;
			box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
		}

		.assignee-picker-employees {
			padding: 0.5rem;
			max-height: 200px;
			overflow-y: auto;
		}

		.assignee-picker-employee {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 0.625rem 0.75rem;
			border-radius: 10px;
			font-size: 0.8125rem;
			color: #334155;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			user-select: none;
			-webkit-user-select: none;
			border: 1px solid transparent;
		}

		.assignee-picker-employee:hover {
			background: linear-gradient(135deg, #eff6ff 0%, #f1f5f9 100%);
			border-color: rgba(59, 130, 246, 0.2);
			transform: translateX(2px);
		}

		.assignee-picker-employee input[type="checkbox"] {
			width: 16px;
			height: 16px;
			border-radius: 5px;
			border: 2px solid #cbd5e1;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			accent-color: #3b82f6;
			flex-shrink: 0;
		}

		.assignee-picker-employee input[type="checkbox"]:hover {
			border-color: #3b82f6;
			transform: scale(1.1);
		}

		.assignee-picker-employee input[type="checkbox"]:checked {
			background-color: #3b82f6;
			border-color: #3b82f6;
			box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
		}

		.assignee-empty-state {
			text-align: center;
			padding: 2rem 1rem;
			color: #94a3b8;
			font-size: 0.8125rem;
		}

		.assignee-empty-state i {
			display: block;
			font-size: 1.5rem;
			margin-bottom: 0.5rem;
			opacity: 0.5;
		}

		[dir="rtl"] .dir-modal-side {
			border-left: none;
			border-right: 1px solid #e2e8f0;
		}

		[dir="rtl"] .assignee-picker-subtoggle {
			margin-left: 0;
			margin-right: 24px;
		}

		/* Custom checkboxes for picker */
		.assignee-picker-card input[type="checkbox"] {
			width: 1rem;
			height: 1rem;
			border-radius: 4px;
			border: 2px solid #cbd5e1;
			transition: all 0.2s;
			cursor: pointer;
		}

		.assignee-picker-card input[type="checkbox"]:checked {

			/* Director Tasks List - Enhanced Table View */
			.dir-modal-section {
				padding: 24px;
				background: #ffffff;
				border-radius: 16px;
				border: 1px solid rgba(148, 163, 184, 0.15);
				box-shadow: 0 2px 8px rgba(15, 23, 42, 0.03);
				transition: all 0.2s ease;
			}

			.dir-modal-section:hover {
				box-shadow: 0 4px 16px rgba(15, 23, 42, 0.05);
			}
		}

		.dir-tasks-table-container thead {
			background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
			border-bottom: 2px solid rgba(148, 163, 184, 0.2);
		}

		.dir-tasks-table-container thead th {
			padding: 18px 24px;
			font-size: 0.7rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.15em;
			color: #64748b;
			text-align: left;
		}

		.dir-tasks-table-container tbody tr {
			border-bottom: 1px solid rgba(148, 163, 184, 0.1);
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.dir-tasks-table-container tbody tr:hover {
			background: linear-gradient(120deg, rgba(59, 130, 246, 0.04), rgba(124, 58, 237, 0.04));
			border-left: 4px solid #3B82F6;
		}

		.dir-tasks-table-container tbody tr:last-child {
			border-bottom: none;
		}

		.dir-tasks-table-container tbody td {
			padding: 20px 24px;
			font-size: 0.9rem;
			color: #475569;
		}

		.interval-badge {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		}

		.assignment-badge {
			background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
		}

		.time-input {
			background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
		}

		.weekday-selector {
			transition: all 0.2s ease;
		}

		.weekday-selector.active {
			background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
			transform: scale(1.05);
		}

		:root {
			--director-indigo: #4338ca;
			--director-blue: #2563eb;
			--director-purple: #7c3aed;
			--director-slate: #0f172a;
			--director-card-bg: #ffffff;
			--director-surface: #f8fafc;
		}

		body {
			font-family: 'Outfit', 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
			color: var(--director-slate);
			background: radial-gradient(circle at top, rgba(59, 130, 246, 0.06), transparent 45%), #f5f7fb;
		}

		.page-hero {
			background: linear-gradient(135deg, #3b82f6 0%, #7c3aed 100%);
			color: white;
			border-radius: 28px;
			padding: 32px;
			position: sticky;
			top: 0;
			z-index: 40;
			overflow: visible;
			box-shadow: 0 25px 60px rgba(67, 56, 202, 0.25);
			margin-bottom: 2rem;
		}

		.page-hero::after {
			content: '';
			position: absolute;
			inset: 0;
			border-radius: 28px;
			background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.25), transparent 50%);
			pointer-events: none;
		}

		.page-hero-content {
			position: relative;
			z-index: 1;
			display: flex;
			flex-direction: column;
			gap: 24px;
		}

		.hero-metadata {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
		}

		.hero-chip {
			background: rgba(255, 255, 255, 0.18);
			border: 1px solid rgba(255, 255, 255, 0.35);
			color: white;
			padding: 10px 16px;
			border-radius: 999px;
			font-size: 0.82rem;
			display: inline-flex;
			align-items: center;
			gap: 12px;
		}

		.hero-actions {
			display: flex;
			flex-direction: column;
			gap: 12px;
			align-items: flex-end;
		}

		.hero-select {
			background: rgba(15, 23, 42, 0.25);
			border: 1px solid rgba(255, 255, 255, 0.3);
			color: #fff;
			border-radius: 12px;
			padding: 10px 16px;
			min-width: 180px;
			backdrop-filter: blur(6px);
		}

		.hero-button {
			background: #fff;
			color: var(--director-indigo);
			border-radius: 14px;
			padding: 12px 20px;
			font-weight: 600;
			display: inline-flex;
			align-items: center;
			gap: 10px;
			box-shadow: 0 15px 30px rgba(15, 23, 42, 0.25);
			transition: transform 0.2s ease, box-shadow 0.2s ease;
		}

		.hero-button:hover {
			transform: translateY(-2px);
			box-shadow: 0 20px 35px rgba(15, 23, 42, 0.35);
		}

		/* Header + notification hero styling (parity with stats page) */
		.header-user-section {
			display: flex;
			align-items: center;
			gap: 16px;
			background: rgba(255, 255, 255, 0.15);
			backdrop-filter: blur(10px);
			padding: 12px 18px;
			border-radius: 20px;
			border: 1px solid rgba(255, 255, 255, 0.25);
			transition: all 0.3s ease;
		}

		.header-user-section:hover {
			background: rgba(255, 255, 255, 0.2);
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
		}

		.header-avatar {
			width: 56px;
			height: 56px;
			border-radius: 16px;
			background: linear-gradient(135deg, #ffffff, #f1f5f9);
			color: #4338ca;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5rem;
			font-weight: 800;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			flex-shrink: 0;
			border: 2px solid rgba(255, 255, 255, 0.5);
		}

		.header-avatar img {
			width: 100%;
			height: 100%;
			border-radius: 14px;
			object-fit: cover;
		}

		.header-user-info {
			display: flex;
			flex-direction: column;
			gap: 4px;
			min-width: 0;
		}

		.header-user-name {
			font-size: 1.1rem;
			font-weight: 700;
			color: #ffffff;
			margin: 0;
			line-height: 1.2;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.header-user-role {
			font-size: 0.75rem;
			font-weight: 600;
			color: rgba(255, 255, 255, 0.85);
			text-transform: uppercase;
			letter-spacing: 0.05em;
			background: rgba(255, 255, 255, 0.15);
			padding: 4px 10px;
			border-radius: 8px;
			display: inline-block;
			width: fit-content;
		}

		.header-actions {
			display: flex;
			align-items: center;
			gap: 16px;
			flex-wrap: wrap;
		}

		.notification-bell {
			position: relative;
			width: 48px;
			height: 48px;
			border-radius: 14px;
			background: rgba(255, 255, 255, 0.15);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.25);
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: all 0.3s ease;
			color: #ffffff;
			font-size: 1.2rem;
		}

		.notification-bell:hover {
			background: rgba(255, 255, 255, 0.25);
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
		}

		.notification-bell:active {
			transform: translateY(0);
		}

		.notification-badge {
			position: absolute;
			top: -4px;
			right: -4px;
			background: linear-gradient(135deg, #ef4444, #dc2626);
			color: white;
			font-size: 0.65rem;
			font-weight: 700;
			padding: 2px 6px;
			border-radius: 10px;
			min-width: 18px;
			height: 18px;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
			border: 2px solid rgba(255, 255, 255, 0.3);
		}

		.notification-badge:empty {
			display: none;
		}

		.header-date {
			display: flex;
			align-items: center;
			gap: 10px;
			background: rgba(255, 255, 255, 0.15);
			backdrop-filter: blur(10px);
			padding: 12px 18px;
			border-radius: 14px;
			border: 1px solid rgba(255, 255, 255, 0.25);
			color: #fff;
			font-weight: 700;
			letter-spacing: 0.02em;
		}

		.header-date i {
			color: #c7d2fe;
		}

		.header-date span {
			font-size: 0.95rem;
		}

		@media (max-width: 1024px) {
			.page-hero {
				position: relative;
				top: auto;
			}
		}

		@media (max-width: 768px) {
			.header-actions {
				width: 100%;
				justify-content: space-between;
			}

			.header-date span {
				display: none;
			}

			.header-date {
				padding: 12px;
				width: 48px;
				height: 48px;
				justify-content: center;
			}
		}

		/* Notification dropdown */
		.notification-dropdown {
			position: absolute;
			top: 100%;
			right: 0;
			margin-top: 12px;
			width: 420px;
			max-width: 95vw;
			background: white;
			border-radius: 16px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
			border: 1px solid rgba(0, 0, 0, 0.08);
			z-index: 1000;
			overflow: hidden;
			animation: dropdownFadeIn 0.2s ease-out;
		}

		@keyframes dropdownFadeIn {
			from {
				opacity: 0;
				transform: translateY(-10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.notification-dropdown.hidden {
			display: none;
		}

		.notification-dropdown-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 16px 20px;
			border-bottom: 1px solid rgba(0, 0, 0, 0.08);
			background: linear-gradient(135deg, #f8fafc, #f1f5f9);
		}

		.notification-dropdown-title {
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 1rem;
			font-weight: 700;
			color: #0f172a;
			margin: 0;
		}

		.notification-dropdown-title i {
			color: #3b82f6;
			font-size: 1.1rem;
		}

		.mark-all-read-btn {
			background: transparent;
			border: none;
			color: #64748b;
			cursor: pointer;
			padding: 8px;
			border-radius: 8px;
			transition: all 0.2s ease;
			font-size: 0.9rem;
		}

		.mark-all-read-btn:hover {
			background: rgba(59, 130, 246, 0.1);
			color: #3b82f6;
		}

		.notification-list {
			max-height: 400px;
			overflow-y: auto;
			overflow-x: hidden;
		}

		.notification-list::-webkit-scrollbar {
			width: 6px;
		}

		.notification-list::-webkit-scrollbar-track {
			background: #f1f5f9;
		}

		.notification-list::-webkit-scrollbar-thumb {
			background: #cbd5e1;
			border-radius: 3px;
		}

		.notification-list::-webkit-scrollbar-thumb:hover {
			background: #94a3b8;
		}

		.notification-loading,
		.notification-empty {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 40px 20px;
			gap: 12px;
			color: #64748b;
		}

		.notification-empty i {
			font-size: 3rem;
			color: #cbd5e1;
		}

		.notification-empty p {
			font-size: 0.9rem;
			font-weight: 500;
		}

		.loading-spinner {
			width: 40px;
			height: 40px;
			border: 4px solid #f1f5f9;
			border-top-color: #3b82f6;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		.notification-item {
			display: flex;
			gap: 12px;
			padding: 14px 20px;
			border-bottom: 1px solid rgba(0, 0, 0, 0.05);
			cursor: pointer;
			transition: all 0.2s ease;
			text-decoration: none;
			color: inherit;
		}

		.notification-item:hover {
			background: #f8fafc;
		}

		.notification-item:last-child {
			border-bottom: none;
		}

		.notification-item.unread {
			background: rgba(59, 130, 246, 0.04);
		}

		.notification-item.unread::before {
			content: '';
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 3px;
			background: #3b82f6;
		}

		.notification-icon {
			width: 40px;
			height: 40px;
			border-radius: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
			font-size: 1rem;
			color: white;
		}

		.notification-icon.task {
			background: linear-gradient(135deg, #3b82f6, #2563eb);
		}

		.notification-icon.report {
			background: linear-gradient(135deg, #f59e0b, #d97706);
		}

		.notification-icon.complaint {
			background: linear-gradient(135deg, #ef4444, #dc2626);
		}

		.notification-icon.signal {
			background: linear-gradient(135deg, #10b981, #059669);
		}

		.notification-content {
			display: flex;
			flex-direction: column;
			gap: 4px;
			flex: 1;
			min-width: 0;
		}

		.notification-title {
			font-weight: 700;
			color: #0f172a;
			font-size: 0.95rem;
		}

		.notification-message {
			font-size: 0.85rem;
			color: #475569;
			line-height: 1.4;
		}

		.notification-time {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			font-size: 0.78rem;
			color: #94a3b8;
		}

		.notification-dropdown-footer {
			padding: 12px 20px;
			border-top: 1px solid rgba(0, 0, 0, 0.08);
			background: #f8fafc;
			display: flex;
			justify-content: flex-end;
		}

		.view-all-link {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			color: #2563eb;
			font-weight: 700;
			text-decoration: none;
			font-size: 0.9rem;
		}

		.view-all-link:hover {
			color: #1d4ed8;
		}

		@media (max-width: 640px) {
			.notification-dropdown {
				position: fixed;
				top: auto;
				right: 0;
				left: 0;
				bottom: 0;
				margin: 0;
				width: 100%;
				max-width: 100%;
				border-radius: 16px 16px 0 0;
			}

			.notification-list {
				max-height: calc(80vh - 140px);
			}
		}

		.kpi-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
			gap: 20px;
			direction: rtl;
		}

		.kpi-card {
			background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.95));
			border-radius: 24px;
			padding: 22px;
			position: relative;
			overflow: hidden;
			border: 1px solid rgba(15, 23, 42, 0.06);
			box-shadow: 0 18px 35px rgba(15, 23, 42, 0.07);
			transition: transform 0.2s ease, box-shadow 0.2s ease;
			display: flex;
			gap: 16px;
			align-items: flex-start;
		}

		.kpi-card:hover {
			transform: translateY(-4px);
			box-shadow: 0 25px 45px rgba(15, 23, 42, 0.12);
		}

		.kpi-card::after {
			content: '';
			position: absolute;
			inset: 0;
			background: radial-gradient(circle at top right, rgba(37, 99, 235, 0.12), transparent 55%);
			pointer-events: none;
		}

		.kpi-icon {
			width: 48px;
			height: 48px;
			border-radius: 16px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(99, 102, 241, 0.35));
			color: #4338ca;
			margin-bottom: 16px;
			position: relative;
			z-index: 1;
		}

		.kpi-card p {
			position: relative;
			z-index: 1;
		}

		.kpi-card h3 {
			position: relative;
			z-index: 1;
		}

		/* Report Stat Cards (Inline Style) */
		.report-stat-card-inline {
			background: #ffffff;
			border-radius: 20px;
			padding: 20px;
			border: 1px solid rgba(15, 23, 42, 0.08);
			box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
			transition: all 0.3s ease;
			display: flex;
			gap: 16px;
			align-items: center;
			flex: 1;
			min-width: 200px;
			text-decoration: none !important;
			position: relative;
			overflow: hidden;
		}

		.report-stat-card-inline:hover {
			transform: translateY(-4px);
			box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
		}

		.report-stat-icon {
			width: 56px;
			height: 56px;
			border-radius: 16px;
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-size: 1.5rem;
			flex-shrink: 0;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
		}

		.report-stat-content {
			flex: 1;
		}

		.report-stat-label {
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			color: #64748b;
			font-weight: 600;
			margin-bottom: 8px;
		}

		.report-stat-value {
			font-size: 2.25rem;
			font-weight: 800;
			color: #0f172a;
			line-height: 1;
			margin-bottom: 0;
		}

		.kpi-card::after {
			display: none;
		}

		.kpi-card:hover {
			transform: translateY(-4px);
			box-shadow: 0 25px 45px rgba(15, 23, 42, 0.12);
		}

		.kpi-icon {
			width: 56px;
			height: 56px;
			border-radius: 16px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			/* background set inline */
			color: white;
			font-size: 1.5rem;
			margin-bottom: 0;
			/* Removed for horizontal layout */
			position: relative;
			z-index: 1;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
			flex-shrink: 0;
		}



		.kpi-card p {
			position: relative;
			z-index: 1;
		}

		.kpi-card h3 {
			position: relative;
			z-index: 1;
		}

		.director-toolbar {
			margin-top: 32px;
			margin-bottom: 48px;
			background: var(--director-card-bg);
			border-radius: 20px;
			border: 1px solid rgba(15, 23, 42, 0.06);
			box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
			padding: 18px 22px;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			min-height: 80px;
		}

		.btn-create-task {
			position: absolute;
			left: 22px;
			display: flex;
			align-items: center;
			gap: 10px;
			background: linear-gradient(135deg, #2563eb, #7c3aed);
			color: white;
			padding: 10px 20px;
			border-radius: 999px;
			font-weight: 700;
			font-size: 0.85rem;
			box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			border: none;
			cursor: pointer;
			text-transform: uppercase;
			letter-spacing: 0.05em;
		}

		.btn-create-task:hover {
			transform: translateY(-2px);
			box-shadow: 0 12px 25px rgba(37, 99, 235, 0.3);
			filter: brightness(1.1);
		}

		.btn-create-task:active {
			transform: translateY(0);
		}

		.btn-create-task i {
			font-size: 1rem;
		}

		[dir="rtl"] .btn-create-task {
			left: auto;
			right: 22px;
		}

		.director-tabs {
			display: inline-flex;
			flex-wrap: wrap;
			gap: 6px;
			padding: 6px;
			background: rgba(255, 255, 255, 0.85);
			border: 1px solid rgba(148, 163, 184, 0.35);
			border-radius: 999px;
		}

		.director-tab {
			border-radius: 999px;
			padding: 8px 16px;
			border: none;
			background: transparent;
			color: #475569;
			font-weight: 600;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			transition: all 0.2s ease;
		}

		.director-tab.active {
			background: linear-gradient(120deg, #2563eb, #7c3aed);
			color: white;
			box-shadow: 0 10px 22px rgba(37, 99, 235, 0.25);
		}

		.director-tab:not(.active):hover {
			background: rgba(241, 245, 249, 0.8);
			color: #1f2937;
		}

		.director-filters {
			display: flex;
			gap: 12px;
			flex-wrap: wrap;
			align-items: center;
		}

		.director-filters input,
		.director-filters select {
			border-radius: 12px;
			border: 1px solid rgba(15, 23, 42, 0.1);
			padding: 10px 14px;
			background: #f8fafc;
		}

		.director-panel {
			margin-top: 16px;
			background: var(--director-card-bg);
			border-radius: 22px;
			padding: 24px 24px 20px;
			box-shadow: 0 24px 48px rgba(15, 23, 42, 0.08);
			border: 1px solid rgba(15, 23, 42, 0.06);
			position: relative;
			overflow: hidden;
		}

		.dashboard-content-container {
			width: 100%;
			margin: 0 auto;
			background: #ffffff;
			border-radius: 32px;
			padding: 32px;
			box-shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
			border: 1px solid rgba(15, 23, 42, 0.04);
			display: flex;
			flex-direction: column;
		}

		.dashboard-v-spacing-high {
			max-width: 80rem;
			margin-left: auto;
			margin-right: auto;
			padding: 24px;
		}
		
		.dashboard-v-spacing-high>*+* {
			margin-top: 64px !important;
		}

		.director-panel::before {
			display: none;
		}

		.director-panel>* {
			position: relative;
			z-index: 1;
		}

		/* Responsible view enhancements - Modern styles only */


		.dir-resp-controls {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.dir-resp-control-row {
			display: flex;
			flex-wrap: wrap;
			gap: 16px;
			align-items: flex-end;
			justify-content: space-between;
		}

		.dir-resp-filters {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
			align-items: center;
			justify-content: flex-start;
		}

		.dir-resp-select {
			width: 100%;
			max-width: 240px;
			height: 46px;
			border-radius: 14px;
			border: 1px solid rgba(15, 23, 42, 0.1);
			padding: 0 16px;
			font-weight: 600;
			background: #ffffff;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
			font-size: 0.9rem;
			display: flex;
			align-items: center;
		}

		.dir-resp-select:hover {
			border-color: rgba(37, 99, 235, 0.3);
			background: #fdfdff;
		}

		.dir-resp-select:focus {
			border-color: #2563eb;
			box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
			outline: none;
		}

		.dir-resp-section {
			position: relative;
			background: #fff;
			border-radius: 26px;
			box-shadow: 0 18px 35px rgba(15, 23, 42, 0.08);
			border: 1px solid rgba(15, 23, 42, 0.05);
			overflow: hidden;
			display: flex;
			flex-direction: column;
			gap: 32px;
		}

		.dir-resp-section::before {
			display: none;
		}

		.dir-resp-section>* {
			position: relative;
			z-index: 1;
		}

		.dir-resp-section-block {
			padding: 0 28px;
		}

		.dir-resp-section-block:first-child {
			padding-top: 28px;
		}

		.dir-resp-section-block:last-child {
			padding-bottom: 28px;
		}

		.dir-resp-pill-group {
			display: inline-flex;
			gap: 8px;
			padding: 4px;
			background: rgba(15, 23, 42, 0.04);
			border-radius: 999px;
			border: 1px solid rgba(15, 23, 42, 0.08);
		}

		.dir-toggle-group {
			display: flex;
			gap: 10px;
			background: rgba(255, 255, 255, 0.8);
			border: 1px solid rgba(148, 163, 184, 0.4);
			border-radius: 18px;
			padding: 6px;
		}

		.dir-toggle-option {
			flex: 1;
			padding: 12px 16px;
			border-radius: 14px;
			border: 1px solid transparent;
			background: transparent;
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			gap: 2px;
			font-weight: 600;
			font-size: 0.9rem;
			color: #475569;
			transition: all 0.2s ease;
		}

		.dir-toggle-option .toggle-head {
			font-size: 0.95rem;
			font-weight: 700;
			color: #0f172a;
		}

		.dir-toggle-option .toggle-sub {
			font-size: 0.7rem;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: #94a3b8;
			font-weight: 600;
		}

		.dir-toggle-option small {
			font-size: 0.65rem;
			letter-spacing: 0.25em;
			text-transform: uppercase;
			color: #94a3b8;
			font-weight: 600;
		}

		.dir-toggle-option.active {
			background: linear-gradient(120deg, #2563eb, #7c3aed);
			color: #fff;
			box-shadow: 0 10px 22px rgba(37, 99, 235, 0.25);
		}

		.dir-toggle-option.active .toggle-head {
			color: #fff;
		}

		.dir-toggle-option.active .toggle-sub {
			color: rgba(255, 255, 255, 0.75);
		}

		.dir-toggle-option.active small {
			color: rgba(255, 255, 255, 0.75);
		}

		.dir-toggle-pill-group {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			background: rgba(255, 255, 255, 0.85);
			border: 1px solid rgba(148, 163, 184, 0.35);
			border-radius: 999px;
			padding: 4px;
		}

		.dir-toggle-pill {
			border: none;
			background: transparent;
			padding: 10px 18px;
			border-radius: 999px;
			font-weight: 600;
			font-size: 0.9rem;
			color: #475569;
			transition: all 0.2s ease;
			display: inline-flex;
			flex-direction: column;
			gap: 2px;
			align-items: flex-start;
		}

		.dir-toggle-pill .toggle-head {
			font-size: 0.95rem;
			font-weight: 700;
			color: #0f172a;
		}

		.dir-toggle-pill .toggle-sub {
			font-size: 0.65rem;
			letter-spacing: 0.25em;
			text-transform: uppercase;
			color: #94a3b8;
			font-weight: 600;
		}

		.dir-toggle-pill.active {
			background: linear-gradient(120deg, #2563eb, #7c3aed);
			color: #fff;
			box-shadow: 0 10px 22px rgba(37, 99, 235, 0.25);
		}

		.dir-toggle-pill.active .toggle-head {
			color: #fff;
		}

		.dir-toggle-pill.active .toggle-sub {
			color: rgba(255, 255, 255, 0.75);
		}

		.dir-resp-quick-actions {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-resp-quick-btn {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 10px 18px;
			border-radius: 14px;
			font-size: 0.85rem;
			font-weight: 600;
			transition: all 0.2s ease;
			border: 1px solid rgba(148, 163, 184, 0.35);
			background: #f8fafc;
			color: #0f172a;
		}

		.dir-resp-quick-btn.primary {
			background: linear-gradient(120deg, #2563eb, #7c3aed);
			color: #fff;
			border-color: transparent;
			box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
		}

		.dir-resp-quick-btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 12px 20px rgba(15, 23, 42, 0.12);
		}

		.dir-resp-table-head {
			display: flex;
			align-items: center;
			gap: 16px;
			padding: 22px 24px;
			border-bottom: 1px solid #e2e8f0;
			background: linear-gradient(120deg, #f8fafc, #eef2ff);
		}

		.dir-resp-table-head-icon {
			width: 46px;
			height: 46px;
			border-radius: 16px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.dir-resp-table-head-body {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		.dir-resp-table-head-label {
			font-size: 0.7rem;
			letter-spacing: 0.3em;
			text-transform: uppercase;
			color: #94a3b8;
			font-weight: 600;
		}

		/* Employees view theme */
		.dir-emp-hero {
			background: linear-gradient(120deg, #0f172a, #1e3a8a, #7c3aed);
			border-radius: 32px;
			padding: 30px;
			color: #fff;
			position: relative;
			overflow: hidden;
			box-shadow: 0 30px 70px rgba(15, 23, 42, 0.45);
			margin-bottom: 32px;
		}

		.dir-emp-hero::after {
			content: '';
			position: absolute;
			inset: 0;
			background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.25), transparent 55%);
			pointer-events: none;
		}

		.dir-emp-hero-content {
			position: relative;
			z-index: 1;
			display: flex;
			flex-direction: column;
			gap: 28px;
		}

		.dir-emp-hero-header {
			display: flex;
			flex-wrap: wrap;
			gap: 18px;
			justify-content: space-between;
			align-items: flex-start;
		}

		.dir-emp-hero-title {
			font-size: 2.2rem;
			font-weight: 800;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.dir-emp-hero-badges {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-emp-hero-chip {
			padding: 10px 18px;
			border-radius: 18px;
			backdrop-filter: blur(4px);
			background: rgba(255, 255, 255, 0.16);
			border: 1px solid rgba(255, 255, 255, 0.25);
			font-size: 0.85rem;
			font-weight: 600;
			display: inline-flex;
			align-items: center;
			gap: 8px;
		}

		.dir-emp-stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
			gap: 18px;
		}

		.dir-emp-stat-card {
			padding: 18px;
			border-radius: 22px;
			background: #ffffff;
			border: 1px solid rgba(15, 23, 42, 0.08);
			box-shadow: 0 4px 12px rgba(15, 23, 42, 0.03);
		}

		.dir-emp-stat-label {
			font-size: 0.7rem;
			text-transform: uppercase;
			letter-spacing: 0.3em;
			color: #64748b;
			margin-bottom: 8px;
			display: block;
		}

		.dir-emp-stat-value {
			font-size: 2rem;
			font-weight: 800;
			color: #0f172a;
		}

		.dir-emp-controls {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.dir-emp-control-head {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 16px;
			flex-wrap: wrap;
			margin-bottom: 18px;
		}

		.dir-emp-label {
			font-size: 0.65rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.35em;
			color: #94a3b8;
		}

		.dir-emp-chip {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 8px 14px;
			border-radius: 999px;
			background: #f1f5f9;
			font-size: 0.85rem;
			font-weight: 600;
			color: #0f172a;
		}

		.dir-emp-control-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
			gap: 20px;
		}

		.dir-emp-field label {
			font-size: 0.85rem;
			font-weight: 600;
			color: #0f172a;
			display: block;
			margin-bottom: 8px;
		}

		.dir-emp-field .dir-emp-select,
		.dir-emp-field input[type="text"] {
			width: 100%;
			border-radius: 16px;
			border: 1px solid rgba(15, 23, 42, 0.1);
			padding: 12px 14px;
			background: #f8fafc;
			font-weight: 600;
			color: #0f172a;
			box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.04);
		}

		.dir-emp-field input[type="text"]::placeholder {
			color: #94a3b8;
		}

		.dir-emp-field .input-icon {
			position: absolute;
			left: 16px;
			top: 50%;
			transform: translateY(-50%);
			color: #94a3b8;
		}

		.dir-emp-combobox {
			position: relative;
		}

		.dir-emp-combobox input {
			padding-left: 42px;
			padding-right: 42px;
		}

		.dir-emp-combobox button {
			position: absolute;
			right: 12px;
			top: 50%;
			transform: translateY(-50%);
			color: #94a3b8;
		}

		.dir-emp-combobox-list {
			position: absolute;
			top: calc(100% + 8px);
			left: 0;
			right: 0;
			background: #fff;
			border-radius: 18px;
			border: 1px solid rgba(15, 23, 42, 0.08);
			box-shadow: 0 24px 40px rgba(15, 23, 42, 0.12);
			max-height: 260px;
			overflow-y: auto;
			z-index: 10;
		}

		.dir-emp-time-filters {
			margin-top: 24px;
			border-top: 1px solid #e2e8f0;
			padding-top: 24px;
		}

		.dir-emp-time-pills {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-emp-time-pills .filter-button {
			border-radius: 999px;
			padding: 10px 18px;
			font-size: 0.9rem;
			font-weight: 600;
			border: 1px solid rgba(148, 163, 184, 0.4);
			background: #fff;
			color: #475569;
			transition: all 0.2s ease;
		}

		.dir-emp-time-pills .filter-button.active {
			background: linear-gradient(120deg, #2563eb, #7c3aed);
			color: #fff;
			border-color: transparent;
			box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
		}

		.dir-emp-mode-switch {
			display: inline-flex;
			align-items: center;
			gap: 12px;
			padding: 6px;
			border-radius: 18px;
			background: rgba(15, 23, 42, 0.04);
			border: 1px solid rgba(148, 163, 184, 0.35);
			margin-bottom: 24px;
		}

		.dir-emp-mode-switch button {
			border: none;
			border-radius: 14px;
			padding: 10px 18px;
			font-size: 0.95rem;
			font-weight: 600;
			background: transparent;
			color: #475569;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			transition: all 0.2s ease;
		}

		.dir-emp-mode-switch button.active {
			background: #fff;
			color: #0f172a;
			box-shadow: 0 12px 24px rgba(15, 23, 42, 0.15);
		}

		.dir-emp-panel {
			padding: 32px 0;
		}

		.dir-emp-empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			text-align: center;
			gap: 10px;
			min-height: 260px;
			color: #475569;
		}

		.dir-emp-empty-state i {
			font-size: 48px;
			color: #cbd5f5;
		}

		.dir-chip {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 8px 14px;
			border-radius: 999px;
			background: rgba(255, 255, 255, 0.12);
			font-size: 0.85rem;
			font-weight: 600;
		}

		.dir-emp-input-group {
			position: relative;
			display: flex;
			align-items: center;
		}

		.dir-emp-input-group .dir-emp-select,
		.dir-emp-input-group input {
			padding-left: 42px;
			padding-right: 42px;
		}

		.dir-input-icon {
			position: absolute;
			left: 14px;
			top: 50%;
			transform: translateY(-50%);
			color: #94a3b8;
			font-size: 0.9rem;
		}

		.dir-icon-btn {
			position: absolute;
			right: 10px;
			top: 50%;
			transform: translateY(-50%);
			width: 28px;
			height: 28px;
			border-radius: 999px;
			border: none;
			background: #e2e8f0;
			color: #475569;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-size: 0.75rem;
			transition: background 0.2s ease;
		}

		.dir-icon-btn:hover {
			background: #cbd5f5;
		}

		.dir-emp-profile {
			background: linear-gradient(135deg, #1e1b4b, #312e81);
			color: #fff;
			border-radius: 28px;
			padding: 24px;
			box-shadow: 0 25px 60px rgba(15, 23, 42, 0.35);
			display: flex;
			flex-direction: column;
			gap: 18px;
		}

		.dir-emp-profile-main {
			display: flex;
			flex-wrap: wrap;
			gap: 18px;
			align-items: center;
			justify-content: space-between;
		}

		.dir-emp-avatar-lg {
			width: 72px;
			height: 72px;
			border-radius: 20px;
			background: rgba(255, 255, 255, 0.15);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.8rem;
			font-weight: 800;
			box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.25);
		}

		.dir-emp-profile-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-emp-pill {
			display: inline-flex;
			flex-direction: column;
			padding: 12px 16px;
			border-radius: 16px;
			background: rgba(15, 23, 42, 0.3);
			border: 1px solid rgba(255, 255, 255, 0.14);
			min-width: 110px;
		}

		.dir-emp-pill span {
			font-size: 0.65rem;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: rgba(255, 255, 255, 0.65);
		}

		.dir-emp-pill strong {
			font-size: 1.1rem;
			font-weight: 800;
		}

		.dir-emp-contact-row {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-emp-contact-chip {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 10px 14px;
			border-radius: 14px;
			background: rgba(255, 255, 255, 0.12);
			border: 1px solid rgba(255, 255, 255, 0.15);
			font-size: 0.85rem;
		}

		.dir-emp-timeline {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
			gap: 18px;
		}

		.dir-emp-timeline-card {
			background: #fff;
			border-radius: 24px;
			padding: 18px;
			border: 1px solid rgba(148, 163, 184, 0.2);
			box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.dir-emp-timeline-head {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
		}

		.dir-emp-timeline-list {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.dir-emp-timeline-item {
			padding: 12px;
			border-radius: 14px;
			border: 1px solid rgba(148, 163, 184, 0.18);
			background: #f8fafc;
			display: flex;
			flex-direction: column;
			gap: 6px;
		}

		.dir-emp-timeline-item h5 {
			font-size: 0.95rem;
			font-weight: 600;
			color: #0f172a;
			margin: 0;
		}

		.dir-emp-meta-row {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			font-size: 0.78rem;
			color: #475569;
		}

		.dir-emp-timeline-empty {
			text-align: center;
			color: #94a3b8;
			font-size: 0.85rem;
			padding: 16px 0;
		}

		.dir-emp-more-btn {
			align-self: flex-start;
			margin-top: auto;
			font-size: 0.8rem;
			color: #2563eb;
			font-weight: 600;
		}

		.dir-emp-summary-card {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.dir-emp-summary-meta h3 {
			margin: 0;
			font-size: 1.25rem;
			font-weight: 700;
		}

		.dir-emp-stat-row {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
		}

		.dir-emp-stat-chip {
			flex: 1;
			min-width: 130px;
			background: #f8fafc;
			border-radius: 16px;
			padding: 12px 14px;
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		.dir-emp-stat-chip span {
			font-size: 0.7rem;
			text-transform: uppercase;
			letter-spacing: 0.25em;
			color: #94a3b8;
		}

		.dir-emp-stat-chip strong {
			font-size: 1.1rem;
			color: #0f172a;
		}

		.dir-emp-section {
			background: #fff;
			border-radius: 24px;
			padding: 24px;
			border: 1px solid rgba(148, 163, 184, 0.2);
			box-shadow: 0 16px 40px rgba(15, 23, 42, 0.07);
		}

		.dir-emp-section-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
			margin-bottom: 16px;
		}

		.dir-emp-count {
			padding: 6px 12px;
			border-radius: 999px;
			background: #f1f5f9;
			font-size: 0.8rem;
			font-weight: 600;
			color: #0f172a;
		}

		.dir-emp-task-grid {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.dir-emp-task-card {
			border: 1px solid rgba(148, 163, 184, 0.3);
			border-radius: 16px;
			padding: 14px;
			background: #f8fafc;
		}

		.dir-emp-task-head {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
		}

		.dir-emp-priority {
			padding: 4px 10px;
			border-radius: 999px;
			font-size: 0.75rem;
			font-weight: 600;
		}

		.dir-emp-task-desc {
			font-size: 0.85rem;
			color: #475569;
			margin: 8px 0;
		}

		.dir-emp-task-meta {
			display: flex;
			gap: 12px;
			font-size: 0.75rem;
			color: #475569;
			flex-wrap: wrap;
		}

		/* Tasks view theme */
		.dir-task-hero {
			background: linear-gradient(120deg, #0e7490, #2563eb, #7c3aed);
			border-radius: 32px;
			padding: 30px;
			color: #fff;
			position: relative;
			margin-bottom: 32px;
			box-shadow: 0 30px 70px rgba(14, 116, 144, 0.4);
			overflow: hidden;
		}

		.dir-task-hero::after {
			content: '';
			position: absolute;
			inset: 0;
			background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.25), transparent 55%);
			pointer-events: none;
		}

		.dir-task-hero-content {
			position: relative;
			z-index: 1;
			display: flex;
			flex-direction: column;
			gap: 24px;
		}

		.dir-task-hero-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 18px;
		}

		.dir-task-metric {
			background: rgba(255, 255, 255, 0.12);
			border-radius: 22px;
			padding: 18px;
			border: 1px solid rgba(255, 255, 255, 0.2);
			backdrop-filter: blur(5px);
		}

		.dir-task-metric-label {
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 0.35em;
			color: rgba(255, 255, 255, 0.75);
			display: block;
			margin-bottom: 8px;
		}

		.dir-task-metric-value {
			font-size: 2rem;
			font-weight: 800;
		}

		.dir-task-filters {
			display: flex;
			flex-direction: column;
			gap: 18px;
		}

		.dir-task-filters-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			flex-wrap: wrap;
			gap: 12px;
		}

		.dir-task-filters-title {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.dir-task-filters-title-icon {
			width: 40px;
			height: 40px;
			border-radius: 999px;
			background: linear-gradient(135deg, #eef2ff, #e0f2fe);
			display: flex;
			align-items: center;
			justify-content: center;
			color: #2563eb;
		}

		.dir-task-filters-subtitle {
			font-size: 0.8rem;
			color: #64748b;
		}

		.dir-task-quick-row {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-task-filter-chips {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin-top: 4px;
		}

		.dir-task-filter-chip {
			padding: 6px 10px;
			border-radius: 999px;
			font-size: 0.75rem;
			background: #f1f5f9;
			color: #475569;
			display: inline-flex;
			align-items: center;
			gap: 6px;
		}

		.dir-task-filter-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
			gap: 14px;
		}

		.dir-task-field-label {
			font-size: 0.7rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.22em;
			color: #94a3b8;
			margin-bottom: 6px;
		}

		.dir-task-select,
		.dir-task-search {
			width: 100%;
			border-radius: 999px;
			border: 1px solid rgba(148, 163, 184, 0.6);
			padding: 10px 14px;
			background: #f8fafc;
			font-size: 0.85rem;
			font-weight: 500;
			color: #0f172a;
		}

		.dir-task-search-wrap {
			position: relative;
		}

		.dir-task-search-wrap input {
			padding-left: 40px;
		}

		.dir-task-search-wrap i {
			position: absolute;
			left: 14px;
			top: 50%;
			transform: translateY(-50%);
			color: #94a3b8;
			font-size: 0.85rem;
		}

		.dir-task-results-card {
			background: #fff;
			border-radius: 30px;
			box-shadow: 0 25px 60px rgba(15, 23, 42, 0.08);
			border: 1px solid rgba(148, 163, 184, 0.25);
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		.dir-task-results-head {
			padding: 18px 22px;
			background: linear-gradient(120deg, #eef2ff, #fdf2f8);
			border-bottom: 1px solid #e2e8f0;
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.dir-task-summary-line {
			display: flex;
			align-items: center;
			justify-content: space-between;
			flex-wrap: wrap;
			gap: 8px;
		}

		.dir-task-summary-line h3 {
			margin: 0;
		}

		.dir-task-summary-line .dir-task-visibility {
			font-size: 0.7rem;
			font-weight: 600;
			color: #0f172a;
			background: #e2e8f0;
			border-radius: 999px;
			padding: 4px 10px;
		}

		.dir-task-progress {
			display: flex;
			height: 6px;
			border-radius: 999px;
			overflow: hidden;
			background: rgba(255, 255, 255, 0.6);
		}

		.dir-task-progress span {
			display: block;
			height: 100%;
		}

		.dir-task-progress .completed {
			background: linear-gradient(90deg, #34d399, #059669);
		}

		.dir-task-progress .inflight {
			background: linear-gradient(90deg, #fbbf24, #f97316);
		}

		.dir-task-progress .overdue {
			background: linear-gradient(90deg, #fb7185, #ef4444);
		}

		.dir-task-metrics {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
		}

		.dir-task-metric {
			flex: 1 1 140px;
			min-width: 140px;
			border-radius: 20px;
			padding: 16px;
			display: flex;
			align-items: center;
			gap: 12px;
			background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98));
			border: 1px solid rgba(15, 23, 42, 0.08);
			box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
			color: #0f172a;
			transition: all 0.3s ease;
		}

		.dir-task-metric:hover {
			transform: translateY(-4px);
			box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
		}

		.dir-task-metric .dir-task-metric-icon {
			width: 48px;
			height: 48px;
			border-radius: 14px;
			background: rgba(255, 255, 255, 0.28);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.2rem;
			color: #fff;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
		}

		.dir-task-metric .dir-task-metric-label {
			font-size: 0.7rem;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			color: #64748b;
			font-weight: 600;
		}

		.dir-task-metric .dir-task-metric-value {
			font-size: 1.8rem;
			font-weight: 800;
			color: #0f172a;
			margin: 0;
			line-height: 1.1;
		}

		/* Metric Colors applied to Icon instead of Card */
		.dir-task-metric.metric-done .dir-task-metric-icon {
			background: linear-gradient(135deg, #10b981, #059669);
		}

		.dir-task-metric.metric-inflight .dir-task-metric-icon {
			background: linear-gradient(135deg, #f59e0b, #d97706);
		}

		.dir-task-metric.metric-overdue .dir-task-metric-icon {
			background: linear-gradient(135deg, #ef4444, #dc2626);
		}

		/* Remove background from card */
		.dir-task-metric.metric-done,
		.dir-task-metric.metric-inflight,
		.dir-task-metric.metric-overdue {
			background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98));
		}

		.dir-task-results-body {
			display: flex;
			flex-direction: column;
		}

		.dir-task-row {
			padding: 24px;
			border-bottom: 1px solid #f1f5f9;
			transition: background 0.2s ease, border-color 0.2s ease;
		}

		.dir-task-row:hover {
			background: linear-gradient(120deg, rgba(99, 102, 241, 0.06), rgba(244, 114, 182, 0.06));
			border-left: 4px solid #6366f1;
			padding-left: 20px;
		}

		.dir-task-assignee-chip {
			padding: 10px 14px;
			border-radius: 16px;
			background: rgba(99, 102, 241, 0.08);
			border: 1px solid rgba(99, 102, 241, 0.2);
			font-size: 0.85rem;
			font-weight: 600;
		}

		.dir-task-empty-state {
			padding: 80px 24px;
			text-align: center;
			color: #94a3b8;
		}

		.dir-task-card {
			border-radius: 24px;
			border: 1px solid rgba(148, 163, 184, 0.2);
			background: #fff;
			padding: 20px;
			box-shadow: 0 16px 40px rgba(15, 23, 42, 0.07);
			display: flex;
			flex-direction: column;
			gap: 16px;
		}

		.dir-task-card-head {
			display: flex;
			align-items: flex-start;
			justify-content: space-between;
			gap: 12px;
		}

		.dir-task-card-title {
			font-size: 1.1rem;
			font-weight: 700;
			margin-bottom: 6px;
			color: #0f172a;
		}

		.dir-task-card-desc {
			font-size: 0.9rem;
			color: #475569;
		}

		.dir-task-card-tags {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}

		.dir-task-card-meta {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
			gap: 10px;
		}

		.dir-task-card-meta span {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 10px 12px;
			border-radius: 16px;
			background: #f8fafc;
			font-size: 0.85rem;
			color: #475569;
		}

		.dir-task-assignees {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-task-assignee-chip {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 8px 12px;
			border-radius: 16px;
			background: rgba(99, 102, 241, 0.09);
			border: 1px solid rgba(99, 102, 241, 0.2);
			font-size: 0.85rem;
		}

		.dir-task-assignee-avatar {
			width: 28px;
			height: 28px;
			border-radius: 999px;
			background: #6366f1;
			color: #fff;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-size: 0.75rem;
			font-weight: 700;
		}

		.dir-task-pagination {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-top: 18px;
			padding-top: 18px;
			border-top: 1px solid #e2e8f0;
		}

		.dir-task-pagination button {
			border: none;
			border-radius: 14px;
			padding: 10px 18px;
			font-weight: 600;
			background: #0ea5e9;
			color: #fff;
			box-shadow: 0 10px 20px rgba(14, 165, 233, 0.25);
			transition: opacity 0.2s ease;
		}

		.dir-task-pagination button:disabled {
			background: #cbd5f5;
			color: #94a3b8;
			box-shadow: none;
			cursor: not-allowed;
		}

		/* Task Details Modal - Card Style */
		.task-details-card {
			transition: all 0.3s ease;
			border: 2px solid transparent;
			background: white;
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 16px;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
			text-align: right;
			direction: rtl;
		}

		.task-details-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
			border-color: #3B82F6;
		}

		.task-info-badge {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 4px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
			margin-left: 8px;
			margin-bottom: 8px;
			float: right;
		}

		.task-priority-badge {
			background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
			color: white;
			padding: 4px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
			margin-left: 8px;
			margin-bottom: 8px;
			float: right;
		}

		.task-type-badge {
			background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			color: white;
			padding: 4px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
			margin-left: 8px;
			margin-bottom: 8px;
			float: right;
		}

		.task-meta-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 16px;
			margin: 20px 0;
			direction: rtl;
			text-align: right;
		}

		.task-meta-item {
			background: #f8fafc;
			border: 1px solid #e2e8f0;
			border-radius: 12px;
			padding: 16px;
			transition: all 0.2s ease;
			text-align: right;
			direction: rtl;
		}

		.task-meta-item:hover {
			background: #f1f5f9;
			border-color: #cbd5e1;
			transform: translateY(-1px);
		}

		.task-meta-label {
			font-size: 11px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			color: #64748b;
			font-weight: 600;
			margin-bottom: 4px;
			text-align: right;
		}

		.task-meta-value {
			font-size: 14px;
			font-weight: 600;
			color: #1e293b;
			text-align: right;
		}

		.task-assignee-card {
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 12px;
			padding: 16px;
			margin-bottom: 12px;
			transition: all 0.2s ease;
			direction: rtl;
			text-align: right;
		}

		.task-assignee-card:hover {
			background: #f8fafc;
			border-color: #3B82F6;
			transform: translateY(-1px);
		}

		.task-description-card {
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 16px;
			direction: rtl;
			text-align: right;
		}

		.task-description-card h4 {
			font-size: 16px;
			font-weight: 700;
			color: #1e293b;
			margin: 0 0 12px 0;
			text-align: right;
		}

		.task-description-card p {
			color: #475569;
			line-height: 1.6;
			margin: 0;
			text-align: right;
		}

		/* RTL Badge Container */
		.rtl-badge-container {
			direction: rtl;
			text-align: right;
			clear: both;
			display: block;
			overflow: hidden;
		}

		@media (max-width: 768px) {

			.dir-emp-hero,
			.dir-task-hero {
				padding: 24px;
			}

			.dir-emp-panel,
			.dir-task-filters {
				padding: 20px;
			}
		}

		.dir-resp-pill {
			padding: 9px 18px;
			border-radius: 999px;
			border: 1px solid transparent;
			background: rgba(255, 255, 255, 0.85);
			color: #475569;
			font-weight: 600;
			font-size: 0.85rem;
			transition: all 0.2s ease;
		}

		.dir-resp-pill.active {
			background: linear-gradient(120deg, #2563eb, #7c3aed);
			color: #fff;
			box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
		}

		.dir-resp-filter-bar {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
			gap: 24px;
			padding: 18px;
			background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(237, 242, 255, 0.95));
			border: 1px solid rgba(148, 163, 184, 0.35);
			border-radius: 24px;
			box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
			margin-bottom: 22px;
		}

		.dir-resp-timefield {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.dir-resp-time-custom {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
			gap: 8px;
		}

		.dir-resp-field {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}

		.dir-resp-field label {
			font-size: 0.7rem;
			letter-spacing: 0.3em;
			text-transform: uppercase;
			color: #94a3b8;
			font-weight: 600;
		}

		.dir-resp-field select,
		.dir-resp-field input {
			border-radius: 14px;
			border: 1px solid rgba(15, 23, 42, 0.12);
			padding: 10px 14px;
			background: #fff;
			font-weight: 500;
			color: #0f172a;
			box-shadow: 0 1px 0 rgba(15, 23, 42, 0.02);
		}

		.dir-resp-search-input {
			position: relative;
		}

		.dir-resp-search-input input {
			width: 100%;
			padding-left: 38px;
		}

		.dir-resp-search-input i {
			position: absolute;
			left: 12px;
			top: 50%;
			transform: translateY(-50%);
			color: #94a3b8;
			font-size: 0.9rem;
		}

		.dir-resp-actions {
			align-items: flex-end;
		}

		.dir-resp-reset {
			padding: 10px 16px;
			border-radius: 12px;
			font-weight: 600;
		}

		.dir-resp-stack {
			display: flex;
			flex-direction: column;
			gap: 18px;
		}

		.dir-resp-summary {
			display: flex;
			flex-direction: column;
			gap: 24px;
		}

		.dir-resp-summary-main {
			display: flex;
			flex-wrap: wrap;
			gap: 20px;
			align-items: center;
			justify-content: space-between;
		}

		.dir-resp-summary-info {
			display: flex;
			align-items: center;
			gap: 16px;
			flex: 1;
			min-width: 240px;
		}

		.dir-resp-summary-header {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			justify-content: space-between;
			gap: 18px;
		}

		.dir-resp-summary-header p.dir-resp-label {
			margin-bottom: 6px;
		}

		.dir-resp-summary-info h3 {
			font-size: 1.6rem;
			font-weight: 700;
			color: #0f172a;
			margin-bottom: 4px;
		}

		.dir-resp-summary-info .dir-resp-contact-line {
			display: flex;
			align-items: center;
			gap: 10px;
			color: #475569;
			font-size: 0.95rem;
		}

		.dir-resp-avatar {
			width: 64px;
			height: 64px;
			border-radius: 18px;
			background: linear-gradient(135deg, #2563eb, #7c3aed);
			color: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.4rem;
			font-weight: 700;
		}

		.dir-resp-avatar-lg {
			width: 76px;
			height: 76px;
			border-radius: 22px;
			background: linear-gradient(135deg, #2563eb, #7c3aed);
			color: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 2rem;
			font-weight: 700;
			box-shadow: 0 18px 35px rgba(37, 99, 235, 0.25);
		}

		.dir-resp-summary-metrics {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
			min-width: 220px;
		}

		.dir-resp-summary-metric {
			min-width: 90px;
			padding: 10px 14px;
			border-radius: 16px;
			text-align: center;
			border: 1px solid rgba(15, 23, 42, 0.08);
			background: rgba(248, 250, 252, 0.7);
		}

		.dir-resp-summary-metric strong {
			display: block;
			font-size: 2rem;
			font-weight: 800;
			color: #0f172a;
			line-height: 1.1;
		}

		.dir-resp-summary-metric.alert {
			background: rgba(248, 113, 113, 0.12);
			border-color: rgba(248, 113, 113, 0.4);
		}

		.dir-resp-summary-metric.alert strong {
			color: #dc2626;
		}

		.dir-resp-summary-detail {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 14px;
			margin-top: 18px;
		}

		.dir-resp-meta-card {
			border-radius: 18px;
			border: 1px solid rgba(148, 163, 184, 0.35);
			padding: 14px 16px;
			background: rgba(255, 255, 255, 0.65);
			box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4);
		}

		.dir-resp-meta-card p {
			font-size: 0.7rem;
			text-transform: uppercase;
			letter-spacing: 0.3em;
			color: #94a3b8;
			font-weight: 600;
			margin-bottom: 6px;
		}

		.dir-resp-meta-card span {
			display: block;
			font-size: 0.95rem;
			font-weight: 600;
			color: #0f172a;
			word-break: break-word;
		}

		.dir-resp-meta-card span.subtle {
			color: #475569;
			font-weight: 500;
		}

		.dir-resp-layout {
			display: flex;
			flex-direction: column;
			gap: 28px;
			align-items: stretch;
			width: 100%;
		}

		.dir-resp-pane {
			height: 100%;
		}

		.dir-resp-pane-main {
			display: flex;
			flex-direction: column;
		}

		.dir-resp-pane-main .dir-resp-section-block:last-child {
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		.dir-resp-pane-main .dir-resp-stack {
			flex: 1;
		}

		.dir-resp-control-grid {
			display: grid;
			grid-template-columns: minmax(0, 1fr) auto;
			gap: 18px;
			align-items: center;
		}

		.dir-resp-filter-context {
			display: flex;
			flex-wrap: wrap;
			gap: 18px;
			justify-content: space-between;
			padding: 18px 22px;
			background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(226, 232, 240, 0.95));
			border: 1px solid rgba(148, 163, 184, 0.4);
			border-radius: 22px;
			box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
			margin-bottom: 16px;
		}

		.dir-resp-filter-context .dir-resp-label {
			letter-spacing: 0.3em;
			color: #475569;
		}

		.dir-resp-filter-name {
			font-size: 1.6rem;
			font-weight: 700;
			color: #0f172a;
			margin-bottom: 4px;
		}

		.dir-resp-filter-desc {
			font-size: 0.9rem;
			color: #475569;
			max-width: 480px;
		}

		.dir-resp-current-pill {
			display: flex;
			align-items: center;
			gap: 14px;
			padding: 12px 18px;
			border-radius: 999px;
			background: rgba(15, 23, 42, 0.06);
			border: 1px solid rgba(148, 163, 184, 0.4);
		}

		.dir-resp-current-avatar {
			width: 42px;
			height: 42px;
			border-radius: 50%;
			background: linear-gradient(135deg, #2563eb, #7c3aed);
			color: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
		}

		.dir-resp-current-meta {
			font-size: 0.85rem;
			color: #0f172a;
			font-weight: 600;
			line-height: 1.3;
		}

		.dir-resp-current-meta.subtle {
			color: #64748b;
			font-weight: 500;
		}

		.dir-resp-filter-fields {
			display: flex;
			flex-direction: column;
			gap: 8px;
			align-items: flex-start;
		}

		.dir-resp-filter-fields .dir-resp-select {
			min-width: 260px;
			width: 100%;
		}

		.dir-resp-filter-prompt {
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: #94a3b8;
			font-weight: 600;
		}

		.dir-resp-focus-panel {
			background: #fff;
			border-radius: 26px;
			border: 1px solid rgba(148, 163, 184, 0.25);
			box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
			display: flex;
			flex-direction: column;
			gap: 24px;
			padding: 24px;
		}

		.dir-resp-focus-header {
			display: flex;
			flex-wrap: wrap;
			gap: 18px;
			justify-content: space-between;
			align-items: center;
		}

		.dir-resp-focus-title {
			font-size: 1.4rem;
			font-weight: 700;
			color: #0f172a;
			margin-bottom: 6px;
		}

		.dir-resp-focus-sub {
			color: #475569;
			max-width: 520px;
		}

		.dir-resp-chip-row {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-resp-chip {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 8px 14px;
			border-radius: 999px;
			background: rgba(99, 102, 241, 0.1);
			color: #3730a3;
			font-size: 0.78rem;
			font-weight: 600;
		}

		.dir-resp-focus-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
			gap: 18px;
		}

		.dir-resp-focus-field {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.dir-resp-focus-field small {
			font-size: 0.75rem;
			color: #94a3b8;
		}

		.dir-resp-focus-actions {
			justify-content: flex-end;
		}

		.dir-resp-actions-stack {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-resp-toggle-deck {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
			gap: 18px;
			align-items: stretch;
		}

		.dir-resp-toggle-card {
			background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(226, 232, 255, 0.95));
			border-radius: 24px;
			padding: 18px 22px;
			border: 1px solid rgba(148, 163, 184, 0.35);
			box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.dir-resp-toggle-desc {
			font-size: 0.85rem;
			color: #475569;
		}

		@media (max-width: 1100px) {
			.dir-resp-layout {
				gap: 20px;
			}

			.dir-resp-focus-panel {
				padding: 20px;
			}
		}

		@media (max-width: 768px) {
			.dir-resp-control-grid {
				grid-template-columns: 1fr;
			}

			.dir-resp-quick-actions {
				justify-content: flex-start;
			}

			.dir-resp-chip-row {
				width: 100%;
				justify-content: flex-start;
			}
		}

		.dir-resp-label {
			font-size: 0.7rem;
			text-transform: uppercase;
			letter-spacing: 0.32em;
			color: #94a3b8;
			font-weight: 600;
		}

		.dir-resp-hint {
			flex: 1;
			text-align: right;
			color: #94a3b8;
			font-size: 0.78rem;
		}

		.dir-resp-table caption {
			text-align: left;
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: #a0aec0;
			padding: 0 20px 8px;
		}

		.dir-resp-table-callout {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			justify-content: space-between;
			gap: 16px;
			padding: 14px 20px;
			background: rgba(248, 250, 252, 0.9);
			border-bottom: 1px solid #e2e8f0;
		}

		.dir-resp-table-callout h4 {
			font-size: 1rem;
			font-weight: 700;
			color: #0f172a;
		}

		.dir-resp-table-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
		}

		.dir-resp-task-pill {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 4px 10px;
			border-radius: 999px;
			font-size: 0.7rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.1em;
		}

		.dir-resp-task-pill.operation {
			background: rgba(59, 130, 246, 0.12);
			color: #1d4ed8;
		}

		.dir-resp-task-pill.instruction {
			background: rgba(168, 85, 247, 0.15);
			color: #6d28d9;
		}

		.dir-resp-instruction-row {
			background: rgba(237, 233, 254, 0.45);
		}

		.dir-resp-name-cell {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		.dir-resp-title-line {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			gap: 8px;
		}

		.dir-table-primary {
			font-weight: 600;
			color: #0f172a;
		}

		.dir-table-subtle {
			font-size: 0.78rem;
			color: #94a3b8;
		}

		.dir-action-stack {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			justify-content: flex-end;
		}

		.dir-table-action {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 9px 16px;
			border-radius: 12px;
			font-size: 0.82rem;
			font-weight: 600;
			border: 1.5px solid rgba(148, 163, 184, 0.25);
			background: #ffffff;
			color: #475569;
			transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
			cursor: pointer;
			text-decoration: none;
		}

		.dir-table-action:hover {
			border-color: #3B82F6;
			background: rgba(59, 130, 246, 0.05);
			color: #2563eb;
			transform: translateY(-2px);
			box-shadow: 0 8px 16px rgba(59, 130, 246, 0.15);
		}

		.dir-table-action.primary {
			background: linear-gradient(135deg, #3B82F6 0%, #6366F1 100%);
			color: #ffffff;
			border-color: transparent;
			box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
		}

		.dir-table-action.primary:hover {
			background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
			color: #ffffff;
			transform: translateY(-3px);
			box-shadow: 0 12px 28px rgba(59, 130, 246, 0.4);
		}

		/* Employee modal */
		.dir-emp-summary-card {
			background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(124, 58, 237, 0.08));
			border: 1px solid rgba(148, 163, 184, 0.35);
			border-radius: 28px;
			padding: 24px;
			margin-bottom: 18px;
			box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
		}

		.dir-emp-summary-main {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			justify-content: space-between;
			gap: 18px;
			margin-bottom: 18px;
		}

		.dir-emp-avatar-lg {
			width: 72px;
			height: 72px;
			border-radius: 22px;
			background: linear-gradient(135deg, #2563eb, #7c3aed);
			color: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.6rem;
			font-weight: 700;
			box-shadow: 0 12px 24px rgba(37, 99, 235, 0.35);
		}

		.dir-emp-avatar-sm {
			width: 44px;
			height: 44px;
			border-radius: 14px;
			background: linear-gradient(135deg, #2563eb, #7c3aed);
			color: #fff;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
		}

		.dir-emp-summary-meta {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		.dir-emp-contact {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
		}

		.dir-emp-contact-chip {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 8px 12px;
			border-radius: 12px;
			background: rgba(255, 255, 255, 0.8);
			border: 1px solid rgba(148, 163, 184, 0.4);
			font-size: 0.85rem;
			color: #475569;
		}

		.dir-emp-stat-row {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
			margin-top: 16px;
		}

		.dir-emp-stat-chip {
			flex: 1;
			min-width: 120px;
			padding: 12px 16px;
			border-radius: 16px;
			background: #fff;
			border: 1px solid rgba(15, 23, 42, 0.08);
			text-align: center;
		}

		.dir-emp-stat-chip span {
			display: block;
			font-size: 0.65rem;
			text-transform: uppercase;
			letter-spacing: 0.25em;
			color: #94a3b8;
			margin-bottom: 6px;
		}

		.dir-emp-stat-chip strong {
			font-size: 1.4rem;
			color: #0f172a;
		}

		.dir-emp-section {
			background: #fff;
			border-radius: 24px;
			padding: 20px;
			border: 1px solid rgba(15, 23, 42, 0.06);
			box-shadow: 0 15px 30px rgba(15, 23, 42, 0.08);
		}

		.dir-emp-section.green {
			border-left: 4px solid #22c55e;
		}

		.dir-emp-section.yellow {
			border-left: 4px solid #facc15;
		}

		.dir-emp-section.red {
			border-left: 4px solid #ef4444;
		}

		.dir-emp-section+.dir-emp-section {
			margin-top: 16px;
		}

		.dir-emp-section-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 16px;
		}

		.dir-emp-section-header h4 {
			font-size: 1rem;
			font-weight: 700;
			color: #0f172a;
		}

		.dir-emp-section-header small {
			display: block;
			color: #94a3b8;
			font-size: 0.75rem;
		}

		.dir-emp-count {
			padding: 6px 12px;
			border-radius: 999px;
			background: rgba(15, 23, 42, 0.06);
			font-weight: 600;
			font-size: 0.8rem;
		}

		.dir-emp-task-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
			gap: 14px;
		}

		.dir-emp-task-card {
			padding: 14px;
			border-radius: 18px;
			border: 1px solid rgba(15, 23, 42, 0.08);
			background: #fff;
			box-shadow: 0 8px 18px rgba(15, 23, 42, 0.05);
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.dir-emp-task-head {
			display: flex;
			align-items: flex-start;
			justify-content: space-between;
			gap: 8px;
		}

		.dir-emp-priority {
			padding: 4px 10px;
			border-radius: 999px;
			font-size: 0.7rem;
			font-weight: 600;
		}

		.dir-emp-task-desc {
			font-size: 0.85rem;
			color: #475569;
			min-height: 48px;
		}

		.dir-emp-task-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			font-size: 0.78rem;
			color: #94a3b8;
		}

		.dir-emp-empty {
			text-align: center;
			padding: 48px 16px;
			color: #94a3b8;
		}

		.dir-resp-table-wrapper {
			width: 100%;
			overflow-x: auto;
		}

		.dir-resp-table {
			width: 100%;
			min-width: 680px;
			border-collapse: collapse;
			background: #fff;
		}

		.dir-resp-table thead {
			background: #f8fafc;
			box-shadow: inset 0 -1px 0 #e2e8f0;
		}

		.dir-resp-table th,
		.dir-resp-table td {
			padding: 16px 20px;
			text-align: left;
			font-size: 0.9rem;
			border-bottom: 1px solid #e2e8f0;
		}

		.dir-resp-table th {
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 0.12em;
			color: #64748b;
		}

		.dir-resp-table tbody tr:hover {
			background: #f1f5f9;
		}

		.dir-resp-table tbody tr:nth-child(even) {
			background: #fcfdff;
		}

		.dir-modal-card {
			background: #fff;
			border-radius: 28px;
			box-shadow: 0 35px 60px rgba(15, 23, 42, 0.18);
			border: 1px solid rgba(15, 23, 42, 0.08);
			overflow: hidden;
		}

		.dir-modal-header {
			background: linear-gradient(120deg, #2563eb, #7c3aed);
			color: #fff;
			padding: 28px;
		}

		.dir-modal-body {
			padding: 24px;
			max-height: 60vh;
			overflow-y: auto;
		}

		.dir-chip {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 8px 14px;
			border-radius: 999px;
			background: rgba(255, 255, 255, 0.2);
			font-size: 0.82rem;
			font-weight: 600;
		}

		.dir-modal-action {
			border-radius: 14px;
			padding: 12px 18px;
			font-weight: 600;
		}

		.dir-modal-action.primary {
			background: linear-gradient(120deg, #2563eb, #7c3aed);
			color: #fff;
			box-shadow: 0 12px 24px rgba(37, 99, 235, 0.35);
		}

		.dir-modal-action.secondary {
			border: 1px solid rgba(15, 23, 42, 0.12);
			background: #fff;
			color: #0f172a;
		}

		.modal-shell {
			background: #ffffff;
			border-radius: 24px;
			box-shadow: 0 25px 50px rgba(15, 23, 42, 0.16);
			border: 1px solid rgba(148, 163, 184, 0.25);
			overflow: hidden;
			display: flex;
			flex-direction: column;
			max-height: 90vh;
		}

		.modal-header-gradient {
			background: linear-gradient(135deg, #2563eb, #7c3aed);
			color: #fff;
		}

		.dir-modal-hero {
			display: flex;
			flex-direction: column;
			gap: 16px;
		}

		.dir-modal-hero-meta {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
			gap: 14px;
		}

		.dir-modal-metric {
			border-radius: 18px;
			padding: 16px;
			background: rgba(255, 255, 255, 0.12);
			border: 1px solid rgba(255, 255, 255, 0.18);
			backdrop-filter: blur(4px);
		}

		.dir-modal-metric--accent {
			background: rgba(15, 23, 42, 0.25);
			border-color: rgba(255, 255, 255, 0.25);
		}

		.dir-modal-metric p {
			margin: 0;
			font-size: 0.8rem;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: rgba(255, 255, 255, 0.7);
		}

		.dir-modal-metric-number {
			display: block;
			font-size: 1.8rem;
			font-weight: 800;
			margin: 6px 0;
			color: #fff;
		}

		.dir-modal-metric-foot {
			display: flex;
			align-items: center;
			justify-content: space-between;
			font-size: 0.85rem;
			color: rgba(255, 255, 255, 0.85);
		}

		.dir-modal-pagination {
			display: inline-flex;
			align-items: center;
			gap: 10px;
			margin-top: 8px;
		}

		.dir-modal-pill {
			padding: 6px 14px;
			border-radius: 999px;
			border: 1px solid rgba(255, 255, 255, 0.3);
			color: #fff;
			background: transparent;
			font-size: 0.75rem;
		}

		.dir-modal-info {
			margin-bottom: 1.25rem;
			padding: 14px 18px;
			border-radius: 14px;
			background: rgba(37, 99, 235, 0.08);
			border: 1px dashed rgba(37, 99, 235, 0.35);
			color: #1e293b;
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.dir-modal-info i {
			color: #2563eb;
		}

		.form-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
			gap: 24px;
		}

		.input-field {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.input-field label {
			font-size: 0.875rem;
			font-weight: 600;
			color: #334155;
			letter-spacing: 0.01em;
		}

		.input-field input,
		.input-field select,
		.input-field textarea {
			border-radius: 12px;
			border: 1.5px solid #e2e8f0;
			padding: 14px 16px;
			background: #ffffff;
			font-size: 0.9375rem;
			color: #1e293b;
			transition: all 0.2s ease;
		}

		.input-field input:focus,
		.input-field select:focus,
		.input-field textarea:focus {
			outline: none;
			border-color: #6366f1;
			box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
			background: #ffffff;
		}

		.input-field textarea {
			resize: vertical;
			min-height: 120px;
		}

		.modal-actions {
			display: flex;
			justify-content: flex-end;
			align-items: center;
			gap: 16px;
			flex-wrap: wrap;
		}

		.btn-secondary {
			border-radius: 12px;
			padding: 13px 24px;
			border: 1.5px solid #e2e8f0;
			background: #ffffff;
			font-weight: 600;
			font-size: 0.9375rem;
			color: #475569;
			transition: all 0.2s ease;
			cursor: pointer;
		}

		.btn-secondary:hover {
			background: #f8fafc;
			border-color: #cbd5e1;
			transform: translateY(-1px);
		}

		.btn-primary {
			border-radius: 12px;
			padding: 13px 28px;
			background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
			color: #ffffff;
			font-weight: 600;
			font-size: 0.9375rem;
			box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
			transition: all 0.2s ease;
			cursor: pointer;
			border: none;
		}

		.btn-primary:hover {
			box-shadow: 0 6px 24px rgba(99, 102, 241, 0.4);
			transform: translateY(-2px);
		}

		.assignee-picker-grid {
			display: flex;
			flex-direction: column;
			gap: 16px;
		}

		.assignee-picker-card {
			border-radius: 12px;
			border: 2px solid transparent;
			background: #ffffff;
			margin-bottom: 12px;
			overflow: hidden;
			box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
			transition: all 0.3s ease;
		}

		.assignee-picker-card-head {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			justify-content: space-between;
			padding: 1rem 1.25rem;
			background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
			border-bottom: 1px solid #e2e8f0;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.assignee-picker-card-title {
			display: flex;
			align-items: center;
			gap: 10px;
			font-weight: 600;
			color: #1e293b;
			font-size: 0.95rem;
		}

		.assignee-picker-card-title i {
			color: #3B82F6;
			transition: transform 0.3s ease;
		}

		.assignee-picker-card-title input {
			width: 20px;
			height: 20px;
			margin-right: 6px;
		}

		.assignee-picker-pill {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 12px;
			border-radius: 999px;
			font-size: 0.8rem;
			font-weight: 600;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: #ffffff;
			box-shadow: 0 8px 18px rgba(79, 70, 229, 0.2);
		}

		.assignee-picker-toggle {
			margin-left: auto;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			font-size: 0.85rem;
			color: #475569;
			font-weight: 600;
		}

		.assignee-picker-toggle input {
			width: 20px;
			height: 20px;
		}

		.assignee-picker-resp {
			padding: 14px 20px;
			background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%);
			border-bottom: 1px solid #e2e8f0;
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: flex-end;
			transition: all 0.2s ease;
			direction: rtl;
		}

		.assignee-picker-resp:hover {
			background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%);
		}

		.assignee-picker-resp-main {
			display: inline-flex;
			align-items: center;
			gap: 12px;
			font-size: 0.9rem;
			font-weight: 500;
			color: #1e293b;
			cursor: pointer;
			user-select: none;
			-webkit-user-select: none;
			padding: 8px 14px;
			border-radius: 10px;
			background: #ffffff;
			border: 2px solid transparent;
			box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
			transition: all 0.2s ease;
		}

		.assignee-picker-resp-main:hover {
			border-color: #3B82F6;
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12);
		}

		.assignee-picker-resp-main .resp-icon {
			color: #3B82F6;
			font-size: 0.9rem;
		}

		.assignee-picker-resp label {
			display: inline-flex;
			align-items: center;
			gap: 10px;
			font-size: 0.9rem;
			font-weight: 600;
			color: #0f172a;
			cursor: pointer;
			user-select: none;
			-webkit-user-select: none;
		}

		.assignee-picker-resp-main input[type="checkbox"] {
			width: 20px;
			height: 20px;
			min-width: 20px;
			min-height: 20px;
			border-radius: 6px;
			border: 2px solid #cbd5e1;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			accent-color: #3b82f6;
			flex-shrink: 0;
			-webkit-appearance: auto;
			appearance: auto;
			pointer-events: auto;
			position: relative;
			z-index: 1;
		}

		.assignee-picker-resp-main input[type="checkbox"]:hover {
			border-color: #3b82f6;
			transform: scale(1.1);
		}

		.assignee-picker-resp-main input[type="checkbox"]:checked {
			background-color: #3b82f6;
			border-color: #3b82f6;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
		}

		.assignee-picker-resp-label {
			font-weight: 600;
			color: #475569;
			font-size: 0.8rem;
		}

		.assignee-picker-resp-name {
			color: #1e293b;
			font-weight: 600;
		}

		.assignee-picker-resp label input[type="checkbox"]:checked {
			background-color: #3b82f6;
			border-color: #3b82f6;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
		}

		.assignee-picker-resp .assignee-picker-subtoggle {
			margin-left: auto;
			font-size: 0.8rem;
			color: #2563eb;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			font-weight: 600;
			cursor: pointer;
			user-select: none;
			-webkit-user-select: none;
			transition: all 0.2s ease;
		}

		.assignee-picker-resp .assignee-picker-subtoggle:hover {
			color: #1d4ed8;
		}

		.assignee-picker-resp .assignee-picker-subtoggle input {
			width: 17px;
			height: 17px;
			min-width: 17px;
			min-height: 17px;
			border-radius: 5px;
			border: 2px solid #cbd5e1;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			accent-color: #2563eb;
			flex-shrink: 0;
			-webkit-appearance: auto;
			appearance: auto;
			pointer-events: auto;
			position: relative;
			z-index: 1;
		}

		.assignee-picker-resp .assignee-picker-subtoggle input:hover {
			border-color: #2563eb;
			transform: scale(1.1);
		}

		.assignee-picker-resp .assignee-picker-subtoggle input:checked {
			background-color: #2563eb;
			border-color: #2563eb;
			box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
		}

		.assignee-picker-employees {
			padding: 16px 20px 20px;
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
			gap: 10px;
			background: white;
		}

		.assignee-picker-employee {
			border: 2px solid transparent;
			border-radius: 10px;
			padding: 12px 14px;
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 0.875rem;
			font-weight: 500;
			color: #1e293b;
			background: #ffffff;
			box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			cursor: pointer;
			user-select: none;
			-webkit-user-select: none;
		}

		.assignee-picker-employee input {
			width: 17px;
			height: 17px;
			border-radius: 5px;
			border: 2px solid #cbd5e1;
			cursor: pointer;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			accent-color: #3b82f6;
			flex-shrink: 0;
		}

		.assignee-picker-employee input:hover {
			border-color: #3b82f6;
			transform: scale(1.1);
		}

		.assignee-picker-employee input:checked {
			background-color: #3b82f6;
			border-color: #3b82f6;
			box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
		}

		.assignee-picker-employee:hover {
			border-color: #3B82F6;
			background: #ffffff;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
		}

		.assignee-picker-employee .truncate {
			flex: 1;
			min-width: 0;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.assignee-selected-bar {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			justify-content: space-between;
			gap: 8px;
			font-size: 0.85rem;
			font-weight: 600;
			color: #0f172a;
		}

		.assignee-selected-count {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 14px;
			border-radius: 999px;
			background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
			color: #ecfdf5;
			font-size: 0.78rem;
			font-weight: 600;
			box-shadow: 0 10px 20px rgba(22, 163, 74, 0.25);
		}

		.assignee-selected-chips {
			display: flex;
			flex-wrap: wrap;
			gap: 6px;
			max-height: 120px;
			overflow-y: auto;
		}

		.assignee-selected-empty {
			font-size: 0.8rem;
			color: #94a3b8;
			font-style: italic;
		}

		.assignee-empty-state {
			padding: 32px 16px;
			text-align: center;
			color: #94a3b8;
			font-size: 0.95rem;
		}

		.assignee-empty-state i {
			display: block;
			font-size: 1.4rem;
			margin-bottom: 10px;
			color: #cbd5f5;
		}

		.dir-modal-layout {
			display: grid;
			grid-template-columns: 2fr 1fr;
			gap: 32px;
			align-items: start;
		}

		.dir-modal-layout.instruction-mode {
			grid-template-columns: 1fr !important;
		}

		.dir-modal-layout.instruction-mode .dir-modal-side {
			display: none !important;
		}

		/* RTL Specific: Sidebar stays on the left for Arabic (panel style) */
		body.dir-lang-ar .dir-modal-layout:not(.instruction-mode) {
			grid-template-columns: 2fr 1fr;
		}

		body.dir-lang-ar .dir-modal-layout.instruction-mode {
			grid-template-columns: 1fr !important;
		}


		@media (min-width: 1280px) {
			.dir-modal-layout {
				grid-template-columns: 1fr 380px;
			}

			body.dir-lang-ar .dir-modal-layout {
				grid-template-columns: 380px 1fr;
			}
		}

		@media (max-width: 1024px) {
			.dir-modal-layout {
				grid-template-columns: 1fr;
			}
		}

		.dir-modal-main {
			min-width: 0;
		}

		.dir-modal-side {
			display: flex;
			flex-direction: column;
			gap: 24px;
		}

		.dir-modal-section {
			background: #ffffff;
			border-radius: 16px;
			padding: 1.5rem;
			border: 2px solid transparent;
			box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
			transition: all 0.3s ease;
			position: relative;
		}

		.dir-modal-section:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
			border-color: #3B82F6;
		}

		.dir-modal-section-head {
			display: flex;
			flex-direction: column;
			gap: 6px;
			margin-bottom: 20px;
			padding-bottom: 16px;
			border-bottom: 2px solid #e2e8f0;
			position: relative;
		}

		.dir-modal-section-eyebrow {
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 0.1em;
			color: #3B82F6;
			font-weight: 700;
			margin-bottom: 4px;
		}

		.dir-modal-section-title {
			font-size: 1.125rem;
			font-weight: 700;
			color: #1e293b;
			margin: 0;
			line-height: 1.4;
			max-width: 100%;
			overflow-wrap: break-word;
		}

		.dir-modal-form {
			margin-top: 10px;
		}

		.dir-selected-chips {
			display: flex;
			flex-wrap: wrap;
			gap: 6px;
			margin-top: 16px;
		}

		.dir-selected-chips.hidden {
			display: none;
		}

		.dir-assignee-actions {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
			flex-wrap: wrap;
		}

		.dir-assignee-note {
			margin-top: 18px;
			font-size: 0.85rem;
			color: #64748b;
		}

		body.dir-lang-ar {
			direction: rtl;
			font-family: 'Cairo', 'Outfit', 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
		}

		body.dir-lang-ar #directorTaskModal,
		body.dir-lang-ar #dirAssigneePickerModal {
			text-align: right;
			direction: rtl;
		}

		body.dir-lang-ar .assignee-picker-resp .assignee-picker-subtoggle {
			margin-left: 0;
			margin-right: auto;
		}

		body.dir-lang-ar .assignee-picker-subtoggle {
			margin-left: 0;
			margin-right: 28px;
		}

		body.dir-lang-ar .director-tab {
			flex-direction: row-reverse;
		}

		body.dir-lang-ar .director-tab i {
			margin-left: 0;
			margin-right: 8px;
		}

		body.dir-lang-ar .modal-actions {
			justify-content: flex-start;
			flex-direction: row-reverse;
		}

		body.dir-lang-ar .modal-actions button {
			flex-direction: row-reverse;
		}

		body.dir-lang-ar .input-field label {
			text-align: right;
		}

		body.dir-lang-ar .input-field input,
		body.dir-lang-ar .input-field select,
		body.dir-lang-ar .input-field textarea {
			text-align: right;
		}

		body.dir-lang-ar .dir-modal-info {
			flex-direction: row-reverse;
		}

		body.dir-lang-ar .dir-modal-pagination {
			flex-direction: row-reverse;
		}

		body.dir-lang-ar .dir-modal-metric-foot {
			flex-direction: row-reverse;
		}

		body.dir-lang-ar .rtl-flex {
			flex-direction: row-reverse;
		}

		body.dir-lang-ar #assigneeSearchInput {
			padding-right: 2.75rem;
			padding-left: 1rem;
		}

		body.dir-lang-ar .assignee-search-icon {
			left: auto;
			right: 1rem;
		}

		body.dir-lang-ar .assignee-picker-card-head,
		body.dir-lang-ar .assignee-picker-resp,
		body.dir-lang-ar .assignee-selected-bar {
			flex-direction: row-reverse;
		}

		body.dir-lang-ar .assignee-picker-toggle,
		body.dir-lang-ar .assignee-picker-resp .assignee-picker-subtoggle,
		body.dir-lang-ar .assignee-selected-count {
			margin-left: 0;
			margin-right: auto;
			flex-direction: row-reverse;
		}

		body.dir-lang-ar .assignee-picker-card-title input {
			margin-left: 0;
			margin-right: 6px;
		}

		body.dir-lang-ar .dept-collapse-toggle {
			margin-left: 0;
			margin-right: 8px;
		}

		body.dir-lang-ar .assignee-picker-card.collapsed .dept-collapse-toggle i {
			transform: rotate(90deg);
		}

		body.dir-lang-ar .dir-modal-section-head {
			flex-direction: row-reverse;
			text-align: right;
			direction: rtl;
		}

		body.dir-lang-ar .dir-modal-section-eyebrow,
		body.dir-lang-ar .dir-modal-section-title {
			text-align: right;
			width: 100%;
		}

		body.dir-lang-ar .dir-modal-section {
			direction: rtl;
			text-align: right;
		}

		body.dir-lang-ar .dir-modal-side {
			direction: rtl;
			text-align: right;
		}

		@keyframes director-spin {
			from {
				transform: rotate(0deg);
			}

			to {
				transform: rotate(360deg);
			}
		}

		.animate-spin {
			animation: director-spin 0.8s linear infinite;
		}

		/* Enhanced Assignee Picker Modal Styles */
		.assignee-modal-enhanced {
			animation: modalFadeIn 0.3s ease-out;
		}

		.assignee-search-wrapper {
			position: relative;
			transition: all 0.3s ease;
		}

		.assignee-search-wrapper:focus-within {
			transform: translateY(-1px);
		}

		.assignee-search-wrapper input:focus {
			box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
			border-color: #3b82f6;
		}

		.assignee-picker-card {
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
		}

		.assignee-picker-card::before {
			content: '';
			position: absolute;
			inset: 0;
			border-radius: 18px;
			padding: 2px;
			background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(124, 58, 237, 0.2));
			-webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
			-webkit-mask-composite: xor;
			mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
			mask-composite: exclude;
			opacity: 0;
			transition: opacity 0.3s ease;
		}

		.assignee-picker-card:hover::before {
			opacity: 1;
		}

		.assignee-picker-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 12px 40px rgba(15, 23, 42, 0.12);
		}

		.assignee-picker-card-head {
			position: relative;
			z-index: 1;
		}

		.assignee-picker-employee {
			cursor: pointer;
			position: relative;
			overflow: hidden;
		}

		.assignee-picker-employee::after {
			content: '';
			position: absolute;
			inset: 0;
			background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
			opacity: 0;
			transition: opacity 0.2s ease;
		}

		.assignee-picker-employee:hover::after {
			opacity: 1;
		}

		.assignee-picker-employee input:checked~* {
			font-weight: 600;
		}

		.assignee-selected-chips {
			scrollbar-width: thin;
			scrollbar-color: rgba(148, 163, 184, 0.3) transparent;
		}

		.assignee-selected-chips::-webkit-scrollbar {
			width: 6px;
			height: 6px;
		}

		.assignee-selected-chips::-webkit-scrollbar-track {
			background: transparent;
		}

		.assignee-selected-chips::-webkit-scrollbar-thumb {
			background: rgba(148, 163, 184, 0.3);
			border-radius: 3px;
		}

		.assignee-selected-chips::-webkit-scrollbar-thumb:hover {
			background: rgba(148, 163, 184, 0.5);
		}

		.assignee-chip {
			animation: chipSlideIn 0.2s ease-out;
			transition: all 0.2s ease;
		}

		.assignee-chip:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
		}

		@keyframes chipSlideIn {
			from {
				opacity: 0;
				transform: translateX(-10px);
			}

			to {
				opacity: 1;
				transform: translateX(0);
			}
		}

		.custom-scrollbar {
			scrollbar-width: thin;
			scrollbar-color: rgba(148, 163, 184, 0.4) rgba(248, 250, 252, 0.5);
		}

		.custom-scrollbar::-webkit-scrollbar {
			width: 8px;
		}

		.custom-scrollbar::-webkit-scrollbar-track {
			background: rgba(248, 250, 252, 0.5);
			border-radius: 4px;
		}

		.custom-scrollbar::-webkit-scrollbar-thumb {
			background: rgba(148, 163, 184, 0.4);
			border-radius: 4px;
		}

		.custom-scrollbar::-webkit-scrollbar-thumb:hover {
			background: rgba(148, 163, 184, 0.6);
		}

		.assignee-picker-pill {
			animation: pillPulse 2s ease-in-out infinite;
		}

		@keyframes pillPulse {

			0%,
			100% {
				box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4);
			}

			50% {
				box-shadow: 0 0 0 4px rgba(37, 99, 235, 0);
			}
		}

		.btn-secondary:active {
			transform: translateY(0);
		}

		.btn-primary:active {
			transform: translateY(0);
		}

		/* Collapsible Department Cards */
		.assignee-picker-card {
			position: relative;
		}

		.assignee-picker-resp,
		.assignee-picker-employees {
			max-height: 1000px;
			overflow: hidden;
			transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
			opacity: 1;
		}

		.assignee-picker-card.collapsed .assignee-picker-resp,
		.assignee-picker-card.collapsed .assignee-picker-employees {
			max-height: 0;
			opacity: 0;
			padding-top: 0;
			padding-bottom: 0;
		}

		.dept-collapse-toggle {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: 24px;
			height: 24px;
			border-radius: 6px;
			background: rgba(59, 130, 246, 0.1);
			color: #3B82F6;
			transition: all 0.3s ease;
			cursor: pointer;
			margin-left: 8px;
		}

		.dept-collapse-toggle:hover {
			background: rgba(59, 130, 246, 0.2);
			transform: scale(1.1);
		}

		.dept-collapse-toggle i {
			transition: transform 0.3s ease;
			font-size: 0.75rem;
		}

		.assignee-picker-card.collapsed .dept-collapse-toggle i {
			transform: rotate(-90deg);
		}

		.assignee-picker-card:hover {
			border-color: #3B82F6;
		}

		.assignee-picker-card:hover .assignee-picker-card-head {
			background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
		}

		/* Badge Styles */
		.assignee-picker-pill {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 4px 10px;
			border-radius: 12px;
			font-size: 0.75rem;
			font-weight: 600;
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}

		/* Responsive improvements */
		@media (max-width: 768px) {
			.assignee-picker-card-head {
				flex-direction: column;
				align-items: flex-start;
			}

			.assignee-picker-pill {
				align-self: flex-start;
			}

			.assignee-picker-employees {
				grid-template-columns: 1fr;
			}

			.modal-shell {
				max-height: 90vh !important;
			}
		}

		/* Loading state */
		.assignee-loading {
			animation: pulse 1.5s ease-in-out infinite;
		}

		@keyframes pulse {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.5;
			}
		}

		/* Page Header */
		.page-header {
			text-align: center;
			margin-bottom: 2rem;
			padding: 2rem 0;
			background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
			border-radius: 16px;
			border: 1px solid rgba(148, 163, 184, 0.1);
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
		}

		.page-title {
			font-size: 2rem;
			font-weight: 700;
			color: #1e293b;
			margin: 0 0 0.75rem 0;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.75rem;
		}

		.page-title i {
			color: #3b82f6;
			font-size: 1.75rem;
		}

		.page-subtitle {
			font-size: 1rem;
			color: #64748b;
			margin: 0;
			font-weight: 500;
		}

		@media (max-width: 768px) {
			.page-title {
				font-size: 1.5rem;
				flex-direction: column;
				gap: 0.5rem;
			}

			.page-title i {
				font-size: 1.5rem;
			}

			.page-subtitle {
				font-size: 0.875rem;
			}
		}
	</style>
</head>

<body class="bg-gray-50">
	<div id="app" class="min-h-screen flex">
		<div id="sidebarMount"></div>
		<main class="flex-1 overflow-y-auto p-6">
			<div>
				<div id="toastRoot" class="toast-container" aria-live="polite" aria-atomic="true"></div>
			<!-- Page Title & Description -->
			<div class="page-header">
				<h1 class="page-title" data-translate="nav.task_management">
					<i class="fas fa-tachometer-alt"></i>
					Task Management
				</h1>
				<p class="page-subtitle" data-translate="director.subtitle">Task Management and Employee Oversight</p>
			</div>

				<!-- KPI Snapshot - Tasks & Instructions Focus -->
				<div class="flex flex-wrap gap-4 justify-between mt-12 mb-12" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
					<div class="report-stat-card-inline" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98)); border-radius: 20px; padding: 20px; border: 1px solid rgba(15, 23, 42, 0.08); box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08); transition: all 0.3s ease; display: flex; gap: 16px; align-items: center; flex: 1; min-width: 200px; text-decoration: none !important; position: relative; overflow: hidden;">
						<div class="report-stat-icon" style="width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); background: linear-gradient(135deg, #3b82f6, #2563eb);">
							<i class="fas fa-layer-group"></i>
						</div>
						<div class="report-stat-content" style="flex: 1;">
							<p class="report-stat-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 600; margin-bottom: 8px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</p>
							<h3 id="kpiAllTasks" class="report-stat-value" style="font-size: 2.25rem; font-weight: 800; color: #0f172a; line-height: 1; margin-bottom: 10px;">0</h3>
							<div class="flex gap-2 flex-wrap">
								<span class="report-stat-badge badge-success" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, #10b981, #059669); color: white;">
									<span class="w-1.5 h-1.5 rounded-full bg-white opacity-60"></span>
									Ù…ÙƒØªÙ…Ù„Ø©: <span id="kpiAllCompleted">0</span>
								</span>
								<span class="report-stat-badge badge-warning" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
									<span class="w-1.5 h-1.5 rounded-full bg-white opacity-60"></span>
									Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: <span id="kpiAllInProgress">0</span>
								</span>
								<span class="report-stat-badge" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
									<span class="w-1.5 h-1.5 rounded-full bg-white opacity-60"></span>
									Ù…ØªØ£Ø®Ø±Ø©: <span id="kpiAllOverdue">0</span>
								</span>
							</div>
						</div>
					</div>

					<div class="report-stat-card-inline" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98)); border-radius: 20px; padding: 20px; border: 1px solid rgba(15, 23, 42, 0.08); box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08); transition: all 0.3s ease; display: flex; gap: 16px; align-items: center; flex: 1; min-width: 200px; text-decoration: none !important; position: relative; overflow: hidden;">
						<div class="report-stat-icon" style="width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
							<i class="fas fa-user-edit"></i>
						</div>
						<div class="report-stat-content" style="flex: 1;">
							<p class="report-stat-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 600; margin-bottom: 8px;">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£ØªÙ‡Ø§</p>
							<h3 id="kpiMyTasks" class="report-stat-value" style="font-size: 2.25rem; font-weight: 800; color: #0f172a; line-height: 1; margin-bottom: 10px;">0</h3>
							<div class="flex gap-2 flex-wrap">
								<span class="report-stat-badge badge-success" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, #10b981, #059669); color: white;">
									<span class="w-1.5 h-1.5 rounded-full bg-white opacity-60"></span>
									Ù…ÙƒØªÙ…Ù„Ø©: <span id="kpiMyCompleted">0</span>
								</span>
								<span class="report-stat-badge badge-warning" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
									<span class="w-1.5 h-1.5 rounded-full bg-white opacity-60"></span>
									Ù†Ø´Ø·Ø©: <span id="kpiMyActive">0</span>
								</span>
								<span class="report-stat-badge badge-info" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
									<span class="w-1.5 h-1.5 rounded-full bg-white opacity-60"></span>
									Ù…Ø¹Ù„Ù‚Ø©: <span id="kpiMyPending">0</span>
								</span>
							</div>
						</div>
					</div>

					<div class="report-stat-card-inline" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98)); border-radius: 20px; padding: 20px; border: 1px solid rgba(15, 23, 42, 0.08); box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08); transition: all 0.3s ease; display: flex; gap: 16px; align-items: center; flex: 1; min-width: 200px; text-decoration: none !important; position: relative; overflow: hidden;">
						<div class="report-stat-icon" style="width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); background: linear-gradient(135deg, #f97316, #ea580c);">
							<i class="fas fa-bullhorn"></i>
						</div>
						<div class="report-stat-content" style="flex: 1;">
							<p class="report-stat-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 600; margin-bottom: 8px;">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</p>
							<h3 id="kpiMyInstructions" class="report-stat-value" style="font-size: 2.25rem; font-weight: 800; color: #0f172a; line-height: 1; margin-bottom: 10px;">0</h3>
							<div class="flex gap-2 flex-wrap">
								<span class="report-stat-badge badge-info" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
									<span class="w-1.5 h-1.5 rounded-full bg-white opacity-60"></span>
									Ø§Ù„Ù…Ø±Ø³Ù„Ø©: <span id="kpiInstrSent">0</span>
								</span>
								<span class="report-stat-badge badge-purple" style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: linear-gradient(135deg, #a855f7, #7c3aed); color: white;">
									<span class="w-1.5 h-1.5 rounded-full bg-white opacity-60"></span>
									Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ†: <span id="kpiInstrRecipients">0</span>
								</span>
							</div>
						</div>
					</div>
				</div>

				<!-- View Toolbar -->
				<div class="director-toolbar mt-8" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98)); border-radius: 20px; padding: 24px; border: 1px solid rgba(15, 23, 42, 0.08); box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08); position: relative; overflow: hidden;">
					<div style="position: absolute; inset: 0; background: linear-gradient(120deg, rgba(37, 99, 235, 0.05), rgba(124, 58, 237, 0.03), rgba(56, 189, 248, 0.03)); opacity: 0.5; pointer-events: none;"></div>
					<div style="display: flex; align-items: center; justify-content: space-between; gap: 20px; position: relative; z-index: 1; flex-wrap: wrap;">
						<nav class="director-tabs" aria-label="Task views" id="directorTabs" style="display: inline-flex; flex-wrap: wrap; gap: 8px; background: rgba(248, 250, 252, 0.6); padding: 6px; border-radius: 16px; border: 1px solid rgba(148, 163, 184, 0.15);">
							<button id="btnViewMytasks" data-view="mytasks" class="director-tab active" style="border-radius: 12px; padding: 12px 20px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); color: white; font-weight: 600; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25); transform: translateY(-1px);">
								<i class="fas fa-list-check" style="font-size: 1rem; color: rgba(255, 255, 255, 0.9);"></i>
								<span data-translate="director.my_tasks">My Tasks</span>
							</button>
							<button id="btnViewResponsibles" data-view="responsibles" class="director-tab" style="border-radius: 12px; padding: 12px 20px; border: none; background: transparent; color: #64748b; font-weight: 500; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; position: relative; overflow: hidden;">
								<i class="fas fa-user-tie" style="font-size: 1rem; color: #64748b; transition: all 0.3s ease;"></i>
								<span data-translate="director.responsibles">Responsibles</span>
								<div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
							</button>
							<button id="btnViewEmployees" data-view="employees" class="director-tab" style="border-radius: 12px; padding: 12px 20px; border: none; background: transparent; color: #64748b; font-weight: 500; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; position: relative; overflow: hidden;">
								<i class="fas fa-users" style="font-size: 1rem; color: #64748b; transition: all 0.3s ease;"></i>
								<span data-translate="director.employees">Employees</span>
								<div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
							</button>
							<button id="btnViewTasks" data-view="tasks" class="director-tab" style="border-radius: 12px; padding: 12px 20px; border: none; background: transparent; color: #64748b; font-weight: 500; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; position: relative; overflow: hidden;">
								<i class="fas fa-tasks" style="font-size: 1rem; color: #64748b; transition: all 0.3s ease;"></i>
								<span data-translate="director.all_tasks">All Tasks</span>
								<div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
							</button>
							<button id="btnViewMyinstructions" data-view="myinstructions" class="director-tab" style="border-radius: 12px; padding: 12px 20px; border: none; background: transparent; color: #64748b; font-weight: 500; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; position: relative; overflow: hidden;">
								<i class="fas fa-bullhorn" style="font-size: 1rem; color: #64748b; transition: all 0.3s ease;"></i>
								<span data-translate="director.instructions">Instructions</span>
								<div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
							</button>
						</nav>

						<button id="btnOpenTaskModal" class="btn-create-task" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; padding: 12px 24px; font-weight: 600; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); position: relative; overflow: hidden;">
							<div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent); opacity: 0; transition: opacity 0.3s ease;"></div>
							<i class="fas fa-plus-circle" style="font-size: 1rem; color: rgba(255, 255, 255, 0.9);"></i>
							<span data-translate="director.create_task_instruction">Add Task/Instruction</span>
						</button>
					</div>
				</div>

				<!-- Main Dashboard Content Container -->
				<div class="dashboard-content-container">
					<div id="dynamicContent"></div>
				</div>

				<!-- Global Employee Details Modal (single instance) -->
				<div id="employeeDetailsModal"
					class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4">
					<div class="modal-shell max-w-4xl w-full flex flex-col transition-all" style="max-height:85vh;">
						<div class="modal-header-gradient flex items-center justify-between p-6">
							<h3 id="modalTitle" class="text-xl font-bold" data-translate="director.employee_details">
								Employee Details</h3>
							<button onclick="closeEmployeeDetails()"
								class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all">
								<i class="fas fa-times text-white"></i>
							</button>
						</div>
						<div class="flex-1 overflow-y-auto p-6 custom-scrollbar bg-white">
							<div id="modalContent" class="space-y-4"></div>
						</div>
						<div class="flex justify-end gap-3 p-6 border-t border-slate-100 bg-slate-50">
							<button onclick="closeEmployeeDetails()" class="btn-secondary"
								data-translate="common.close">Close</button>
						</div>
					</div>
				</div>

				<!-- Task Details Modal (Director) -->
				<div id="taskDetailsModalDir"
					class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
					<div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto transition-all duration-300"
						style="max-height:85vh; direction: rtl; text-align: right;">
						<div class="p-6 border-b border-gray-200" style="direction: rtl; text-align: right;">
							<div class="flex items-center justify-between" style="direction: rtl; text-align: right;">
								<h3 id="dirDetailsTitle" class="text-xl font-bold text-gray-900"
									data-translate="director.task_details" style="text-align: right; direction: rtl;">
									Task Details</h3>
								<button id="dirCloseDetailsModal"
									class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200">
									<i class="fas fa-times text-gray-600"></i>
								</button>
							</div>
						</div>
						<div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar bg-gray-50"
							style="direction: rtl; text-align: right;">
							<div id="dirTaskDetailsContent" style="direction: rtl; text-align: right;"></div>
							<div class="border-t pt-6 bg-white rounded-xl p-6"
								style="direction: rtl; text-align: right;">
								<h4 class="text-base font-semibold text-gray-900 mb-4"
									style="text-align: right; direction: rtl;" data-translate="director.comments">
									Comments</h4>
								<div id="dirTaskComments"
									class="space-y-3 max-h-48 overflow-y-auto mb-4 custom-scrollbar"
									style="direction: rtl; text-align: right;">
								</div>
								<div class="flex gap-3" style="direction: rtl; text-align: right;">
									<input type="text" id="dirNewComment"
										data-translate-placeholder="director.add_comment" placeholder="Add a comment..."
										class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
										style="direction: rtl; text-align: right;" />
									<button id="dirAddCommentBtn"
										class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 transform hover:scale-105 shadow-lg flex items-center gap-2"
										data-translate-title="director.send_comment" title="Send comment">
										<i class="fas fa-paper-plane"></i>
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<!-- Small Reusable Modal (Edit / Confirm) -->
	<div id="dirSmallModal"
		class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 p-4 items-center justify-center">
		<div class="modal-shell w-full max-w-md mx-auto overflow-hidden">
			<div class="modal-header-gradient flex items-center justify-between p-5">
				<h3 id="dirSmallModalTitle" class="text-lg font-bold" data-translate="common.modal">Modal</h3>
				<button id="dirSmallModalClose"
					class="w-9 h-9 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all">
					<i class="fas fa-times text-white text-sm"></i>
				</button>
			</div>
			<div id="dirSmallModalBody" class="p-5 text-sm text-gray-800 bg-white"></div>
			<div class="flex items-center justify-end gap-3 p-5 border-t border-gray-200 bg-slate-50">
				<button id="dirSmallCancelBtn" class="btn-secondary text-sm"
					data-translate="common.cancel">Cancel</button>
				<button id="dirSmallPrimaryBtn" class="btn-primary text-sm" data-translate="common.ok">OK</button>
			</div>
		</div>
	</div>

	<!-- Modal Gï¿½nï¿½ration Tï¿½che / Instruction -->
	<div id="directorTaskModal"
		class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4">
		<div class="modal-shell w-full max-w-5xl mx-auto transition-all">
			<div class="modal-header-standard">
				<div class="flex items-center gap-4">
					<div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center">
						<i class="fas fa-layer-group text-blue-600 text-xl"></i>
					</div>
					<div>
						<h3 class="modal-header-title" data-locale-key="modal.title">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ù…Ø© / ØªØ¹Ù„ÙŠÙ…Ø§Øª</h3>
						<p class="text-sm text-slate-500 font-medium" data-locale-key="modal.subtitle">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
							ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
					</div>
				</div>
				<button id="closeDirectorTaskModal" class="modal-header-close">
					<i class="fas fa-times"></i>
				</button>
			</div>
			<div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50">
				<div class="p-6 space-y-6" style="direction: rtl;">
					<div class="flex flex-wrap gap-4" role="tablist"
						style="direction: rtl; justify-content: flex-end; width: 100%;">
						<button id="tabAddTask" class="director-tab active" type="button" aria-selected="true"
							style="direction: rtl; flex-direction: row-reverse;">
							<i class="fas fa-list-check text-indigo-500" style="margin-left: 8px; margin-right: 0;"></i>
							<span data-locale-key="modal.tab_task">Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
						</button>
						<button id="tabAddInstruction" class="director-tab" type="button" aria-selected="false"
							style="direction: rtl; flex-direction: row-reverse;">
							<i class="fas fa-bullhorn text-indigo-500" style="margin-left: 8px; margin-right: 0;"></i>
							<span data-locale-key="modal.tab_instruction">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</span>
						</button>
					</div>
					<div class="dir-modal-layout">
						<div class="dir-modal-main">
							<section id="taskBuilderSection" class="dir-modal-section" style="min-height: 500px;">
								<div class="dir-modal-section-head"
									style="direction: rtl; text-align: right; display: flex; justify-content: flex-end; width: 100%;">
									<div style="text-align: right; width: 100%;">
										<p class="dir-modal-section-eyebrow" style="text-align: right;"
											data-locale-key="modal.tab_task">Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
										<h4 class="dir-modal-section-title" style="text-align: right;"
											data-locale-key="modal.task_section_hint">Ø­Ø¯Ø¯ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</h4>
									</div>
								</div>
								<form id="directorAddTaskForm" class="space-y-8 dir-modal-form">
									<div class="form-grid">
										<div class="input-field">
											<label for="dirTaskTitle" data-locale-key="modal.field_title">Title</label>
											<input id="dirTaskTitle" type="text" required />
										</div>
										<div class="input-field">
											<label for="dirTaskDueDate" data-locale-key="modal.field_due">Due
												date</label>
											<input id="dirTaskDueDate" type="date" />
										</div>
									</div>

									<div class="form-grid">
										<div class="input-field">
											<label for="dirTaskType" data-locale-key="modal.field_type">Type</label>
											<select id="dirTaskType">
												<option value="Daily" data-locale-key="modal.type_daily">Daily</option>
												<option value="Special" data-locale-key="modal.type_special" selected>
													Special</option>
											</select>
										</div>
										<div class="input-field">
											<label for="dirTaskPriority"
												data-locale-key="modal.field_priority">Priority</label>
											<select id="dirTaskPriority">
												<option value="Low" data-locale-key="modal.priority_low">Low</option>
												<option value="Medium" data-locale-key="modal.priority_medium" selected>
													Medium</option>
												<option value="High" data-locale-key="modal.priority_high">High</option>
											</select>
										</div>
									</div>

									<div class="input-field">
										<label for="dirTaskDescription"
											data-locale-key="modal.field_description">Description</label>
										<textarea id="dirTaskDescription" rows="4"
											data-locale-placeholder="modal.description_placeholder"
											placeholder="Describe the goal, context or expected outputs."></textarea>
									</div>

									<!-- Selected Count & Preview (Integrated) -->
									<div class="mt-6 p-5 rounded-2xl space-y-4"
										style="direction: rtl; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #bfdbfe; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);">
										<div class="flex items-center" style="justify-content: flex-end; gap: 12px;">
											<div style="text-align: right;">
												<p class="text-xs uppercase tracking-wider font-bold"
													style="color: #1e40af;" data-locale-key="assignee.selected_label">
													Ø§Ù„Ù…Ø­Ø¯Ø¯ÙˆÙ†</p>
												<span id="assigneePickerCount" class="text-lg font-bold"
													style="color: #2563eb;"
													data-locale-template="assignee.count_template">0 Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹</span>
											</div>
											<div
												style="width: 44px; height: 44px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);">
												<i class="fas fa-users" style="color: white; font-size: 18px;"></i>
											</div>
										</div>

										<div id="assigneePickerSelected"
											class="flex flex-wrap gap-2 max-h-32 overflow-y-auto custom-scrollbar"
											style="direction: rtl; justify-content: flex-end;">
											<!-- Selected chips injected here -->
										</div>
										<div id="assigneePickerEmpty" class="text-center py-4 text-sm italic rounded-xl"
											style="background: rgba(255,255,255,0.7); border: 2px dashed #93c5fd; color: #1e40af;">
											<i class="fas fa-user-plus" style="margin-left: 8px;"></i>
											<span data-locale-key="assignee.none_chip">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯</span>
										</div>
									</div>

									<div class="modal-actions pt-6 mt-4 border-t border-slate-200">
										<button type="button" id="dirCancelBtn" class="btn-secondary"
											data-locale-key="modal.cancel">Cancel</button>
										<button type="submit" class="btn-primary"
											data-locale-key="modal.create">Create</button>
									</div>
								</form>
							</section>

							<section id="instructionBuilderSection" class="dir-modal-section"
								style="min-height: 500px;">
								<div class="dir-modal-section-head"
									style="direction: rtl; text-align: right; display: flex; justify-content: flex-end; width: 100%;">
									<div style="text-align: right; width: 100%;">
										<p class="dir-modal-section-eyebrow" style="text-align: right;"
											data-locale-key="modal.tab_instruction">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>
										<h4 class="dir-modal-section-title" style="text-align: right;"
											data-locale-key="instruction.section_hint">Ø£Ø±Ø³Ù„ ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ù„Ù„Ø£Ù‚Ø³Ø§Ù…</h4>
									</div>
								</div>
								<form id="directorAddInstructionForm" class="space-y-8 dir-modal-form">
									<div class="input-field">
										<label for="dirInstructionText"
											data-locale-key="instruction.field_text">Instruction</label>
										<textarea id="dirInstructionText" rows="4"
											data-locale-placeholder="instruction.placeholder"
											placeholder="Rï¿½diger l'instruction..."></textarea>
									</div>
									<!-- Target Selection Section -->
									<div class="instruction-target-section" style="direction: rtl;">
										<div class="instruction-target-label">
											<i class="fas fa-bullseye"></i>
											<span data-locale-key="instruction.target">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</span>
										</div>
										<div class="target-options-grid">
											<!-- Responsible Only -->
											<label class="target-option-card">
												<input id="dirDeptResponsibleOnly" name="deptOption" type="radio"
													checked>
												<div class="target-option-icon">
													<i class="fas fa-user-tie"></i>
												</div>
												<div class="target-option-title"
													data-locale-key="instruction.target_resp">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·</div>
												<div class="target-option-desc">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø¹ÙŠÙ†</div>
												<div class="check-indicator">
													<i class="fas fa-check"></i>
												</div>
											</label>

											<!-- Whole Department -->
											<label class="target-option-card">
												<input id="dirDeptAllEmployees" name="deptOption" type="radio">
												<div class="target-option-icon">
													<i class="fas fa-users"></i>
												</div>
												<div class="target-option-title"
													data-locale-key="instruction.target_all">ÙƒÙ„ Ø§Ù„Ù‚Ø³Ù…</div>
												<div class="target-option-desc">Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
												<div class="check-indicator">
													<i class="fas fa-check"></i>
												</div>
											</label>

											<!-- All Departments -->
											<label class="target-option-card">
												<input id="dirAllSchoolResponsibles" type="checkbox">
												<div class="target-option-icon">
													<i class="fas fa-building"></i>
												</div>
												<div class="target-option-title"
													data-locale-key="instruction.all_school">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
												<div class="target-option-desc">ÙƒÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
												<div class="check-indicator">
													<i class="fas fa-check"></i>
												</div>
											</label>
										</div>

										<!-- Department Selection (shown when not "All Departments") -->
										<div id="departmentSelectionWrapper" class="form-grid"
											style="margin-top: 20px;">
											<div class="input-field">
												<label for="dirDeptSelect"
													data-locale-key="instruction.department">Ø§Ù„Ù‚Ø³Ù…</label>
												<select id="dirDeptSelect"></select>
											</div>
										</div>
									</div>

									<div class="form-grid">
										<div class="input-field">
											<label for="dirInstructionPriority"
												data-locale-key="modal.field_priority">Priority</label>
											<select id="dirInstructionPriority">
												<option value="Low" data-locale-key="modal.priority_low">Low</option>
												<option value="Medium" data-locale-key="modal.priority_medium" selected>
													Medium</option>
												<option value="High" data-locale-key="modal.priority_high">High</option>
											</select>
										</div>
										<div class="input-field">
											<label for="dirInstructionDueDate" data-locale-key="modal.field_due">Due
												date</label>
											<input id="dirInstructionDueDate" type="date" />
										</div>
									</div>
									<div class="modal-actions pt-6 mt-4 border-t border-slate-200">
										<button type="button" id="dirCancelBtn2" class="btn-secondary"
											data-locale-key="modal.cancel">Cancel</button>
										<button type="submit" class="btn-primary"
											data-locale-key="modal.send">Send</button>
									</div>
								</form>
							</section>
						</div>
						<aside class="dir-modal-side" style="direction: rtl; text-align: right;">
							<section class="dir-modal-section"
								style="position: sticky; top: 0; direction: rtl; text-align: right;">
								<!-- Header -->
								<div class="dir-modal-section-head"
									style="direction: rtl; text-align: right; display: flex; justify-content: flex-end; width: 100%;">
									<div style="text-align: right; width: 100%;">
										<p class="dir-modal-section-eyebrow" style="text-align: right;"
											data-locale-key="modal.assignee_overview">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙƒÙ„ÙÙŠÙ†</p>
										<h4 class="dir-modal-section-title" style="text-align: right;"
											data-locale-key="modal.assignee_hint">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ù‡Ù…Ø©</h4>
									</div>
								</div>

								<!-- Search Bar -->
								<div class="mb-4" style="direction: rtl;">
									<div class="relative">
										<input id="assigneeSearchInput" type="text"
											data-locale-placeholder="assignee.search_placeholder"
											placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..."
											class="w-full py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
											style="padding-right: 40px; padding-left: 16px; text-align: right; direction: rtl;"
											aria-label="Search users" />
										<i class="fas fa-search absolute text-gray-400"
											style="right: 14px; top: 50%; transform: translateY(-50%);"></i>
									</div>
								</div>

								<!-- Quick Actions -->
								<div class="flex items-center gap-3 mb-4"
									style="direction: rtl; justify-content: flex-end;">
									<button id="assigneeSelectAll"
										class="flex-1 px-4 py-2.5 rounded-lg transition-all text-sm font-semibold shadow-sm hover:shadow-md"
										style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; display: flex; align-items: center; justify-content: center; gap: 8px; flex-direction: row-reverse;"
										data-locale-key="assignee.select_all" aria-label="Select all">
										<i class="fas fa-check-double"></i>
										<span>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span>
									</button>
									<button id="assigneeClearAll"
										class="flex-1 px-4 py-2.5 rounded-lg transition-all text-sm font-semibold shadow-sm hover:shadow-md"
										style="background: white; color: #64748b; border: 2px solid #e2e8f0; display: flex; align-items: center; justify-content: center; gap: 8px; flex-direction: row-reverse;"
										data-locale-key="assignee.clear_all" aria-label="Clear all">
										<i class="fas fa-times-circle"></i>
										<span>Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</span>
									</button>
								</div>

								<!-- Filter: Responsibles Only -->
								<div class="mb-4 p-4 rounded-xl"
									style="direction: rtl; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #bfdbfe;">
									<label class="flex items-center text-sm cursor-pointer"
										style="flex-direction: row-reverse; justify-content: flex-end; gap: 12px;">
										<span data-locale-key="assignee.resp_only" class="font-semibold"
											style="color: #1e40af; margin-left: 8px;">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† ÙÙ‚Ø·</span>
										<div
											style="width: 32px; height: 32px; background: #3b82f6; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
											<i class="fas fa-user-tie" style="color: white; font-size: 14px;"></i>
										</div>
										<input type="checkbox" id="assigneeSelectResponsibles"
											style="width: 22px; height: 22px; border-radius: 6px; border: 2px solid #3b82f6; accent-color: #3b82f6; cursor: pointer; margin-left: 4px;" />
									</label>
								</div>

								<!-- Departments & Employees List -->
								<div id="assigneePickerBody"
									class="overflow-y-auto bg-white custom-scrollbar rounded-lg border border-gray-200 mb-4"
									style="max-height: 400px; min-height: 250px;" role="region"
									aria-label="Assignee list">
									<!-- Content injected by JS -->
									<div class="assignee-loading text-center text-gray-400 py-12 text-sm">
										<div class="inline-flex flex-col items-center gap-3">
											<i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
											<p class="font-medium" data-locale-key="assignee.loading">Loading...</p>
										</div>
									</div>
								</div>


								<!-- Hidden containers for compatibility -->
								<div id="dirSelectedEmployees" class="hidden"></div>
								<div id="dirEmployeesContainer" class="hidden"></div>
								<div id="dirAssigneeCountLabel" class="hidden">
									<span id="dirAssigneeCount">0</span>
								</div>
								<!-- Hidden button for compatibility -->
								<button type="button" id="openAssigneePickerBtn" class="hidden"></button>
							</section>
						</aside>
					</div>
				</div>
			</div>
		</div>

	</div>

	<!-- Assignee Picker Modal - Enhanced -->
	<div id="dirAssigneePickerModal"
		class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 p-4 flex items-center justify-center"
		role="dialog" aria-labelledby="assigneeModalTitle" aria-modal="true">
		<div class="modal-shell assignee-modal-enhanced w-full max-w-4xl mx-auto " style="max-height:85vh;">

			<div class="modal-header-standard">
				<div class="flex items-center gap-4">
					<div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center">
						<i class="fas fa-user-plus text-blue-600 text-xl"></i>
					</div>
					<div>
						<h3 class="modal-header-title" data-locale-key="assignee.manage_title">Ø¥Ø¯Ø§Ø±Ø©
							Ø§Ù„Ù…ÙƒÙ„ÙÙŠÙ†</h3>
						<p class="text-sm text-slate-500 font-medium" data-locale-key="assignee.subtitle">Ø­Ø¯Ø¯ Ù…Ù† Ø³ÙŠØªÙ„Ù‚Ù‰
							Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©.</p>
					</div>
				</div>
				<button id="closeAssigneePickerBtn" class="modal-header-close">
					<i class="fas fa-times text-lg"></i>
				</button>
			</div>

			<!-- Search Bar -->
			<div class="px-6 py-5 md:px-8 md:py-6 border-b border-slate-200 bg-white">
				<div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 rtl-flex">
					<div class="assignee-search-wrapper flex-1">
						<div class="relative">
							<input id="enhAssigneeSearchInput" type="text"
								data-locale-placeholder="assignee.search_placeholder" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..."
								class="w-full pl-11 pr-4 py-3.5 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm bg-white placeholder:text-gray-400"
								aria-label="Search users" />
							<i
								class="fas fa-search absolute left-4 top-4 text-gray-400 text-sm assignee-search-icon pointer-events-none"></i>
						</div>
					</div>
					<div class="flex items-center gap-2 flex-wrap sm:flex-nowrap">
						<button id="enhAssigneeSelectAll"
							class="btn-secondary text-xs px-4 py-3 whitespace-nowrap hover:shadow-md"
							data-locale-key="assignee.all" aria-label="Select all">
							<i class="fas fa-check-double mr-1.5"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
						</button>
						<button id="enhAssigneeClearAll"
							class="btn-secondary text-xs px-4 py-3 whitespace-nowrap hover:shadow-md"
							data-locale-key="assignee.none" aria-label="Clear all">
							<i class="fas fa-times-circle mr-1.5"></i>Ù…Ø³Ø­
						</button>
					</div>
				</div>
			</div>

			<!-- Two-column Content -->
			<div class="px-6 py-6 md:px-8 bg-white">
				<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
					<!-- Left: departments & employees -->
					<div class="lg:col-span-2">
						<div id="enhAssigneePickerBody"
							class="flex-1 overflow-y-auto bg-white custom-scrollbar rounded-2xl border border-slate-200"
							style="max-height:350px; min-height:200px;" role="region" aria-label="Assignee list">
							<!-- Content injected by JS -->
							<div class="assignee-loading text-center text-gray-400 py-16 text-sm">
								<div class="inline-flex flex-col items-center gap-3">
									<i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i>
									<p class="font-medium" data-locale-key="assignee.loading">Ø¬Ø§Ø±ÙŠ
										Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Right: filters + selected preview -->
					<aside class="space-y-4">
						<div class="dir-modal-section">
							<div class="flex flex-col gap-3">
								<label
									class="inline-flex items-center gap-2.5 text-sm text-gray-700 cursor-pointer rtl-flex hover:text-gray-900 transition-colors">
									<input type="checkbox" id="enhAssigneeSelectResponsibles"
										class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 cursor-pointer" />
									<i class="fas fa-user-tie text-gray-500"></i>
									<span data-locale-key="assignee.resp_only" class="font-medium">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† ÙÙ‚Ø·</span>
								</label>
								<div
									class="flex items-center justify-between gap-2 px-3 py-2 bg-blue-50 rounded-lg border border-blue-100">
									<div class="flex items-center gap-2">
										<i class="fas fa-info-circle text-blue-600 text-sm"></i>
										<span id="enhAssigneePickerCount"
											class="text-xs font-semibold text-blue-700 whitespace-nowrap"
											data-locale-template="assignee.count_template">0 Ù…Ø­Ø¯Ø¯
											Ø­Ø§Ù„ÙŠØ§Ù‹</span>
									</div>
								</div>
							</div>
						</div>

						<div class="dir-modal-section">
							<div class="assignee-selected-bar mb-3">
								<div class="flex items-center gap-2">
									<i class="fas fa-check-circle text-green-600"></i>
									<span class="font-semibold text-gray-800"
										data-locale-key="assignee.selected_label">Ø§Ù„Ù…Ø­Ø¯Ø¯ÙˆÙ†</span>
								</div>
								<span class="assignee-selected-count" data-locale-count-badge="true">
									<i class="fas fa-users text-xs mr-1"></i>0 Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹
								</span>
							</div>
							<div id="enhAssigneePickerSelected" class="assignee-selected-chips mt-3 empty:hidden">
								<!-- Selected chips injected here -->
							</div>
							<div id="enhAssigneePickerEmpty"
								class="assignee-selected-empty text-center py-4 text-gray-400 text-sm">
								<i class="fas fa-user-slash mb-2 text-2xl"></i>
								<p data-locale-key="assignee.none_chip">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯</p>
							</div>
						</div>
					</aside>
				</div>
			</div>

			<!-- Action Buttons -->
			<div
				class="px-6 py-5 md:px-8 border-t border-slate-200 flex flex-col-reverse sm:flex-row justify-between sm:justify-end items-stretch sm:items-center gap-3 bg-white">
				<button id="assigneePickerCancel"
					class="btn-secondary flex items-center justify-center gap-2 hover:shadow-lg"
					data-locale-key="assignee.cancel">
					<i class="fas fa-times"></i>
					<span>Ø¥Ù„ØºØ§Ø¡</span>
				</button>
				<button id="assigneePickerApply"
					class="btn-primary flex items-center justify-center gap-2 hover:shadow-xl"
					data-locale-key="assignee.apply">
					<i class="fas fa-check"></i>
					<span>ØªØ·Ø¨ÙŠÙ‚</span>
				</button>
			</div>
		</div>
	</div>



	<!-- Socket.IO will be loaded dynamically if needed -->
	<!-- <script src="genererR.js"></script> -->
	<!-- <script src="sidebar.js"></script> -->
	<!-- <script src="/socket.io/socket.io.js"></script> -->
	<script src="translations.js"></script>
	<script>
		const getCurrentLanguage = () => (typeof window !== 'undefined' && window.currentLanguage) ? window.currentLanguage : (localStorage.getItem('language') || localStorage.getItem('lang') || 'en');
		const t = (key) => (typeof translate === 'function') ? translate(key) : key;
		const translatePriorityValue = (value) => {
			const lang = getCurrentLanguage();
			const normalized = String(value || '').toLowerCase();
			const map = {
				en: { low: 'Low', medium: 'Medium', high: 'High', critical: 'Critical', normal: 'Normal' },
				fr: { low: 'Faible', medium: 'Moyenne', high: 'Ã‰levÃ©e', critical: 'Critique', normal: 'Normale' },
				ar: { low: 'Ù…Ù†Ø®ÙØ¶Ø©', medium: 'Ù…ØªÙˆØ³Ø·Ø©', high: 'Ø¹Ø§Ù„ÙŠØ©', critical: 'Ø­Ø±Ø¬Ø©', normal: 'Ø¹Ø§Ø¯ÙŠØ©' }
			};
			return (map[lang] && map[lang][normalized]) || value || '';
		};
		const translateTaskTypeValue = (value) => {
			if (!value) return t('tasks.task');
			const key = String(value).toLowerCase();
			const typeMap = {
				daily: 'tasks.daily',
				special: 'tasks.special',
				instruction: 'tasks.instructions',
				meeting: 'tasks.meetings'
			};
			const translateKey = typeMap[key] || 'tasks.task';
			return t(translateKey) || value;
		};
		const translateStatusValue = (value) => {
			const normalized = String(value || '').toLowerCase();
			const map = {
				pending: t('status.pending'),
				'in progress': t('status.in_progress'),
				completed: t('status.completed'),
				accepted: t('status.accepted'),
				denied: t('status.denied'),
				active: t('status.active')
			};
			return map[normalized] || value || '';
		};

		const directorModalLocale = {
			'modal.title': { en: 'Create Task / Instruction', fr: 'CrÃ©er une tÃ¢che / Instruction', ar: 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‡Ù…Ø© / ØªØ¹Ù„ÙŠÙ…Ø§Øª' },
			'modal.subtitle': { en: 'Director Actions & Management', fr: 'Actions du directeur & Gestion', ar: 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©' },
			'modal.hero_by_task': { en: 'By Task', fr: 'Par tÃ¢che', ar: 'Ø­Ø³Ø¨ Ø§Ù„Ù…Ù‡Ù…Ø©' },
			'modal.hero_by_employee': { en: 'By Employee', fr: 'Par employÃ©', ar: 'Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù' },
			'modal.hero_total': { en: 'Total', fr: 'Total', ar: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' },
			'modal.hero_workload_title': { en: 'Task distribution', fr: 'RÃ©partition des tÃ¢ches', ar: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…' },
			'modal.hero_workload_desc': { en: 'Instant snapshot of the load based on your selections.', fr: 'Vue instantanÃ©e de la charge selon vos sÃ©lections.', ar: 'Ù„Ù‚Ø·Ø© ÙÙˆØ±ÙŠØ© Ù„Ù„Ø­Ù…Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø±Ø§ØªÙƒ.' },
			'modal.hero_prev': { en: 'Prev', fr: 'PrÃ©cÃ©dent', ar: 'Ø§Ù„Ø³Ø§Ø¨Ù‚' },
			'modal.hero_next': { en: 'Next', fr: 'Suivant', ar: 'Ø§Ù„ØªØ§Ù„ÙŠ' },
			'modal.hero_page': { en: 'Page {{page}} / {{pages}}', fr: 'Page {{page}} / {{pages}}', ar: 'Ø§Ù„ØµÙØ­Ø© {{page}} / {{pages}}' },
			'modal.tab_task': { en: 'Add Task', fr: 'Ajouter une tÃ¢che', ar: 'Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©' },
			'modal.tab_instruction': { en: 'Add Instruction', fr: 'Ajouter une instruction', ar: 'ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©' },
			'modal.helper': { en: 'Stay aligned: provide context, due dates and recipients to keep teams in sync.', fr: 'Restez alignÃ© : partagez le contexte, les Ã©chÃ©ances et les destinataires.', ar: 'Ù‚Ø¯Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†.' },
			'modal.task_section_hint': { en: 'Define the task scope, deadlines and context.', fr: 'DÃ©finissez le pÃ©rimÃ¨tre, les Ã©chÃ©ances et le contexte.', ar: 'Ø­Ø¯Ø¯ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©' },
			'modal.field_title': { en: 'Title', fr: 'Titre', ar: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' },
			'modal.field_due': { en: 'Due date', fr: 'Ã‰chÃ©ance', ar: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚' },
			'modal.field_type': { en: 'Type', fr: 'Type', ar: 'Ø§Ù„Ù†ÙˆØ¹' },
			'modal.type_daily': { en: 'Daily', fr: 'Quotidienne', ar: 'ÙŠÙˆÙ…ÙŠØ©' },
			'modal.type_special': { en: 'Special', fr: 'SpÃ©ciale', ar: 'Ø®Ø§ØµØ©' },
			'modal.field_priority': { en: 'Priority', fr: 'PrioritÃ©', ar: 'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©' },
			'modal.priority_low': { en: 'Low', fr: 'Faible', ar: 'Ù…Ù†Ø®ÙØ¶Ø©' },
			'modal.priority_medium': { en: 'Medium', fr: 'Moyenne', ar: 'Ù…ØªÙˆØ³Ø·Ø©' },
			'modal.priority_high': { en: 'High', fr: 'Ã‰levÃ©e', ar: 'Ø¹Ø§Ù„ÙŠØ©' },
			'modal.field_description': { en: 'Description', fr: 'Description', ar: 'Ø§Ù„ÙˆØµÙ' },
			'modal.description_placeholder': {
				en: 'Describe the goal, context or expected outputs.', fr: 'DÃ©crivez l\'objectif, le contexte ou les livrables attendus.', ar: 'ØµÙ Ø§Ù„Ù‡Ø¯Ù Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø£Ùˆ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©.'
			},
			'modal.field_assign_to': { en: 'Assign to', fr: 'Assigner Ã ', ar: 'ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰' },
			'modal.btn_select_assignees': { en: 'Select assignees', fr: 'SÃ©lectionner les assignÃ©s', ar: 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙƒÙ„ÙÙŠÙ†' },
			'modal.selected_template': { en: '{{count}} selected', fr: '{{count}} sÃ©lectionnÃ©(s)', ar: '{{count}} Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹' },
			'modal.cancel': { en: 'Cancel', fr: 'Annuler', ar: 'Ø¥Ù„ØºØ§Ø¡' },
			'modal.create': { en: 'Create', fr: 'CrÃ©er', ar: 'Ø¥Ù†Ø´Ø§Ø¡' },
			'modal.send': { en: 'Send', fr: 'Envoyer', ar: 'Ø¥Ø±Ø³Ø§Ù„' },
			'instruction.field_text': { en: 'Instruction', fr: 'Instruction', ar: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª' },
			'instruction.placeholder': { en: 'Write the instruction...', fr: "RÃ©digez l'instruction...", ar: 'Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª...' },
			'instruction.section_hint': { en: 'Send guidance to departments', fr: 'Envoyer des consignes aux dÃ©partements', ar: 'Ø£Ø±Ø³Ù„ ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ù„Ù„Ø£Ù‚Ø³Ø§Ù…' },
			'instruction.department': { en: 'Department', fr: 'DÃ©partement', ar: 'Ø§Ù„Ù‚Ø³Ù…' },
			'instruction.target': { en: 'Target', fr: 'Cible', ar: 'Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù' },
			'instruction.target_resp': { en: 'Responsible only', fr: 'Responsable uniquement', ar: 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·' },
			'instruction.target_all': { en: 'Whole department', fr: 'Tout le dÃ©partement', ar: 'ÙƒÙ„ Ø§Ù„Ù‚Ø³Ù…' },
			'instruction.all_school': { en: 'All departments (all responsibles)', fr: 'Tous les dÃ©partements (tous les responsables)', ar: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ÙƒÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†)' },
			'modal.assignee_overview': { en: 'Assign Recipients', fr: 'Assigner les destinataires', ar: 'ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙƒÙ„ÙÙŠÙ†' },
			'modal.assignee_hint': { en: 'Choose employees for the task', fr: 'Choisir les employÃ©s pour la tÃ¢che', ar: 'Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ù‡Ù…Ø©' },
			'modal.assignee_note': {
				en: 'Selections persist across the task and instruction builders.', fr: 'Les sÃ©lections sont partagÃ©es entre la tÃ¢che et l\'instruction.', ar: 'ØªØ¸Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø«Ø§Ø¨ØªØ© Ø¹Ø¨Ø± Ù…Ù†Ø´Ø¦ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª.'
			},
			'assignee.manage_title': { en: 'Manage Assignees', fr: 'GÃ©rer les assignÃ©s', ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒÙ„ÙÙŠÙ†' },
			'assignee.subtitle': { en: 'Curate who receives this task.', fr: 'Choisissez qui recevra cette tÃ¢che.', ar: 'Ø­Ø¯Ø¯ Ù…Ù† Ø³ÙŠØªÙ„Ù‚Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©.' },
			'assignee.search_placeholder': { en: 'Search for a user...', fr: 'Rechercher un utilisateur...', ar: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…...' },
			'assignee.all': { en: 'Select all', fr: 'Tout sÃ©lectionner', ar: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„' },
			'assignee.none': { en: 'Clear', fr: 'Effacer', ar: 'Ù…Ø³Ø­' },
			'assignee.count_template': { en: '{{count}} selected', fr: '{{count}} sÃ©lectionnÃ©(s)', ar: '{{count}} Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹' },
			'assignee.resp_only': { en: 'Responsibles only', fr: 'Responsables uniquement', ar: 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† ÙÙ‚Ø·' },
			'assignee.loading': { en: 'Loading...', fr: 'Chargement...', ar: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' },
			'assignee.selected_label': { en: 'Selected', fr: 'SÃ©lectionnÃ©s', ar: 'Ø§Ù„Ù…Ø­Ø¯Ø¯ÙˆÙ†' },
			'assignee.none_chip': { en: 'No selection yet', fr: 'Aucune sÃ©lection', ar: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯' },
			'assignee.cancel': { en: 'Cancel', fr: 'Annuler', ar: 'Ø¥Ù„ØºØ§Ø¡' },
			'assignee.apply': { en: 'Apply', fr: 'Appliquer', ar: 'ØªØ·Ø¨ÙŠÙ‚' },
			'assignee.employee_suffix': { en: 'employee(s)', fr: 'employÃ©(s)', ar: 'Ù…ÙˆØ¸Ù/ÙˆÙ†' },
			'assignee.responsible_label': { en: 'Responsible', fr: 'Responsable', ar: 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„' },
			'assignee.unassigned': { en: 'Unassigned', fr: 'Non assignÃ©', ar: 'ØºÙŠØ± Ù…Ø¹ÙŠÙ†' },
			'assignee.include_team': { en: 'Include entire team', fr: 'Inclure tous les employÃ©s', ar: 'ØªØ¶Ù…ÙŠÙ† ÙƒÙ„ Ø§Ù„ÙØ±ÙŠÙ‚' },
			'assignee.no_results': { en: 'No result', fr: 'Aucun rÃ©sultat', ar: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬' },
			'assignee.remove': { en: 'Remove', fr: 'Retirer', ar: 'Ø¥Ø²Ø§Ù„Ø©' },
			'assignee.clear_badge': { en: 'Unselect', fr: 'DÃ©sÃ©lectionner', ar: 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯' },
			'assignee.select_all': { en: 'Select All', fr: 'Tout sÃ©lectionner', ar: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„' },
			'assignee.clear_all': { en: 'Clear', fr: 'Effacer', ar: 'Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„' },
			'modal.lead': { en: 'Lead', fr: 'Responsable', ar: 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„' },
			'modal.members': { en: 'members', fr: 'membres', ar: 'Ø£Ø¹Ø¶Ø§Ø¡' },
			'toast.close': { en: 'Close', fr: 'Fermer', ar: 'Ø¥ØºÙ„Ø§Ù‚' },
			'notification.none': { en: 'No notifications', fr: 'Aucune notification', ar: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' }
		};


		function resolveDirectorLocale(key, fallback = '', replacements = {}) {
			const lang = getCurrentLanguage();
			const bucket = directorModalLocale[key];
			let value = bucket ? (bucket[lang] || bucket.en || fallback || '') : (fallback || '');
			if (value && replacements) {
				Object.entries(replacements).forEach(([token, val]) => {
					const regex = new RegExp(`{{\\s*${token}\\s*}}`, 'g');
					value = value.replace(regex, val);
				});
			}
			return value;
		}

		function updateDirAssigneeCountDisplay() {
			const count = dirSelectedEmployeeIds ? dirSelectedEmployeeIds.size : 0;
			const label = document.getElementById('dirAssigneeCountLabel');
			if (label) {
				const templateKey = label.dataset.localeTemplate || 'modal.selected_template';
				label.innerHTML = resolveDirectorLocale(templateKey, label.innerHTML || '', {
					count: `<span id="dirAssigneeCount">${count}</span>`
				});
			}
		}

		function updateDirectorModalOverview() {
			const totalTasksEl = document.getElementById('dirModalTaskTotal');
			if (!totalTasksEl) return;
			const tasksTotal = Array.isArray(allTasks) ? allTasks.length : 0;
			const employeesTotal = Array.isArray(employees) ? employees.length : 0;
			const selected = dirSelectedEmployeeIds ? dirSelectedEmployeeIds.size : 0;
			const taskDisplayed = document.getElementById('dirModalTaskDisplayed');
			const empTotalEl = document.getElementById('dirModalEmployeeTotal');
			const empSelectedEl = document.getElementById('dirModalEmployeeSelected');
			totalTasksEl.textContent = tasksTotal;
			if (taskDisplayed) taskDisplayed.textContent = selected || tasksTotal;
			if (empTotalEl) empTotalEl.textContent = employeesTotal;
			if (empSelectedEl) empSelectedEl.textContent = selected;
			const pageEl = document.getElementById('dirModalPageLabel');
			if (pageEl) {
				const pages = Math.max(1, Math.ceil(Math.max(selected, 1) / 10));
				pageEl.dataset.localePage = '1';
				pageEl.dataset.localePages = String(pages);
				pageEl.textContent = resolveDirectorLocale('modal.hero_page', 'Page 1 / 1', { page: '1', pages: String(pages) });
			}
		}

		function updateAssigneeSelectedBadge(count) {
			const badge = document.querySelector('[data-locale-count-badge="true"]');
			if (badge) {
				const value = resolveDirectorLocale('assignee.count_template', `${count}`, { count });
				badge.textContent = value;
			}
		}

		function applyDirectorModalLocalization() {
			try {
				const lang = getCurrentLanguage();
				const isRTL = lang === 'ar';
				if (document.documentElement) {
					document.documentElement.setAttribute('dir', isRTL ? 'rtl' : 'ltr');
				}
				if (document.body) {
					document.body.classList.toggle('dir-lang-ar', isRTL);
				}
				document.querySelectorAll('[data-locale-key]').forEach((el) => {
					const key = el.dataset.localeKey;
					if (!key) return;
					const replacements = {};
					if (el.dataset.localeCount) replacements.count = el.dataset.localeCount;
					if (el.dataset.localePage) replacements.page = el.dataset.localePage;
					if (el.dataset.localePages) replacements.pages = el.dataset.localePages;
					el.textContent = resolveDirectorLocale(key, el.textContent, replacements);
				});
				document.querySelectorAll('[data-locale-placeholder]').forEach((el) => {
					const key = el.dataset.localePlaceholder;
					if (!key) return;
					el.setAttribute('placeholder', resolveDirectorLocale(key, el.getAttribute('placeholder') || ''));
				});
				document.querySelectorAll('[data-locale-title]').forEach((el) => {
					const key = el.dataset.localeTitle;
					if (!key) return;
					el.setAttribute('title', resolveDirectorLocale(key, el.getAttribute('title') || ''));
				});
				updateDirAssigneeCountDisplay();
				updatePickerCount();
				updateAssigneeSelectedBadge(dirSelectedEmployeeIds ? dirSelectedEmployeeIds.size : 0);
			} catch (err) {
				console.warn('applyDirectorModalLocalization failed', err);
			}
		}
		if (typeof window !== 'undefined') {
			window.applyDirectorModalLocalization = applyDirectorModalLocalization;
		}
		document.addEventListener('languageChanged', () => {
			try {
				switchView(currentView);
			} catch (err) {
				console.warn('Language change refresh failed', err);
			}
		});
		// ===== Toasts (success / error) =====
		(function () {
			function createToast(type, title, message, duration) {
				try {
					const root = document.getElementById('toastRoot'); if (!root) return;
					const el = document.createElement('div');
					el.className = 'toast ' + (type === 'error' ? 'toast-error' : 'toast-success');
					el.setAttribute('role', 'status');
					el.innerHTML = `
							<div class="toast-icon">${type === 'error' ? '<i class="fas fa-times"></i>' : '<i class="fas fa-check"></i>'}</div>
							<div class="min-w-0">
								<div class="toast-title">${title || ''}</div>
								${message ? `<div class="toast-body">${message}</div>` : ''}
								<div class="toast-progress"><span></span></div>
							</div>
							<button class="toast-close" aria-label="Fermer"><i class="fas fa-times"></i></button>
						`;
					root.appendChild(el);
					const closeBtn = el.querySelector('.toast-close');
					let timer = setTimeout(() => dismiss(), Math.max(2000, duration || 3200));
					function dismiss() { try { el.style.animation = 'toast-out 180ms ease-in forwards'; setTimeout(() => { el.remove(); }, 170); } catch (_) { } }
					if (closeBtn) { closeBtn.addEventListener('click', () => { clearTimeout(timer); dismiss(); }); }
					return el;
				} catch (_) {/* noop */ }
			}
			window.showToast = function (optsOrType, title, message, duration) {
				if (typeof optsOrType === 'string') return createToast(optsOrType, title, message, duration);
				const o = optsOrType || {}; return createToast(o.type, o.title, o.message, o.duration);
			};
		})();
		const API = (function () {
			try {
				// Check if embedded and parent has API configuration
				if (window.parent && window.parent !== window && window.parent.API_BASE) {
					return window.parent.API_BASE;
				}
				// Check for window.API_BASE (set by other scripts)
				if (window.API_BASE) {
					return window.API_BASE;
				}
				const origin = (window.location && window.location.origin) || '';
				const hostname = (window.location && window.location.hostname) || '';
				const port = window.location.port || '';
				// Treat VS Code Live Server style ports (commonly 5500-5599) as dev mode
				const portNumber = parseInt(port, 10);
				const isLiveServerPort = !Number.isNaN(portNumber) && portNumber >= 5500 && portNumber <= 5599;
				const isLocalHost = /^(127\.0\.0\.1|localhost)$/i.test(hostname || '');
				if ((isLocalHost && isLiveServerPort) || !origin || !/^https?:\/\//i.test(origin)) {
					return 'http://localhost:3020';
				}
				return origin;
			} catch (_) {
				return 'http://localhost:3020';
			}
		})();

		// Helper function to get department service URL
		function getDepartmentServiceURL() {
			try {
				// Check parent window for API_SERVICES
				if (window.parent && window.parent !== window && window.parent.API_SERVICES) {
					return window.parent.API_SERVICES.departments || 'http://localhost:3003';
				}
				// Check current window
				if (window.API_SERVICES && window.API_SERVICES.departments) {
					return window.API_SERVICES.departments;
				}
				// Default to department-service port
				return 'http://localhost:3003';
			} catch (_) {
				return 'http://localhost:3003';
			}
		}

		// Helper function to get auth headers
		function getAuthHeaders() {
			try {
				const authToken = (() => {
					// First try: parent window's authManager (when embedded)
					try {
						if (window.parent && window.parent !== window && window.parent.authManager) {
							const token = window.parent.authManager.getToken();
							if (token) {
								// Sync to localStorage for fallback
								localStorage.setItem('token', token);
								return token;
							}
						}
					} catch (e) {
						console.warn('Could not access parent authManager:', e);
					}

					// Second try: local authManager (if auth.js is included)
					if (typeof authManager !== 'undefined' && authManager && authManager.getToken) {
						const token = authManager.getToken();
						if (token) return token;
					}

					// Third try: localStorage
					return localStorage.getItem('token');
				})();

				return authToken ? {
					'Authorization': `Bearer ${authToken}`,
					'Content-Type': 'application/json'
				} : {
					'Content-Type': 'application/json'
				};
			} catch (_) {
				return { 'Content-Type': 'application/json' };
			}
		}

		// Helper function to get user-management service URL
		function getUserManagementServiceURL() {
			try {
				// Check parent window for API_SERVICES
				if (window.parent && window.parent !== window && window.parent.API_SERVICES) {
					return window.parent.API_SERVICES.users || 'http://localhost:3002';
				}
				// Check current window
				if (window.API_SERVICES && window.API_SERVICES.users) {
					return window.API_SERVICES.users;
				}
				// Default to user-management-service port
				return 'http://localhost:3002';
			} catch (_) {
				return 'http://localhost:3002';
			}
		}

		// Helper function to fetch all employees (tries user-management-service first, falls back to hr_tasks)
		async function fetchAllEmployees() {
			const userServiceURL = getUserManagementServiceURL();
			const authHeaders = getAuthHeaders();

			try {
				// Try user-management-service first
				const res = await fetch(`${userServiceURL}/employees`, { headers: authHeaders });
				if (res.ok) {
					const employees = await res.json();
					console.log(`? Employï¿½s chargï¿½s depuis user-management-service:`, employees.length);
					return Array.isArray(employees) ? employees : [];
				}
			} catch (err) {
				console.warn(`?? Erreur avec user-management-service, fallback vers hr_tasks:`, err);
			}

			// Fallback to hr_tasks service
			try {
				const res = await fetch(`${API}/employees`);
				if (res.ok) {
					const employees = await res.json();
					console.log(`? Employï¿½s chargï¿½s depuis hr_tasks:`, employees.length);
					return Array.isArray(employees) ? employees : [];
				}
			} catch (err) {
				console.error(`? Erreur chargement employï¿½s:`, err);
			}

			return [];
		}

		// Helper function to fetch responsibles (calculates from departments loaded from department-service)
		async function fetchResponsibles() {
			try {
				// Responsibles are employees who are responsible for departments
				// Since we already have departments loaded, we can extract responsibles from them
				if (departments && departments.length > 0) {
					const responsibleIds = new Set();
					departments.forEach(dept => {
						if (dept.responsible_id) {
							responsibleIds.add(String(dept.responsible_id));
						}
					});

					// Get all employees first
					const allEmployees = await fetchAllEmployees();

					// Filter to get only responsibles
					const responsibles = allEmployees.filter(emp =>
						responsibleIds.has(String(emp.id))
					);

					console.log(`? Responsables calculï¿½s depuis dï¿½partements:`, responsibles.length);
					return responsibles;
				}

				// Fallback: try hr_tasks service
				const res = await fetch(`${API}/api/reports/responsibles`);
				if (res.ok) {
					const data = await res.json();
					const responsibles = Array.isArray(data) ? data : (data.responsibles || data.data || []);
					console.log(`? Responsables chargï¿½s depuis hr_tasks:`, responsibles.length);
					return responsibles;
				}
			} catch (err) {
				console.error(`? Erreur chargement responsables:`, err);
			}

			return [];
		}

		// Helper function to fetch department employees (tries department-service first, falls back to hr_tasks)
		async function fetchDepartmentEmployees(deptId) {
			const deptServiceURL = getDepartmentServiceURL();
			const authHeaders = getAuthHeaders();

			try {
				// Try department-service first: /departments/:id returns department with employees array
				const deptRes = await fetch(`${deptServiceURL}/departments/${deptId}`, { headers: authHeaders });
				if (deptRes.ok) {
					const deptData = await deptRes.json();
					// department-service returns department object with employees array
					if (deptData.employees && Array.isArray(deptData.employees)) {
						console.log(`? Employï¿½s chargï¿½s depuis department-service pour dï¿½partement ${deptId}:`, deptData.employees.length);
						return deptData.employees;
					}
				}
			} catch (err) {
				console.warn(`?? Erreur avec department-service, fallback vers hr_tasks:`, err);
			}

			// Fallback to hr_tasks service
			try {
				const res = await fetch(`${API}/departments/${deptId}/employees`);
				if (res.ok) {
					const employees = await res.json();
					console.log(`? Employï¿½s chargï¿½s depuis hr_tasks pour dï¿½partement ${deptId}:`, employees.length);
					return Array.isArray(employees) ? employees : [];
				}
			} catch (err) {
				console.error(`? Erreur chargement employï¿½s dï¿½partement ${deptId}:`, err);
			}

			return [];
		}
		// Add a small debounce utility
		function debounce(fn, delay) { let t; return function (...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), delay); }; }
		let allTasks = [];
		let departments = [];
		let employees = [];
		let responsibles = [];
		let currentView = 'responsibles';
		const TASKS_PER_PAGE = 10;
		let dirTaskFilteredCache = [];
		let dirTaskCurrentPage = 1;
		
		// All Tasks state variables
		let allTasksCurrentViewMode = 'cards'; // 'cards' or 'list'
		let allTasksSortOrder = 'asc'; // 'asc' or 'desc'
		let allTasksCurrentPage = 1;
		
		// Notifications state
		let notifTimer = null;
		let lastNotifAt = null;
		window.__notifications = window.__notifications || [];
		let notifUnreadCount = 0;
		// Index des dï¿½partements par employï¿½ et map deptId -> dept
		const employeeDeptIds = new Map();
		const deptIdToDept = new Map();

		function formatDate(s) {
			if (!s) return 'Non dï¿½finie';
			const d = new Date(s);
			return d.toLocaleDateString('fr-FR');
		}

		function sortAllTasksByLanguage(items) {
			const currentLang = typeof currentLanguage !== 'undefined' ? currentLanguage : (window.currentLanguage || 'en');
			console.log('Sorting All Tasks:', items.length, 'items, order:', allTasksSortOrder);

			return [...items].sort((a, b) => {
				const textA = a.title || '';
				const textB = b.title || '';

				let comparison = 0;

				// Arabic sorting
				if (currentLang === 'ar') {
					comparison = textA.localeCompare(textB, 'ar', { sensitivity: 'base' });
				}
				// French sorting
				else if (currentLang === 'fr') {
					comparison = textA.localeCompare(textB, 'fr', { sensitivity: 'base', ignorePunctuation: true });
				}
				// English sorting (default)
				else {
					comparison = textA.localeCompare(textB, 'en', { sensitivity: 'base' });
				}

				return allTasksSortOrder === 'asc' ? comparison : -comparison;
			});
		}

		function updateSortIcon(icon, order) {
			if (order === 'asc') {
				icon.className = 'fas fa-sort-alpha-down';
			} else {
				icon.className = 'fas fa-sort-alpha-up';
			}
		}

		function isOverdue(task) {
			return task.status !== 'Completed' && task.due_date && new Date(task.due_date) < new Date();
		}

		function getStatusBadge(status) {
			const badges = {
				'Completed': 'bg-green-100 text-green-800',
				'In Progress': 'bg-yellow-100 text-yellow-800',
				'Pending': 'bg-blue-100 text-blue-800',
				'Not Done': 'bg-red-100 text-red-800'
			};
			return badges[status] || 'bg-gray-100 text-gray-800';
		}

		function getPriorityBadge(priority) {
			const badges = {
				'High': 'bg-red-100 text-red-800',
				'Medium': 'bg-yellow-100 text-yellow-800',
				'Low': 'bg-green-100 text-green-800'
			};
			return badges[priority] || 'bg-gray-100 text-gray-800';
		}

		async function loadCore() {
			try {
				console.log('?? Chargement des donnï¿½es principales...');

				// Use helper functions for department service
				const deptServiceURL = getDepartmentServiceURL();
				const authHeaders = getAuthHeaders();

				console.log('?? Department Service URL:', deptServiceURL);
				console.log('?? HR Tasks API URL:', API);

				const [tasksRes, deptRes] = await Promise.all([
					fetch(`${API}/tasks`).catch(err => { console.error('? Erreur fetch tasks:', err); return null; }),
					fetch(`${deptServiceURL}/departments`, { headers: authHeaders }).catch(err => {
						console.error('? Erreur fetch departments from department-service:', err);
						// Fallback to hr_tasks service
						console.log('?? Fallback: Trying hr_tasks service for departments...');
						return fetch(`${API}/departments`).catch(e => {
							console.error('? Erreur fetch departments from hr_tasks:', e);
							return null;
						});
					})
				]);

				// Load tasks
				if (tasksRes && tasksRes.ok) {
					allTasks = await tasksRes.json();
					console.log('? Tï¿½ches chargï¿½es:', allTasks.length);
				} else {
					allTasks = [];
					console.warn('?? Aucune tï¿½che chargï¿½e (status:', tasksRes?.status || 'no response', ')');
				}

				// Load departments
				console.log('?? ========== LOADING DEPARTMENTS ==========');
				console.log('?? Department Service URL:', deptServiceURL);
				console.log('?? Fallback HR Tasks URL:', `${API}/departments`);
				if (deptRes && deptRes.ok) {
					const deptData = await deptRes.json();
					console.log('?? Raw departments response (type):', Array.isArray(deptData) ? 'Array' : typeof deptData);
					console.log('?? Raw departments response (length/keys):', Array.isArray(deptData) ? deptData.length : Object.keys(deptData));
					console.log('?? Raw departments response (full):', JSON.stringify(deptData, null, 2));

					// Handle both array and object with departments property
					departments = Array.isArray(deptData) ? deptData : (deptData.departments || deptData.data || []);
					console.log('? Dï¿½partements chargï¿½s:', departments.length);

					// Detailed logging of each department
					console.log('?? Dï¿½tails de chaque dï¿½partement:');
					departments.forEach((d, index) => {
						console.log(`  ${index + 1}. ID: ${d.id}`);
						console.log(`     Name: "${d.name}"`);
						console.log(`     Responsible ID: ${d.responsible_id || 'NULL'}`);
						console.log(`     Employee Count: ${d.employee_count || 0}`);
						console.log(`     Full object:`, d);
					});

					// Check for expected departments
					const expectedNames = ['depa', 'Direction', 'new teck', 'Ressources Humaines', 'teachers', 'Informatique'];
					const foundNames = departments.map(d => d.name).filter(Boolean);
					console.log('?? Vï¿½rification des dï¿½partements attendus:');
					expectedNames.forEach(name => {
						const found = foundNames.includes(name);
						console.log(`  "${name}": ${found ? '? TROUVï¿½' : '? NON TROUVï¿½'}`);
					});

					if (departments.length === 0) {
						console.warn('?? Aucun dï¿½partement trouvï¿½');
					} else if (departments.length < 5) {
						console.warn(`?? Seulement ${departments.length} dï¿½partements chargï¿½s, il devrait y en avoir 5 (depa, Direction, new teck, Ressources Humaines, teachers)`);
						console.warn(`?? Dï¿½partements manquants:`, expectedNames.filter(name => !foundNames.includes(name)));
					} else {
						console.log(`? Tous les dï¿½partements attendus sont prï¿½sents! (${departments.length} dï¿½partements)`);
					}
					console.log('? ========== END LOADING DEPARTMENTS ==========');
				} else {
					departments = [];
					console.error('? Erreur chargement dï¿½partements (status:', deptRes?.status || 'no response', ')');
					if (deptRes) {
						const errorText = await deptRes.text().catch(() => '');
						console.error('? Error response body:', errorText);
					}
					console.log('? ========== END LOADING DEPARTMENTS (ERROR) ==========');
				}

				// Load employees using new helper function (after departments are loaded)
				console.log('?? ========== LOADING EMPLOYEES ==========');
				employees = await fetchAllEmployees();
				console.log('? ========== END LOADING EMPLOYEES ==========');

				// Load responsibles using new helper function (after departments and employees are loaded)
				// This depends on both departments and employees being loaded
				console.log('?? ========== LOADING RESPONSIBLES ==========');
				responsibles = await fetchResponsibles();
				console.log('? ========== END LOADING RESPONSIBLES ==========');

				// Prï¿½parer deptId -> dept
				deptIdToDept.clear();
				(departments || []).forEach(d => { deptIdToDept.set(String(d.id), d); });

				console.log('?? Donnï¿½es chargï¿½es:', {
					allTasks: allTasks.length,
					departments: departments.length,
					employees: employees.length,
					responsibles: responsibles.length
				});
			} catch (error) {
				console.error('? Erreur lors du chargement:', error);
				// Set defaults to prevent undefined errors
				allTasks = allTasks || [];
				departments = departments || [];
				employees = employees || [];
				responsibles = responsibles || [];
			}
		}

		// Construire l'index employï¿½ -> dï¿½partements (via /departments/:id/employees)
		async function buildEmployeeDeptIndex() {
			try {
				employeeDeptIds.clear();
				await Promise.all((departments || []).map(async d => {
					try {
						const list = await fetchDepartmentEmployees(d.id);
						(list || []).forEach(e => {
							const key = String(e.id);
							if (!employeeDeptIds.has(key)) employeeDeptIds.set(key, new Set());
							employeeDeptIds.get(key).add(String(d.id));
						});
					} catch (_) {/* ignore */ }
				}));
			} catch (e) { console.warn('buildEmployeeDeptIndex error', e); }
		}

		function updateKPIs() {
			const all = Array.isArray(allTasks) ? allTasks : [];
			const directorId = getDirectorEmployeeId && getDirectorEmployeeId();

			// Global snapshot: tasks, my tasks, my instructions, responsibles
			const totalTasks = all.length;
			const myTasks = directorId
				? all.filter(t => String(t.assigned_by) === String(directorId) && !String(t.title || '').startsWith('Instruction:')).length
				: 0;
			const myInstructions = directorId
				? all.filter(t => String(t.assigned_by) === String(directorId) && String(t.title || '').startsWith('Instruction:')).length
				: 0;
			const resp = Array.isArray(responsibles) ? responsibles.length : 0;

			const elAll = document.getElementById('kpiAllTasks'); if (elAll) elAll.textContent = totalTasks;
			const elMine = document.getElementById('kpiMyTasks'); if (elMine) elMine.textContent = myTasks;
			const elInstr = document.getElementById('kpiMyInstructions'); if (elInstr) elInstr.textContent = myInstructions;
			const elResp = document.getElementById('kpiResponsibles'); if (elResp) elResp.textContent = resp;
		}

		// Vue Dï¿½partements
		async function renderDepartmentsView() {
			const content = document.getElementById('dynamicContent');
			content.innerHTML = '<div class="flex justify-center items-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-600"></i><span class="ml-2 text-gray-700">Chargement...</span></div>';

			// Ensure departments is initialized
			if (!departments || !Array.isArray(departments)) {
				console.warn('?? Dï¿½partements non initialisï¿½s, rï¿½essai de chargement...');
				departments = [];
				// Try to reload if not loaded
				if (departments.length === 0) {
					await loadCore();
				}
			}

			let departmentCards = '';

			if (departments.length === 0) {
				content.innerHTML = `
					<div class="space-y-6">
						<h2 class="text-2xl font-bold text-gray-900 mb-6">
							<i class="fas fa-building mr-2"></i>Vue par Dï¿½partements
						</h2>
						<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
							<div class="flex items-center">
								<i class="fas fa-exclamation-triangle text-yellow-600 mr-3 text-xl"></i>
								<div>
									<h3 class="text-lg font-semibold text-yellow-800">Aucun dï¿½partement trouvï¿½</h3>
									<p class="text-yellow-700 mt-1">Les dï¿½partements n'ont pas pu ï¿½tre chargï¿½s. Vï¿½rifiez la console pour plus de dï¿½tails.</p>
									<button onclick="loadCore().then(() => renderDepartmentsView())" class="mt-3 px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
										<i class="fas fa-sync-alt mr-2"></i>Rï¿½essayer
									</button>
								</div>
							</div>
						</div>
					</div>
				`;
				return;
			}

			console.log(`?? Rendu de ${departments.length} dï¿½partements...`);
			for (let i = 0; i < departments.length; i++) {
				const dept = departments[i];
				console.log(`?? Traitement dï¿½partement ${i + 1}/${departments.length}:`, { id: dept.id, name: dept.name });
				if (!dept.id || !dept.name) {
					console.warn(`?? Dï¿½partement invalide ignorï¿½:`, dept);
					continue;
				}
				try {
					// Rï¿½cupï¿½rer les employï¿½s du dï¿½partement
					const deptEmployees = await fetchDepartmentEmployees(dept.id);
					console.log(`  ?? ${deptEmployees.length} employï¿½s trouvï¿½s pour ${dept.name}`);

					// Trouver le responsable du dï¿½partement via departments.responsible_id
					let responsible = null;
					if (dept.responsible_id) {
						responsible = employees.find(e => String(e.id) === String(dept.responsible_id)) ||
							deptEmployees.find(e => String(e.id) === String(dept.responsible_id)) || null;
					}

					// Tï¿½ches du dï¿½partement
					const deptEmpIds = new Set(deptEmployees.map(e => e.id));
					const deptTasks = allTasks.filter(t =>
						(t.assignees || []).some(a => deptEmpIds.has(a.id))
					);

					const completed = deptTasks.filter(t => t.status === 'Completed').length;
					const inProgress = deptTasks.filter(t => t.status === 'In Progress' || t.status === 'Pending').length;
					const overdue = deptTasks.filter(isOverdue).length;

					const totalEmployees = deptEmployees.length;

					departmentCards += `
						<div class="card-modern rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300">
							<div class="p-6 bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 text-white">
								<div class="flex items-start justify-between gap-4">
									<div class="flex-1 min-w-0">
										<div class="flex items-center gap-3 mb-2">
											<div class="p-3 bg-white/20 backdrop-blur-sm rounded-xl">
												<i class="fas fa-building text-2xl"></i>
											</div>
											<div class="flex-1 min-w-0">
												<h3 class="text-xl font-bold truncate">${dept.name}</h3>
												<p class="text-white/90 text-sm mt-1 line-clamp-2">${dept.description || 'No description'}</p>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="p-6 bg-white">
								<div class="space-y-4">
									<div class="flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
										<div class="flex items-center gap-3">
											<div class="p-2 bg-blue-100 rounded-lg">
												<i class="fas fa-user-tie text-blue-600"></i>
											</div>
											<div>
												<p class="text-xs text-gray-600 font-medium">Responsible</p>
												<p class="text-sm font-semibold text-gray-900">${responsible ? `${responsible.first_name || ''} ${responsible.last_name || ''}` : 'Not assigned'}</p>
											</div>
										</div>
									</div>
									<div class="grid grid-cols-2 gap-3">
										<div class="p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
											<div class="flex items-center gap-2 mb-1">
												<i class="fas fa-users text-indigo-600"></i>
												<span class="text-xs text-gray-600 font-medium">Employees</span>
											</div>
											<p class="text-2xl font-bold text-indigo-700">${totalEmployees}</p>
										</div>
										<div class="p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-100">
											<div class="flex items-center gap-2 mb-1">
												<i class="fas fa-tasks text-green-600"></i>
												<span class="text-xs text-gray-600 font-medium">Tasks</span>
											</div>
											<p class="text-2xl font-bold text-green-700">${deptTasks.length}</p>
										</div>
									</div>
									<button class="w-full px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-medium transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center gap-2" onclick="showDepartmentEmployees('${dept.id}')">
										<i class="fas fa-user-group"></i>
										<span>View Employees</span>
									</button>
								</div>
							</div>
						</div>
					`;
				} catch (error) {
					console.error(`? Erreur pour le dï¿½partement ${dept.name}:`, error);
					// Still show the department card even if employee fetch fails
					departmentCards += `
						<div class="bg-white rounded-2xl shadow-md ring-2 ring-black border border-black overflow-hidden">
							<div class="p-6 border-b bg-gradient-to-r from-indigo-50 to-white">
								<div class="flex items-start justify-between gap-4">
									<div class="min-w-0">
										<div class="inline-flex items-center gap-2 mb-1">
											<span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-100 text-indigo-700"><i class="fas fa-building"></i></span>
											<h3 class="text-xl font-semibold text-gray-900 truncate">${dept.name}</h3>
										</div>
										<p class="text-gray-600">${dept.description || 'Aucune description'}</p>
									</div>
								</div>
							<div class="p-6">
								<div class="bg-red-50 border border-red-200 rounded-lg p-4">
									<p class="text-red-700 text-sm"><i class="fas fa-exclamation-circle mr-2"></i>Erreur lors du chargement des donnï¿½es</p>
								</div>
							</div>
						</div>
					`;
				}
			}

			const renderedCount = (departmentCards.match(/<div class="bg-white rounded-2xl/g) || []).length;
			console.log(`? Rendu terminï¿½: ${renderedCount} cartes de dï¿½partements crï¿½ï¿½es sur ${departments.length} dï¿½partements chargï¿½s`);

			if (renderedCount < departments.length) {
				console.warn(`?? Attention: ${departments.length - renderedCount} dï¿½partements n'ont pas ï¿½tï¿½ rendus!`);
			}

			content.innerHTML = `
				<div class="space-y-6">
					<div class="flex items-center justify-between mb-6">
						<div>
							<h2 class="text-3xl font-bold text-gray-900 mb-2">
								<i class="fas fa-building mr-3 text-indigo-600"></i>Departments View
							</h2>
							<p class="text-gray-600">${renderedCount} department${renderedCount !== 1 ? 's' : ''} found</p>
						</div>
					</div>
					<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${departmentCards}</div>
				</div>
			`;

			// Ajouter les event listeners pour les filtres existants si besoin (retirï¿½ ici pour clartï¿½)
		}

		function getInitials(first, last) {
			const a = (first || '').trim().charAt(0).toUpperCase();
			const b = (last || '').trim().charAt(0).toUpperCase();
			return (a + b) || '?';
		}

		async function showDepartmentEmployees(deptId) {
			try {
				const details = await fetchDepartmentEmployees(deptId);

				const cards = details.map(emp => {
					const name = `${emp.first_name || ''} ${emp.last_name || ''}`.trim();
					const email = emp.email || '';
					const phone = emp.phone || '';
					const nationality = emp.nationality || '';
					const joinDate = emp.join_date ? new Date(emp.join_date).toLocaleDateString('fr-FR') : '';
					const address = emp.address || '';
					const avatar = emp.profile_picture_url || '';

					return `
				<div class="card-modern rounded-2xl overflow-hidden hover:shadow-xl transition-all duration-300">
					<div class="p-6 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-500 text-white">
						<div class="flex flex-col items-center text-center gap-3">
							<div class="h-20 w-20 rounded-full bg-white/20 backdrop-blur-sm border-2 border-white/30 flex items-center justify-center overflow-hidden shadow-lg">
								${avatar
							? `<img src="${avatar}" alt="${name}" class="h-full w-full object-cover"/>`
							: `<span class="font-bold text-xl">${getInitials(emp.first_name, emp.last_name)}</span>`}
							</div>
							<div class="min-w-0">
								<div class="font-bold text-lg truncate">${name || 'ï¿½'}</div>
								<div class="text-sm text-white/90 truncate mt-1">${emp.position || t('common.no_position')}</div>
							</div>
						</div>
					</div>

					<div class="p-5 bg-white">
						<div class="space-y-3">
							${email ? `<div class="flex items-center gap-2 p-2 bg-blue-50 rounded-lg"><i class="fas fa-envelope text-blue-600"></i><span class="text-xs text-gray-700 truncate">${email}</span></div>` : ''}
							${phone ? `<div class="flex items-center gap-2 p-2 bg-purple-50 rounded-lg"><i class="fas fa-phone text-purple-600"></i><span class="text-xs text-gray-700">${phone}</span></div>` : ''}
							${joinDate ? `<div class="flex items-center gap-2 p-2 bg-indigo-50 rounded-lg"><i class="fas fa-calendar text-indigo-600"></i><span class="text-xs text-gray-700">${t('employee.join_date')}: ${joinDate}</span></div>` : ''}
							${nationality ? `<div class="flex items-center gap-2 p-2 bg-green-50 rounded-lg"><i class="fas fa-globe text-green-600"></i><span class="text-xs text-gray-700">${nationality}</span></div>` : ''}
							${address ? `<div class="flex items-center gap-2 p-2 bg-pink-50 rounded-lg"><i class="fas fa-map-marker-alt text-pink-600"></i><span class="text-xs text-gray-700 truncate">${address}</span></div>` : ''}
						</div>
					</div>
				</div>
			`;
				}).join('');

				document.getElementById('modalTitle').textContent = t('director.department_employees');
				document.getElementById('modalContent').innerHTML = `
			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
				${cards || `<div class="col-span-full text-center py-12"><i class="fas fa-users text-4xl text-gray-300 mb-3"></i><p class="text-gray-600">${t('director.no_employees_found')}</p></div>`}
			</div>
		`;
				document.getElementById('employeeDetailsModal').classList.remove('hidden');
				document.body.classList.add('overflow-hidden');
			} catch (e) {
				console.error('showDepartmentEmployees error', e);
			}
		}


		// ensure global access for inline onclick
		window.showDepartmentEmployees = showDepartmentEmployees;

		// Vue Responsables (basï¿½ sur departments.responsible_id et employee_departments)
		async function renderResponsiblesView() {
			const content = document.getElementById('dynamicContent');
			let responsibleCards = '';
			for (const resp of responsibles) {
				// Dï¿½partements gï¿½rï¿½s par ce responsable
				const managedDepts = departments.filter(d => String(d.responsible_id) === String(resp.id));
				// Rï¿½cupï¿½rer les employï¿½s via /departments/:id/employees (reliï¿½ ï¿½ employee_departments)
				let respEmployees = [];
				for (const d of managedDepts) {
					try {
						const list = await fetchDepartmentEmployees(d.id);
						respEmployees = respEmployees.concat(list);
					} catch (_) { }
				}
				// Unifier par id
				const uniqueIds = new Set(respEmployees.map(e => e.id));
				respEmployees = Array.from(uniqueIds).map(id => respEmployees.find(e => e.id === id)).filter(Boolean);
				const empIds = new Set(respEmployees.map(e => e.id));
				// Tï¿½ches assignï¿½es au responsable ou ï¿½ ses employï¿½s
				const respTasks = allTasks.filter(t => (t.assignees || []).some(a => empIds.has(a.id) || String(a.id) === String(resp.id)));

				const completed = respTasks.filter(t => t.status === 'Completed').length;
				const inProgress = respTasks.filter(t => t.status === 'In Progress' || t.status === 'Pending').length;
				const overdue = respTasks.filter(isOverdue).length;
				const completionRate = respTasks.length > 0 ? Math.round((completed / respTasks.length) * 100) : 0;

				responsibleCards += `
				<div class="group relative bg-white rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 overflow-hidden border-2 border-gray-100 hover:border-blue-300 transform hover:-translate-y-2">
					<!-- Gradient Header -->
					<div class="relative bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 p-8 text-white overflow-hidden">
						<!-- Decorative circles -->
						<div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
						<div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
						
						<div class="relative z-10 flex items-center gap-5">
							<div class="w-20 h-20 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center text-white text-2xl font-black shadow-2xl border-2 border-white/30 group-hover:scale-110 transition-transform duration-300">
								${getInitials(resp.first_name, resp.last_name)}
							</div>
							<div class="flex-1">
								<h3 class="text-2xl font-black mb-1">${resp.first_name || ''} ${resp.last_name || ''}</h3>
								<p class="text-white/90 text-sm flex items-center gap-2">
									<i class="fas fa-envelope"></i>
									${resp.email || 'No email'}
								</p>
							</div>
							<div class="text-right">
								<div class="text-xs text-white/80 font-semibold mb-1">Completion Rate</div>
								<div class="text-3xl font-black">${completionRate}%</div>
							</div>
						</div>
					</div>

					<!-- Card Body -->
					<div class="p-8 space-y-6">
						<!-- Progress Bar -->
						<div class="space-y-2">
							<div class="flex justify-between text-xs font-bold text-gray-600">
								<span>Task Progress</span>
								<span>${completed} / ${respTasks.length}</span>
							</div>
							<div class="h-3 bg-gray-100 rounded-full overflow-hidden shadow-inner">
								<div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all duration-500 shadow-lg" style="width: ${completionRate}%"></div>
							</div>
						</div>

						<!-- Stats Grid -->
						<div class="grid grid-cols-3 gap-4">
							<div class="bg-gradient-to-br from-blue-50 to-blue-100/50 rounded-2xl p-4 text-center border border-blue-200 hover:shadow-md transition-shadow">
								<div class="text-3xl font-black text-blue-600 mb-1">${respTasks.length}</div>
								<div class="text-xs font-bold text-blue-700 uppercase tracking-wide">Total Tasks</div>
							</div>
							<div class="bg-gradient-to-br from-green-50 to-green-100/50 rounded-2xl p-4 text-center border border-green-200 hover:shadow-md transition-shadow">
								<div class="text-3xl font-black text-green-600 mb-1">${completed}</div>
								<div class="text-xs font-bold text-green-700 uppercase tracking-wide">Completed</div>
							</div>
							<div class="bg-gradient-to-br from-purple-50 to-purple-100/50 rounded-2xl p-4 text-center border border-purple-200 hover:shadow-md transition-shadow">
								<div class="text-3xl font-black text-purple-600 mb-1">${respEmployees.length}</div>
								<div class="text-xs font-bold text-purple-700 uppercase tracking-wide">Team Size</div>
							</div>
						</div>

						<!-- Input Fields -->
						<form class="space-y-5" onsubmit="event.preventDefault();">
							<!-- Name Input -->
							<div class="relative">
								<label class="block text-xs font-black text-gray-500 uppercase tracking-wider mb-2">Full Name</label>
								<div class="relative">
									<i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
									<input type="text" 
										value="${resp.first_name || ''} ${resp.last_name || ''}" 
										class="w-full pl-12 pr-4 py-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-semibold text-gray-900 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all outline-none"
										placeholder="Enter name..." />
								</div>
							</div>

							<!-- Email Input -->
							<div class="relative">
								<label class="block text-xs font-black text-gray-500 uppercase tracking-wider mb-2">Email Address</label>
								<div class="relative">
									<i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
									<input type="email" 
										value="${resp.email || ''}" 
										class="w-full pl-12 pr-4 py-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-semibold text-gray-900 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all outline-none"
										placeholder="Enter email..." />
								</div>
							</div>

							<!-- Department Input -->
							<div class="relative">
								<label class="block text-xs font-black text-gray-500 uppercase tracking-wider mb-2">Departments</label>
								<div class="relative">
									<i class="fas fa-building absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
									<input type="text" 
										value="${managedDepts.map(d => d.name).join(', ') || 'No departments'}" 
										readonly
										class="w-full pl-12 pr-4 py-4 bg-gray-50 border-2 border-gray-200 rounded-xl font-semibold text-gray-700 cursor-not-allowed"
										placeholder="No departments assigned" />
								</div>
							</div>

							<!-- Status Badges -->
							<div class="space-y-2">
								<label class="block text-xs font-black text-gray-500 uppercase tracking-wider">Status</label>
								<div class="flex flex-wrap gap-2">
									<span class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl text-sm font-bold shadow-md">
										<i class="fas fa-check-circle"></i>
										Active
									</span>
									<span class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl text-sm font-bold shadow-md">
										<i class="fas fa-user-tie"></i>
										Director
									</span>
									${overdue > 0 ? `
									<span class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-xl text-sm font-bold shadow-md animate-pulse">
										<i class="fas fa-exclamation-triangle"></i>
										${overdue} Overdue
									</span>
									` : ''}
								</div>
							</div>
						</form>

						<!-- Action Buttons -->
						<div class="flex gap-3 pt-4 border-t-2 border-gray-100">
							<button class="flex-1 px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-bold transition-all duration-200 transform hover:scale-105 shadow-lg flex items-center justify-center gap-2">
								<i class="fas fa-eye"></i>
								View Profile
							</button>
							<button class="px-6 py-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold border border-gray-300 transition-all duration-200 shadow-sm hover:shadow-md flex items-center justify-center gap-2">
								<i class="fas fa-edit"></i>
								Edit
							</button>
						</div>
					</div>

					<!-- Hover Tooltip -->
					<div class="absolute -top-3 -right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
						<div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-xl">
							Click to manage
						</div>
					</div>
				</div>
			`;
			}

			content.innerHTML = `
			<div class="space-y-8">
				<!-- Header Section -->
				<div class="flex items-center justify-between">
					<div>
						<h2 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-gray-900 via-blue-900 to-indigo-900 mb-3">
							<i class="fas fa-user-tie mr-3 text-blue-600"></i>Responsibles
						</h2>
						<p class="text-gray-600 text-lg font-medium">Manage and edit responsible details with ease.</p>
					</div>
					<div class="flex gap-3">
						<button class="px-6 py-3 bg-white border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 hover:border-blue-500 font-medium transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-2">
							<i class="fas fa-filter"></i>
							Filter
						</button>
						<button class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-medium transition-all duration-200 transform hover:scale-105 shadow-lg flex items-center gap-2">
							<i class="fas fa-plus"></i>
							Add New
						</button>
					</div>
				</div>
				
				<!-- Cards Grid -->
				<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">${responsibleCards}</div>
			</div>
		`;
		}

		// Nouvelle Vue Responsables V2 (rï¿½plique repports.js) - Improved UI with language support
		async function renderResponsiblesViewV2() {
			const content = document.getElementById('dynamicContent');
			const options = responsibles.map(r => `<option value="${r.id}">${r.first_name || ''} ${r.last_name || ''}</option>`).join('');
			content.innerHTML = `
				<div class="dashboard-v-spacing-high">
					<!-- Modern Filters Section -->
					<section style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
						<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 16px;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
							<!-- Responsible Selector -->
							<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 16px; flex: 1;">
								<!-- Title -->
								<div style="display: flex; align-items: center; gap: 12px;">
									<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
										<i class="fas fa-user-tie" style="font-size: 14px;"></i>
									</div>
									<span style="font-size: 16px; font-weight: 600; color: #1e293b;" data-translate="director.filter_by_responsible">${t('director.filter_by_responsible')}</span>
								</div>
								
								<select id="responsibleSelectorV2" style="padding: 10px 16px; font-size: 14px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; color: #374151; min-width: 220px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; font-weight: 500;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'">
									${options}
								</select>
							</div>
							
							<!-- Action Buttons -->
							<div style="display: flex; align-items: center; gap: 10px;">
								<button id="refreshResponsibleData" style="padding: 8px 14px; font-size: 12px; font-weight: 600; color: #6b7280; background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" 
									onmouseover="this.style.background='linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
									onmouseout="this.style.background='linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
									<i class="fas fa-sync-alt" style="font-size: 12px;"></i>
									<span data-translate="director.refresh_data">${t('director.refresh_data')}</span>
								</button>
							</div>
						</div>
					</section>

					<div class="dir-resp-section" id="responsibleViewContainerV2"></div>
				</div>
			`;

			function updateResponsibleFilterSummary(responsibleId) {
				const nameEl = document.getElementById('dirSelectedResponsibleName');
				const initialsEl = document.getElementById('dirSelectedResponsibleInitials');
				const deptEl = document.getElementById('dirSelectedResponsibleDept');
				if (!nameEl) return;
				const resp = responsibles.find(r => String(r.id) === String(responsibleId));
				if (!resp) {
					nameEl.textContent = t('director.no_responsible_selected') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø­Ø¯Ø¯';
					if (initialsEl) initialsEl.textContent = '?';
					if (deptEl) deptEl.textContent = t('director.no_department_assigned') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯';
					return;
				}
				const deptNames = departments
					.filter(d => String(d.responsible_id) === String(resp.id))
					.map(d => d.name)
					.filter(Boolean)
					.join(', ') || t('director.no_department_assigned') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚Ø³Ù… Ù…Ø­Ø¯Ø¯';
				nameEl.textContent = `${resp.first_name || ''} ${resp.last_name || ''}`.trim() || t('director.unnamed_responsible') || 'Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
				if (initialsEl) initialsEl.textContent = getInitials(resp.first_name, resp.last_name);
				if (deptEl) deptEl.textContent = deptNames;
			}

			const selector = document.getElementById('responsibleSelectorV2');

			// Auto-select first responsible
			if (responsibles.length > 0) {
				const firstResponsibleId = responsibles[0].id;
				selector.value = firstResponsibleId;
				updateResponsibleFilterSummary(firstResponsibleId);
				await renderSelectedResponsibleV2(firstResponsibleId);
			} else {
				updateResponsibleFilterSummary(null);
			}

			selector.addEventListener('change', async (e) => {
				updateResponsibleFilterSummary(e.target.value);
				await renderSelectedResponsibleV2(e.target.value);
			});

			// Refresh button functionality
			const refreshBtn = document.getElementById('refreshResponsibleData');
			if (refreshBtn) {
				refreshBtn.addEventListener('click', async () => {
					const currentResponsibleId = selector.value;
					if (currentResponsibleId) {
						// Show loading state
						refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 12px;"></i><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</span>';
						refreshBtn.disabled = true;
						
						// Reload data and refresh view
						await loadCore();
						updateResponsibleFilterSummary(currentResponsibleId);
						await renderSelectedResponsibleV2(currentResponsibleId);
						
						// Restore button state
						refreshBtn.innerHTML = '<i class="fas fa-sync-alt" style="font-size: 12px;"></i><span data-translate="director.refresh">ØªØ­Ø¯ÙŠØ«</span>';
						refreshBtn.disabled = false;
					}
				});
			}

			// Initialize translations
			if (typeof updatePageTranslations === 'function') {
				updatePageTranslations();
			}
		}

		async function renderSelectedResponsibleV2(responsibleId) {
			const container = document.getElementById('responsibleViewContainerV2');
			if (!responsibleId) {
				container.innerHTML = `<div class="text-gray-500 p-6" data-translate="director.select_responsible_to_view">${t('director.select_responsible_to_view')}</div>`;
				return;
			}
			const resp = responsibles.find(r => String(r.id) === String(responsibleId));
			if (!resp) {
				container.innerHTML = `<div class="text-red-600 p-6" data-translate="director.responsible_not_found">${t('director.responsible_not_found')}</div>`;
				return;
			}
			const managedDepts = departments.filter(d => String(d.responsible_id) === String(resp.id));

			async function getEmployeesManagedByResponsible(respId) {
				const scopedDepts = respId === resp.id ? managedDepts : departments.filter(d => String(d.responsible_id) === String(respId));
				let result = [];
				for (const d of scopedDepts) {
					try {
						const list = await fetchDepartmentEmployees(d.id);
						result = result.concat(list);
					} catch (_) { }
				}
				const uniq = new Map();
				result.forEach(e => { if (e && !uniq.has(String(e.id))) uniq.set(String(e.id), e); });
				return Array.from(uniq.values());
			}

			const respEmployees = await getEmployeesManagedByResponsible(resp.id);
			let respTasks = allTasks.filter(t => (t.assignees || []).some(a => respEmployees.some(e => e.id === a.id) || String(a.id) === String(resp.id)));
			const activeBreakdownTab = (renderResponsibleContent && renderResponsibleContent.activeTab) ? renderResponsibleContent.activeTab : 'employee';
			const currentViewMode = window.__dirViewMode || 'tasks';
			let currentDateFilteredTasksV2 = respTasks;

			// -------- Time filter helpers (created_at) --------
			function filterTasksByPeriodV2(baseTasks, period) {
				const today = new Date();
				let startDate, endDate;
				switch (period) {
					case 'today':
						startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0, 0);
						endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59, 999);
						break;
					case 'week':
						const weekStart = new Date(today);
						weekStart.setDate(today.getDate() - today.getDay());
						startDate = new Date(weekStart.setHours(0, 0, 0, 0));
						endDate = new Date();
						break;
					case 'month':
						startDate = new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0, 0);
						endDate = new Date();
						break;
					case 'year':
						startDate = new Date(today.getFullYear(), 0, 1, 0, 0, 0, 0);
						endDate = new Date();
						break;
					default:
						return baseTasks;
				}
				return (baseTasks || []).filter(task => {
					const taskDate = new Date(task.created_at);
					return taskDate >= startDate && taskDate <= endDate;
				});
			}

			function filterTasksByCustomRangeV2(baseTasks, from, to) {
				const startDate = new Date(from);
				const endDate = new Date(to);
				endDate.setHours(23, 59, 59, 999);
				return (baseTasks || []).filter(task => {
					const d = new Date(task.created_at);
					return d >= startDate && d <= endDate;
				});
			}

			// Helper functions for priority styling
		function getPriorityGradient(priority) {
			switch (priority) {
				case 'High': return 'from-red-500 to-red-600';
				case 'Medium': return 'from-yellow-500 to-yellow-600';
				case 'Low': return 'from-green-500 to-green-600';
				default: return 'from-gray-500 to-gray-600';
			}
		}

		function getPriorityIcon(priority) {
			switch (priority) {
				case 'High': return 'fa-exclamation-triangle';
				case 'Medium': return 'fa-minus-circle';
				case 'Low': return 'fa-arrow-down';
				default: return 'fa-circle';
			}
		}

		function calculateEmployeeStatsForTasks(tasks) {
				const stats = {};
				(tasks || []).forEach(task => {
					(task.assignees || []).forEach(assignee => {
						const id = assignee.id;
						if (!stats[id]) stats[id] = { id, name: `${assignee.first_name || ''} ${assignee.last_name || ''}`.trim(), total: 0, completed: 0, inProgress: 0, overdue: 0 };
						stats[id].total++;
						if (assignee.status === 'Completed') stats[id].completed++;
						else if (assignee.status === 'In Progress' || assignee.status === 'Pending') stats[id].inProgress++;
						if (assignee.status !== 'Completed' && new Date(task.due_date) < new Date()) stats[id].overdue++;
					});
				});
				return Object.values(stats);
			}

			function generateResponsibleByEmployeeHTML(tasks) {
				const employeeStats = calculateEmployeeStatsForTasks(tasks);
				const t = (typeof window.translate === 'function') ? window.translate : ((typeof window.t === 'function') ? window.t : (key) => key);
				const tSafe = (key) => (typeof t === 'function') ? t(key) : (typeof translate === 'function' ? translate(key) : key);
				
				return `
					<section class="overflow-hidden">
						<div class="w-full p-6">
							<div class="mb-6">
								<div class="flex items-center justify-between gap-4" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
									<div>
										<h1 class="text-2xl font-bold text-gray-900" data-translate="director.people_grid">${t('director.people_grid') || 'People Grid'}</h1>
										<p class="text-gray-600" data-translate="director.people_grid_desc">${t('director.people_grid_desc') || 'View team workload distribution'}</p>
									</div>
									<div class="flex items-center space-x-2">
										<div class="flex items-center space-x-2">
											<button id="respEmployeeSortToggle" class="p-2 rounded-lg bg-gray-100 text-gray-600 transition-colors" title="Toggle Sort">
												<i class="fas fa-sort-alpha-down" id="respEmployeeSortIcon"></i>
											</button>
											<button id="respEmployeeViewModeCards" class="p-2 rounded-lg transition-colors bg-gray-100 text-gray-600" title="Cards View">
												<i class="fas fa-border-all"></i>
											</button>
											<button id="respEmployeeViewModeList" class="p-2 rounded-lg transition-colors" title="List View">
												<i class="fas fa-list"></i>
											</button>
										</div>
									</div>
								</div>
							</div>
							<div id="responsibleEmployeeList" class="p-6 w-full"></div>
						</div>
					</section>
				`;
			}

			function generateResponsibleByTaskHTML(tasks) {
				// Pagination state per responsible
				window.respTaskPageByResp = window.respTaskPageByResp || {};
				window._respTaskTotalPagesByResp = window._respTaskTotalPagesByResp || {};
				const t = (typeof window.translate === 'function') ? window.translate : ((typeof window.t === 'function') ? window.t : (key) => key);
				const tSafe = (key) => (typeof t === 'function') ? t(key) : (typeof translate === 'function' ? translate(key) : key);
				
				return `
					<section class="overflow-hidden">
						<div class="w-full p-6">
							<div class="mb-6">
								<div class="flex items-center justify-between gap-4" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
									<div>
										<h1 class="text-2xl font-bold text-gray-900" data-translate="director.task_matrix">${t('director.task_matrix')}</h1>
										<p class="text-gray-600"><span data-translate="director.total">${t('director.total')}</span>: <span class="font-semibold text-slate-700">${tasks.length}</span></p>
									</div>
									<div class="flex items-center space-x-2">
										<button id="respTaskSortToggle" class="p-2 rounded-lg bg-gray-100 text-gray-600 transition-colors" title="Toggle Sort">
											<i class="fas fa-sort-alpha-down" id="respTaskSortIcon"></i>
										</button>
										<button id="respTaskViewModeCards" class="p-2 rounded-lg transition-colors bg-gray-100 text-gray-600" title="Cards View">
											<i class="fas fa-border-all"></i>
										</button>
										<button id="respTaskViewModeList" class="p-2 rounded-lg transition-colors" title="List View">
											<i class="fas fa-list"></i>
										</button>
									</div>
								</div>
							</div>
							<div id="responsibleTaskList" class="p-6 w-full"></div>
						</div>
					</section>
				`;
			}

			// Header + stats + controls
			const completed = respTasks.filter(t => t.status === 'Completed').length;
			const inProgress = respTasks.filter(t => t.status === 'In Progress' || t.status === 'Pending').length;
			const overdue = respTasks.filter(isOverdue).length;

			const departmentNames = managedDepts.map(d => d.name).filter(Boolean).join(', ') || t('director.no_department_assigned');
			const initials = getInitials(resp.first_name, resp.last_name);

			container.innerHTML = `
				<div class="dir-resp-layout">
					<!-- Unified Overview and Filters Section -->
					<section style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 20px; margin-bottom: 24px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); width: 100%;">
						<!-- Top Section: Responsible Info + Stats -->
						<div style="display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
							<!-- Responsible Avatar and Info -->
							<div style="display: flex; align-items: center; gap: 16px; flex: 1; min-width: 280px;">
								<div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 20px; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);">
									${initials}
								</div>
								<div style="display: flex; flex-direction: column; gap: 4px;">
									<span style="font-size: 12px; color: #64748b; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;" data-translate="director.responsible_snapshot">${t('director.responsible_snapshot') || 'Ù„Ù…Ø­Ø© Ø¹Ù† Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„'}</span>
									<h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin: 0;">${resp.first_name || ''} ${resp.last_name || ''}</h3>
									<div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
										<span style="font-size: 13px; color: #64748b;" data-translate="director.team_size">${t('director.team_size') || 'Ø­Ø¬Ù… Ø§Ù„ÙØ±ÙŠÙ‚'}:</span>
										<span style="font-size: 13px; font-weight: 600; color: #1e293b;">${respEmployees.length || 0} ${t('director.members') || 'Ø£Ø¹Ø¶Ø§Ø¡'}</span>
									</div>
								</div>
							</div>
							
							<!-- Stats Cards -->
							<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; flex: 2; min-width: 300px;">
								<div style="background: white; border-radius: 8px; padding: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: center;">
									<p style="font-size: 11px; color: #64748b; font-weight: 500; margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.5px;" data-translate="director.total_tasks">${t('director.total_tasks') || 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…'}</p>
									<div style="font-size: 24px; font-weight: 700; color: #1e293b; margin: 0;">${respTasks.length}</div>
								</div>
								<div style="background: white; border-radius: 8px; padding: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: center;">
									<p style="font-size: 11px; color: #16a34a; font-weight: 500; margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.5px;" data-translate="director.completed">${t('director.completed') || 'Ù…ÙƒØªÙ…Ù„'}</p>
									<div style="font-size: 24px; font-weight: 700; color: #16a34a; margin: 0;">${completed}</div>
								</div>
								<div style="background: white; border-radius: 8px; padding: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: center;">
									<p style="font-size: 11px; color: #ca8a04; font-weight: 500; margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.5px;" data-translate="director.in_progress">${t('director.in_progress') || 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}</p>
									<div style="font-size: 24px; font-weight: 700; color: #ca8a04; margin: 0;">${inProgress}</div>
								</div>
								<div style="background: white; border-radius: 8px; padding: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: center; ${overdue > 0 ? 'border-color: #fca5a5; background: #fef2f2;' : ''}">
									<p style="font-size: 11px; color: ${overdue > 0 ? '#dc2626' : '#64748b'}; font-weight: 500; margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.5px;" data-translate="director.overdue">${t('director.overdue') || 'Ù…ØªØ£Ø®Ø±'}</p>
									<div style="font-size: 24px; font-weight: 700; color: ${overdue > 0 ? '#dc2626' : '#1e293b'}; margin: 0;">${overdue}</div>
								</div>
							</div>
						</div>
						
						<!-- Divider -->
						<div style="height: 1px; background: #e2e8f0; margin: 16px 0;"></div>
						
						<!-- Middle Section: Contact Info -->
						<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
							<div style="display: flex; align-items: center; gap: 8px;">
								<i class="fas fa-envelope" style="color: #64748b; font-size: 14px;"></i>
								<span style="font-size: 13px; color: #64748b;" data-translate="director.email">${t('director.email') || 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'}:</span>
								<span style="font-size: 13px; font-weight: 500; color: #1e293b;">${resp.email || t('director.no_email_available') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'}</span>
							</div>
							<div style="display: flex; align-items: center; gap: 8px;">
								<i class="fas fa-building" style="color: #64748b; font-size: 14px;"></i>
								<span style="font-size: 13px; color: #64748b;" data-translate="director.department">${t('director.department') || 'Ø§Ù„Ù‚Ø³Ù…'}:</span>
								<span style="font-size: 13px; font-weight: 500; color: #1e293b;">${departmentNames}</span>
							</div>
						</div>
						
						<!-- Divider -->
						<div style="height: 1px; background: #e2e8f0; margin: 16px 0;"></div>
						
						<!-- Bottom Section: Filters -->
						<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 16px;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
							<!-- Filter Icon and Title -->
							<div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
								<i class="fas fa-sliders-h" style="color: #3b82f6; font-size: 15px;"></i>
								<span style="font-size: 14px; font-weight: 600; color: #1e40af;" data-translate="director.controls">${t('director.controls') || 'Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…'}</span>
							</div>
							
							<!-- Filters -->
							<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px; flex: 1;">
								<div style="position: relative;">
									<input id="responsibleSearch-${resp.id}" type="text" placeholder="${t('director.search_by_name') || 'Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…...'}" 
										style="padding: 8px 14px 8px 36px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; width: 160px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
										onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
										onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'" />
									<div style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
										<i class="fas fa-search" style="color: #64748b; font-size: 13px;"></i>
									</div>
								</div>
								
								<select id="employeeFilter-${resp.id}" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 130px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
									<option value="">${t('director.all_employees') || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†'}</option>
								</select>
								
								<select id="dirTimeRange-${resp.id}" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 110px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
									<option value="today">${t('director.today') || 'Ø§Ù„ÙŠÙˆÙ…'}</option>
									<option value="week">${t('director.this_week') || 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹'}</option>
									<option value="month">${t('director.this_month') || 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±'}</option>
									<option value="year">${t('director.this_year') || 'Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…'}</option>
									<option value="custom">${t('director.custom') || 'Ù…Ø®ØµØµ'}</option>
								</select>
							</div>
							
							<!-- Action Buttons -->
							<div style="display: flex; align-items: center; gap: 10px;">
								<button id="resetEmployeeFilter-${resp.id}" style="padding: 8px 14px; font-size: 12px; font-weight: 600; color: #6b7280; background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" 
									onmouseover="this.style.background='linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
									onmouseout="this.style.background='linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
									<i class="fas fa-undo" style="font-size: 12px;"></i>
									<span data-translate="common.reset">${t('common.reset') || 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†'}</span>
								</button>
							</div>
						</div>
						
						<!-- Custom Date Range (Hidden by default) -->
						<div id="dirTimeCustom-${resp.id}" class="hidden" style="display: none; margin-top: 16px; padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; border: 2px solid #e2e8f0; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); position: relative;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
							<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
								<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);">
									<i class="fas fa-calendar-alt" style="color: white; font-size: 18px;"></i>
								</div>
								<div style="display: flex; flex-direction: column;">
									<span style="font-size: 16px; font-weight: 700; color: #1e293b;" data-translate="director.custom">${t('director.custom')}</span>
									<span style="font-size: 12px; color: #64748b; font-weight: 500;" data-translate="attendance.daily.please_select_date">${t('attendance.daily.please_select_date')}</span>
								</div>
							</div>
							
							<div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
								<div style="display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 200px;">
									<label style="font-size: 12px; font-weight: 600; color: #475569; text-transform: uppercase; letter-spacing: 0.5px;" data-translate="director.due_date">${t('director.due_date')}</label>
									<input type="date" id="dirTimeFrom-${resp.id}" style="padding: 12px 16px; font-size: 14px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; color: #1e293b; font-weight: 500; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); width: 100%;" 
										onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" 
										onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'" />
								</div>
								
								<div style="display: flex; align-items: center; justify-content: center; padding: 12px 0;">
									<div style="width: 32px; height: 2px; background: linear-gradient(90deg, #3b82f6, #1d4ed8); border-radius: 1px;"></div>
								</div>
								
								<div style="display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 200px;">
									<label style="font-size: 12px; font-weight: 600; color: #475569; text-transform: uppercase; letter-spacing: 0.5px;" data-translate="director.created_label">${t('director.created_label')}</label>
									<input type="date" id="dirTimeTo-${resp.id}" style="padding: 12px 16px; font-size: 14px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; color: #1e293b; font-weight: 500; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); width: 100%;" 
										onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" 
										onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'" />
								</div>
								
								<div style="display: flex; align-items: flex-end; gap: 12px;">
									<button id="dirTimeApply-${resp.id}" style="padding: 12px 24px; font-size: 14px; font-weight: 600; color: white; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.25); display: flex; align-items: center; gap: 8px;" 
										onmouseover="this.style.background='linear-gradient(135deg, #2563eb, #1e40af)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(59, 130, 246, 0.35)'" 
										onmouseout="this.style.background='linear-gradient(135deg, #3b82f6, #1d4ed8)'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.25)'">
										<i class="fas fa-check" style="font-size: 12px;"></i>
										<span data-translate="common.apply">${t('common.apply')}</span>
									</button>
									
									<button id="dirTimeCancel-${resp.id}" style="padding: 12px 20px; font-size: 14px; font-weight: 600; color: #64748b; background: white; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);" 
										onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#cbd5e1'; this.style.transform='translateY(-1px)'" 
										onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0px)'">
										<span data-translate="common.cancel">${t('common.cancel')}</span>
									</button>
								</div>
							</div>
						</div>
						
						<!-- Divider -->
						<div style="height: 1px; background: #e2e8f0; margin: 16px 0;"></div>
						
						<!-- Toggle Controls Section -->
						<div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 32px; padding: 8px 0;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
							<!-- View Mode Toggle -->
							<div style="display: flex; align-items: center; gap: 24px; flex: 1; min-width: 320px;">
								<!-- Elegant Label -->
								<div style="display: flex; flex-direction: column; gap: 6px;">
									<div style="display: flex; align-items: center; gap: 10px;">
										<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.25);">
											<i class="fas fa-eye" style="color: white; font-size: 14px;"></i>
										</div>
										<div style="display: flex; flex-direction: column;">
											<span style="font-size: 13px; font-weight: 600; color: #1e40af; text-transform: uppercase; letter-spacing: 0.8px;" data-translate="director.view_mode">${t('director.view_mode') || 'ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶'}</span>
											<div style="width: 24px; height: 3px; background: linear-gradient(90deg, #3b82f6, #1d4ed8); border-radius: 2px; margin-top: 2px;"></div>
										</div>
									</div>
								</div>
								
								<!-- Toggle Buttons -->
								<div class="dir-toggle-pill-group" style="display: flex; background: #f8fafc; border-radius: 16px; border: 2px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative;">
									<button id="dirViewTasksBtn-${resp.id}" class="dir-toggle-pill ${currentViewMode === 'tasks' ? 'active' : ''}" type="button" 
										style="padding: 12px 24px; font-size: 15px; font-weight: 600; color: ${currentViewMode === 'tasks' ? 'white' : '#64748b'}; background: ${currentViewMode === 'tasks' ? 'linear-gradient(135deg, #3b82f6, #1d4ed8)' : 'transparent'}; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; z-index: ${currentViewMode === 'tasks' ? '2' : '1'}; border-radius: 14px; margin: 2px;"
										onmouseover="if(!this.classList.contains('active')) { this.style.background='#f1f5f9'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; } else { this.style.background='linear-gradient(135deg, #2563eb, #1e40af)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; }"
										onmouseout="if(!this.classList.contains('active')) { this.style.background='transparent'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'; } else { this.style.background='linear-gradient(135deg, #3b82f6, #1d4ed8)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'; }">
										<span data-translate="director.tasks">${t('director.tasks') || 'Ø§Ù„Ù…Ù‡Ø§Ù…'}</span>
									</button>
									<button id="dirViewInstrBtn-${resp.id}" class="dir-toggle-pill ${currentViewMode === 'instructions' ? 'active' : ''}" type="button" 
										style="padding: 12px 24px; font-size: 15px; font-weight: 600; color: ${currentViewMode === 'instructions' ? 'white' : '#64748b'}; background: ${currentViewMode === 'instructions' ? 'linear-gradient(135deg, #3b82f6, #1d4ed8)' : 'transparent'}; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; z-index: ${currentViewMode === 'instructions' ? '2' : '1'}; border-radius: 14px; margin: 2px;"
										onmouseover="if(!this.classList.contains('active')) { this.style.background='#f1f5f9'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; } else { this.style.background='linear-gradient(135deg, #2563eb, #1e40af)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; }"
										onmouseout="if(!this.classList.contains('active')) { this.style.background='transparent'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'; } else { this.style.background='linear-gradient(135deg, #3b82f6, #1d4ed8)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'; }">
										<span data-translate="director.instructions">${t('director.instructions') || 'Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª'}</span>
									</button>
								</div>
							</div>
							
							<!-- Breakdown Toggle -->
							<div style="display: flex; align-items: center; gap: 24px; flex: 1; min-width: 320px; justify-content: flex-end;">
								<!-- Toggle Buttons -->
								<div class="dir-toggle-pill-group" style="display: flex; background: #f8fafc; border-radius: 16px; border: 2px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative;">
									<button id="tabByEmployee-${resp.id}" class="dir-toggle-pill ${activeBreakdownTab === 'employee' ? 'active' : ''}" type="button" 
										style="padding: 12px 24px; font-size: 15px; font-weight: 600; color: ${activeBreakdownTab === 'employee' ? 'white' : '#64748b'}; background: ${activeBreakdownTab === 'employee' ? 'linear-gradient(135deg, #10b981, #059669)' : 'transparent'}; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; z-index: ${activeBreakdownTab === 'employee' ? '2' : '1'}; border-radius: 14px; margin: 2px;"
										onmouseover="if(!this.classList.contains('active')) { this.style.background='#f1f5f9'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; } else { this.style.background='linear-gradient(135deg, #059669, #047857)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; }"
										onmouseout="if(!this.classList.contains('active')) { this.style.background='transparent'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'; } else { this.style.background='linear-gradient(135deg, #10b981, #059669)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'; }">
										<span data-translate="director.by_employee">${t('director.by_employee') || 'Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù'}</span>
									</button>
									<button id="tabByTask-${resp.id}" class="dir-toggle-pill ${activeBreakdownTab === 'task' ? 'active' : ''}" type="button" 
										style="padding: 12px 24px; font-size: 15px; font-weight: 600; color: ${activeBreakdownTab === 'task' ? 'white' : '#64748b'}; background: ${activeBreakdownTab === 'task' ? 'linear-gradient(135deg, #10b981, #059669)' : 'transparent'}; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; z-index: ${activeBreakdownTab === 'task' ? '2' : '1'}; border-radius: 14px; margin: 2px;"
										onmouseover="if(!this.classList.contains('active')) { this.style.background='#f1f5f9'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; } else { this.style.background='linear-gradient(135deg, #059669, #047857)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'; }"
										onmouseout="if(!this.classList.contains('active')) { this.style.background='transparent'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'; } else { this.style.background='linear-gradient(135deg, #10b981, #059669)'; this.style.transform='translateY(0px)'; this.style.boxShadow='none'; }">
										<span data-translate="director.by_task">${t('director.by_task') || 'Ø­Ø³Ø¨ Ø§Ù„Ù…Ù‡Ù…Ø©'}</span>
									</button>
								</div>
								
								<!-- Elegant Label -->
								<div style="display: flex; flex-direction: column; gap: 6px;">
									<div style="display: flex; align-items: center; gap: 10px;">
										<div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(16, 185, 129, 0.25);">
											<i class="fas fa-th-large" style="color: white; font-size: 14px;"></i>
										</div>
										<div style="display: flex; flex-direction: column;">
											<span style="font-size: 13px; font-weight: 600; color: #059669; text-transform: uppercase; letter-spacing: 0.8px;" data-translate="director.breakdown">${t('director.breakdown') || 'Ø§Ù„ØªÙ‚Ø³ÙŠÙ…'}</span>
											<div style="width: 24px; height: 3px; background: linear-gradient(90deg, #10b981, #059669); border-radius: 2px; margin-top: 2px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</section>

					<section class="dir-resp-section dir-resp-pane dir-resp-pane-main" style="width: 100%;">

						<!-- Content Container -->
						<div id="responsibleViewContent-${resp.id}" class="dir-resp-stack dir-resp-section-block"></div>
					</section>
				</div>
			`;

			const empSelect = document.getElementById(`employeeFilter-${resp.id}`);
			const timeRangeSelect = document.getElementById(`dirTimeRange-${resp.id}`);
			const timeCustomWrap = document.getElementById(`dirTimeCustom-${resp.id}`);
			const timeFromInput = document.getElementById(`dirTimeFrom-${resp.id}`);
			const timeToInput = document.getElementById(`dirTimeTo-${resp.id}`);
			const timeApplyBtn = document.getElementById(`dirTimeApply-${resp.id}`);
			const timeCancelBtn = document.getElementById(`dirTimeCancel-${resp.id}`);
			const searchInput = document.getElementById(`responsibleSearch-${resp.id}`);
			
			// Function to gray out/enable other filters
			function toggleFiltersGrayedOut(grayedOut) {
				const filtersToGray = [empSelect, searchInput];
				filtersToGray.forEach(filter => {
					if (filter) {
						if (grayedOut) {
							filter.style.opacity = '0.4';
							filter.style.pointerEvents = 'none';
							filter.style.filter = 'grayscale(1)';
						} else {
							filter.style.opacity = '1';
							filter.style.pointerEvents = 'auto';
							filter.style.filter = 'grayscale(0)';
						}
					}
				});
			}
			
			if (empSelect) {
				empSelect.innerHTML = [`<option value="all">${t('director.all_employees')}</option>`].concat(respEmployees.map(emp => `<option value="${emp.id}">${emp.first_name || ''} ${emp.last_name || ''}</option>`)).join('');
			}

			if (timeRangeSelect) {
				const initialValue = timeRangeSelect.value || 'today';
				if (initialValue !== 'custom') {
					currentDateFilteredTasksV2 = filterTasksByPeriodV2(respTasks, initialValue);
				}
				timeRangeSelect.addEventListener('change', (e) => {
					const value = e.target.value;
					if (value === 'custom') {
						// Show custom date range and gray out other filters
						timeCustomWrap.style.display = 'block';
						toggleFiltersGrayedOut(true);
						return;
					}
					// Hide custom date range and enable other filters
					timeCustomWrap.style.display = 'none';
					toggleFiltersGrayedOut(false);
					currentDateFilteredTasksV2 = filterTasksByPeriodV2(respTasks, value);
					rerenderAfterFilters();
				});
			}

			if (timeApplyBtn) {
				timeApplyBtn.addEventListener('click', () => {
					const from = timeFromInput?.value;
					const to = timeToInput?.value;
					if (!from || !to) return;
					currentDateFilteredTasksV2 = filterTasksByCustomRangeV2(respTasks, from, to);
					// Hide custom date range and enable other filters after applying
					timeCustomWrap.style.display = 'none';
					toggleFiltersGrayedOut(false);
					// Reset time range select to show that custom was applied
					if (timeRangeSelect) {
						timeRangeSelect.value = 'custom';
					}
					rerenderAfterFilters();
				});
			}
			
			if (timeCancelBtn) {
				timeCancelBtn.addEventListener('click', () => {
					// Hide custom date range and enable other filters
					timeCustomWrap.style.display = 'none';
					toggleFiltersGrayedOut(false);
					// Reset time range to default
					if (timeRangeSelect) {
						timeRangeSelect.value = 'today';
						currentDateFilteredTasksV2 = filterTasksByPeriodV2(respTasks, 'today');
						rerenderAfterFilters();
					}
				});
			}
			else {
				currentDateFilteredTasksV2 = respTasks;
			}

			function filterTasksForResponsibleBase(baseTasks) {
				const q = (document.getElementById(`responsibleSearch-${resp.id}`)?.value || '').trim().toLowerCase();
				const empId = (document.getElementById(`employeeFilter-${resp.id}`)?.value) || 'all';
				let result = baseTasks;
				if (empId !== 'all') result = result.filter(task => (task.assignees || []).some(a => String(a.id) === String(empId)));
				if (q) {
					result = result.filter(task => {
						const title = (task.title || '').toLowerCase();
						const desc = (task.description || '').toLowerCase();
						const hasInTask = title.includes(q) || desc.includes(q);
						const hasInAssignees = (task.assignees || []).some(a => {
							const fn = (a.first_name || '').toLowerCase();
							const ln = (a.last_name || '').toLowerCase();
							const full = `${fn} ${ln}`.trim();
							return fn.includes(q) || ln.includes(q) || full.includes(q);
						});
						return hasInTask || hasInAssignees;
					});
				}
				return result;
			}

			function resetTaskPagination() {
				window.respTaskPageByResp = window.respTaskPageByResp || {};
				window.respTaskPageByResp[String(resp.id)] = 1;
			}

			function rerenderAfterFilters() {
				resetTaskPagination();
				renderResponsibleContent(renderResponsibleContent.activeTab);
			}
			function syncViewModeToggles() {
				const mode = window.__dirViewMode || 'tasks';
				const tasksBtn = document.getElementById(`dirViewTasksBtn-${resp.id}`);
				const instrBtn = document.getElementById(`dirViewInstrBtn-${resp.id}`);
				
				if (tasksBtn) {
					const isTasks = mode === 'tasks';
					tasksBtn.classList.toggle('active', isTasks);
					tasksBtn.setAttribute('aria-pressed', String(isTasks));
					// Update inline styles
					tasksBtn.style.color = isTasks ? 'white' : '#64748b';
					tasksBtn.style.background = isTasks ? 'linear-gradient(135deg, #3b82f6, #1d4ed8)' : 'transparent';
					tasksBtn.style.zIndex = isTasks ? '2' : '1';
				}
				if (instrBtn) {
					const isInstructions = mode === 'instructions';
					instrBtn.classList.toggle('active', isInstructions);
					instrBtn.setAttribute('aria-pressed', String(isInstructions));
					// Update inline styles
					instrBtn.style.color = isInstructions ? 'white' : '#64748b';
					instrBtn.style.background = isInstructions ? 'linear-gradient(135deg, #3b82f6, #1d4ed8)' : 'transparent';
					instrBtn.style.zIndex = isInstructions ? '2' : '1';
				}
			}

			function syncBreakdownToggles() {
				const current = renderResponsibleContent.activeTab || 'employee';
				const employeeBtn = document.getElementById(`tabByEmployee-${resp.id}`);
				const taskBtn = document.getElementById(`tabByTask-${resp.id}`);
				
				if (employeeBtn) {
					const isEmployee = current === 'employee';
					employeeBtn.classList.toggle('active', isEmployee);
					employeeBtn.setAttribute('aria-pressed', String(isEmployee));
					// Update inline styles
					employeeBtn.style.color = isEmployee ? 'white' : '#64748b';
					employeeBtn.style.background = isEmployee ? 'linear-gradient(135deg, #10b981, #059669)' : 'transparent';
					employeeBtn.style.zIndex = isEmployee ? '2' : '1';
				}
				if (taskBtn) {
					const isTask = current === 'task';
					taskBtn.classList.toggle('active', isTask);
					taskBtn.setAttribute('aria-pressed', String(isTask));
					// Update inline styles
					taskBtn.style.color = isTask ? 'white' : '#64748b';
					taskBtn.style.background = isTask ? 'linear-gradient(135deg, #10b981, #059669)' : 'transparent';
					taskBtn.style.zIndex = isTask ? '2' : '1';
				}
			}

			function renderResponsibleContent(activeTab = (renderResponsibleContent.activeTab || 'employee')) {
				renderResponsibleContent.activeTab = activeTab;
				const base = currentDateFilteredTasksV2;
				let tasksToRender = filterTasksForResponsibleBase(base);
				// Apply Tasks/Instructions toggle
				const mode = window.__dirViewMode || 'tasks';
				const isInstr = (t) => (t.title || '').startsWith('Instruction:');
				tasksToRender = tasksToRender.filter(t => mode === 'instructions' ? isInstr(t) : !isInstr(t));
				window.currentFilteredTasksForModal = tasksToRender;
				const mount = document.getElementById(`responsibleViewContent-${resp.id}`);
				if (!mount) return;
				const headerToggle = ``;
				mount.innerHTML = headerToggle + (activeTab === 'employee' ? generateResponsibleByEmployeeHTML(tasksToRender) : generateResponsibleByTaskHTML(tasksToRender));
				syncViewModeToggles();
				syncBreakdownToggles();
				
				// Render content based on active tab
				if (activeTab === 'employee') {
					renderResponsibleEmployeeList(tasksToRender);
					// Always wire buttons when employee tab is rendered
					setTimeout(() => {
						wireResponsibleEmployeeViewModeButtons();
					}, 100);
				} else {
					renderResponsibleTaskList(tasksToRender);
					// Always wire buttons when task tab is rendered
					setTimeout(() => {
						wireResponsibleTaskViewModeButtons();
					}, 100);
				}
				
				// Wire toggle
				const btnA = document.getElementById(`dirViewTasksBtn-${resp.id}`);
				const btnB = document.getElementById(`dirViewInstrBtn-${resp.id}`);
				if (btnA && btnB) {
					btnA.onclick = () => { window.__dirViewMode = 'tasks'; syncViewModeToggles(); renderResponsibleContent(activeTab); };
					btnB.onclick = () => { window.__dirViewMode = 'instructions'; syncViewModeToggles(); renderResponsibleContent(activeTab); };
				}
				// Wire pagination buttons after render
				if (activeTab === 'task') {
					const prevBtn = document.getElementById(`resp-page-prev-${resp.id}`);
					const nextBtn = document.getElementById(`resp-page-next-${resp.id}`);
					if (prevBtn) prevBtn.addEventListener('click', () => { window.respTaskPageByResp[String(resp.id)] = Math.max(1, (window.respTaskPageByResp[String(resp.id)] || 1) - 1); renderResponsibleContent('task'); });
					if (nextBtn) nextBtn.addEventListener('click', () => {
						const total = (window._respTaskTotalPagesByResp || {})[String(resp.id)] || 1;
						window.respTaskPageByResp[String(resp.id)] = Math.min(total, (window.respTaskPageByResp[String(resp.id)] || 1) + 1);
						renderResponsibleContent('task');
					});
				}
			}

			// Initialize view mode and sorting state
			window.responsibleEmployeeViewMode = window.responsibleEmployeeViewMode || 'cards';
			window.responsibleTaskViewMode = window.responsibleTaskViewMode || 'cards';
			window.responsibleEmployeeSortDirection = window.responsibleEmployeeSortDirection || 'asc';
			window.responsibleTaskSortDirection = window.responsibleTaskSortDirection || 'asc';

			// Employee view rendering functions
			function renderResponsibleEmployeeList(tasks, preSortedStats = null) {
				const employeeStats = preSortedStats || calculateEmployeeStatsForTasks(tasks);
				const listEl = document.getElementById('responsibleEmployeeList');
				if (!listEl) return;
				
				const currentViewMode = window.responsibleEmployeeViewMode || 'cards';
				
				if (currentViewMode === 'list') {
					// Table view for employees
					listEl.innerHTML = `
						<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden w-full">
							<table class="min-w-full divide-y divide-gray-200 w-full">
								<thead class="bg-gray-50">
									<tr>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${t('director.employee') || 'Employee'}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${t('director.total') || 'Total'}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${t('director.completed') || 'Completed'}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${t('director.in_progress') || 'In Progress'}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${t('director.overdue') || 'Overdue'}</th>
										<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">${t('director.actions') || 'Actions'}</th>
									</tr>
								</thead>
								<tbody class="bg-white divide-y divide-gray-200">
									${employeeStats.map(stat => `
										<tr class="hover:bg-gray-50">
											<td class="px-6 py-4 whitespace-nowrap">
												<div class="flex items-center">
													<div class="flex-shrink-0 h-10 w-10">
														<div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm">
															${(() => {
																const nameParts = stat.name.split(' ');
																const first = nameParts[0] || '';
																const last = nameParts.slice(1).join(' ') || '';
																return getInitials(first, last);
															})()}
														</div>
													</div>
													<div class="ml-4">
														<div class="text-sm font-medium text-gray-900">${stat.name}</div>
														<div class="text-sm text-gray-500">${stat.completed} ${t('director.completed') || 'completed'} â€¢ ${stat.overdue} ${t('director.overdue') || 'overdue'}</div>
													</div>
												</div>
											</td>
											<td class="px-6 py-4 whitespace-nowrap">
												<span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-600">${stat.total}</span>
											</td>
											<td class="px-6 py-4 whitespace-nowrap">
												<span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-600">${stat.completed}</span>
											</td>
											<td class="px-6 py-4 whitespace-nowrap">
												<span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-50 text-yellow-600">${stat.inProgress}</span>
											</td>
											<td class="px-6 py-4 whitespace-nowrap">
												<span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-xs font-semibold bg-red-50 text-red-600">${stat.overdue}</span>
											</td>
											<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
												<button onclick="showEmployeeDetails('${stat.id}', '${stat.name}')" class="text-indigo-600 hover:text-indigo-900 px-3 py-1 rounded-md bg-indigo-50 hover:bg-indigo-100 transition-colors">
													<i class="fas fa-eye mr-1"></i>${t('director.view') || 'View'}
												</button>
											</td>
										</tr>
									`).join('')}
								</tbody>
							</table>
						</div>
					`;
				} else {
					// Card view for employees
					listEl.innerHTML = `
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
							${employeeStats.map(stat => `
								<div class="timetable-card" style="padding: 24px;">
									<div style="display: flex; flex-direction: column; gap: 20px;">
										<!-- Header Section -->
										<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
											<div style="flex: 1; min-width: 0;">
												<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
													<div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);">
														${(() => {
															const nameParts = stat.name.split(' ');
															const first = nameParts[0] || '';
															const last = nameParts.slice(1).join(' ') || '';
															return getInitials(first, last);
														})()}
													</div>
													<div style="flex: 1; min-width: 0;">
														<h4 style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin: 0; line-height: 1.3;">${stat.name}</h4>
														<p style="font-size: 0.9rem; color: #64748b; line-height: 1.5; margin: 0;">${stat.completed} ${t('director.completed') || 'completed'} â€¢ ${stat.overdue} ${t('director.overdue') || 'overdue'}</p>
													</div>
												</div>
											</div>
										</div>
										
										<!-- Stats Grid -->
										<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
											<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 14px;">
												<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
													<i class="fas fa-tasks" style="font-size: 1rem;"></i>
												</div>
												<div style="flex: 1; min-width: 0;">
													<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #3B82F6; margin: 0 0 4px 0; font-weight: 600;">${t('director.total') || 'Total'}</p>
													<p style="font-size: 1.1rem; font-weight: 700; color: #0f172a; margin: 0;">${stat.total}</p>
												</div>
											</div>
											<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.04)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 14px;">
												<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #10B981, #059669); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
													<i class="fas fa-check-circle" style="font-size: 1rem;"></i>
												</div>
												<div style="flex: 1; min-width: 0;">
													<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #10B981; margin: 0 0 4px 0; font-weight: 600;">${t('director.completed') || 'Completed'}</p>
													<p style="font-size: 1.1rem; font-weight: 700; color: #0f172a; margin: 0;">${stat.completed}</p>
												</div>
											</div>
											<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(245, 158, 11, 0.04)); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 14px;">
												<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #F59E0B, #D97706); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
													<i class="fas fa-spinner" style="font-size: 1rem;"></i>
												</div>
												<div style="flex: 1; min-width: 0;">
													<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #F59E0B; margin: 0 0 4px 0; font-weight: 600;">${t('director.in_progress') || 'In Progress'}</p>
													<p style="font-size: 1.1rem; font-weight: 700; color: #0f172a; margin: 0;">${stat.inProgress}</p>
												</div>
											</div>
											<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.04)); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 14px;">
												<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #EF4444, #DC2626); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
													<i class="fas fa-exclamation-triangle" style="font-size: 1rem;"></i>
												</div>
												<div style="flex: 1; min-width: 0;">
													<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #EF4444; margin: 0 0 4px 0; font-weight: 600;">${t('director.overdue') || 'Overdue'}</p>
													<p style="font-size: 1.1rem; font-weight: 700; color: #0f172a; margin: 0;">${stat.overdue}</p>
												</div>
											</div>
										</div>
										
										<!-- Actions -->
										<div style="display: flex; justify-content: flex-end; gap: 8px; padding-top: 16px; border-top: 1px solid rgba(148, 163, 184, 0.15);">
											<button class="dir-table-action" onclick="showEmployeeDetails('${stat.id}', '${stat.name}')" title="View Details">
												<i class="fas fa-eye"></i>
												<span>${t('director.view_details') || 'View Details'}</span>
											</button>
										</div>
									</div>
								</div>
							`).join('')}
						</div>
					`;
				}
			}

			// Task view rendering functions
			function renderResponsibleTaskList(tasks) {
				const listEl = document.getElementById('responsibleTaskList');
				if (!listEl) return;
				
				// Pagination
				window.respTaskPageByResp = window.respTaskPageByResp || {};
				window._respTaskTotalPagesByResp = window._respTaskTotalPagesByResp || {};
				const respId = String(resp.id);
				if (!window.respTaskPageByResp[respId]) window.respTaskPageByResp[respId] = 1;
				const currentPage = window.respTaskPageByResp[respId];
				const itemsPerPage = 10;
				const total = tasks.length;
				const totalPages = Math.ceil(total / itemsPerPage) || 1;
				window._respTaskTotalPagesByResp[respId] = totalPages;
				const paginatedTasks = tasks.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
				
				const currentViewMode = window.responsibleTaskViewMode || 'cards';
				
				if (!paginatedTasks.length) {
					listEl.innerHTML = `<div class="p-16 text-center text-slate-400"><i class="fas fa-tasks text-4xl text-slate-200 mb-3"></i><p>No tasks found</p></div>`;
					return;
				}
				
				if (currentViewMode === 'list') {
					// Table view for tasks
					listEl.innerHTML = `
						<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden w-full">
							<table class="min-w-full divide-y divide-gray-200 w-full">
								<thead class="bg-gradient-to-r from-slate-50 to-gray-50 border-b border-gray-200">
									<tr>
										<th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider" style="font-weight: 600; letter-spacing: 0.05em;">${t('director.task') || 'Task'}</th>
										<th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider" style="font-weight: 600; letter-spacing: 0.05em;">${t('director.status') || 'Status'}</th>
										<th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider" style="font-weight: 600; letter-spacing: 0.05em;">${t('director.priority') || 'Priority'}</th>
										<th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider" style="font-weight: 600; letter-spacing: 0.05em;">${t('director.due_date') || 'Due Date'}</th>
										<th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider" style="font-weight: 600; letter-spacing: 0.05em;">${t('director.assignees') || 'Assignees'}</th>
										<th class="px-6 py-4 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider" style="font-weight: 600; letter-spacing: 0.05em;">${t('director.actions') || 'Actions'}</th>
									</tr>
								</thead>
								<tbody class="bg-white divide-y divide-gray-200">
									${paginatedTasks.map(task => {
						const assignees = Array.isArray(task.assignees) ? task.assignees : [];
						const names = assignees.length ? assignees.map(a => (a.first_name || '') + ' ' + (a.last_name || '')).filter(n => n.trim()).join(', ') : 'None';
						const taskType = translateTaskTypeValue(task.type || 'Special');
						return `
											<tr class="hover:bg-gradient-to-r hover:from-slate-50 hover:to-gray-50 transition-colors duration-150 border-b border-gray-100">
												<td class="px-6 py-5">
													<div class="flex items-start gap-4">
														<div class="flex-shrink-0">
															<div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm shadow-lg">
																<i class="fas fa-tasks" style="display: inline-block !important; font-family: 'Font Awesome 6 Free' !important; font-weight: 900 !important; visibility: visible !important; opacity: 1 !important;"></i>
															</div>
														</div>
														<div class="flex-1 min-w-0">
															<div class="flex items-center gap-3 mb-2">
																<span class="text-sm font-semibold text-gray-900 text-base">${task.title || 'No title'}</span>
																<span style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; background: linear-gradient(135deg, #f8fafc, #f1f5f9); padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0;">${taskType}</span>
																${isOverdue(task) ? `<span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fecaca; border-radius: 8px; font-size: 0.75rem; font-weight: 700; color: #dc2626; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1);"><i class="fas fa-exclamation-triangle" style="display: inline-block !important; font-family: 'Font Awesome 6 Free' !important; font-weight: 900 !important; visibility: visible !important; opacity: 1 !important;"></i>${t('director.overdue') || 'Overdue'}</span>` : ''}
															</div>
															<div class="text-sm text-gray-600 leading-relaxed">${task.description || 'No description'}</div>
														</div>
													</div>
												</td>
												<td class="px-6 py-5">
													<span class="inline-flex items-center justify-center px-4 py-2 rounded-full text-xs font-semibold ${getStatusBadge(task.status)}" style="font-weight: 600; letter-spacing: 0.05em; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${translateStatusValue(task.status || 'Pending')}</span>
												</td>
												<td class="px-6 py-5">
													<div class="flex items-center gap-3">
														<div class="w-10 h-10 rounded-xl bg-gradient-to-br ${getPriorityGradient(task.priority)} flex items-center justify-center text-white flex-shrink-0 shadow-lg">
															<i class="fas ${getPriorityIcon(task.priority)} text-sm" style="display: inline-block !important; font-family: 'Font Awesome 6 Free' !important; font-weight: 900 !important; visibility: visible !important; opacity: 1 !important;"></i>
														</div>
														<span class="text-sm font-semibold text-gray-900">${translatePriorityValue(task.priority || 'Medium')}</span>
													</div>
												</td>
												<td class="px-6 py-5">
													<div class="flex items-center gap-3">
														<div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white flex-shrink-0 shadow-lg">
															<i class="fas fa-calendar text-sm" style="display: inline-block !important; font-family: 'Font Awesome 6 Free' !important; font-weight: 900 !important; visibility: visible !important; opacity: 1 !important;"></i>
														</div>
														<span class="text-sm font-semibold text-gray-900">${formatDate(task.due_date)}</span>
													</div>
												</td>
												<td class="px-6 py-5">
													<div class="flex items-center gap-3">
														${assignees.length > 0 ? assignees.slice(0, 3).map(assignee => `
															<div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm shadow-lg" title="${assignee.first_name || ''} ${assignee.last_name || ''}">
																${(() => {
																	const first = assignee.first_name || '';
																	const last = assignee.last_name || '';
																	return getInitials(first, last);
																})()}
															</div>
														`).join('') : `
															<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-sm shadow-md">
																<i class="fas fa-user" style="display: inline-block !important; font-family: 'Font Awesome 6 Free' !important; font-weight: 900 !important; visibility: visible !important; opacity: 1 !important;"></i>
															</div>
														`}
														${assignees.length > 3 ? `
															<div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-gray-600 text-sm font-semibold shadow-md border border-gray-300">
																+${assignees.length - 3}
															</div>
														` : ''}
														<span class="text-sm text-gray-900 font-medium" title="${names}">${names.length > 30 ? names.substring(0, 30) + '...' : names}</span>
													</div>
												</td>
												<td class="px-6 py-5 whitespace-nowrap text-right text-sm font-medium">
													<button onclick="dirShowTaskDetails('${task.id}')" class="inline-flex items-center gap-2 px-4 py-2 text-xs font-semibold text-blue-600 bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md border border-blue-200">
														<i class="fas fa-eye" style="display: inline-block !important; font-family: 'Font Awesome 6 Free' !important; font-weight: 900 !important; visibility: visible !important; opacity: 1 !important;"></i>
														<span>${t('director.view') || 'View'}</span>
													</button>
													<button onclick="openDirectorEditTask('${task.id}')" class="inline-flex items-center gap-2 px-4 py-2 text-xs font-semibold text-blue-600 bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md border border-blue-200">
														<i class="fas fa-pen" style="display: inline-block !important; font-family: 'Font Awesome 6 Free' !important; font-weight: 900 !important; visibility: visible !important; opacity: 1 !important;"></i>
														<span>${t('director.edit') || 'Edit'}</span>
													</button>
												</td>
											</tr>
										`;
									}).join('')}
								</tbody>
							</table>
						</div>
					`;
				} else {
					// Card view for tasks
					listEl.innerHTML = `
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
							${paginatedTasks.map(task => {
								const assignees = Array.isArray(task.assignees) ? task.assignees : [];
								const names = assignees.length ? assignees.map(a => (a.first_name || '') + ' ' + (a.last_name || '')).filter(n => n.trim()).join(', ') : 'None';
								return `
									<div class="timetable-card" style="padding: 24px;">
										<div style="display: flex; flex-direction: column; gap: 20px;">
											<!-- Header Section -->
											<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
												<div style="flex: 1; min-width: 0;">
													<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
														<span style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: #64748b;">${translateTaskTypeValue(task.type || 'Special')}</span>
														${isOverdue(task) ? `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fecaca; border-radius: 999px; font-size: 0.7rem; font-weight: 700; color: #dc2626;"><i class="fas fa-exclamation-triangle"></i>Overdue</span>` : ''}
													</div>
													<h4 style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin: 0 0 8px 0; line-height: 1.3;">${task.title || 'No title'}</h4>
													<p style="font-size: 0.9rem; color: #64748b; line-height: 1.5; margin: 0;">${task.description || 'No description'}</p>
												</div>
												<span style="display: inline-block; padding: 6px 14px; font-size: 0.75rem; font-weight: 600; border-radius: 999px; white-space: nowrap;" class="${getStatusBadge(task.status)}">${translateStatusValue(task.status || 'Pending')}</span>
											</div>
											
											<!-- Info Grid -->
											<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
												<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 14px;">
													<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
														<i class="fas fa-users" style="font-size: 1rem;"></i>
													</div>
													<div style="flex: 1; min-width: 0;">
														<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #3B82F6; margin: 0 0 4px 0; font-weight: 600;">${t('director.assignees') || 'Assignees'}</p>
														<div style="display: flex; align-items: center; gap: 2px; margin-top: 2px;">
															${assignees.length > 0 ? assignees.slice(0, 3).map(assignee => `
																<div style="width: 20px; height: 20px; border-radius: 50%; background: linear-gradient(135deg, #3B82F6, #2563EB); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 8px;" title="${assignee.first_name || ''} ${assignee.last_name || ''}">
																	${(() => {
																		const first = assignee.first_name || '';
																		const last = assignee.last_name || '';
																		return getInitials(first, last);
																	})()}
																</div>
															`).join('') : `
																<div style="width: 20px; height: 20px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 8px;">
																	<i class="fas fa-user"></i>
																</div>
															`}
															${assignees.length > 3 ? `
																<div style="width: 20px; height: 20px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 8px; font-weight: 600;">
																	+${assignees.length - 3}
																</div>
															` : ''}
														</div>
														<p style="font-size: 0.75rem; color: #64748b; margin: 2px 0 0 0; font-weight: 500;" title="${names}">${names.length > 20 ? names.substring(0, 20) + '...' : names}</p>
													</div>
												</div>
												<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.04)); border: 1px solid rgba(124, 58, 237, 0.2); border-radius: 14px;">
													<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #7C3AED, #6D28D9); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
														<i class="fas ${getPriorityIcon(task.priority)}" style="font-size: 1rem;"></i>
													</div>
													<div style="flex: 1; min-width: 0;">
														<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #7C3AED; margin: 0 0 4px 0; font-weight: 600;">${t('director.priority') || 'Priority'}</p>
														<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${translatePriorityValue(task.priority || 'Medium')}</p>
													</div>
												</div>
												<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.04)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 14px;">
													<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #10B981, #059669); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
														<i class="fas fa-calendar" style="font-size: 1rem;"></i>
													</div>
													<div style="flex: 1; min-width: 0;">
														<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #10B981; margin: 0 0 4px 0; font-weight: 600;">${t('director.due_date') || 'Due Date'}</p>
														<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${formatDate(task.due_date)}</p>
													</div>
												</div>
											</div>
											
											<!-- Actions -->
											<div style="display: flex; justify-content: flex-end; gap: 8px; padding-top: 16px; border-top: 1px solid rgba(148, 163, 184, 0.15);">
												<button class="dir-table-action" onclick="dirShowTaskDetails('${task.id}')" title="View">
													<i class="fas fa-eye"></i>
													<span>${t('director.view') || 'View'}</span>
												</button>
												<button class="dir-table-action primary" onclick="openDirectorEditTask('${task.id}')" title="Edit">
													<i class="fas fa-pen"></i>
													<span>${t('director.edit') || 'Edit'}</span>
												</button>
											</div>
										</div>
									</div>
								`;
							}).join('')}
						</div>
					`;
				}
				
				// Update pagination info
				const pageInfo = document.querySelector('.text-slate-900');
				if (pageInfo) {
					pageInfo.textContent = currentPage;
				}
				const totalPagesEl = pageInfo?.parentElement?.querySelector('.text-slate-500:last-child');
				if (totalPagesEl) {
					totalPagesEl.textContent = totalPages;
				}
			}

			// Wire view mode buttons for employees
			function wireResponsibleEmployeeViewModeButtons(retryCount = 0) {
				const btnCards = document.getElementById('respEmployeeViewModeCards');
				const btnList = document.getElementById('respEmployeeViewModeList');
				const sortBtn = document.getElementById('respEmployeeSortToggle');
				
				console.log('Wiring employee view buttons (attempt ' + (retryCount + 1) + '):', { btnCards: !!btnCards, btnList: !!btnList, sortBtn: !!sortBtn });
				
				// If buttons don't exist, retry up to 3 times
				if ((!btnCards || !btnList) && retryCount < 3) {
					console.log('Buttons not found, retrying in 200ms...');
					setTimeout(() => wireResponsibleEmployeeViewModeButtons(retryCount + 1), 200);
					return;
				}
				
				if (btnCards && btnList) {
					const updateViewMode = (mode) => {
						console.log('Updating employee view mode to:', mode);
						window.responsibleEmployeeViewMode = mode;
						if (mode === 'cards') {
							btnCards.classList.add('bg-blue-600', 'text-white');
							btnCards.classList.remove('bg-gray-100', 'text-gray-600');
							btnList.classList.add('bg-gray-100', 'text-gray-600');
							btnList.classList.remove('bg-blue-600', 'text-white');
						} else {
							btnList.classList.add('bg-blue-600', 'text-white');
							btnList.classList.remove('bg-gray-100', 'text-gray-600');
							btnCards.classList.add('bg-gray-100', 'text-gray-600');
							btnCards.classList.remove('bg-blue-600', 'text-white');
						}
						// Only render the employee list, not the entire content
						const tasks = window.currentFilteredTasksForModal || [];
						renderResponsibleEmployeeList(tasks);
					};
					
					// Remove existing listeners to prevent duplicates
					btnCards.replaceWith(btnCards.cloneNode(true));
					btnList.replaceWith(btnList.cloneNode(true));
					
					// Get fresh references after cloning
					const freshBtnCards = document.getElementById('respEmployeeViewModeCards');
					const freshBtnList = document.getElementById('respEmployeeViewModeList');
					
					freshBtnCards.addEventListener('click', () => {
						console.log('Cards button clicked');
						updateViewMode('cards');
					});
					freshBtnList.addEventListener('click', () => {
						console.log('List button clicked');
						updateViewMode('list');
					});
					
					updateViewMode(window.responsibleEmployeeViewMode || 'cards');
				} else {
					console.error('Employee view buttons not found after retries');
				}
				
				if (sortBtn) {
					sortBtn.addEventListener('click', () => {
						// Toggle sort direction
						window.responsibleEmployeeSortDirection = window.responsibleEmployeeSortDirection === 'asc' ? 'desc' : 'asc';
						
						// Update sort icon
						const icon = document.getElementById('respEmployeeSortIcon');
						if (icon) {
							if (window.responsibleEmployeeSortDirection === 'asc') {
								icon.className = 'fas fa-sort-alpha-down';
							} else {
								icon.className = 'fas fa-sort-alpha-up';
							}
						}
						
						// Sort employees by name
						const tasks = window.currentFilteredTasksForModal || [];
						const employeeStats = calculateEmployeeStatsForTasks(tasks);
						
						employeeStats.sort((a, b) => {
							const nameA = a.name.toLowerCase();
							const nameB = b.name.toLowerCase();
							if (window.responsibleEmployeeSortDirection === 'asc') {
								return nameA.localeCompare(nameB);
							} else {
								return nameB.localeCompare(nameA);
							}
						});
						
						// Re-render with sorted data
						renderResponsibleEmployeeList(tasks, employeeStats);
					});
				}
			}

			// Wire view mode buttons for tasks
			function wireResponsibleTaskViewModeButtons() {
				const btnCards = document.getElementById('respTaskViewModeCards');
				const btnList = document.getElementById('respTaskViewModeList');
				const sortBtn = document.getElementById('respTaskSortToggle');
				
				console.log('Wiring task view buttons:', { btnCards: !!btnCards, btnList: !!btnList, sortBtn: !!sortBtn });
				
				if (btnCards && btnList) {
					const updateViewMode = (mode) => {
						console.log('Updating task view mode to:', mode);
						window.responsibleTaskViewMode = mode;
						if (mode === 'cards') {
							btnCards.classList.add('bg-blue-600', 'text-white');
							btnCards.classList.remove('bg-gray-100', 'text-gray-600');
							btnList.classList.add('bg-gray-100', 'text-gray-600');
							btnList.classList.remove('bg-blue-600', 'text-white');
						} else {
							btnList.classList.add('bg-blue-600', 'text-white');
							btnList.classList.remove('bg-gray-100', 'text-gray-600');
							btnCards.classList.add('bg-gray-100', 'text-gray-600');
							btnCards.classList.remove('bg-blue-600', 'text-white');
						}
						// Only render the task list, not the entire content
						const tasks = window.currentFilteredTasksForModal || [];
						renderResponsibleTaskList(tasks);
					};
					
					// Remove existing listeners to prevent duplicates
					btnCards.replaceWith(btnCards.cloneNode(true));
					btnList.replaceWith(btnList.cloneNode(true));
					
					// Get fresh references after cloning
					const freshBtnCards = document.getElementById('respTaskViewModeCards');
					const freshBtnList = document.getElementById('respTaskViewModeList');
					
					freshBtnCards.addEventListener('click', () => {
						console.log('Task cards button clicked');
						updateViewMode('cards');
					});
					freshBtnList.addEventListener('click', () => {
						console.log('Task list button clicked');
						updateViewMode('list');
					});
					
					updateViewMode(window.responsibleTaskViewMode || 'cards');
				}
				
				if (sortBtn) {
					sortBtn.addEventListener('click', () => {
						// Toggle sort direction
						window.responsibleTaskSortDirection = window.responsibleTaskSortDirection === 'asc' ? 'desc' : 'asc';
						
						// Update sort icon
						const icon = document.getElementById('respTaskSortIcon');
						if (icon) {
							if (window.responsibleTaskSortDirection === 'asc') {
								icon.className = 'fas fa-sort-alpha-down';
							} else {
								icon.className = 'fas fa-sort-alpha-up';
							}
						}
						
						// Sort tasks by title
						let tasks = window.currentFilteredTasksForModal || [];
						
						// Create a copy to avoid mutating the original
						tasks = [...tasks];
						
						tasks.sort((a, b) => {
							const titleA = (a.title || '').toLowerCase();
							const titleB = (b.title || '').toLowerCase();
							if (window.responsibleTaskSortDirection === 'asc') {
								return titleA.localeCompare(titleB);
							} else {
								return titleB.localeCompare(titleA);
							}
						});
						
						// Re-render with sorted data
						renderResponsibleTaskList(tasks);
					});
				}
			}

			const tabEmp = document.getElementById(`tabByEmployee-${resp.id}`);
			const tabTask = document.getElementById(`tabByTask-${resp.id}`);
			if (tabEmp) {
				tabEmp.addEventListener('click', () => {
					renderResponsibleContent('employee');
				});
			}
			if (tabTask) {
				tabTask.addEventListener('click', () => {
					renderResponsibleContent('task');
				});
			}

			// Initialize translations
			if (typeof updatePageTranslations === 'function') {
				updatePageTranslations();
			}
			if (searchInput) searchInput.addEventListener('input', debounce(() => { rerenderAfterFilters(); }, 250));
			if (empSelect) empSelect.addEventListener('change', () => { rerenderAfterFilters(); });
			const resetBtn = document.getElementById(`resetEmployeeFilter-${resp.id}`);
			if (resetBtn) resetBtn.addEventListener('click', () => {
				if (empSelect) empSelect.value = 'all';
				if (searchInput) searchInput.value = '';
				if (timeRangeSelect) {
					timeRangeSelect.value = 'today';
					timeCustomWrap?.classList.add('hidden');
					currentDateFilteredTasksV2 = filterTasksByPeriodV2(respTasks, 'today');
				} else {
					currentDateFilteredTasksV2 = respTasks;
				}
				rerenderAfterFilters();
			});

			renderResponsibleContent('employee');

			// Detail viewers for task table
			window.showTaskAssignees = function (assignees) {
				const safeList = Array.isArray(assignees) ? assignees : [];
				const modalTitle = document.getElementById('modalTitle');
				modalTitle.innerHTML = `
					<div class="flex items-center gap-3">
						<div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
							<i class="fas fa-users text-white text-lg"></i>
						</div>
						<div>
							<h3 class="text-xl font-bold text-gray-900" data-translate="director.task_assignees">Task Assignees</h3>
							<p class="text-sm text-gray-600">${safeList.length} <span data-translate="director.assignees">assignees</span></p>
						</div>
					</div>
				`;
				const html = `
					<div class="space-y-3">
						${safeList.length > 0 ? safeList.map((a, idx) => `
							<div class="flex items-center justify-between p-4 bg-gradient-to-r from-white to-gray-50 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:shadow-md transition-all">
								<div class="flex items-center gap-3 flex-1">
									<div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold">
										${(a.first_name || '').charAt(0) || '?'}
									</div>
									<div class="flex-1 text-center">
										<div class="font-semibold text-gray-900 text-base">${(a.first_name || '') + ' ' + (a.last_name || '') || 'Unknown'}</div>
										<div class="text-sm text-gray-600 mt-1">
											<span class="inline-flex items-center px-3 py-1 rounded-lg ${a.status === 'Completed' ? 'bg-green-100 text-green-700' : a.status === 'In Progress' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'} font-medium">
												${a.status || 'ï¿½'}
											</span>
										</div>
									</div>
								</div>
							</div>
						`).join('') : `
							<div class="text-center py-12">
								<div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
									<i class="fas fa-users text-gray-400 text-2xl"></i>
								</div>
								<p class="text-gray-600 text-base" data-translate="director.no_assignees">No assignees</p>
							</div>
						`}
					</div>
				`;
				document.getElementById('modalContent').innerHTML = html;
				document.getElementById('employeeDetailsModal').classList.remove('hidden');
				document.body.classList.add('overflow-hidden');

				// Initialize translations
				if (typeof updatePageTranslations === 'function') {
					updatePageTranslations();
				}
			};

			window.showTaskComments = async function (input) {
				let list = [];
				try {
					if (typeof input === 'string' || typeof input === 'number') {
						const r = await fetch(`${API}/tasks/${input}/comments`);
						const data = await r.json();
						list = (data && data.success && Array.isArray(data.comments)) ? data.comments : [];
					} else {
						list = Array.isArray(input) ? input : [];
					}
				} catch (_) { list = []; }
				const modalTitle = document.getElementById('modalTitle');
				modalTitle.innerHTML = `
					<div class="flex items-center gap-3">
						<div class="w-12 h-12 bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl flex items-center justify-center">
							<i class="fas fa-comments text-white text-lg"></i>
						</div>
						<div>
							<h3 class="text-xl font-bold text-gray-900" data-translate="director.task_comments">Task Comments</h3>
							<p class="text-sm text-gray-600">${list.length} <span data-translate="director.comments">comments</span></p>
						</div>
					</div>
				`;
				const html = `
					<div class="space-y-4">
						${list.length > 0 ? list.map(c => `
							<div class="p-5 bg-gradient-to-r from-white to-gray-50 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:shadow-md transition-all">
								<div class="flex items-start gap-3 mb-3">
									<div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
										${(c.author_name || c.first_name || '?').charAt(0).toUpperCase()}
									</div>
									<div class="flex-1 text-center">
										<div class="font-semibold text-gray-900 mb-1">${c.author_name || (c.first_name ? `${c.first_name} ${c.last_name}` : 'Unknown')}</div>
										<div class="text-xs text-gray-500">${c.created_at ? new Date(c.created_at).toLocaleString() : ''}</div>
									</div>
								</div>
								<div class="text-gray-800 text-base leading-relaxed text-center bg-white p-4 rounded-lg border border-gray-200">
									${c.text || c.comment || ''}
								</div>
							</div>
						`).join('') : `
							<div class="text-center py-12">
								<div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
									<i class="fas fa-comments text-gray-400 text-2xl"></i>
								</div>
								<p class="text-gray-600 text-base" data-translate="director.no_comments">No comments</p>
							</div>
						`}
					</div>
				`;
				document.getElementById('modalContent').innerHTML = html;
				document.getElementById('employeeDetailsModal').classList.remove('hidden');
				document.body.classList.add('overflow-hidden');

				// Initialize translations
				if (typeof updatePageTranslations === 'function') {
					updatePageTranslations();
				}
			};

			window.showTaskReports = async function (input) {
				let list = [];
				try {
					if (typeof input === 'string' || typeof input === 'number') {
						const r = await fetch(`${API}/api/reports/task/${input}`);
						const data = await r.json();
						list = (data && data.success && Array.isArray(data.reports)) ? data.reports : [];
					} else {
						list = Array.isArray(input) ? input : [];
					}
				} catch (_) { list = []; }
				const modalTitle = document.getElementById('modalTitle');
				modalTitle.innerHTML = `
					<div class="flex items-center gap-3">
						<div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
							<i class="fas fa-file-alt text-white text-lg"></i>
						</div>
						<div>
							<h3 class="text-xl font-bold text-gray-900" data-translate="director.task_reports">Task Reports</h3>
							<p class="text-sm text-gray-600">${list.length} <span data-translate="director.reports">reports</span></p>
						</div>
					</div>
				`;
				const html = `
					<div class="space-y-4">
						${list.length > 0 ? list.map(r => `
							<div class="p-5 bg-gradient-to-r from-white to-gray-50 rounded-xl border-2 border-gray-200 hover:border-indigo-300 hover:shadow-md transition-all">
								<div class="flex items-start gap-3 mb-3">
									<div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white flex-shrink-0">
										<i class="fas fa-file-pdf"></i>
									</div>
									<div class="flex-1 text-center">
										<div class="font-bold text-gray-900 text-lg mb-1">${r.title || 'Report'}</div>
										<div class="text-xs text-gray-500 mb-2">
											<span data-translate="director.by">By</span> ${r.author_name || (r.first_name ? `${r.first_name} ${r.last_name}` : 'Unknown')} ï¿½ ${r.created_at ? new Date(r.created_at).toLocaleString() : ''}
										</div>
									</div>
								</div>
								${r.content ? `
									<div class="text-gray-700 text-sm leading-relaxed bg-white p-4 rounded-lg border border-gray-200 mb-3 text-center">
										${r.content}
									</div>
								` : ''}
								${r.pdf_url ? `
									<div class="text-center">
										<a href="${r.pdf_url}" target="_blank" class="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-medium hover:from-indigo-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg">
											<i class="fas fa-file-pdf"></i>
											<span data-translate="director.open_pdf">Open PDF</span>
										</a>
									</div>
								` : ''}
							</div>
						`).join('') : `
							<div class="text-center py-12">
								<div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
									<i class="fas fa-file-alt text-gray-400 text-2xl"></i>
								</div>
								<p class="text-gray-600 text-base" data-translate="director.no_reports">No reports</p>
							</div>
						`}
					</div>
				`;
				document.getElementById('modalContent').innerHTML = html;
				document.getElementById('employeeDetailsModal').classList.remove('hidden');
				document.body.classList.add('overflow-hidden');

				// Initialize translations
				if (typeof updatePageTranslations === 'function') {
					updatePageTranslations();
				}
			};

		}

		// Vue Employï¿½s
		function renderEmployeesView() {
			const content = document.getElementById('dynamicContent');

			if (!departments || !Array.isArray(departments)) {
				departments = [];
			}
			if (!employees || !Array.isArray(employees)) {
				employees = [];
			}
			if (!responsibles || !Array.isArray(responsibles)) {
				responsibles = [];
			}

			const currentMode = window.__empViewMode || 'tasks';

			const emptyStateHTML = `
				<div class="dir-emp-empty-state">
					<i class="fas fa-users-slash"></i>
					<h3 class="text-xl font-semibold text-slate-700" data-translate="director.no_employee_selected">${t('director.no_employee_selected')}</h3>
					<p class="text-slate-500 max-w-xl" data-translate="director.lock_teammate">${t('director.lock_teammate')}</p>
				</div>
			`;

			const heroHTML = `
				<section class="dir-emp-hero">
					<div class="dir-emp-hero-content">
						<div class="dir-emp-hero-header">
							<div>
								<p class="dir-emp-label text-white/60 tracking-[0.35em]" data-translate="director.people_cockpit">${t('director.people_cockpit')}</p>
								<h2 class="dir-emp-hero-title">
									<i class="fas fa-users text-white/80"></i>
									<span data-translate="director.employees_view">${t('director.employees_view')}</span>
								</h2>
								<p class="text-white/85 text-base max-w-3xl leading-relaxed mt-2" data-translate="director.employees_intro">
									${t('director.employees_intro')}
								</p>
							</div>
							<div class="dir-emp-hero-badges">
								<span class="dir-chip"><i class="fas fa-bolt"></i>${t('director.focus_mode')}</span>
								<span class="dir-chip"><i class="fas fa-layer-group"></i>${t('director.shared_palette')}</span>
								<span class="dir-chip"><i class="fas fa-plug"></i>${t('director.realtime_sync')}</span>
							</div>
						</div>
					</div>
				</section>
			`;

			const controlsHTML = `
				<section style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
					<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 16px;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
						<!-- Filter Icon and Title -->
						<div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
							<i class="fas fa-filter" style="color: #3b82f6; font-size: 15px;"></i>
							<span style="font-size: 14px; font-weight: 600; color: #1e40af;" data-translate="director.filters_label">${t('director.filters_label') || 'Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª'}</span>
						</div>
						
						<!-- Department Filter -->
						<div style="display: flex; align-items: center; gap: 8px;">
							<label style="font-size: 13px; font-weight: 500; color: #64748b;" data-translate="director.department">${t('director.department') || 'Ø§Ù„Ù‚Ø³Ù…'}</label>
							<select id="deptPicker" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 140px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
								onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
								onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
								<option value="all">${t('director.all_departments') || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…'}</option>
								${departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
							</select>
						</div>
						
						<!-- Employee Search -->
						<div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 200px;">
							<label style="font-size: 13px; font-weight: 500; color: #64748b;" data-translate="director.employee">${t('director.employee') || 'Ø§Ù„Ù…ÙˆØ¸Ù'}</label>
							<div style="position: relative; flex: 1;">
								<i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 14px;"></i>
								<input id="comboEmp" type="text" placeholder="${t('director.search_employee_placeholder') || 'Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù...'}" 
									style="padding: 8px 14px 8px 36px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'"
									autocomplete="off" />
								<button id="comboClear" type="button" aria-label="${t('director.clear_selection')}" 
									style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;"
									onmouseover="this.style.color='#3b82f6'; this.style.background='rgba(59,130,246,0.1)'"
									onmouseout="this.style.color='#9ca3af'; this.style.background='none'">
									<i class="fas fa-times" style="font-size: 12px;"></i>
								</button>
								<div id="comboEmpList" class="hidden" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 50; max-height: 200px; overflow-y: auto; margin-top: 4px;"></div>
							</div>
						</div>
						
						<!-- Stats Badge -->
						<div style="display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(59,130,246,0.2);">
							<i class="fas fa-user-tie" style="font-size: 14px;"></i>
							<span style="font-size: 13px; font-weight: 600;">${responsibles.length} ${t('director.responsibles_count') || 'Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ†'}</span>
						</div>
					</div>
					
					<!-- Time Filters (Hidden by default) -->
					<div id="empTimeFilters" class="hidden" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
						<label style="font-size: 13px; font-weight: 600; color: #64748b; margin-bottom: 12px; display: block;" data-translate="director.timeline_focus">${t('director.timeline_focus') || 'Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ'}</label>
						<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
							<button class="filter-button active" data-period="today" style="padding: 6px 12px; font-size: 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #374151; cursor: pointer; transition: all 0.2s;" 
								onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'" 
								onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#374151'">${t('director.today') || 'Ø§Ù„ÙŠÙˆÙ…'}</button>
							<button class="filter-button" data-period="week" style="padding: 6px 12px; font-size: 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #374151; cursor: pointer; transition: all 0.2s;"
								onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'" 
								onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#374151'">${t('director.this_week') || 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹'}</button>
							<button class="filter-button" data-period="month" style="padding: 6px 12px; font-size: 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #374151; cursor: pointer; transition: all 0.2s;"
								onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'" 
								onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#374151'">${t('director.this_month') || 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±'}</button>
							<button class="filter-button" data-period="year" style="padding: 6px 12px; font-size: 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #374151; cursor: pointer; transition: all 0.2s;"
								onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'" 
								onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#374151'">${t('director.this_year') || 'Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…'}</button>
							<button class="filter-button" data-period="custom" style="padding: 6px 12px; font-size: 12px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #374151; cursor: pointer; transition: all 0.2s;"
								onmouseover="this.style.borderColor='#3b82f6'; this.style.color='#3b82f6'" 
								onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#374151'">${t('director.custom') || 'Ù…Ø®ØµØµ'}</button>
						</div>
						<div id="empCustomRange" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
							<div>
								<label style="font-size: 12px; font-weight: 500; color: #64748b; margin-bottom: 4px; display: block;" data-translate="director.from">${t('director.from') || 'Ù…Ù†'}</label>
								<input type="date" id="empDateFrom" style="padding: 8px 12px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; color: #374151; width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'" />
							</div>
							<div>
								<label style="font-size: 12px; font-weight: 500; color: #64748b; margin-bottom: 4px; display: block;" data-translate="director.to">${t('director.to') || 'Ø¥Ù„Ù‰'}</label>
								<input type="date" id="empDateTo" style="padding: 8px 12px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; color: #374151; width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'" />
							</div>
							<div>
								<button id="empApplyFilter" style="padding: 8px 16px; font-size: 13px; font-weight: 600; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(59,130,246,0.2); transition: all 0.2s; white-space: nowrap;"
									onmouseover="this.style.background='linear-gradient(135deg, #2563eb, #1d4ed8)'; this.style.boxShadow='0 4px 6px rgba(59,130,246,0.3)'" 
									onmouseout="this.style.background='linear-gradient(135deg, #3b82f6, #2563eb)'; this.style.boxShadow='0 2px 4px rgba(59,130,246,0.2)'" 
									data-translate="director.apply_filter">${t('director.apply_filter') || 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±'}</button>
							</div>
						</div>
					</div>
				</section>
			`;

			function renderEmployeePersonalViewLikeReports(tasksAll, employee) {
				const myTasks = (tasksAll || []).filter(t => (t.assignees || []).some(a => String(a.id) === String(employee.id)));
				let total = 0, completed = 0, inProgress = 0, overdue = 0;
				const accomplishedTasks = [], inProgressTasks = [], overdueTasks = [];
				myTasks.forEach(task => {
					const a = (task.assignees || []).find(x => String(x.id) === String(employee.id));
					if (!a) return;
					total++;
					if (a.status === 'Completed') { completed++; accomplishedTasks.push(task); }
					else if (a.status === 'In Progress' || a.status === 'Pending') { inProgress++; inProgressTasks.push(task); }
					if (a.status !== 'Completed' && isOverdue(task)) { overdue++; overdueTasks.push(task); }
				});

				const employeeDisplayName = (`${employee.first_name || ''} ${employee.last_name || ''}`).trim() || t('director.unnamed_employee');
				const safeEmployeeDisplayName = employeeDisplayName.replace(/'/g, "\\'");

				function timelineSection(title, accent, icon, items) {
					const palette = {
						green: { icon: '#16a34a', border: 'border-green-100' },
						amber: { icon: '#d97706', border: 'border-amber-100' },
						rose: { icon: '#e11d48', border: 'border-rose-100' }
					}[accent] || { icon: '#2563eb', border: 'border-blue-100' };
					const visible = items.slice(0, 3);
					return `
						<div class="dir-emp-timeline-card ${palette.border}">
							<div class="dir-emp-timeline-head">
								<div class="flex items-center gap-3">
									<i class="fas ${icon}" style="color:${palette.icon};"></i>
									<div>
										<p class="text-xs uppercase tracking-[0.3em] text-slate-400 mb-1">${title}</p>
										<strong class="text-lg text-slate-900">${items.length || 0}</strong>
									</div>
								</div>
							</div>
							<div class="dir-emp-timeline-list">
								${visible.length ? visible.map(task => `
									<div class="dir-emp-timeline-item">
										<h5>${task.title || t('director.untitled_task')}</h5>
										<div class="dir-emp-meta-row">
											<span><i class="fas fa-calendar-alt"></i>${task.due_date ? new Date(task.due_date).toLocaleDateString('fr-FR') : 'ï¿½'}</span>
											<span><i class="fas fa-flag"></i>${task.priority || 'ï¿½'}</span>
										</div>
									</div>
								`).join('') : `<div class="dir-emp-timeline-empty">${t('director.nothing_here')}</div>`}  
							</div>
					${items.length > 3 ? `<button type="button" class="dir-emp-more-btn" onclick="showEmployeeDetails('${employee.id}', '${safeEmployeeDisplayName}')">${t('director.view_full_timeline')}</button>` : ''}
						</div>
					`;
				}

				const initials = getInitials(employee.first_name, employee.last_name);
				const contactChips = [
					employee.email ? `<span class="dir-emp-contact-chip"><i class="fas fa-envelope"></i>${employee.email}</span>` : '',
					employee.phone ? `<span class="dir-emp-contact-chip"><i class="fas fa-phone"></i>${employee.phone}</span>` : ''
				].filter(Boolean).join('') || `<span class="dir-emp-contact-chip text-white/60"><i class="fas fa-info-circle"></i>${t('director.no_contact_data')}</span>`;

				return `
					<section class="dir-emp-profile">
						<div class="dir-emp-profile-main">
							<div class="flex items-center gap-4">
								<div class="dir-emp-avatar-lg">${initials}</div>
								<div>
									<h3 class="text-2xl font-bold mb-1">${employee.first_name || ''} ${employee.last_name || ''}</h3>
									<p class="text-sm text-white/70">${employee.position || 'ï¿½'}</p>
								</div>
							</div>
							<div class="dir-emp-profile-meta">
								<div class="dir-emp-pill"><span data-translate="director.total">${t('director.total')}</span><strong>${total}</strong></div>
								<div class="dir-emp-pill"><span data-translate="director.completed">${t('director.completed')}</span><strong>${completed}</strong></div>
								<div class="dir-emp-pill"><span data-translate="director.in_progress">${t('director.in_progress')}</span><strong>${inProgress}</strong></div>
								<div class="dir-emp-pill"><span data-translate="director.overdue">${t('director.overdue')}</span><strong>${overdue}</strong></div>
							</div>
						</div>
						<div class="dir-emp-contact-row">${contactChips}</div>
					</section>
					<section class="dir-emp-summary-card">
						<div class="dir-emp-summary-main">
							<div class="dir-emp-summary-meta">
								<h3 data-translate="director.personal_activity">${t('director.personal_activity')}</h3>
								<p class="text-slate-500 text-sm" data-translate="director.personal_activity_hint">${t('director.personal_activity_hint')}</p>
							</div>
						</div>
						<div class="dir-emp-timeline">
							${timelineSection(t('director.completed'), 'green', 'fa-check-circle', accomplishedTasks)}
							${timelineSection(t('director.in_progress'), 'amber', 'fa-clock', inProgressTasks)}
							${timelineSection(t('director.overdue'), 'rose', 'fa-exclamation-circle', overdueTasks)}
						</div>
					</section>
				`;
			}

			content.innerHTML = `
				<div class="dashboard-v-spacing-high">
					${controlsHTML}
					<div class="space-y-4">
						<div class="dir-emp-mode-switch">
							<button id="empViewTasksBtn" type="button" class="${currentMode === 'tasks' ? 'active' : ''}">
								<i class="fas fa-tasks"></i>
								<span data-translate="director.tasks_timeline">${t('director.tasks_timeline')}</span>
							</button>
							<button id="empViewInstrBtn" type="button" class="${currentMode === 'instructions' ? 'active' : ''}">
								<i class="fas fa-bullhorn"></i>
								<span data-translate="director.instructions_log">${t('director.instructions_log')}</span>
							</button>
						</div>
						<div id="employeesContent" class="dir-emp-panel">
							${emptyStateHTML}
					</div>
					</div>
				</div>
			`;

			function getEmployeesForDept(deptId) {
				if (!deptId || deptId === 'all') return employees;
				return employees.filter(e => {
					const deps = employeeDeptIds.get(String(e.id));
					return deps && deps.has(String(deptId));
				});
			}

			const deptPicker = document.getElementById('deptPicker');
			const comboInput = document.getElementById('comboEmp');
			const comboList = document.getElementById('comboEmpList');
			const comboClear = document.getElementById('comboClear');
			let comboItems = employees;
			let selectedEmpId = null;
			let currentEmpDateFilteredTasks = allTasks;

			function renderComboList() {
				const q = (comboInput.value || '').trim().toLowerCase();
				const list = comboItems.filter(e => {
					const name = (`${e.first_name || ''} ${e.last_name || ''}`).trim().toLowerCase();
					return q ? name.startsWith(q) : true;
				});
				comboList.innerHTML = list.map(e => `<div data-id="${e.id}" class="px-3 py-2 hover:bg-gray-100 cursor-pointer">${e.first_name || ''} ${e.last_name || ''}</div>`).join('') || `<div class="px-3 py-2 text-gray-500">${t('director.no_matches')}</div>`;
				comboList.classList.remove('hidden');
			}

			function filterEmpTasksByPeriod(baseTasks, period) {
				const today = new Date();
				let startDate, endDate;
				switch (period) {
					case 'today': startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0, 0); endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59, 999); break;
					case 'week': { const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay()); startDate = new Date(weekStart.setHours(0, 0, 0, 0)); endDate = new Date(); break; }
					case 'month': startDate = new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0, 0); endDate = new Date(); break;
					case 'year': startDate = new Date(today.getFullYear(), 0, 1, 0, 0, 0, 0); endDate = new Date(); break;
					default: return baseTasks;
				}
				return (baseTasks || []).filter(task => { const d = new Date(task.created_at); return d >= startDate && d <= endDate; });
			}
			function filterEmpTasksByCustom(baseTasks, from, to) {
				const startDate = new Date(from);
				const endDate = new Date(to); endDate.setHours(23, 59, 59, 999);
				return (baseTasks || []).filter(task => { const d = new Date(task.created_at); return d >= startDate && d <= endDate; });
			}

			function showEmployeeView(empId) {
				const mount = document.getElementById('employeesContent');
				const emp = employees.find(e => String(e.id) === String(empId));
				if (!emp) { mount.innerHTML = emptyStateHTML; return; }
				// initial period: today
				currentEmpDateFilteredTasks = filterEmpTasksByPeriod(allTasks, 'today');
				const mode = window.__empViewMode || 'tasks';
				const isInstr = (t) => (t.title || '').startsWith('Instruction:');
				const base = currentEmpDateFilteredTasks.filter(t => mode === 'instructions' ? isInstr(t) : !isInstr(t));
				mount.innerHTML = renderEmployeePersonalViewLikeReports(base, emp);
				// show time filters
				document.getElementById('empTimeFilters')?.classList.remove('hidden');
			}

			if (deptPicker) {
				deptPicker.addEventListener('change', () => {
					comboItems = getEmployeesForDept(deptPicker.value);
					selectedEmpId = null;
					comboInput.value = '';
					comboList.classList.add('hidden');
					document.getElementById('employeesContent').innerHTML = emptyStateHTML;
					document.getElementById('empTimeFilters')?.classList.add('hidden');
				});
			}
			if (comboInput) {
				comboInput.addEventListener('focus', renderComboList);
				comboInput.addEventListener('input', () => { renderComboList(); });
			}
			if (comboList) {
				comboList.addEventListener('click', (e) => {
					const el = e.target.closest('[data-id]');
					if (!el) return;
					selectedEmpId = el.getAttribute('data-id');
					const emp = employees.find(x => String(x.id) === String(selectedEmpId));
					comboInput.value = emp ? `${emp.first_name || ''} ${emp.last_name || ''}` : '';
					comboList.classList.add('hidden');
					showEmployeeView(selectedEmpId);
				});
			}
			if (comboClear) {
				comboClear.addEventListener('click', () => {
					selectedEmpId = null;
					comboInput.value = '';
					comboList.classList.add('hidden');
					document.getElementById('employeesContent').innerHTML = emptyStateHTML;
					document.getElementById('empTimeFilters')?.classList.add('hidden');
				});
			}

			// Wire time filters for employee view
			const tf = document.getElementById('empTimeFilters');
			if (tf) {
				const buttons = Array.from(tf.querySelectorAll('.filter-button'));
				const customWrap = document.getElementById('empCustomRange');
				const applyBtn = document.getElementById('empApplyFilter');
				buttons.forEach(btn => {
					btn.addEventListener('click', () => {
						buttons.forEach(b => b.classList.remove('active'));
						btn.classList.add('active');
						const period = btn.getAttribute('data-period');
						if (period === 'custom') { customWrap.classList.remove('hidden'); return; }
						customWrap.classList.add('hidden');
						if (!selectedEmpId) return;
						currentEmpDateFilteredTasks = filterEmpTasksByPeriod(allTasks, period);
						const emp = employees.find(x => String(x.id) === String(selectedEmpId));
						if (emp) document.getElementById('employeesContent').innerHTML = renderEmployeePersonalViewLikeReports(currentEmpDateFilteredTasks, emp);
					});
				});
				if (applyBtn) {
					applyBtn.addEventListener('click', () => {
						const from = document.getElementById('empDateFrom').value;
						const to = document.getElementById('empDateTo').value;
						if (!selectedEmpId || !from || !to) return;
						currentEmpDateFilteredTasks = filterEmpTasksByCustom(allTasks, from, to);
						const emp = employees.find(x => String(x.id) === String(selectedEmpId));
						if (emp) document.getElementById('employeesContent').innerHTML = renderEmployeePersonalViewLikeReports(currentEmpDateFilteredTasks, emp);
					});
				}
			}

			// Wire Emp toggle
			const empBtnA = document.getElementById('empViewTasksBtn');
			const empBtnB = document.getElementById('empViewInstrBtn');
			if (empBtnA && empBtnB) {
				empBtnA.onclick = () => {
					window.__empViewMode = 'tasks';
					if (selectedEmpId) showEmployeeView(selectedEmpId);
					empBtnA.classList.add('active');
					empBtnB.classList.remove('active');
				};
				empBtnB.onclick = () => {
					window.__empViewMode = 'instructions';
					if (selectedEmpId) showEmployeeView(selectedEmpId);
					empBtnB.classList.add('active');
					empBtnA.classList.remove('active');
				};
			}
		}

		// Vue Tï¿½ches
		function renderTasksView() {
			const content = document.getElementById('dynamicContent');

			const heroHTML = `
				<div class="mb-6">
					<div class="flex items-center justify-between gap-4" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
						<div>
							<h2 class="text-2xl font-bold text-slate-900" data-translate="director.all_tasks">${t('director.all_tasks')}</h2>
							<p class="text-slate-600" data-translate="director.all_tasks_description">${t('director.all_tasks_description') || 'Manage and track all tasks in the system'}</p>
						</div>
						<div class="flex items-center space-x-2">
							<div class="flex items-center space-x-2">
								<button id="allTasksSortToggle" class="p-2 rounded-lg bg-gray-100 text-gray-600 transition-colors" title="Toggle Sort">
									<i class="fas fa-sort-alpha-down" id="allTasksSortIcon"></i>
								</button>
								<button id="allTasksViewModeCards" class="p-2 rounded-lg transition-colors bg-gray-100 text-gray-600" title="Cards View">
									<i class="fas fa-border-all"></i>
								</button>
								<button id="allTasksViewModeList" class="p-2 rounded-lg transition-colors" title="List View">
									<i class="fas fa-list"></i>
								</button>
							</div>
						</div>
					</div>
				</div>
			`;

			const filtersHTML = `
				<section style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
					<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 16px;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
						<!-- Filter Icon and Title -->
						<div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
							<i class="fas fa-filter" style="color: #3b82f6; font-size: 15px;"></i>
							<span style="font-size: 14px; font-weight: 600; color: #1e40af;" data-translate="director.filters_label">${t('director.filters_label') || 'Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª'}</span>
						</div>
						
						<!-- Filters -->
						<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
							<select id="statusFilter" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 110px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
								onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
								onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
								<option value="">${t('director.all_option') || 'Ø§Ù„ÙƒÙ„'}</option>
								<option value="Completed">${t('status.completed') || 'Ù…ÙƒØªÙ…Ù„'}</option>
								<option value="In Progress">${t('status.in_progress') || 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}</option>
								<option value="Pending">${t('status.pending') || 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</option>
								<option value="Not Done">${t('director.not_done') || 'ØºÙŠØ± Ù…Ù†Ø¬Ø²'}</option>
							</select>
							
							<select id="priorityFilter" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 110px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
								onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
								onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
								<option value="">${t('director.all_option') || 'Ø§Ù„ÙƒÙ„'}</option>
								<option value="High">${t('priority.high') || 'Ø¹Ø§Ù„ÙŠØ©'}</option>
								<option value="Medium">${t('priority.medium') || 'Ù…ØªÙˆØ³Ø·Ø©'}</option>
								<option value="Low">${t('priority.low') || 'Ù…Ù†Ø®ÙØ¶Ø©'}</option>
							</select>
							
							<select id="deptFilterTasks" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 130px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
								onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
								onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
								<option value="">${t('director.all_option') || 'Ø§Ù„ÙƒÙ„'}</option>
								${departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
							</select>
							
							<select id="empFilterTasks" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 130px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
								onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
								onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
								<option value="">${t('director.all_option') || 'Ø§Ù„ÙƒÙ„'}</option>
								${employees.map(e => `<option value="${e.id}">${e.first_name || ''} ${e.last_name || ''}</option>`).join('')}
							</select>
							
							<div style="position: relative;">
								<input id="searchTasks" type="text" placeholder="${t('director.search_placeholder') || 'Ø¨Ø­Ø«...'}" 
									style="padding: 8px 14px 8px 36px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; width: 160px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'" />
								<div style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
									<i class="fas fa-search" style="color: #64748b; font-size: 13px;"></i>
								</div>
							</div>
						</div>
						
						<!-- Action Buttons -->
						<div style="display: flex; align-items: center; gap: 10px; ${currentLanguage === 'ar' ? 'margin-right: auto;' : 'margin-left: auto;'}">
							<button id="showOverdue" style="padding: 8px 14px; font-size: 12px; font-weight: 600; color: #dc2626; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 1px solid #fca5a5; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(220,38,38,0.1);" 
								onmouseover="this.style.background='linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px rgba(220,38,38,0.15)'" 
								onmouseout="this.style.background='linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 2px rgba(220,38,38,0.1)'">
								<i class="fas fa-exclamation-triangle" style="font-size: 12px;"></i>
								<span data-translate="director.overdue_only">${t('director.overdue_only') || 'Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© ÙÙ‚Ø·'}</span>
							</button>
							<button id="clearFilters" style="padding: 8px 14px; font-size: 12px; font-weight: 600; color: #6b7280; background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" 
								onmouseover="this.style.background='linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
								onmouseout="this.style.background='linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
								<i class="fas fa-times" style="font-size: 12px;"></i>
								<span data-translate="director.clear">${t('director.clear') || 'Ù…Ø³Ø­'}</span>
							</button>
						</div>
					</div>
				</section>
			`;

			content.innerHTML = `
				<div class="dashboard-v-spacing-high">
					${filtersHTML}
					${heroHTML}
					<div id="tasksContainer"></div>
					
					<!-- Pagination Controls -->
					<div id="allTasksPagination" class="flex justify-center items-center space-x-4 mt-6 px-6">
						<button id="allTasksPrevBtn" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
							<i class="fas fa-chevron-left mr-2"></i>
							<span data-translate="common.previous">${t('common.previous')}</span>
						</button>
						<span id="allTasksPageInfo" class="text-sm text-gray-600">
							Page <span id="allTasksCurrentPage">1</span> of <span id="allTasksTotalPages">1</span>
						</span>
						<button id="allTasksNextBtn" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
							<span data-translate="common.next">${t('common.next')}</span>
							<i class="fas fa-chevron-right ml-2"></i>
						</button>
					</div>
				</div>
			`;

			renderFilteredTasks();
			setupTaskFilters();
		}

		function renderTaskRow(task) {
			const assignees = task.assignees || [];
			const deptNamesSet = new Set();
			assignees.forEach(a => {
				const deps = employeeDeptIds.get(String(a.id));
				if (deps) { deps.forEach(did => { const d = deptIdToDept.get(String(did)); if (d) deptNamesSet.add(d.name); }); }
			});
			const deptNames = Array.from(deptNamesSet);
			const metaChips = [
				`<span><i class="fas fa-calendar"></i>${t('tasks.due')}: ${formatDate(task.due_date)}</span>`,
				`<span><i class="fas fa-user-tie"></i>${t('director.by_label')}: ${(task.assigned_by_first_name || '')} ${(task.assigned_by_last_name || '')}</span>`,
				`<span><i class="fas fa-building"></i>${deptNames.length ? deptNames.join(', ') : t('common.no_data')}</span>`,
				`<span><i class="fas fa-clock"></i>${t('director.created')}: ${formatDate(task.created_at)}</span>`
			].join('');
			const assigneesHTML = assignees.length ? assignees.map(assignee => {
				const initials = getInitials(assignee.first_name, assignee.last_name) || getInitials('?', '');
				const employeeMatch = employees.find(e => e.id === assignee.id);
				const label = `${assignee.first_name || employeeMatch && employeeMatch.first_name || ''} ${assignee.last_name || employeeMatch && employeeMatch.last_name || ''}`.trim() || t('director.unnamed_employee');
				return `
						<div class="dir-task-assignee-chip">
							<div class="dir-task-assignee-avatar">${initials}</div>
							<div>
								<div class="text-sm font-semibold text-slate-900">${label}</div>
								<div class="text-xs text-slate-500">${assignee.status ? translateStatusValue(assignee.status) : t('common.no_data')}</div>
							</div>
						</div>`;
			}).join('') : `<span class="text-slate-400 text-sm" data-translate="director.no_assignees">${t('director.no_assignees')}</span>`;
			return `
					<div class="dir-task-card" onclick="dirShowTaskDetails('${task.id}')">
						<div class="dir-task-card-head">
							<div>
								<p class="dir-task-card-title">${task.title || t('director.no_title')}</p>
								<p class="dir-task-card-desc">${task.description || t('director.no_description_available')}</p>
							</div>
							<div class="dir-task-card-tags">
								<span class="px-3 py-1 text-xs font-semibold rounded-full ${getStatusBadge(task.status)}">${task.status ? translateStatusValue(task.status) : t('director.undefined')}</span>
								<span class="px-3 py-1 text-xs font-semibold rounded-full ${getPriorityBadge(task.priority)}">${task.priority ? translatePriorityValue(task.priority) : t('director.undefined')}</span>
								${isOverdue(task) ? `<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-exclamation-triangle mr-1"></i>${t('director.overdue')}</span>` : ''}
							</div>
						</div>
						<div class="dir-task-card-meta">${metaChips}</div>
						<div class="dir-task-assignees">${assigneesHTML}</div>
					</div>
				`;
		}

		function buildTaskResultsCard(tasks, options = {}) {
			const heading = options.heading || t('director.tasks');
			const subheading = options.subheading || '';
			const pagination = options.pagination;
			const totals = options.totals || {};
			const completed = tasks.filter(t => t.status === 'Completed').length;
			const inflight = tasks.filter(t => t.status === 'In Progress' || t.status === 'Pending').length;
			const overdue = tasks.filter(isOverdue).length;
			const overallTotal = typeof totals.total === 'number' ? totals.total : tasks.length;
			const overallCompleted = typeof totals.completed === 'number' ? totals.completed : completed;
			const overallInFlight = typeof totals.inflight === 'number' ? totals.inflight : inflight;
			const overallOverdue = typeof totals.overdue === 'number' ? totals.overdue : overdue;
			const body = tasks.length ? tasks.map(renderTaskRow).join('') : `
				<div class="dir-task-empty-state">
					<i class="fas fa-search text-4xl mb-3"></i>
					<p class="text-lg" data-translate="director.no_tasks_filters">${t('director.no_tasks_filters')}</p>
					<p class="text-sm text-slate-500" data-translate="director.widen_scope">${t('director.widen_scope')}</p>
				</div>`;
			const metricBadge = (label, value, icon, className) => `
				<div class="dir-task-metric ${className}">
					<div class="dir-task-metric-icon">
						<i class="${icon}"></i>
					</div>
					<div>
						<p class="dir-task-metric-label">${label}</p>
						<p class="dir-task-metric-value">${value}</p>
					</div>
				</div>`;
			const paginationMarkup = pagination ? `
				<div class="dir-task-pagination">
					<button id="dirTaskPrev" ${pagination.page <= 1 ? 'disabled' : ''}>${t('common.prev')}</button>
					<span class="text-xs font-medium text-slate-500">${t('common.page')} ${pagination.page} / ${pagination.totalPages}</span>
					<button id="dirTaskNext" ${pagination.page >= pagination.totalPages ? 'disabled' : ''}>${t('common.next')}</button>
				</div>` : '';
			return `
				<div class="dir-task-results-card">
					<div class="dir-task-results-head">
						<div class="dir-task-summary-line">
							<div class="flex items-center gap-2">
								<h3 class="text-sm font-semibold text-slate-900">${heading}</h3>
								<span class="dir-task-visibility">${tasks.length} ${t('director.visible')}</span>
								${overallTotal !== tasks.length ? `<span class="text-[0.7rem] text-slate-500">${t('director.of_label')} ${overallTotal}</span>` : ''}
							</div>
							${subheading ? `<span class="text-[0.7rem] text-slate-500">${subheading}</span>` : ''}
						</div>
						${overallTotal > 0 ? `
							<div class="dir-task-progress" aria-hidden="true">
								<span class="completed" style="flex:${Math.max(overallCompleted, 0)}"></span>
								<span class="inflight" style="flex:${Math.max(overallInFlight, 0)}"></span>
								<span class="overdue" style="flex:${Math.max(overallOverdue, 0)}"></span>
							</div>` : ''}
						${overallTotal > 0 ? `
							<div class="dir-task-metrics">
								${metricBadge(t('director.done'), overallCompleted, 'fas fa-check-circle', 'metric-done')}
								${metricBadge(t('director.in_flight'), overallInFlight, 'fas fa-plane-departure', 'metric-inflight')}
								${metricBadge(t('director.overdue'), overallOverdue, 'fas fa-bolt', 'metric-overdue')}
							</div>` : ''}
					</div>
					<div class="dir-task-results-body">${body}</div>
					${paginationMarkup}
				</div>
			`;
		}

		function renderFilteredTasks(resetPage = true) {
			const container = document.getElementById('tasksContainer');
			if (!container) return;

			const statusFilter = document.getElementById('statusFilter')?.value || '';
			const priorityFilter = document.getElementById('priorityFilter')?.value || '';
			const deptFilter = document.getElementById('deptFilterTasks')?.value || '';
			const empFilter = document.getElementById('empFilterTasks')?.value || '';
			const searchFilter = document.getElementById('searchTasks')?.value.toLowerCase() || '';

			let filteredTasks = [...allTasks];

			if (statusFilter) filteredTasks = filteredTasks.filter(t => t.status === statusFilter);
			if (priorityFilter) filteredTasks = filteredTasks.filter(t => t.priority === priorityFilter);
			if (deptFilter) {
				filteredTasks = filteredTasks.filter(t => (t.assignees || []).some(a => {
					const deps = employeeDeptIds.get(String(a.id));
					return deps && deps.has(String(deptFilter));
				}));
			}
			if (empFilter) filteredTasks = filteredTasks.filter(t => (t.assignees || []).some(a => String(a.id) === String(empFilter)));
			if (searchFilter) {
				filteredTasks = filteredTasks.filter(t => (t.title || '').toLowerCase().includes(searchFilter) || (t.description || '').toLowerCase().includes(searchFilter));
			}

			// Apply sorting
			filteredTasks = sortAllTasksByLanguage(filteredTasks);
			
			// Store filtered results and render
			dirTaskFilteredCache = filteredTasks;
			if (resetPage) allTasksCurrentPage = 1;
			renderAllTasksList(filteredTasks);
			updateAllTasksPagination(filteredTasks.length);
		}

		function renderAllTasksList(list) {
			console.log('renderAllTasksList called with:', list.length, 'items');
			const listEl = document.getElementById('tasksContainer');
			console.log('tasksContainer element:', listEl);
			
			const source = (list && list.length ? list : []);

			if (!listEl) {
				console.log('tasksContainer not found!');
				return;
			}

			if (!source.length) {
				console.log('No tasks to display, showing empty state');
				listEl.innerHTML = `<div class="p-16 text-center text-slate-400" data-translate="director.no_tasks_found">${t('director.no_tasks_found')}</div>`;
				return;
			}

			console.log('Rendering tasks in view mode:', allTasksCurrentViewMode);
			const paginatedList = getAllTasksPaginated(source);
			console.log('Paginated list length:', paginatedList.length);

			if (allTasksCurrentViewMode === 'list') {
				listEl.innerHTML = `
					<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden w-full">
						<table class="min-w-full divide-y divide-gray-200 w-full">
							<thead class="bg-gray-50">
								<tr>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.title">${t('director.title')}</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.status">${t('director.status')}</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="tasks.due">${t('tasks.due')}</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="tasks.priority">${t('tasks.priority')}</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.assigned">${t('director.assigned')}</th>
									<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.actions">${t('director.actions')}</th>
								</tr>
							</thead>
							<tbody class="bg-white divide-y divide-gray-200">
								${paginatedList.map(task => {
					const assignees = Array.isArray(task.assignees) ? task.assignees : [];
					const names = assignees.length ? assignees.map(a => (a.first_name || '') + ' ' + (a.last_name || '')).filter(n => n.trim()).join(', ') : t('common.none');
					return `
										<tr class="hover:bg-gray-50">
											<td class="px-6 py-4 whitespace-nowrap">
												<div class="text-sm font-medium text-gray-900">${task.title || t('director.no_title')}</div>
												<div class="text-sm text-gray-500">${task.description || t('director.no_description')}</div>
											</td>
											<td class="px-6 py-4 whitespace-nowrap">
												<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadge(task.status)}">
													${translateStatusValue(task.status || 'Pending')}
												</span>
											</td>
											<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(task.due_date)}</td>
											<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${translatePriorityValue(task.priority || 'Medium')}</td>
											<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${names}">${names}</td>
											<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
												<div class="flex justify-end gap-2">
													<button class="dir-table-action" onclick="dirShowTaskDetails('${task.id}')" title="${t('common.view')}"><i class="fas fa-eye"></i></button>
												</div>
											</td>
										</tr>
									`;
				}).join('')}
							</tbody>
						</table>
					</div>
				`;
				return;
			}

			// Card view (default)
			listEl.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${paginatedList.map(task => {
				const assignees = Array.isArray(task.assignees) ? task.assignees : [];
				const names = assignees.length ? assignees.map(a => (a.first_name || '') + ' ' + (a.last_name || '')).filter(n => n.trim()).join(', ') : t('common.none');
				const overdueClass = isOverdue(task) ? 'border-red-300' : '';
				return `
				<div class="timetable-card ${overdueClass}" style="padding: 24px;">
					<div style="display: flex; flex-direction: column; gap: 20px;">
						<!-- Header Section -->
						<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
							<div style="flex: 1; min-width: 0;">
								<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
									<span style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: #64748b;">${translateTaskTypeValue(task.type || 'Special')}</span>
									${isOverdue(task) ? `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fecaca; border-radius: 999px; font-size: 0.7rem; font-weight: 700; color: #dc2626;" data-translate="director.overdue"><i class="fas fa-exclamation-triangle"></i>${t('director.overdue')}</span>` : ''}
								</div>
								<h4 style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin: 0 0 8px 0; line-height: 1.3;">${task.title || t('director.no_title')}</h4>
								<p style="font-size: 0.9rem; color: #64748b; line-height: 1.5; margin: 0;">${task.description || t('director.no_description')}</p>
							</div>
							<span style="display: inline-block; padding: 6px 14px; font-size: 0.75rem; font-weight: 600; border-radius: 999px; white-space: nowrap;" class="${getStatusBadge(task.status)}">${translateStatusValue(task.status || 'Pending')}</span>
						</div>
						
						<!-- Info Grid -->
						<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
							<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 14px;">
								<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
									<i class="fas fa-users" style="font-size: 1rem;"></i>
								</div>
								<div style="flex: 1; min-width: 0;">
									<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #3B82F6; margin: 0 0 4px 0; font-weight: 600;" data-translate="director.assigned">${t('director.assigned')}</p>
									<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${names}">${names}</p>
								</div>
							</div>
							<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.04)); border: 1px solid rgba(124, 58, 237, 0.2); border-radius: 14px;">
								<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #7C3AED, #6D28D9); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
									<i class="fas fa-bolt" style="font-size: 1rem;"></i>
								</div>
								<div style="flex: 1; min-width: 0;">
									<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #7C3AED; margin: 0 0 4px 0; font-weight: 600;" data-translate="tasks.priority">${t('tasks.priority')}</p>
									<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${translatePriorityValue(task.priority || 'Medium')}</p>
								</div>
							</div>
							<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.04)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 14px;">
								<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #10B981, #059669); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
									<i class="fas fa-calendar" style="font-size: 1rem;"></i>
								</div>
								<div style="flex: 1; min-width: 0;">
									<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #10B981; margin: 0 0 4px 0; font-weight: 600;" data-translate="tasks.due">${t('tasks.due')}</p>
									<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${formatDate(task.due_date)}</p>
								</div>
							</div>
						</div>
						
						<!-- Actions -->
						<div style="display: flex; justify-content: flex-end; gap: 8px; padding-top: 16px; border-top: 1px solid rgba(148, 163, 184, 0.15);">
							<button class="dir-table-action" onclick="dirShowTaskDetails('${task.id}')" title="${t('common.view')}"><i class="fas fa-eye"></i><span data-translate="common.view">${t('common.view')}</span></button>
						</div>
					</div>
				</div>
			`;
			}).join('')}</div>`;
		}

		function getAllTasksPaginated(items) {
			const itemsPerPage = allTasksCurrentViewMode === 'cards' ? 10 : 20;
			const startIndex = (allTasksCurrentPage - 1) * itemsPerPage;
			const endIndex = startIndex + itemsPerPage;
			return items.slice(startIndex, endIndex);
		}

		function updateAllTasksPagination(totalItems) {
			const itemsPerPage = allTasksCurrentViewMode === 'cards' ? 10 : 20;
			const totalPages = Math.ceil(totalItems / itemsPerPage);
			
			const currentPageEl = document.getElementById('allTasksCurrentPage');
			const totalPagesEl = document.getElementById('allTasksTotalPages');
			const prevBtn = document.getElementById('allTasksPrevBtn');
			const nextBtn = document.getElementById('allTasksNextBtn');
			
			if (currentPageEl) currentPageEl.textContent = allTasksCurrentPage;
			if (totalPagesEl) totalPagesEl.textContent = totalPages;
			
			if (prevBtn) prevBtn.disabled = allTasksCurrentPage <= 1;
			if (nextBtn) nextBtn.disabled = allTasksCurrentPage >= totalPages;
		}

		function updateAllTasksViewModeButtons() {
			const btnCards = document.getElementById('allTasksViewModeCards');
			const btnList = document.getElementById('allTasksViewModeList');
			if (!btnCards || !btnList) return;

			if (allTasksCurrentViewMode === 'cards') {
				btnCards.classList.add('bg-blue-600', 'text-white');
				btnCards.classList.remove('bg-gray-100', 'text-gray-600');
				btnList.classList.add('bg-gray-100', 'text-gray-600');
				btnList.classList.remove('bg-blue-600', 'text-white');
			} else {
				btnList.classList.add('bg-blue-600', 'text-white');
				btnList.classList.remove('bg-gray-100', 'text-gray-600');
				btnCards.classList.add('bg-gray-100', 'text-gray-600');
				btnCards.classList.remove('bg-blue-600', 'text-white');
			}
		}

		function renderTaskPage(page = dirTaskCurrentPage) {
			const container = document.getElementById('tasksContainer');
			if (!container) return;
			const total = dirTaskFilteredCache.length;
			const totalPages = Math.max(1, Math.ceil(total / TASKS_PER_PAGE));
			const safePage = Math.min(Math.max(1, page), totalPages);
			dirTaskCurrentPage = safePage;
			const startIndex = (safePage - 1) * TASKS_PER_PAGE;
			const slice = dirTaskFilteredCache.slice(startIndex, startIndex + TASKS_PER_PAGE);
			const totals = {
				total,
				completed: dirTaskFilteredCache.filter(t => t.status === 'Completed').length,
				inflight: dirTaskFilteredCache.filter(t => t.status === 'In Progress' || t.status === 'Pending').length,
				overdue: dirTaskFilteredCache.filter(isOverdue).length
			};
			container.innerHTML = buildTaskResultsCard(slice, {
				heading: t('director.tasks'),
				subheading: '',
				pagination: { page: safePage, totalPages },
				totals
			});
			const prevBtn = document.getElementById('dirTaskPrev');
			const nextBtn = document.getElementById('dirTaskNext');
			if (prevBtn) prevBtn.onclick = () => { if (dirTaskCurrentPage > 1) renderTaskPage(dirTaskCurrentPage - 1); };
			if (nextBtn) nextBtn.onclick = () => { if (dirTaskCurrentPage < totalPages) renderTaskPage(dirTaskCurrentPage + 1); };
		}

		function setupTaskFilters() {
			const filters = ['statusFilter', 'priorityFilter', 'deptFilterTasks', 'empFilterTasks', 'searchTasks'];

			filters.forEach(filterId => {
				const element = document.getElementById(filterId);
				if (element) {
					element.addEventListener('change', () => renderFilteredTasks());
					element.addEventListener('input', () => renderFilteredTasks());
				}
			});

			// Bouton effacer les filtres
			const clearBtn = document.getElementById('clearFilters');
			if (clearBtn) {
				clearBtn.addEventListener('click', () => {
					filters.forEach(filterId => {
						const element = document.getElementById(filterId);
						if (element) element.value = '';
					});
					renderFilteredTasks();
				});
			}

			// Bouton afficher en retard
			const overdueBtn = document.getElementById('showOverdue');
			console.log('Overdue button found:', overdueBtn);
			if (overdueBtn) {
				overdueBtn.addEventListener('click', () => {
					console.log('Overdue button clicked!');
					console.log('All tasks:', allTasks.length);
					
					// Effacer tous les filtres d'abord
					filters.forEach(filterId => {
						const element = document.getElementById(filterId);
						if (element) element.value = '';
					});
					
					// Puis afficher seulement les tches en retard avec le nouveau systÃ¨me
					const overdueTasks = allTasks.filter(isOverdue);
					console.log('Overdue tasks found:', overdueTasks.length);
					
					dirTaskFilteredCache = overdueTasks;
					allTasksCurrentPage = 1;
					
					console.log('Rendering overdue tasks...');
					renderAllTasksList(overdueTasks);
					updateAllTasksPagination(overdueTasks.length);
				});
			} else {
				console.log('Overdue button not found!');
			}

			// Setup All Tasks view mode and sorting event listeners
			const btnCards = document.getElementById('allTasksViewModeCards');
			const btnList = document.getElementById('allTasksViewModeList');
			const sortBtn = document.getElementById('allTasksSortToggle');
			const sortIcon = document.getElementById('allTasksSortIcon');

			if (btnCards && btnList) {
				const updateViewMode = (mode) => {
					allTasksCurrentViewMode = mode;
					allTasksCurrentPage = 1; // Reset page when switching views
					updateAllTasksViewModeButtons();
					renderFilteredTasks(false);
				};
				btnCards.addEventListener('click', () => updateViewMode('cards'));
				btnList.addEventListener('click', () => updateViewMode('list'));
				updateAllTasksViewModeButtons();
			}

			// Sort toggle event listener
			if (sortBtn) {
				sortBtn.addEventListener('click', () => {
					console.log('Sort button clicked, current order:', allTasksSortOrder);
					allTasksSortOrder = allTasksSortOrder === 'asc' ? 'desc' : 'asc';
					console.log('New sort order:', allTasksSortOrder);
					updateSortIcon(sortIcon, allTasksSortOrder);
					renderFilteredTasks(false);
				});
			} else {
				console.log('Sort button not found');
			}

			// Pagination event listeners
			const prevBtn = document.getElementById('allTasksPrevBtn');
			const nextBtn = document.getElementById('allTasksNextBtn');
			
			if (prevBtn) {
				prevBtn.addEventListener('click', () => {
					if (allTasksCurrentPage > 1) {
						allTasksCurrentPage--;
						renderAllTasksList(dirTaskFilteredCache);
						updateAllTasksPagination(dirTaskFilteredCache.length);
					}
				});
			}
			
			if (nextBtn) {
				nextBtn.addEventListener('click', () => {
					const itemsPerPage = allTasksCurrentViewMode === 'cards' ? 10 : 20;
					const totalPages = Math.ceil(dirTaskFilteredCache.length / itemsPerPage);
					if (allTasksCurrentPage < totalPages) {
						allTasksCurrentPage++;
						renderAllTasksList(dirTaskFilteredCache);
						updateAllTasksPagination(dirTaskFilteredCache.length);
					}
				});
			}
		}

		// Gestion des vues avec systme de tabs (HR System Style)
		function switchView(viewName) {
			currentView = viewName;

			// Rcuprer tous les boutons de navigation (tabs)
			const allNavButtons = document.querySelectorAll('#directorTabs button[data-view]');

			// Reset: remettre tous les boutons leurtat normal (inactive style)
			allNavButtons.forEach(btn => {
				btn.style.background = 'transparent';
				btn.style.color = '#64748b';
				btn.style.fontWeight = '500';
				btn.style.boxShadow = 'none';
				btn.style.transform = 'translateY(0px)';
				
				// Update icon color
				const icon = btn.querySelector('i');
				if (icon) {
					icon.style.color = '#64748b';
				}
				
				// Hide hover overlay
				const overlay = btn.querySelector('div[style*="background: linear-gradient"]');
				if (overlay) {
					overlay.style.opacity = '0';
				}
			});

			// Activer le bouton slectionn (active style)
			const activeBtn = document.querySelector(`#directorTabs button[data-view="${viewName}"]`);
			if (activeBtn) {
				activeBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #6366f1 100%)';
				activeBtn.style.color = 'white';
				activeBtn.style.fontWeight = '600';
				activeBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.25)';
				activeBtn.style.transform = 'translateY(-1px)';
				
				// Update icon color for active tab
				const activeIcon = activeBtn.querySelector('i');
				if (activeIcon) {
					activeIcon.style.color = 'rgba(255, 255, 255, 0.9)';
				}
				
				// Hide hover overlay for active tab
				const activeOverlay = activeBtn.querySelector('div[style*="background: linear-gradient"]');
				if (activeOverlay) {
					activeOverlay.style.opacity = '0';
				}
			}

			// Rendre la vue appropriee
			switch (viewName) {
				case 'departments':
					// Departments view removed - redirect to responsibles
					renderResponsiblesViewV2();
					break;
				case 'responsibles':
					renderResponsiblesViewV2();
					break;
				case 'employees':
					renderEmployeesView();
					break;
				case 'tasks':
					renderTasksView();
					break;
				case 'mytasks':
					renderDirectorMyTasksView();
					break;
				case 'myinstructions':
					renderDirectorMyInstructionsView();
					break;
				default:
					renderDepartmentsView();
			}
		}

		// (supprimï¿½) Initialisation doublon via DOMContentLoaded ï¿½ init() gï¿½re dï¿½jï¿½ le rendu initial

		function setupEventListeners() {
			// Departments tab removed - no event listener needed
			document.getElementById('btnViewResponsibles').addEventListener('click', () => switchView('responsibles'));
			document.getElementById('btnViewEmployees').addEventListener('click', () => switchView('employees'));
			document.getElementById('btnViewTasks').addEventListener('click', () => switchView('tasks'));
			document.getElementById('btnViewMytasks').addEventListener('click', () => switchView('mytasks'));
			document.getElementById('btnViewMyinstructions').addEventListener('click', () => switchView('myinstructions'));

			// Add hover effects for tabs
			const allTabs = document.querySelectorAll('#directorTabs button[data-view]');
			allTabs.forEach(tab => {
				tab.addEventListener('mouseenter', () => {
					// Only apply hover effect if not active
					if (!tab.style.background || tab.style.background === 'transparent') {
						const overlay = tab.querySelector('div[style*="background: linear-gradient"]');
						if (overlay) {
							overlay.style.opacity = '1';
						}
					}
				});
				
				tab.addEventListener('mouseleave', () => {
					// Only remove hover effect if not active
					if (!tab.style.background || tab.style.background === 'transparent') {
						const overlay = tab.querySelector('div[style*="background: linear-gradient"]');
						if (overlay) {
							overlay.style.opacity = '0';
						}
					}
				});
			});

			// Add hover effect for create button
			const createBtn = document.getElementById('btnOpenTaskModal');
			if (createBtn) {
				createBtn.addEventListener('mouseenter', () => {
					const overlay = createBtn.querySelector('div[style*="background: linear-gradient"]');
					if (overlay) {
						overlay.style.opacity = '1';
					}
				});
				
				createBtn.addEventListener('mouseleave', () => {
					const overlay = createBtn.querySelector('div[style*="background: linear-gradient"]');
					if (overlay) {
						overlay.style.opacity = '0';
					}
				});
			}

			const refreshBtn = document.getElementById('btnDirectorRefresh');
			if (refreshBtn) {
				refreshBtn.addEventListener('click', async () => {
					if (refreshBtn.disabled) return;
					const icon = refreshBtn.querySelector('i');
					refreshBtn.disabled = true;
					refreshBtn.classList.add('opacity-60', 'cursor-not-allowed');
					if (icon) icon.classList.add('animate-spin');
					try {
						await loadCore();
						await buildEmployeeDeptIndex();
						updateKPIs();
						switchView(currentView);
					} catch (err) {
						console.error('Refresh failed', err);
					} finally {
						refreshBtn.disabled = false;
						refreshBtn.classList.remove('opacity-60', 'cursor-not-allowed');
						if (icon) icon.classList.remove('animate-spin');
					}
				});
			}

			// Language selector
			const languageSelector = document.getElementById('languageSelector');
			if (languageSelector) {
				languageSelector.value = (typeof currentLanguage !== 'undefined' ? currentLanguage : (window.currentLanguage || 'en'));
				languageSelector.addEventListener('change', (e) => {
					if (typeof setLanguage === 'function') {
						setLanguage(e.target.value);
					}
					if (typeof updatePageTranslations === 'function') {
						updatePageTranslations();
					}
					applyDirectorModalLocalization();
					updateHeroDate(e.target.value || getCurrentLanguage());
				});
			}

			// Initialize translations
			if (typeof updatePageTranslations === 'function') {
				updatePageTranslations();
			}
			applyDirectorModalLocalization();
			updateHeroDate(getCurrentLanguage());
			// Open/close modal
			const openBtn = document.getElementById('btnOpenTaskModal');
			const modal = document.getElementById('directorTaskModal');
			const closeBtn = document.getElementById('closeDirectorTaskModal');
			if (openBtn) openBtn.addEventListener('click', () => { modal.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); prepareDirectorModal(); });
			if (closeBtn) closeBtn.addEventListener('click', () => { modal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); });
			if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) { modal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); } });

			// Tabs
			const tabTask = document.getElementById('tabAddTask');
			const tabInstr = document.getElementById('tabAddInstruction');
			if (tabTask && tabInstr) {
				const sections = {
					task: document.getElementById('taskBuilderSection'),
					instruction: document.getElementById('instructionBuilderSection')
				};
				const activate = (mode) => {
					tabTask.classList.toggle('active', mode === 'task');
					tabInstr.classList.toggle('active', mode === 'instruction');

					const layout = document.querySelector('.dir-modal-layout');
					if (layout) {
						layout.classList.toggle('instruction-mode', mode === 'instruction');
					}

					// Hide/show sections
					if (sections.task) {
						sections.task.style.display = mode === 'task' ? 'block' : 'none';
					}
					if (sections.instruction) {
						sections.instruction.style.display = mode === 'instruction' ? 'block' : 'none';
					}
				};
				tabTask.addEventListener('click', () => activate('task'));
				tabInstr.addEventListener('click', () => activate('instruction'));
				// Initialize with task section visible
				activate('task');
			}

			// Forms submit handlers
			const cancel1 = document.getElementById('dirCancelBtn');
			const cancel2 = document.getElementById('dirCancelBtn2');
			if (cancel1) cancel1.addEventListener('click', () => { document.getElementById('directorTaskModal').classList.add('hidden'); document.body.classList.remove('overflow-hidden'); });
			if (cancel2) cancel2.addEventListener('click', () => { document.getElementById('directorTaskModal').classList.add('hidden'); document.body.classList.remove('overflow-hidden'); });

			const taskForm = document.getElementById('directorAddTaskForm');
			if (taskForm) taskForm.addEventListener('submit', submitDirectorTaskForm);
			const instrForm = document.getElementById('directorAddInstructionForm');
			if (instrForm) instrForm.addEventListener('submit', submitDirectorInstructionForm);

			// Target selection interaction
			const allSchoolCheckbox = document.getElementById('dirAllSchoolResponsibles');
			const deptSelectWrapper = document.getElementById('departmentSelectionWrapper');
			const deptSelect = document.getElementById('dirDeptSelect');
			const targetCards = document.querySelectorAll('.target-option-card');

			if (allSchoolCheckbox && deptSelectWrapper) {
				function updateDepartmentVisibility() {
					const isAllSchool = allSchoolCheckbox.checked;
					if (isAllSchool) {
						deptSelectWrapper.style.opacity = '0.5';
						deptSelectWrapper.style.pointerEvents = 'none';
						deptSelect.disabled = true;
					} else {
						deptSelectWrapper.style.opacity = '1';
						deptSelectWrapper.style.pointerEvents = 'auto';
						deptSelect.disabled = false;
					}
				}

				allSchoolCheckbox.addEventListener('change', updateDepartmentVisibility);

				// Handle card selection
				targetCards.forEach(card => {
					const input = card.querySelector('input');
					if (input) {
						input.addEventListener('change', () => {
							// Update card visual state
							targetCards.forEach(c => c.classList.remove('selected'));
							if (input.checked) {
								card.classList.add('selected');
							}

							// If "All Departments" is selected, uncheck radio buttons
							if (input.id === 'dirAllSchoolResponsibles' && input.checked) {
								document.getElementById('dirDeptResponsibleOnly').checked = false;
								document.getElementById('dirDeptAllEmployees').checked = false;
							} else if (input.type === 'radio' && input.checked) {
								allSchoolCheckbox.checked = false;
							}

							updateDepartmentVisibility();
						});
					}
				});

				// Initialize
				updateDepartmentVisibility();
				document.querySelector('.target-option-card').classList.add('selected');
			}
		}

		// ----- Helpers modal (reprise de repports.js) -----
		function toggleSection(sectionId) {
			const doc = document;
			const content = doc.getElementById(`section-${sectionId}`);
			const icon = doc.getElementById(`icon-${sectionId}`);
			if (!content || !icon) return;
			if (content.classList.contains('hidden')) {
				content.classList.remove('hidden');
				icon.textContent = '-';
			} else {
				content.classList.add('hidden');
				icon.textContent = '+';
			}
		}

		function showEmployeeDetails(employeeId, employeeName) {
			const baseTasks = window.currentFilteredTasksForModal || allTasks || [];
			const tasks = baseTasks.filter(task => (task.assignees || []).some(a => String(a.id) === String(employeeId)));

			const completedTasks = tasks.filter(task => {
				const a = (task.assignees || []).find(a => String(a.id) === String(employeeId));
				return a && a.status === 'Completed';
			});
			const inProgressTasks = tasks.filter(task => {
				const a = (task.assignees || []).find(a => String(a.id) === String(employeeId));
				return a && (a.status === 'In Progress' || a.status === 'Pending');
			});
			const overdueTasks = tasks.filter(task => {
				const a = (task.assignees || []).find(a => String(a.id) === String(employeeId));
				return a && a.status !== 'Completed' && new Date(task.due_date) < new Date();
			});

			const employeeRecord = employees.find(e => String(e.id) === String(employeeId)) || {};
			const initials = getInitials(employeeRecord.first_name || employeeName.split(' ')[0] || '', employeeRecord.last_name || employeeName.split(' ')[1] || '');
			const deptIds = employeeDeptIds.get(String(employeeId));
			const departmentNames = deptIds ? Array.from(deptIds).map(id => deptIdToDept.get(String(id))?.name).filter(Boolean) : [];

			const modalTitle = document.getElementById('modalTitle');
			modalTitle.innerHTML = `
					<div class="flex items-center gap-3">
					<div class="dir-emp-avatar-sm">${initials}</div>
						<div>
						<p class="text-xs uppercase tracking-[0.35em] text-slate-400 font-semibold" data-translate="director.employee_spotlight">${t('director.employee_spotlight')}</p>
						<h3 class="text-lg font-bold text-slate-900">${employeeName}</h3>
						</div>
					</div>
			`;

			const contactChips = [
				employeeRecord.email ? `<span class="dir-emp-contact-chip"><i class="fas fa-envelope"></i>${employeeRecord.email}</span>` : '',
				employeeRecord.phone ? `<span class="dir-emp-contact-chip"><i class="fas fa-phone"></i>${employeeRecord.phone}</span>` : '',
				departmentNames.length ? `<span class="dir-emp-contact-chip"><i class="fas fa-building"></i>${departmentNames.join(', ')}</span>` : ''
			].filter(Boolean).join('') || `<span class="dir-emp-contact-chip text-slate-400" data-translate="director.no_contact_details"><i class="fas fa-info-circle"></i>${t('director.no_contact_details')}</span>`;

			const summaryHTML = `
				<div class="dir-emp-summary-card">
					<div class="dir-emp-summary-main">
						<div class="flex items-center gap-4">
							<div class="dir-emp-avatar-lg">${initials}</div>
							<div class="dir-emp-summary-meta">
								<h3 class="text-xl font-semibold text-slate-900">${employeeName}</h3>
								<p class="text-sm text-slate-500">${employeeRecord.position || 'ï¿½'}</p>
						</div>
						</div>
						<div class="dir-emp-stat-row">
							<div class="dir-emp-stat-chip">
								<span data-translate="director.total">Total</span>
								<strong>${tasks.length}</strong>
						</div>
							<div class="dir-emp-stat-chip">
								<span data-translate="director.completed">Completed</span>
								<strong>${completedTasks.length}</strong>
						</div>
							<div class="dir-emp-stat-chip">
								<span data-translate="director.in_progress">In Progress</span>
								<strong>${inProgressTasks.length}</strong>
							</div>
							<div class="dir-emp-stat-chip">
								<span data-translate="director.overdue">Overdue</span>
								<strong>${overdueTasks.length}</strong>
							</div>
						</div>
					</div>
					<div class="dir-emp-contact mt-4">
						${contactChips}
					</div>
				</div>
			`;

			function renderTaskGroup(titleKey, accent, taskList) {
				if (!taskList.length) return '';
				const label = t(titleKey);
				return `
					<section class="dir-emp-section ${accent}">
						<div class="dir-emp-section-header">
								<div>
								<small class="text-xs text-slate-400 uppercase tracking-wide" data-translate="${titleKey}">${label}</small>
								<h4>${label}</h4>
								</div>
							<span class="dir-emp-count">${taskList.length}</span>
							</div>
						<div class="dir-emp-task-grid">
							${taskList.map(task => {
					const due = task.due_date ? formatDate(task.due_date) : 'ï¿½';
					const assigneeCount = task.assignees?.length || 0;
					const priorityTone = task.priority === 'High' ? 'bg-red-100 text-red-700' : task.priority === 'Medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-emerald-100 text-emerald-700';
					return `
									<article class="dir-emp-task-card">
										<div class="dir-emp-task-head">
											<h5 class="text-sm font-semibold text-slate-900">${task.title || t('director.untitled_task')}</h5>
											<span class="dir-emp-priority ${priorityTone}">${translatePriorityValue(task.priority || 'Medium')}</span>
						</div>
										<p class="dir-emp-task-desc">${task.description || `<span class="text-slate-400" data-translate="director.no_description">${t('director.no_description')}</span>`}</p>
										<div class="dir-emp-task-meta">
											<span><i class="fas fa-calendar-alt mr-1 text-slate-400"></i>${due}</span>
											<span><i class="fas fa-users mr-1 text-slate-400"></i>${assigneeCount}</span>
									</div>
									</article>
								`;
				}).join('')}
									</div>
					</section>
				`;
			}

			let sectionsHTML = `
				${renderTaskGroup('director.completed_tasks', 'green', completedTasks)}
				${renderTaskGroup('director.in_progress_tasks', 'yellow', inProgressTasks)}
				${renderTaskGroup('director.overdue_tasks', 'red', overdueTasks)}
			`;

			if (!tasks.length || !sectionsHTML.trim()) {
				sectionsHTML = `
					<div class="dir-emp-empty">
						<i class="fas fa-inbox text-3xl mb-3"></i>
						<p data-translate="director.no_tasks_for_employee">This employee has no assigned tasks.</p>
					</div>
				`;
			}

			document.getElementById('modalContent').innerHTML = summaryHTML + sectionsHTML;
			document.getElementById('employeeDetailsModal').classList.remove('hidden');
			document.body.classList.add('overflow-hidden');

			// Initialize translations
			if (typeof updatePageTranslations === 'function') {
				updatePageTranslations();
			}
		}

		function closeEmployeeDetails() {
			document.getElementById('employeeDetailsModal').classList.add('hidden');
			document.body.classList.remove('overflow-hidden');
		}

		// ===== Small Modal Helpers =====
		(function () {
			const small = document.getElementById('dirSmallModal');
			const btnClose = document.getElementById('dirSmallModalClose');
			const btnCancel = document.getElementById('dirSmallCancelBtn');
			function hide() { if (small) { small.classList.add('hidden'); small.classList.remove('flex'); } }
			if (btnClose) btnClose.addEventListener('click', hide);
			if (btnCancel) btnCancel.addEventListener('click', hide);
			window.__openSmallModal = function ({ title, bodyHTML, primaryLabel = 'OK', onPrimary }) {
				const t = document.getElementById('dirSmallModalTitle');
				const b = document.getElementById('dirSmallModalBody');
				const p = document.getElementById('dirSmallPrimaryBtn');
				if (!small || !t || !b || !p) return;
				t.textContent = title || 'Information';
				b.innerHTML = bodyHTML || '';
				p.textContent = primaryLabel || 'OK';
				p.onclick = async () => { try { if (onPrimary) await onPrimary(); } finally { hide(); } };
				small.classList.remove('hidden'); small.classList.add('flex');
			};
		})();

		// ===== Director Task Details (modal + comments) =====
		let dirCurrentTaskId = null;
		function openDirDetailsModal() {
			const m = document.getElementById('taskDetailsModalDir');
			if (!m) return; m.classList.remove('hidden'); m.classList.add('flex');
		}
		function closeDirDetailsModal() {
			const m = document.getElementById('taskDetailsModalDir');
			if (!m) return; m.classList.add('hidden'); m.classList.remove('flex');
		}
		document.addEventListener('click', (e) => {
			if (e.target && e.target.id === 'taskDetailsModalDir') closeDirDetailsModal();
		});
		(function () {
			const btn = document.getElementById('dirCloseDetailsModal');
			if (btn) btn.addEventListener('click', closeDirDetailsModal);
			const addBtn = document.getElementById('dirAddCommentBtn');
			if (addBtn) addBtn.addEventListener('click', dirAddComment);
		})();

		// Safe helper to get current user (works when embedded)
		function getEmbeddedUser() {
			try {
				if (window.parent && window.parent !== window && window.parent.authManager) {
					return window.parent.authManager.getUser();
				}
			} catch (e) {
				console.warn('Cannot access parent authManager user:', e);
			}
			try {
				if (typeof authManager !== 'undefined' && authManager.getUser) return authManager.getUser();
			} catch (_) { /* noop */ }
			try {
				const raw = localStorage.getItem('user');
				return raw ? JSON.parse(raw) : null;
			} catch (_) { return null; }
		}

		function updateHeroDate(lang) {
			try {
				const dateElement = document.getElementById('currentDate');
				if (!dateElement) return;
				const today = new Date();
				const options = { year: 'numeric', month: 'long', day: 'numeric', numberingSystem: 'latn' };
				let locale = 'en-US';
				if (lang === 'ar') locale = 'ar-SA';
				else if (lang === 'fr') locale = 'fr-FR';
				dateElement.textContent = today.toLocaleDateString(locale, options);
			} catch (e) {
				console.warn('updateHeroDate failed:', e);
			}
		}

		// =====================
		// Hero Notification UI (parity with stats dashboard)
		// =====================
		let heroNotifications = [];
		let heroNotificationRefreshInterval = null;

		function toggleHeroNotificationDropdown() {
			const dropdown = document.getElementById('notificationDropdown');
			if (!dropdown) return;
			const isHidden = dropdown.classList.contains('hidden');
			if (isHidden) {
				dropdown.classList.remove('hidden');
				loadHeroNotifications();
			} else {
				dropdown.classList.add('hidden');
			}
		}

		document.addEventListener('click', function (event) {
			const dropdown = document.getElementById('notificationDropdown');
			const bell = document.getElementById('notificationBell');
			if (!dropdown || !bell) return;
			if (!dropdown.contains(event.target) && !bell.contains(event.target)) {
				dropdown.classList.add('hidden');
			}
		});

		document.getElementById('notificationBell')?.addEventListener('click', function (e) {
			e.stopPropagation();
			toggleHeroNotificationDropdown();
		});

		document.getElementById('markAllReadBtn')?.addEventListener('click', function (e) {
			e.stopPropagation();
			markAllHeroNotificationsRead();
		});

		async function loadHeroNotifications() {
			showHeroNotificationLoading();
			try {
				const [tasks, reports, complaints, signals] = await Promise.all([
					loadHeroTaskNotifications(),
					loadHeroReportNotifications(),
					loadHeroComplaintNotifications(),
					loadHeroSignalNotifications()
				]);
				heroNotifications = [...tasks, ...reports, ...complaints, ...signals];
				heroNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
				const unreadCount = heroNotifications.filter(n => !n.isRead).length;
				updateHeroNotificationBadge(unreadCount);
				renderHeroNotifications(heroNotifications);
			} catch (error) {
				console.error('Error loading notifications:', error);
				showHeroNotificationEmpty();
			}
		}

		async function loadHeroTaskNotifications() {
			try {
				const response = await fetch(`${API}/tasks`, { headers: getAuthHeaders() });
				if (!response.ok) return [];
				const tasks = await response.json();
				const notifications = [];
				const now = new Date();
				tasks.forEach(task => {
					const dueDate = task.due_date ? new Date(task.due_date) : null;
					const isOverdue = dueDate && dueDate < now && task.status !== 'Completed';
					const isPending = task.status === 'Pending' || task.status === 'In Progress';
					if (isOverdue) {
						notifications.push({
							id: `task-${task.id}`,
							type: 'task',
							title: task.title || 'Task',
							message: `Overdue task - Due ${formatHeroNotificationDate(dueDate)}`,
							link: `tasks.html?task=${task.id}`,
							icon: 'fa-tasks',
							color: '#ef4444',
							timestamp: task.created_at,
							isRead: false
						});
					} else if (isPending && task.priority === 'high') {
						notifications.push({
							id: `task-${task.id}`,
							type: 'task',
							title: task.title || 'Task',
							message: 'High priority task pending',
							link: `tasks.html?task=${task.id}`,
							icon: 'fa-tasks',
							color: '#3b82f6',
							timestamp: task.created_at,
							isRead: false
						});
					}
				});
				return notifications.slice(0, 10);
			} catch (error) {
				console.error('Error loading task notifications:', error);
				return [];
			}
		}

		async function loadHeroReportNotifications() {
			try {
				const response = await fetch(`${API}/api/rapportemp/director/all-reports`, { headers: getAuthHeaders() });
				if (!response.ok) return [];
				const data = await response.json();
				const reports = data.reports || [];
				const notifications = [];
				reports.forEach(report => {
					let analysis = report.analysis;
					if (typeof analysis === 'string') {
						try { analysis = JSON.parse(analysis); } catch (e) { analysis = null; }
					}
					const urgencyScore = analysis?.urgency?.score || 0;
					if (report.status === 'pending' && urgencyScore >= 8) {
						notifications.push({
							id: `report-${report.id}`,
							type: 'report',
							title: report.title || 'Report',
							message: `Urgent report - Priority score: ${urgencyScore}/10`,
							link: `priorities.html?report=${report.id}`,
							icon: 'fa-file-alt',
							color: '#f59e0b',
							timestamp: report.created_at,
							isRead: false
						});
					}
				});
				return notifications.slice(0, 10);
			} catch (error) {
				console.error('Error loading report notifications:', error);
				return [];
			}
		}

		async function loadHeroComplaintNotifications() {
			try {
				const response = await fetch(`${API}/api/director/complaints-statistics`, { headers: getAuthHeaders() });
				if (!response.ok) return [];
				const data = await response.json();
				const overview = data.overview || {};
				const notifications = [];
				if (overview.pending > 0) {
					notifications.push({
						id: 'complaints-pending',
						type: 'complaint',
						title: 'Pending Complaints',
						message: `${overview.pending} complaint${overview.pending > 1 ? 's' : ''} awaiting review`,
						link: 'complaints_director.html',
						icon: 'fa-comment',
						color: '#ef4444',
						timestamp: new Date().toISOString(),
						isRead: false
					});
				}
				if (overview.overdue > 0) {
					notifications.push({
						id: 'complaints-overdue',
						type: 'complaint',
						title: 'Overdue Complaints',
						message: `${overview.overdue} complaint${overview.overdue > 1 ? 's' : ''} past due date`,
						link: 'complaints_director.html',
						icon: 'fa-comment',
						color: '#dc2626',
						timestamp: new Date().toISOString(),
						isRead: false
					});
				}
				return notifications;
			} catch (error) {
				console.error('Error loading complaint notifications:', error);
				return [];
			}
		}

		async function loadHeroSignalNotifications() {
			try {
				const response = await fetch(`${API}/api/director/signals-stats`, { headers: getAuthHeaders() });
				if (!response.ok) return [];
				const data = await response.json();
				const overview = data.overview || {};
				const notifications = [];
				if (overview.pending > 0) {
					notifications.push({
						id: 'signals-pending',
						type: 'signal',
						title: 'Pending Signals',
						message: `${overview.pending} signal${overview.pending > 1 ? 's' : ''} awaiting treatment`,
						link: 'signals_responsible.html',
						icon: 'fa-exclamation-triangle',
						color: '#10b981',
						timestamp: new Date().toISOString(),
						isRead: false
					});
				}
				if (overview.high_priority > 0) {
					notifications.push({
						id: 'signals-high-priority',
						type: 'signal',
						title: 'High Priority Signals',
						message: `${overview.high_priority} high priority signal${overview.high_priority > 1 ? 's' : ''}`,
						link: 'signals_responsible.html',
						icon: 'fa-exclamation-triangle',
						color: '#059669',
						timestamp: new Date().toISOString(),
						isRead: false
					});
				}
				return notifications;
			} catch (error) {
				console.error('Error loading signal notifications:', error);
				return [];
			}
		}

		function updateHeroNotificationBadge(count) {
			const badge = document.getElementById('notificationCount');
			if (!badge) return;
			badge.textContent = count;
			badge.style.display = count > 0 ? 'flex' : 'none';
		}

		function renderHeroNotifications(notifications) {
			const listContainer = document.getElementById('notificationList');
			const loading = document.getElementById('notificationLoading');
			const empty = document.getElementById('notificationEmpty');
			if (!listContainer) return;
			if (loading) loading.style.display = 'none';
			const existingItems = listContainer.querySelectorAll('.notification-item');
			existingItems.forEach(item => item.remove());
			if (!notifications || notifications.length === 0) {
				if (empty) empty.classList.remove('hidden');
				return;
			}
			if (empty) empty.classList.add('hidden');
			notifications.forEach(notification => {
				const item = createHeroNotificationItem(notification);
				listContainer.appendChild(item);
			});
		}

		function createHeroNotificationItem(notification) {
			const div = document.createElement('div');
			div.className = `notification-item ${notification.isRead ? '' : 'unread'}`;
			div.style.position = 'relative';
			div.innerHTML = `
				<div class="notification-icon ${notification.type}">
					<i class="fas ${notification.icon}"></i>
				</div>
				<div class="notification-content">
					<div class="notification-title">${notification.title}</div>
					<div class="notification-message">${notification.message}</div>
					<div class="notification-time">
						<i class="fas fa-clock"></i>
						${formatHeroRelativeTime(notification.timestamp)}
					</div>
				</div>
			`;
			div.addEventListener('click', () => { window.location.href = notification.link; });
			return div;
		}

		function formatHeroRelativeTime(timestamp) {
			const now = new Date();
			const date = new Date(timestamp);
			const diffMs = now - date;
			const diffMins = Math.floor(diffMs / 60000);
			const diffHours = Math.floor(diffMs / 3600000);
			const diffDays = Math.floor(diffMs / 86400000);
			if (diffMins < 1) return 'Just now';
			if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
			if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
			if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
			return formatHeroNotificationDate(date);
		}

		function formatHeroNotificationDate(date) {
			if (!date) return '';
			const d = new Date(date);
			return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
		}

		function showHeroNotificationLoading() {
			const loading = document.getElementById('notificationLoading');
			const empty = document.getElementById('notificationEmpty');
			if (loading) loading.style.display = 'flex';
			if (empty) empty.classList.add('hidden');
		}

		function showHeroNotificationEmpty() {
			const loading = document.getElementById('notificationLoading');
			const empty = document.getElementById('notificationEmpty');
			if (loading) loading.style.display = 'none';
			if (empty) empty.classList.remove('hidden');
		}

		function markAllHeroNotificationsRead() {
			heroNotifications.forEach(n => n.isRead = true);
			updateHeroNotificationBadge(0);
			renderHeroNotifications(heroNotifications);
		}

		function startHeroNotificationRefresh() {
			if (heroNotificationRefreshInterval) clearInterval(heroNotificationRefreshInterval);
			heroNotificationRefreshInterval = setInterval(() => { loadHeroNotifications(); }, 30000);
		}

		setTimeout(() => {
			loadHeroNotifications();
			startHeroNotificationRefresh();
		}, 1000);

		async function dirShowTaskDetails(taskId) {
			const task = (allTasks || []).find(t => String(t.id) === String(taskId));
			if (!task) return;
			dirCurrentTaskId = taskId;
			const assignees = task.assignees || [];
			const assigneesHtml = assignees.length ? assignees.map(a => `
				<div class="task-assignee-card">
					<div class="flex justify-between items-center">
						<div>
							<p class="font-semibold text-gray-900">${((a.first_name || '') + ' ' + (a.last_name || '')).trim() || t('common.unknown')}</p>
							${a.completed_at ? `<p class="text-xs text-gray-500 mt-1">${t('director.completed')}: ${new Date(a.completed_at).toLocaleString(getCurrentLanguage() === 'ar' ? 'ar-EG' : getCurrentLanguage() === 'fr' ? 'fr-FR' : undefined)}</p>` : ''}
						</div>
						<span class="px-2.5 py-1 rounded-full text-xs font-semibold ${getStatusBadge(a.status)}">${translateStatusValue(a.status || 'Pending')}</span>
					</div>
				</div>
			`).join('') : `<p class="text-gray-500 text-sm" data-translate="director.no_assignees">${t('director.no_assignees')}</p>`;

			document.getElementById('dirDetailsTitle').textContent = task.title || t('director.task_details_heading');
			document.getElementById('dirTaskDetailsContent').innerHTML = `
				<div class="task-details-card">
					<div class="mb-4" style="direction: rtl; text-align: right;">
						<h3 class="text-lg font-semibold text-gray-900 mb-2" style="text-align: right; direction: rtl;">${task.title || t('director.task_details_heading')}</h3>
						<p class="text-sm text-gray-600 mb-3" style="text-align: right; direction: rtl;">${task.description || t('director.no_description_available')}</p>
						<div class="rtl-badge-container">
							<span class="task-info-badge">${translateStatusValue(task.status || 'Pending')}</span>
							<span class="task-priority-badge">${t('director.priority_label')}: ${translatePriorityValue(task.priority || 'Medium')}</span>
							<span class="task-type-badge">${translateTaskTypeValue(task.type || 'Special')}</span>
						</div>
					</div>
				</div>
				
				<div class="task-meta-grid">
					<div class="task-meta-item">
						<div class="task-meta-label" data-translate="director.status_label">${t('director.status_label')}</div>
						<div class="task-meta-value">${translateStatusValue(task.status || 'Pending')}</div>
					</div>
					<div class="task-meta-item">
						<div class="task-meta-label" data-translate="director.due_label">${t('director.due_label')}</div>
						<div class="task-meta-value">${formatDate(task.due_date) || 'â€”'}</div>
					</div>
					<div class="task-meta-item">
						<div class="task-meta-label" data-translate="director.created_label">${t('director.created_label')}</div>
						<div class="task-meta-value">${formatDate(task.created_at) || 'â€”'}</div>
					</div>
					<div class="task-meta-item">
						<div class="task-meta-label" data-translate="director.by_label">${t('director.by_label')}</div>
						<div class="task-meta-value">${((task.assigned_by_first_name || '') + ' ' + (task.assigned_by_last_name || '')).trim() || t('common.unknown')}</div>
					</div>
				</div>
				
				<div class="task-description-card">
					<h4 data-translate="director.description_heading">${t('director.description_heading')}</h4>
					<p class="text-gray-700 text-sm leading-relaxed">${task.description || t('director.no_description')}</p>
				</div>
				
				<div class="task-description-card">
					<h4 data-translate="director.assignees_heading">${t('director.assignees_heading')}</h4>
					<div class="space-y-2">${assigneesHtml}</div>
				</div>
			`;
			await dirLoadAndDisplayComments(taskId);
			openDirDetailsModal();
		}

		async function dirLoadAndDisplayComments(taskId) {
			const wrap = document.getElementById('dirTaskComments');
			if (!wrap) return; wrap.innerHTML = `<p class="text-gray-500 text-sm" data-translate="director.loading">${t('director.loading')}</p>`;
			try {
				const r = await fetch(`${API}/tasks/${taskId}/comments`);
				const data = await r.json();
				const list = (data && data.success && Array.isArray(data.comments)) ? data.comments : [];
				wrap.innerHTML = list.length ? list.map(c => `
					<div class="bg-gray-50 rounded-lg p-3">
						<div class="flex items-center justify-between mb-1">
							<span class="text-sm font-medium text-gray-900">${(c.first_name || '') + ' ' + (c.last_name || '')}</span>
							<span class="text-xs text-gray-500">${c.created_at ? new Date(c.created_at).toLocaleString('fr-FR') : ''}</span>
						</div>
						<p class="text-sm text-gray-700">${c.comment || c.text || ''}</p>
					</div>
				`).join('') : `<p class="text-gray-500 text-sm" data-translate="director.no_comments">${t('director.no_comments')}</p>`;
			} catch (_) { wrap.innerHTML = `<p class="text-red-500 text-sm" data-translate="director.error_loading">${t('director.error_loading')}</p>`; }
		}

		async function dirAddComment() {
			const input = document.getElementById('dirNewComment');
			if (!input) return; const text = (input.value || '').trim(); if (!text || !dirCurrentTaskId) return;
			try {
				const employeeId = getDirectorEmployeeId();
				const resp = await fetch(`${API}/tasks/${dirCurrentTaskId}/comments`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ comment: text, employee_id: employeeId }) });
				const data = await resp.json();
				if (!resp.ok || !data.success) throw new Error(data.error || `HTTP ${resp.status}`);
				input.value = '';
				await dirLoadAndDisplayComments(dirCurrentTaskId);
			} catch (err) { console.error('dirAddComment', err); }
		}

		document.addEventListener('click', function (e) {
			const modal = document.getElementById('employeeDetailsModal');
			if (e.target === modal) { modal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }
		});

		// Initialisation
		async function init() {
			try {
				console.log('Initialisation...');
				await loadCore();
				await buildEmployeeDeptIndex();
				await initializeDirectorEmployeeId(); // Initialize director employee ID cache
				updateHeroDate(getCurrentLanguage());
				updateKPIs();
				setupEventListeners();
				switchView('mytasks'); // Vue par dï¿½faut : Mes tï¿½ches
				// Notifications (socket-only)
				setupSocketNotificationsDirector();
				setupEmpNotificationsUIDirector();
				console.log('Initialisation terminï¿½e');
			} catch (error) {
				console.error('Erreur lors de l\'initialisation:', error);
				document.getElementById('dynamicContent').innerHTML = `
					<div class="bg-red-50 border border-red-200 rounded-lg p-6">
						<div class="flex items-center">
							<i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
							<div>
								<h3 class="text-lg font-semibold text-red-800">Erreur de chargement</h3>
								<p class="text-red-600 mt-1">Impossible de charger les donnï¿½es. Vï¿½rifiez que le serveur API est accessible.</p>
								<button onclick="init()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
									<i class="fas fa-sync-alt mr-2"></i>Rï¿½essayer
								</button>
							</div>
						</div>
					</div>
				`;
			}
		}

		// Helpers Director Modal
		let dirAllEmployeesCache = [];
		let dirSelectedEmployeeIds = new Set();
		let dirCurrentFilteredEmployees = [];
		let dirEditingTaskId = null;
		let cachedDirectorEmployeeId = null;

		// Initialize director employee ID cache
		async function initializeDirectorEmployeeId() {
			if (cachedDirectorEmployeeId) return cachedDirectorEmployeeId;

			// Try to get from parent window's authManager (if embedded)
			try {
				if (window.parent && window.parent !== window && window.parent.authManager) {
					const authManager = window.parent.authManager;
					if (authManager.isAuthenticated && authManager.isAuthenticated()) {
						const user = authManager.getUser();
						if (user && user.id) {
							// Find employee with matching user_id and role Director
							const directorEmployee = employees.find(emp => {
								// Check if employee's user_id matches the current user's id
								return emp.user_id === user.id ||
									(emp.id === user.employee_id) ||
									(emp.id === user.id);
							});

							if (directorEmployee) {
								console.log('? Found director employee from authManager:', directorEmployee);
								cachedDirectorEmployeeId = directorEmployee.id;
								return cachedDirectorEmployeeId;
							}

							// If not found in employees list, try fetching from API
							try {
								const usersApiBase = window.parent.API_SERVICES?.users || 'http://localhost:3002';
								const token = authManager.getToken();
								if (token && usersApiBase) {
									const response = await fetch(`${usersApiBase}/profile`, {
										headers: {
											'Authorization': `Bearer ${token}`
										}
									});

									if (response.ok) {
										const profile = await response.json();
										// Profile might have employee_id or id that's the employee ID
										if (profile.id && profile.role === 'Director') {
											// Find employee with this ID or user_id
											const emp = employees.find(e =>
												e.id === profile.id ||
												e.user_id === profile.id ||
												e.id === profile.employee_id
											);
											if (emp) {
												console.log('? Found director employee from profile API:', emp);
												cachedDirectorEmployeeId = emp.id;
												return cachedDirectorEmployeeId;
											}
											// If profile.id is the employee ID itself
											if (profile.id && !employees.find(e => e.user_id === profile.id)) {
												cachedDirectorEmployeeId = profile.id;
												return cachedDirectorEmployeeId;
											}
										}
									}
								}
							} catch (e) {
								console.warn('Could not fetch profile from API:', e);
							}
						}
					}
				}
			} catch (e) {
				console.warn('Could not access parent authManager:', e);
			}

			// Fallback: Try URL parameters
			const urlParams = new URLSearchParams(window.location.search);
			let empId = urlParams.get('employee_id') || urlParams.get('user_id');

			// Last fallback: use first responsible (should not happen if auth is working)
			if (!empId) {
				empId = responsibles?.[0]?.id;
				console.warn('?? No director employee found, using fallback:', empId);
			}

			if (empId) {
				cachedDirectorEmployeeId = empId;
			}

			return cachedDirectorEmployeeId;
		}

		// Synchronous version that uses cache
		function getDirectorEmployeeId() {
			if (cachedDirectorEmployeeId) {
				return cachedDirectorEmployeeId;
			}

			// Try synchronous lookup if possible
			try {
				if (window.parent && window.parent !== window && window.parent.authManager) {
					const authManager = window.parent.authManager;
					if (authManager.isAuthenticated && authManager.isAuthenticated()) {
						const user = authManager.getUser();
						if (user && user.id && Array.isArray(employees) && employees.length > 0) {
							const directorEmployee = employees.find(emp => {
								return emp.user_id === user.id ||
									(emp.id === user.employee_id) ||
									(emp.id === user.id);
							});

							if (directorEmployee) {
								cachedDirectorEmployeeId = directorEmployee.id;
								return cachedDirectorEmployeeId;
							}
						}
					}
				}
			} catch (e) {
				// Ignore errors, will use fallback
			}

			// Fallback: Try URL parameters
			const urlParams = new URLSearchParams(window.location.search);
			const empId = urlParams.get('employee_id') || urlParams.get('user_id');

			if (empId) {
				cachedDirectorEmployeeId = empId;
				return empId;
			}

			// Last fallback
			return responsibles?.[0]?.id || null;
		}

		function tomorrowISO() { const d = new Date(); d.setDate(d.getDate() + 1); return d.toISOString().split('T')[0]; }

		async function prepareDirectorModal() {
			try {
				const due1 = document.getElementById('dirTaskDueDate'); if (due1) due1.value = tomorrowISO();
				const due2 = document.getElementById('dirInstructionDueDate'); if (due2) due2.value = tomorrowISO();

				// Ensure employees are cached
				dirAllEmployeesCache = (employees && employees.length) ? employees : (await fetchAllEmployees());

				if (!(dirSelectedEmployeeIds && dirSelectedEmployeeIds.size)) {
					dirSelectedEmployeeIds = new Set();
				}

				dirCurrentFilteredEmployees = dirAllEmployeesCache.slice();
				updateDirSelectedBadges();

				const deptSel = document.getElementById('dirDeptSelect');
				if (deptSel) {
					deptSel.innerHTML = (departments || []).map(d => `<option value="${d.id}">${d.name}</option>`).join('');
				}

				// Initialize integrated sidebar picker
				renderAssigneePicker();

				// Attach listeners for integrated sidebar (only once)
				setupIntegratedSidebarListeners();

				updateDirectorModalOverview();
				applyDirectorModalLocalization();
			} catch (e) { console.error('prepareDirectorModal error', e); }
		}

		let sidebarListenersAttached = false;
		function setupIntegratedSidebarListeners() {
			if (sidebarListenersAttached) return;

			const search = document.getElementById('assigneeSearchInput');
			const selAll = document.getElementById('assigneeSelectAll');
			const clrAll = document.getElementById('assigneeClearAll');
			const selResp = document.getElementById('assigneeSelectResponsibles');

			if (search) search.oninput = debounce(() => renderAssigneePicker(), 200);
			if (selAll) selAll.onclick = () => { collectAllAssigneeIds().forEach(id => dirSelectedEmployeeIds.add(String(id))); renderAssigneePicker(); };
			if (clrAll) clrAll.onclick = () => { dirSelectedEmployeeIds.clear(); renderAssigneePicker(); };
			if (selResp) {
				selResp.onchange = () => {
					(departments || []).forEach(d => {
						if (d && d.responsible_id) {
							if (selResp.checked) dirSelectedEmployeeIds.add(String(d.responsible_id));
							else dirSelectedEmployeeIds.delete(String(d.responsible_id));
						}
					});
					renderAssigneePicker();
				};
			}
			sidebarListenersAttached = true;
		}

		function debounce(func, wait) {
			let timeout;
			return function (...args) {
				clearTimeout(timeout);
				timeout = setTimeout(() => func.apply(this, args), wait);
			};
		}

		function renderDirEmployees(list) {
			const container = document.getElementById('dirEmployeesContainer'); if (!container) return;
			const html = `
				<div class="space-y-2">
					${list.map(e => {
				const idStr = String(e.id);
				const checkedAttr = dirSelectedEmployeeIds.has(idStr) ? 'checked' : '';
				return `
						<label class=\"flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer\"> 
							<input type=\"checkbox\" ${checkedAttr} class=\"dir-emp-checkbox mr-2\" value=\"${idStr}\"> 
							<span class=\"text-sm\">${e.first_name || ''} ${e.last_name || ''}</span>
						</label>`;
			}).join('')}
				</div>`;
			container.innerHTML = html;
			Array.from(container.querySelectorAll('.dir-emp-checkbox')).forEach(cb => {
				cb.addEventListener('change', (ev) => {
					const val = String(ev.target.value);
					if (ev.target.checked) { dirSelectedEmployeeIds.add(val); } else { dirSelectedEmployeeIds.delete(val); }
					updateDirSelectedBadges();
				});
			});
			updateDirSelectedBadges();
		}

		function updateDirSelectedBadges() {
			const wrap = document.getElementById('dirSelectedEmployees'); if (!wrap) return;
			const ids = Array.from(dirSelectedEmployeeIds);
			if (!ids.length) {
				wrap.classList.add('hidden');
				wrap.innerHTML = '';
				updateDirAssigneeCountDisplay();
				updateDirectorModalOverview();
				return;
			}
			const byId = new Map((dirAllEmployeesCache || []).map(e => [String(e.id), e]));
			const removeLabel = resolveDirectorLocale('assignee.clear_badge', 'Unselect');
			wrap.innerHTML = ids.map(id => {
				const e = byId.get(String(id));
				const name = e ? `${e.first_name || ''} ${e.last_name || ''}`.trim() : `ID ${id}`;
				return `
					<span class=\"px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs inline-flex items-center gap-1\">
						${name}
						<button type="button" 
        class="ml-1 text-blue-700 hover:text-red-700" 
        title="${removeLabel}" 
        onclick="dirRemoveSelectedEmployee('${String(id)}')" 
        style="padding:4px !important; font-size:12px !important; line-height:1.2 !important;">
    <i class="fas fa-times" style="font-size:12px !important;"></i>
</button>

					</span>`;
			}).join('');
			wrap.classList.remove('hidden');
			updateDirAssigneeCountDisplay();
			updateDirectorModalOverview();
		}

		function dirRemoveSelectedEmployee(id) {
			try {
				const idStr = String(id);
				dirSelectedEmployeeIds.delete(idStr);
				updateDirSelectedBadges();
				renderDirEmployees(dirCurrentFilteredEmployees && dirCurrentFilteredEmployees.length ? dirCurrentFilteredEmployees : dirAllEmployeesCache);
			} catch (_) {/* noop */ }
		}

		function filterEmployees() {
			try {
				const search = document.getElementById('dirEmployeeSearch');
				const q = (search?.value || '').trim().toLowerCase();
				dirCurrentFilteredEmployees = (dirAllEmployeesCache || []).filter(e => (`${e.first_name || ''} ${e.last_name || ''}`).toLowerCase().includes(q));
				renderDirEmployees(dirCurrentFilteredEmployees);
			} catch (_) {/* noop */ }
		}

		async function submitDirectorTaskForm(e) {
			e.preventDefault();
			try {
				const assignedBy = getDirectorEmployeeId(); if (!assignedBy) { alert('Impossible d\'identifier le directeur'); return; }
				const title = document.getElementById('dirTaskTitle').value.trim();
				const description = document.getElementById('dirTaskDescription').value.trim();
				const type = document.getElementById('dirTaskType').value;
				const priority = document.getElementById('dirTaskPriority').value;
				const due_date = document.getElementById('dirTaskDueDate').value || null;
				const assigned_to = Array.from(dirSelectedEmployeeIds || new Set());
				if (!assigned_to.length) { alert('Sï¿½lectionnez au moins un employï¿½'); return; }
				const payload = { title, description, type, priority, due_date, assigned_to, assigned_by: assignedBy };
				let resp, data;
				if (dirEditingTaskId) {
					resp = await fetch(`${API}/tasks/${encodeURIComponent(dirEditingTaskId)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
					data = await resp.json(); if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);
					if (window.showToast) { window.showToast({ type: 'success', title: 'Tï¿½che mise ï¿½ jour', message: 'La tï¿½che a ï¿½tï¿½ mise ï¿½ jour avec succï¿½s.' }); }
				} else {
					resp = await fetch(`${API}/tasks`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
					data = await resp.json(); if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);
					if (window.showToast) { window.showToast({ type: 'success', title: 'Tï¿½che crï¿½ï¿½e', message: 'La tï¿½che a ï¿½tï¿½ crï¿½ï¿½e avec succï¿½s.' }); }
				}
				// reset edit state and close
				dirEditingTaskId = null;
				const submitBtn = document.querySelector('#directorAddTaskForm button[type="submit"]'); if (submitBtn) submitBtn.textContent = 'Crï¿½er';
				document.getElementById('directorTaskModal').classList.add('hidden'); document.body.classList.remove('overflow-hidden');
				// refresh data and view
				await loadCore();
				await buildEmployeeDeptIndex();
				updateKPIs();
				if (currentView === 'mytasks') { renderDirectorMyTasksView(); }
			} catch (err) { console.error('submitDirectorTaskForm error', err); if (window.showToast) { window.showToast({ type: 'error', title: 'ï¿½chec de l\'opï¿½ration', message: err && err.message ? err.message : 'Erreur inconnue' }); } else { alert('Erreur: ' + (err.message || 'inconnue')); } }
		}

		async function submitDirectorInstructionForm(e) {
			e.preventDefault();
			try {
				const assignedBy = getDirectorEmployeeId(); if (!assignedBy) { alert('Impossible d\'identifier le directeur'); return; }
				const text = document.getElementById('dirInstructionText').value.trim(); if (!text) { alert('Veuillez saisir une instruction'); return; }
				const prio = document.getElementById('dirInstructionPriority').value;
				const due = document.getElementById('dirInstructionDueDate').value || null;
				const allSchool = document.getElementById('dirAllSchoolResponsibles').checked;
				let assigned_to = [];
				if (allSchool) {
					assigned_to = (departments || []).map(d => d.responsible_id).filter(Boolean);
				} else {
					const deptId = document.getElementById('dirDeptSelect').value;
					const respOnly = document.getElementById('dirDeptResponsibleOnly').checked;
					const allEmp = document.getElementById('dirDeptAllEmployees').checked;
					if (!deptId) { alert('Veuillez choisir un dï¿½partement'); return; }
					if (respOnly) {
						const dept = (departments || []).find(d => String(d.id) === String(deptId));
						if (dept && dept.responsible_id) assigned_to = [dept.responsible_id];
					}
					if (allEmp) {
						const list = await fetchDepartmentEmployees(deptId);
						assigned_to = assigned_to.concat(list.map(e => e.id));
					}
				}
				assigned_to = Array.from(new Set(assigned_to.filter(Boolean)));
				if (!assigned_to.length) { alert('Aucun destinataire dï¿½terminï¿½'); return; }
				const payload = { body: text, priority: prio, due_at: due, created_by_employee_id: assignedBy, recipients: assigned_to };
				const resp = await fetch(`${API}/api/instructions`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
				const data = await resp.json(); if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);
				if (window.showToast) { window.showToast({ type: 'success', title: 'Instruction envoyï¿½e', message: 'Votre instruction a ï¿½tï¿½ envoyï¿½e avec succï¿½s.' }); }
				document.getElementById('directorTaskModal').classList.add('hidden'); document.body.classList.remove('overflow-hidden');
			} catch (err) { console.error('submitDirectorInstructionForm error', err); if (window.showToast) { window.showToast({ type: 'error', title: "ï¿½chec de l'opï¿½ration", message: err && err.message ? err.message : 'Erreur inconnue' }); } else { alert('Erreur: ' + (err.message || 'inconnue')); } }
		}

		// ===== Hierarchical Assignee Picker =====
		let deptEmployeesCache = new Map(); // deptId -> employees[]
		let expandedDepts = new Set(); // Track which departments are expanded
		function openAssigneePicker() {
			const m = document.getElementById('dirAssigneePickerModal'); if (!m) return;
			renderAssigneePicker();
			applyDirectorModalLocalization();
			m.classList.remove('hidden'); m.classList.add('flex');
			const close = document.getElementById('closeAssigneePickerBtn');
			const cancel = document.getElementById('assigneePickerCancel');
			const apply = document.getElementById('assigneePickerApply');
			const search = document.getElementById('enhAssigneeSearchInput');
			const selAll = document.getElementById('enhAssigneeSelectAll');
			const clrAll = document.getElementById('enhAssigneeClearAll');
			const selResp = document.getElementById('enhAssigneeSelectResponsibles');
			if (close) close.onclick = closeAssigneePicker;
			if (cancel) cancel.onclick = closeAssigneePicker;
			if (apply) apply.onclick = () => { updateDirSelectedBadges(); closeAssigneePicker(); };
			if (search) search.oninput = debounce(() => renderAssigneePicker(), 200);
			if (selAll) selAll.onclick = () => { try { const allIds = collectAllAssigneeIds(); allIds.forEach(id => dirSelectedEmployeeIds.add(String(id))); renderAssigneePicker(); } catch (_) { } };
			if (clrAll) clrAll.onclick = () => { dirSelectedEmployeeIds.clear(); renderAssigneePicker(); };
			if (selResp) selResp.onchange = () => { try { (departments || []).forEach(d => { if (d && d.responsible_id) { if (selResp.checked) dirSelectedEmployeeIds.add(String(d.responsible_id)); else dirSelectedEmployeeIds.delete(String(d.responsible_id)); } }); renderAssigneePicker(); } catch (_) { } };
			m.onclick = (e) => { if (e.target === m) closeAssigneePicker(); };
		}
		function closeAssigneePicker() { const m = document.getElementById('dirAssigneePickerModal'); if (!m) return; m.classList.add('hidden'); m.classList.remove('flex'); }
		function collectAllAssigneeIds() {
			const ids = new Set();
			(departments || []).forEach(d => { if (d.responsible_id) ids.add(String(d.responsible_id)); });
			(dirAllEmployeesCache || []).forEach(e => ids.add(String(e.id)));
			return Array.from(ids);
		}
		async function ensureDeptEmployeesCache() {
			try {
				const missing = (departments || []).filter(d => !deptEmployeesCache.has(String(d.id)));
				await Promise.all(missing.map(async d => {
					try {
						const list = await fetchDepartmentEmployees(d.id);
						deptEmployeesCache.set(String(d.id), Array.isArray(list) ? list : []);
					} catch (_) {
						deptEmployeesCache.set(String(d.id), []);
					}
				}));
			} catch (_) {/* noop */ }
		}
		function updatePickerCount() {
			const count = dirSelectedEmployeeIds ? dirSelectedEmployeeIds.size : 0;
			const targets = ['assigneePickerCount', 'enhAssigneePickerCount'];
			targets.forEach(id => {
				const c = document.getElementById(id);
				if (c) {
					const key = c.dataset.localeTemplate || 'assignee.count_template';
					c.textContent = resolveDirectorLocale(key, c.textContent || '', { count });
				}
			});
			updateAssigneeSelectedBadge(count);
			updateDirAssigneeCountDisplay();
			updateDirectorModalOverview();
		}
		function isChecked(id) { return dirSelectedEmployeeIds.has(String(id)); }
		function toggleId(id, checked) { const key = String(id); if (checked) dirSelectedEmployeeIds.add(key); else dirSelectedEmployeeIds.delete(key); }
		function toggleDept(deptId, checked) {
			const d = (departments || []).find(x => String(x.id) === String(deptId)); if (!d) return;
			if (d.responsible_id) toggleId(d.responsible_id, checked);
			const emps = deptEmployeesCache.get(String(deptId)) || [];
			emps.forEach(e => toggleId(e.id, checked));
		}
		function toggleResponsible(respId, deptId, includeTeam) {
			toggleId(respId, true);
			if (includeTeam) {
				const emps = deptEmployeesCache.get(String(deptId)) || [];
				emps.forEach(e => toggleId(e.id, true));
			}
			renderAssigneePicker();
		}
		async function renderAssigneePicker() {
			await ensureDeptEmployeesCache();
			const bodies = document.querySelectorAll('[id="assigneePickerBody"], [id="enhAssigneePickerBody"]');
			if (!bodies.length) return;

			const q1 = document.getElementById('assigneeSearchInput')?.value || '';
			const q2 = document.getElementById('enhAssigneeSearchInput')?.value || '';
			const q = (q1 || q2 || '').trim().toLowerCase();

			const employeeSuffix = resolveDirectorLocale('assignee.employee_suffix', 'members');
			const responsibleLabel = resolveDirectorLocale('assignee.responsible_label', 'Lead');
			const unassignedLabel = resolveDirectorLocale('assignee.unassigned', 'Unassigned');
			const includeTeamLabel = resolveDirectorLocale('assignee.include_team', 'Include team');
			const noResultsLabel = resolveDirectorLocale('assignee.no_results', 'No results');

			const cards = (departments || []).map(d => {
				const deptName = d.name || '';
				const resp = d.responsible_id ? (dirAllEmployeesCache || []).find(e => String(e.id) === String(d.responsible_id)) : null;
				const list = deptEmployeesCache.get(String(d.id)) || [];

				const matches = !q ||
					deptName.toLowerCase().includes(q) ||
					(resp ? (`${resp.first_name || ''} ${resp.last_name || ''}`).toLowerCase().includes(q) : false) ||
					list.some(e => (`${e.first_name || ''} ${e.last_name || ''}`).toLowerCase().includes(q));

				if (!matches) return '';

				const deptChecked = (resp ? isChecked(resp.id) : false) && list.length > 0 && list.every(e => isChecked(e.id));

				const isExpanded = expandedDepts.has(String(d.id));
				return `
				<div class="assignee-picker-card${isExpanded ? '' : ' collapsed'}" data-dept-id="${d.id}">
					<div class="assignee-picker-card-head">
						<div style="display: flex; align-items: center; gap: 8px; flex: 1;">
							<span class="dept-collapse-toggle" data-dept-toggle="${d.id}">
								<i class="fas fa-chevron-down"></i>
							</span>
							<label class="assignee-picker-card-title" style="margin: 0;">
								<input type="checkbox" ${deptChecked ? 'checked' : ''} data-dept-check="${d.id}" class="w-4 h-4 rounded text-blue-600">
								<i class="fas fa-layer-group text-blue-500/70"></i>
								<span>${deptName}</span>
							</label>
						</div>
						<span class="assignee-picker-pill">
							<i class="fas fa-user-group text-[10px]"></i>
							${list.length}
						</span>
					</div>
					
					<div class="assignee-picker-resp" dir="rtl">
						<label class="assignee-picker-resp-main">
							<span class="assignee-picker-resp-name">${resp ? `${resp.first_name || ''} ${resp.last_name || ''}` : unassignedLabel}</span>
							<span class="assignee-picker-resp-label">${responsibleLabel}</span>
							<i class="fas fa-user-tie resp-icon"></i>
							<input type="checkbox" ${resp && isChecked(resp.id) ? 'checked' : ''} data-resp-check="${d.id}:${resp ? resp.id : ''}">
						</label>
					</div>

					<div class="assignee-picker-employees custom-scrollbar bg-slate-50/30">
						${list.length ? list.map(e => `
							<label class="assignee-picker-employee hover:bg-white hover:shadow-sm transition-all">
								<input type="checkbox" data-emp-check="${d.id}:${e.id}" ${isChecked(e.id) ? 'checked' : ''} class="w-3.5 h-3.5 rounded text-blue-500">
								<span class="truncate font-medium">${(e.first_name || '') + ' ' + (e.last_name || '')}</span>
							</label>`).join('') : `
							<div class="py-4 text-center text-slate-400 text-xs italic">
								${noResultsLabel}
							</div>`}
					</div>
				</div>`;
			}).join('');

			bodies.forEach(body => {
				body.innerHTML = cards ?
					`<div class="p-3 space-y-4">${cards}</div>` :
					`<div class="assignee-empty-state">
					<div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
						<i class="fas fa-search text-slate-300"></i>
					</div>
					<p>${noResultsLabel}</p>
				</div>`;

				// Re-attach event listeners
				Array.from(body.querySelectorAll('[data-dept-check]')).forEach(cb => {
					cb.addEventListener('change', () => {
						toggleDept(cb.getAttribute('data-dept-check'), cb.checked);
						renderAssigneePicker();
					});
				});

				Array.from(body.querySelectorAll('[data-resp-check]')).forEach(cb => {
					cb.addEventListener('change', () => {
						const [, respId] = cb.getAttribute('data-resp-check').split(':');
						if (respId) toggleId(respId, cb.checked);
						updatePickerCount();
						renderAssigneeSelectedChips();
						renderAssigneePicker(); // Keep all views (same person in multiple depts) in sync
					});
				});

				Array.from(body.querySelectorAll('[data-resp-team]')).forEach(cb => {
					cb.addEventListener('change', () => {
						const [deptId, respId] = cb.getAttribute('data-resp-team').split(':');
						// Toggle Team Logic:
						// If checked: select responsible AND all employees in that department
						// If unchecked: deselect all employees in that department (and maybe responsible too?)

						if (cb.checked) {
							// Select Responsible
							if (respId && !isChecked(respId)) {
								dirSelectedEmployeeIds.add(String(respId));
							}
							// Select all employees in dept
							const list = deptEmployeesCache.get(String(deptId)) || [];
							list.forEach(e => dirSelectedEmployeeIds.add(String(e.id)));
						} else {
							// Deselect all employees in dept
							const list = deptEmployeesCache.get(String(deptId)) || [];
							list.forEach(e => dirSelectedEmployeeIds.delete(String(e.id)));
							// Optional: Do we deselect responsible? Let's say yes for "Include Team" untoggle behavior
							if (respId) dirSelectedEmployeeIds.delete(String(respId));
						}

						renderAssigneePicker();
					});
				});

				Array.from(body.querySelectorAll('[data-emp-check]')).forEach(cb => {
					cb.addEventListener('change', () => {
						const [, empId] = cb.getAttribute('data-emp-check').split(':');
						toggleId(empId, cb.checked);
						updatePickerCount();
						renderAssigneeSelectedChips();
						renderAssigneePicker(); // Keep all views in sync
					});
				});

				// Add collapse toggle event listeners
				Array.from(body.querySelectorAll('[data-dept-toggle]')).forEach(toggle => {
					toggle.addEventListener('click', (e) => {
						e.stopPropagation();
						const deptId = toggle.getAttribute('data-dept-toggle');
						const card = body.querySelector(`[data-dept-id="${deptId}"]`);
						if (card) {
							card.classList.toggle('collapsed');
							// Track expanded state
							if (card.classList.contains('collapsed')) {
								expandedDepts.delete(String(deptId));
							} else {
								expandedDepts.add(String(deptId));
							}
						}
					});
				});

			});

			updatePickerCount();
			renderAssigneeSelectedChips();
		}

		function renderAssigneeSelectedChips() {
			try {
				const targets = ['assigneePickerSelected', 'enhAssigneePickerSelected'];
				const empties = ['assigneePickerEmpty', 'enhAssigneePickerEmpty'];
				const ids = Array.from(dirSelectedEmployeeIds || []);
				const byId = new Map((dirAllEmployeesCache || []).map(e => [String(e.id), e]));
				const removeLabel = resolveDirectorLocale('assignee.remove', 'Remove');

				targets.forEach((tid, idx) => {
					const mount = document.getElementById(tid);
					const empty = document.getElementById(empties[idx]);
					if (!mount) return;

					if (!ids.length) {
						mount.innerHTML = '';
						if (empty) empty.classList.remove('hidden');
						return;
					}
					if (empty) empty.classList.add('hidden');

					mount.innerHTML = ids.map(id => {
						const e = byId.get(String(id));
						const name = e ? `${e.first_name || ''} ${e.last_name || ''}`.trim() : `ID ${id}`;
						return `
						<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs inline-flex items-center gap-1 assignee-chip">
							${name}
							<button type="button" class="ml-1 text-blue-700 hover:text-red-700" title="${removeLabel}" onclick="(function(){ try{ dirSelectedEmployeeIds.delete('${String(id)}'); renderAssigneeSelectedChips(); updatePickerCount(); renderAssigneePicker(); }catch(_){} })()">
								<i class="fas fa-times"></i>
							</button>
						</span>`;
					}).join('');
				});
			} catch (_) {/* noop */ }
		}

		// Lancer l'initialisation
		init();

		// ===== Notifications aligned with tasks.html =====
		window.__empNotifications = window.__empNotifications || [];
		function setupSocketNotificationsDirector() {
			try {
				// ï¿½viter les connexions multiples
				if (window.__empSocket && window.__empSocket.connected) {
					console.log('[WS] Director socket already connected, skipping setup');
					return;
				}

				// Nettoyer les anciennes connexions
				if (window.__empSocket) {
					try {
						window.__empSocket.disconnect();
					} catch (_) { }
					window.__empSocket = null;
				}

				// ensure io is available by loading from API_BASE if needed
				if (typeof io === 'undefined') {
					console.log('?? Loading Socket.IO library...');
					const s = document.createElement('script');
					s.src = (window.API || 'http://localhost:3020') + '/socket.io/socket.io.js';
					s.async = false;
					s.onload = () => {
						console.log('? Socket.IO library loaded, retrying setup...');
						try { setupSocketNotificationsDirector(); } catch (e) {
							console.error('? Error in socket setup retry:', e);
						}
					};
					document.head.appendChild(s);
					return;
				}

				console.log('?? Creating Socket.IO connection...');
				const socket = io(API || undefined, {
					transports: ['websocket', 'polling'],
					timeout: 20000,
					forceNew: true
				});

				window.__empSocket = socket;

				socket.on('connect', () => {
					try {
						console.log('[WS] Director connected to server');
						const uid = getDirectorEmployeeId();
						if (uid) {
							try {
								socket.emit('register', uid);
								console.log('[WS] Director registered user:', uid);
							} catch (_) { }
						}
						// Request current list via socket to hydrate on refresh
						if (uid) {
							try {
								socket.emit('notifications:list', { user_id: uid });
							} catch (_) { }
						}
					} catch (_) {/* noop */ }
				});

				socket.on('disconnect', () => {
					console.log('[WS] Director disconnected from server');
				});

				socket.on('notification:new', (n) => {
					try {
						if (n && n.id) {
							// Vï¿½rifier si la notification existe dï¿½jï¿½ pour ï¿½viter les doublons
							const exists = window.__empNotifications.some(notif => notif.id === n.id);
							if (!exists) {
								window.__empNotifications = [n].concat(window.__empNotifications || []);
								updateEmpNotifBadge();
								const dd = document.getElementById('empNotifDropdown');
								if (dd && !dd.classList.contains('hidden')) renderEmpNotificationsList(window.__empNotifications);
							}
						}
					} catch (_) {/* noop */ }
				});

				socket.on('notifications:list', (payload) => {
					try {
						const list = Array.isArray(payload) ? payload : Array.isArray(payload?.notifications) ? payload.notifications : [];
						console.log('[WS] Director received notifications from server:', list.length);

						// La liste du serveur est la source de vï¿½ritï¿½ - remplacer complï¿½tement
						window.__empNotifications = list;
						updateEmpNotifBadge();
						const dd = document.getElementById('empNotifDropdown');
						if (dd && !dd.classList.contains('hidden')) renderEmpNotificationsList(window.__empNotifications);
					} catch (_) {/* noop */ }
				});
			} catch (e) {
				console.error('[WS] Director setup error:', e);
			}
		}

		// No HTTP fallback; we rely on socket 'notifications:list' hydration

		function setupEmpNotificationsUIDirector() {
			try {
				const bell = document.getElementById('empNotifBell');
				const dd = document.getElementById('empNotifDropdown');
				const markAll = document.getElementById('empNotifMarkAll');
				const clearAll = document.getElementById('empNotifClearAll');
				if (bell && dd) {
					bell.addEventListener('click', (e) => {
						e.stopPropagation();
						if (dd.classList.contains('hidden')) {
							dd.classList.remove('hidden');
							void dd.offsetWidth;
							setTimeout(() => { dd.classList.remove('opacity-0', 'translate-y-2'); dd.classList.add('opacity-100', 'translate-y-0'); }, 10);
							renderEmpNotificationsList(window.__empNotifications || []);
						} else {
							dd.classList.remove('opacity-100', 'translate-y-0');
							dd.classList.add('translate-y-2');
							setTimeout(() => { dd.classList.add('hidden'); }, 200);
						}
					});
					document.addEventListener('click', (e) => {
						if (!dd.contains(e.target) && e.target !== bell && !bell.contains(e.target)) {
							dd.classList.remove('opacity-100', 'translate-y-0');
							dd.classList.add('translate-y-2');
							setTimeout(() => { dd.classList.add('hidden'); }, 200);
						}
					});
				}
				if (markAll) {
					markAll.addEventListener('click', async () => {
						const uid = getDirectorEmployeeId(); if (!uid) return;
						try { await fetch(`${API}/notifications/mark-all-read?user_id=${encodeURIComponent(uid)}`, { method: 'PUT' }); } catch (_) { }
						window.__empNotifications = (window.__empNotifications || []).map(n => ({ ...n, is_read: true }));
						updateEmpNotifBadge();
						renderEmpNotificationsList(window.__empNotifications);
					});
				}
				if (clearAll) {
					clearAll.addEventListener('click', async () => {
						const uid = getDirectorEmployeeId(); if (!uid) return;
						try {
							const response = await fetch(`${API}/notifications?user_id=${encodeURIComponent(uid)}`, { method: 'DELETE' });
							console.log('Director clear all notifications response:', response.status);
						} catch (e) {
							console.error('Error clearing director notifications:', e);
						}

						// Vider complï¿½tement le localStorage des notifications
						try {
							localStorage.removeItem('emp_notifications');
							localStorage.removeItem('notification_read_status');
						} catch (_) { }

						window.__empNotifications = [];
						updateEmpNotifBadge();
						renderEmpNotificationsList(window.__empNotifications);
					});
				}
			} catch (e) { console.error('Director notif UI error', e); }
		}

		function updateEmpNotifBadge() {
			const badge = document.getElementById('empNotifBadge'); if (!badge) return;
			const cnt = (window.__empNotifications || []).filter(n => !n.is_read).length;
			if (cnt > 0) { badge.textContent = cnt > 99 ? '99+' : String(cnt); badge.classList.remove('hidden'); }
			else { badge.classList.add('hidden'); }
		}

		function renderEmpNotificationsList(list) {
			const wrap = document.getElementById('empNotifList'); if (!wrap) return;
			const items = Array.isArray(list) ? list : [];
			if (items.length === 0) {
				wrap.innerHTML = `
                    <div class="p-4 text-center text-sm text-gray-500">
                        <i class="fas fa-bell text-gray-300 text-lg mb-2 block"></i>
                        <span>Aucune notification</span>
                    </div>`; return;
			}
			wrap.innerHTML = items.map(n => {
				const isUnread = !n.is_read; const timeAgo = formatEmpTimeAgo(n.created_at);
				return `
                    <div class="w-full p-3 mb-2 ${isUnread ? 'bg-gray-50 border-l-2 border-indigo-200' : 'bg-white'} hover:bg-gray-50 transition-colors rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex items-start gap-3">
                            <div class="relative flex-shrink-0 mt-0.5">
                                <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                                    <i class="fas ${empNotifTypeIcon(n.type)} text-white text-xs"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <button class="group w-full text-left" data-open-emp-notif data-notif-id="${n.id}" data-notif-type="${n.type || ''}" data-ref-type="${n.ref_type || ''}" data-ref-id="${n.ref_id || ''}">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="text-sm font-bold text-gray-900 group-hover:text-gray-700 truncate pr-2">${n.title || ''}</div>
                                        <span class="text-xs text-gray-400 whitespace-nowrap flex-shrink-0">${timeAgo}</span>
                                    </div>
                                    ${n.body ? `<div class="text-xs text-gray-600 mb-1 line-clamp-2">${n.body}</div>` : ''}
                                </button>
                            </div>
                            <button class="opacity-80 hover:opacity-100 text-gray-400 hover:text-gray-600 p-1 rounded self-start flex-shrink-0 transition-colors" title="Supprimer" data-del-emp-notif="${n.id}">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>`;
			}).join('');
			Array.from(wrap.querySelectorAll('[data-open-emp-notif]')).forEach(item => {
				item.addEventListener('click', async () => {
					const id = item.getAttribute('data-notif-id');
					const refType = item.getAttribute('data-ref-type');
					const refId = item.getAttribute('data-ref-id');
					if (id) { try { await fetch(`${API}/notifications/${id}/read`, { method: 'PUT' }); } catch (_) { } }
					window.__empNotifications = (window.__empNotifications || []).map(x => x.id === id ? { ...x, is_read: true } : x);
					updateEmpNotifBadge();
					handleEmpNotificationOpen({ type: item.getAttribute('data-notif-type') || '', refType, refId });
					document.getElementById('empNotifDropdown')?.classList.add('hidden');
					renderEmpNotificationsList(window.__empNotifications);
				});
			});
			Array.from(wrap.querySelectorAll('[data-del-emp-notif]')).forEach(btn => {
				btn.addEventListener('click', async (e) => {
					e.stopPropagation(); const id = btn.getAttribute('data-del-emp-notif');
					try {
						const response = await fetch(`${API}/notifications/${id}`, { method: 'DELETE' });
						console.log('Director delete notification response:', response.status);
					} catch (e) {
						console.error('Error deleting director notification:', e);
					}

					// Supprimer aussi du localStorage
					try {
						const readStatus = JSON.parse(localStorage.getItem('notification_read_status') || '{}');
						delete readStatus[id];
						localStorage.setItem('notification_read_status', JSON.stringify(readStatus));
					} catch (_) { }

					window.__empNotifications = (window.__empNotifications || []).filter(x => x.id !== id);
					updateEmpNotifBadge();
					renderEmpNotificationsList(window.__empNotifications);
				});
			});
		}

		function empNotifTypeIcon(t) {
			switch (t) {
				case 'task_created': return 'fa-clipboard-list';
				case 'comment_added': return 'fa-comment';
				case 'task_completed': return 'fa-check-circle';
				case 'urgent': return 'fa-exclamation';
				default: return 'fa-bell';
			}
		}
		function formatEmpTimeAgo(d) {
			try { const now = new Date(); const dt = new Date(d); const diff = (now - dt) / 1000; if (diff < 60) return 'ï¿½ l\'instant'; if (diff < 3600) return `${Math.floor(diff / 60)} min`; if (diff < 86400) return `${Math.floor(diff / 3600)} h`; return dt.toLocaleDateString('fr-FR'); } catch (_) { return ''; }
		}
		function handleEmpNotificationOpen(n) {
			try {
				const refType = (n.refType || '').toLowerCase();
				const type = (n.type || '').toLowerCase();
				const refId = n.refId || n.ref_id;

				console.log('Director opening notification:', { type, refType, refId, title: n.title });

				// Si c'est une notification de tï¿½che, ouvrir les dï¿½tails de la tï¿½che
				if (refId && (refType === 'task' || type === 'task_created' || type === 'task_completed' || type === 'assignment_completed' || type === 'comment_added' || type === 'instruction_created')) {
					try {
						// S'assurer que les tï¿½ches sont chargï¿½es
						if (!allTasks || allTasks.length === 0) {
							console.log('Loading tasks first...');
							loadTasks();
						}

						// Vï¿½rifier si la tï¿½che existe dans le tableau
						const task = allTasks.find(t => String(t.id) === String(refId));
						if (task) {
							switchView('tasks');
							setTimeout(() => {
								try {
									dirShowTaskDetails(refId);
								} catch (e) {
									console.error('Error opening task details:', e);
									alert(`Erreur lors de l'ouverture de la tï¿½che: ${e.message}`);
								}
							}, 200);
						} else {
							console.log('Task not found in local array, fetching from server...');
							// Si la tï¿½che n'est pas dans le tableau local, la rï¿½cupï¿½rer du serveur
							fetch(`${API}/tasks/${refId}`)
								.then(response => {
									if (response.ok) {
										return response.json();
									} else {
										throw new Error('Task not found');
									}
								})
								.then(taskData => {
									// Ajouter la tï¿½che au tableau local
									allTasks.push(taskData);
									switchView('tasks');
									setTimeout(() => {
										try {
											dirShowTaskDetails(refId);
										} catch (e) {
											console.error('Error opening task details:', e);
											alert(`Erreur lors de l'ouverture de la tï¿½che: ${e.message}`);
										}
									}, 200);
								})
								.catch(e => {
									console.error('Error fetching task:', e);
									alert(`Erreur lors de la rï¿½cupï¿½ration de la tï¿½che: ${e.message}`);
								});
						}
					} catch (e) {
						console.error('Error switching to tasks view:', e);
						alert(`Erreur lors de l'ouverture de la tï¿½che: ${e.message}`);
					}
					return;
				}

				// Fallback: afficher une alerte avec les dï¿½tails de la notification
				if (n.title || n.body) {
					alert(`${n.title || 'Notification'}\n\n${n.body || 'Aucun dï¿½tail disponible'}`);
				}
			} catch (e) {
				console.error('Error handling notification open:', e);
			}
		}

		// ===== Notifications (UI + polling) =====
		function setupSocket() {
			try {
				if (window.__socket && window.__socket.connected) return;
				const socket = io();
				window.__socket = socket;
				socket.on('connect', () => {
					try {
						const uid = getDirectorEmployeeId();
						if (uid) socket.emit('register', uid);
					} catch (_) {/* noop */ }
				});
				socket.on('notification:new', async (n) => {
					try {
						// Mettre ï¿½ jour l'ï¿½tat local et l'UI sans GET
						if (n && n.id) {
							// Injecter en tï¿½te
							window.__notifications = [n].concat(window.__notifications || []);
							if (!n.is_read) notifUnreadCount = Math.max(0, (notifUnreadCount || 0) + 1);
							updateNotifBadge();
							// Si le menu est ouvert, re-render
							const dd = document.getElementById('notifDropdown');
							if (dd && !dd.classList.contains('hidden')) renderNotificationsList(window.__notifications);
						} else {
							// Sï¿½curitï¿½: si format inattendu, tenter un rafraï¿½chissement unique
							try { await fetchAndRenderNotifications(); } catch (_) {/* noop */ }
						}
					} catch (_) {/* noop */ }
				});
			} catch (_) {/* noop */ }
		}

		function setupNotificationsUI() {
			try {
				const bell = document.getElementById('notifBell');
				const dd = document.getElementById('notifDropdown');
				const badge = document.getElementById('notifBadge');
				const markAll = document.getElementById('notifMarkAll');
				if (bell && dd) {
					bell.addEventListener('click', async () => {
						dd.classList.toggle('hidden');
						if (!dd.classList.contains('hidden')) {
							await fetchAndRenderNotifications();
						}
					});
					document.addEventListener('click', (e) => {
						if (!dd.contains(e.target) && e.target !== bell) { dd.classList.add('hidden'); }
					});
				}
				if (markAll) {
					markAll.addEventListener('click', async () => {
						const uid = getDirectorEmployeeId(); if (!uid) return;
						await fetch(`${API}/notifications/mark-all-read?user_id=${encodeURIComponent(uid)}`, { method: 'PUT' });
						notifUnreadCount = 0; updateNotifBadge();
						await fetchAndRenderNotifications();
					});
				}
			} catch (_) {/* noop */ }
		}

		function updateNotifBadge() {
			const badge = document.getElementById('notifBadge');
			if (!badge) return;
			if (notifUnreadCount > 0) { badge.textContent = String(notifUnreadCount); badge.classList.remove('hidden'); }
			else { badge.classList.add('hidden'); }
		}

		function notifTypeIcon(t) {
			switch (t) {
				case 'task_created': return 'fa-clipboard-list text-indigo-600';
				case 'comment_added': return 'fa-comment-dots text-emerald-600';
				default: return 'fa-bell text-gray-500';
			}
		}

		function formatTimeAgo(d) {
			try {
				const now = new Date(); const dt = new Date(d);
				const diff = Math.max(0, (now - dt) / 1000);
				if (diff < 60) return 'ï¿½ l\'instant';
				if (diff < 3600) return `${Math.floor(diff / 60)} min`;
				if (diff < 86400) return `${Math.floor(diff / 3600)} h`;
				return dt.toLocaleDateString('fr-FR');
			} catch (_) { return ''; }
		}

		async function fetchAndRenderNotifications() {
			try {
				const uid = getDirectorEmployeeId(); if (!uid) return;
				const qs = new URLSearchParams({ user_id: uid });
				if (lastNotifAt) qs.append('since', lastNotifAt);
				const r = await fetch(`${API}/notifications?${qs.toString()}`);
				const data = await r.json();
				const list = Array.isArray(data.notifications) ? data.notifications : [];
				window.__notifications = list;

				notifUnreadCount = list.filter(n => !n.is_read).length;
				updateNotifBadge();
				renderNotificationsList(list);
				// update last seen watermark
				if (list.length) { lastNotifAt = list[0].created_at; }
			} catch (e) { /* silent */ }
		}

		function renderNotificationsList(list) {
			const wrap = document.getElementById('notifList'); if (!wrap) return;
			const items = Array.isArray(list) ? list : [];
			wrap.innerHTML = items.length ? items.map(n => {
				const isUnread = !n.is_read;
				return `
                    <div class="notification-item group w-full px-5 py-4 border-b border-slate-100 ${isUnread ? 'notification-unread' : 'notification-read'} flex items-start gap-4 hover:shadow-sm">
                        <div class="mt-1 shrink-0">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${getNotificationColor(n.type)} flex items-center justify-center shadow-sm">
                                <i class="fas ${notifTypeIcon(n.type)} text-white text-sm"></i>
                            </div>
                        </div>
                        
                        <button class="min-w-0 flex-1 text-left" data-open-notif data-notif-id="${n.id}" data-ref-type="${n.ref_type || ''}" data-ref-id="${n.ref_id || ''}">
                            <div class="flex items-start justify-between gap-3 mb-1">
                                <div class="font-medium text-slate-900 text-sm leading-tight">${n.title || ''}</div>
                                ${isUnread ? '<div class="w-2 h-2 rounded-full bg-blue-500 shrink-0 mt-1"></div>' : ''}
                            </div>
                            <div class="text-xs text-slate-600 line-clamp-2 mb-2">${n.body || ''}</div>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-slate-400">${formatTimeAgo(n.created_at)}</span>
                                <span class="text-xs text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity">Cliquer pour ouvrir</span>
                            </div>
                        </button>
                        
                        <button class="opacity-60 hover:opacity-100 text-red-500 hover:text-red-600 p-2 hover:bg-red-50 rounded-lg transition-all" title="Supprimer" data-del-notif="${n.id}">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
			}).join('') : `
                <div class="p-8 text-center">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center">
                        <i class="fas fa-inbox text-2xl text-slate-400"></i>
                    </div>
                    <p class="text-sm text-slate-500 font-medium">Aucune notification</p>
                    <p class="text-xs text-slate-400 mt-1">Vous ï¿½tes ï¿½ jour !</p>
                </div>
            `;
			// wire click open + mark as read
			Array.from(wrap.querySelectorAll('[data-open-notif]')).forEach(item => {
				item.addEventListener('click', async () => {
					const id = item.getAttribute('data-notif-id');
					const refType = item.getAttribute('data-ref-type');
					const refId = item.getAttribute('data-ref-id');
					if (id) { try { await fetch(`${API}/notifications/${id}/read`, { method: 'PUT' }); } catch (_) { } }
					handleNotificationOpen({ refType, refId });
					document.getElementById('notifDropdown')?.classList.add('hidden');
					// Mettre ï¿½ jour l'ï¿½tat local au lieu de re-fetch
					window.__notifications = (window.__notifications || []).map(x => x.id === id ? { ...x, is_read: true } : x);
					notifUnreadCount = (window.__notifications || []).filter(n => !n.is_read).length; updateNotifBadge();
					renderNotificationsList(window.__notifications);
				});
			});
			// wire delete
			Array.from(wrap.querySelectorAll('[data-del-notif]')).forEach(btn => {
				btn.addEventListener('click', async (e) => {
					e.stopPropagation();
					const id = btn.getAttribute('data-del-notif');
					try { await fetch(`${API}/notifications/${id}`, { method: 'DELETE' }); } catch (_) { }
					window.__notifications = (window.__notifications || []).filter(x => x.id !== id);
					notifUnreadCount = (window.__notifications || []).filter(n => !n.is_read).length; updateNotifBadge();
					renderNotificationsList(window.__notifications);
				});
			});
		}

		// Polling supprimï¿½: notifications uniquement par Socket.IO
		function getNotificationColor(type) {
			switch (type) {
				case 'task_created': return 'from-blue-500 to-blue-600';
				case 'comment_added': return 'from-green-500 to-green-600';
				case 'task_completed': return 'from-emerald-500 to-emerald-600';
				case 'urgent': return 'from-red-500 to-red-600';
				default: return 'from-slate-400 to-slate-500';
			}
		}
		function handleNotificationOpen(n) {
			try {
				const t = (n.refType || '').toLowerCase();
				if (t === 'task' && n.refId) {
					// Open tasks view and show details
					switchView('tasks');
					// slight delay to allow render
					setTimeout(() => { try { dirShowTaskDetails(n.refId); } catch (_) { } }, 200);
					return;
				}
				// Other types can be handled here (employee, report, etc.)
			} catch (_) {/* noop */ }
		}

		// Footer actions
		(function () {
			const clearBtn = document.getElementById('notifClearAll');
			const refreshBtn = document.getElementById('notifRefresh');
			if (clearBtn) {
				clearBtn.addEventListener('click', async () => {
					const uid = getDirectorEmployeeId(); if (!uid) return;
					try { await fetch(`${API}/notifications?user_id=${encodeURIComponent(uid)}`, { method: 'DELETE' }); } catch (_) { }
					await fetchAndRenderNotifications();
				});
			}
			if (refreshBtn) { refreshBtn.addEventListener('click', fetchAndRenderNotifications); }
		})();

		// global paginate helper
		window.paginateRespTasks = function (respKey, dir) {
			window.respTaskPageByResp = window.respTaskPageByResp || {};
			window._respTaskTotalPagesByResp = window._respTaskTotalPagesByResp || {};
			const total = window._respTaskTotalPagesByResp[respKey] || 1;
			const current = window.respTaskPageByResp[respKey] || 1;
			window.respTaskPageByResp[respKey] = dir === 'prev' ? Math.max(1, current - 1) : Math.min(total, current + 1);
			renderResponsibleContent('task');
		};

		// ---- Mes Tï¿½ches (assignï¿½es par le directeur) ----
		// Safe translator fallback (avoids t is not a function when translations are late)
		function tSafe(key) {
			try {
				if (typeof translate === 'function') {
					const v = translate(key);
					if (v !== undefined && v !== null) return v;
				}
				const lang = (typeof currentLanguage !== 'undefined' && currentLanguage) || (typeof window !== 'undefined' && window.currentLanguage) || 'en';
				if (typeof window !== 'undefined' && window.translations && window.translations[lang] && window.translations[lang][key]) {
					return window.translations[lang][key];
				}
			} catch (_) { }
			return key;
		}

		function renderDirectorMyTasksView() {
			const content = document.getElementById('dynamicContent');
			const myId = getDirectorEmployeeId();
			let mine = (allTasks || []).filter(t => String(t.assigned_by) === String(myId) && !(String(t.title || '').startsWith('Instruction:')));
			let currentViewMode = 'cards';
			const t = (typeof window.translate === 'function') ? window.translate : ((typeof window.t === 'function') ? window.t : (key) => key);
			const tSafe = (key) => (typeof t === 'function') ? t(key) : (typeof translate === 'function' ? translate(key) : key);
			content.innerHTML = `
				<div class="dashboard-v-spacing-high">
					<!-- Modern Filters Section -->
					<section style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
						<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 16px;" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
							<!-- Filter Icon and Title -->
							<div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
								<i class="fas fa-filter" style="color: #3b82f6; font-size: 15px;"></i>
								<span style="font-size: 14px; font-weight: 600; color: #1e40af;" data-translate="director.filters_label">${t('director.filters_label') || 'Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª'}</span>
							</div>
							
							<!-- Filters -->
							<div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
								<select id="dirTasksStatus" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 110px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
									<option value="" data-translate="director.all_statuses">${tSafe('director.all_statuses') || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª'}</option>
									<option value="Pending" data-translate="status.pending">${tSafe('status.pending') || 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</option>
									<option value="In Progress" data-translate="status.in_progress">${tSafe('status.in_progress') || 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'}</option>
									<option value="Completed" data-translate="status.completed">${tSafe('status.completed') || 'Ù…ÙƒØªÙ…Ù„'}</option>
								</select>
								
								<select id="dirTasksType" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 110px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
									<option value="" data-translate="director.all_types">${tSafe('director.all_types') || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹'}</option>
									<option value="Daily" data-translate="tasks.daily">${tSafe('tasks.daily') || 'ÙŠÙˆÙ…ÙŠ'}</option>
									<option value="Special" data-translate="tasks.special">${tSafe('tasks.special') || 'Ø®Ø§Øµ'}</option>
								</select>
								
								<select id="dirTasksPriority" style="padding: 8px 14px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; min-width: 110px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
									onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
									onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
									<option value="" data-translate="director.all_priorities">${tSafe('director.all_priorities') || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª'}</option>
									<option value="High" data-translate="priority.high">${tSafe('priority.high') || 'Ø¹Ø§Ù„ÙŠØ©'}</option>
									<option value="Medium" data-translate="priority.medium">${tSafe('priority.medium') || 'Ù…ØªÙˆØ³Ø·Ø©'}</option>
									<option value="Low" data-translate="priority.low">${tSafe('priority.low') || 'Ù…Ù†Ø®ÙØ¶Ø©'}</option>
								</select>
								
								<div style="position: relative;">
									<input id="dirTasksSearch" type="text" placeholder="${tSafe('director.search_tasks_placeholder') || 'Ø¨Ø­Ø« Ø§Ù„Ù…Ù‡Ø§Ù…...'}" 
										style="padding: 8px 14px 8px 36px; font-size: 13px; border: 1px solid #cbd5e1; border-radius: 8px; background: white; color: #374151; width: 160px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s;" 
										onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" 
										onmouseout="this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'" />
									<div style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
										<i class="fas fa-search" style="color: #64748b; font-size: 13px;"></i>
									</div>
								</div>
							</div>
							
							<!-- Action Buttons -->
							<div style="display: flex; align-items: center; gap: 10px; ${currentLanguage === 'ar' ? 'margin-right: auto;' : 'margin-left: auto;'}">
								<button id="clearDirTasksFilters" style="padding: 8px 14px; font-size: 12px; font-weight: 600; color: #6b7280; background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" 
									onmouseover="this.style.background='linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
									onmouseout="this.style.background='linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'">
									<i class="fas fa-times" style="font-size: 12px;"></i>
									<span data-translate="director.clear">${t('director.clear') || 'Ù…Ø³Ø­'}</span>
								</button>
							</div>
						</div>
					</section>

					<section class="overflow-hidden">
						<div class="max-w-7xl mx-auto p-6">
							<div class="mb-6">
								<div class="flex items-center justify-between gap-4" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
								<div>
									<h1 class="text-2xl font-bold text-gray-900" data-translate="director.task_list_header">${t('director.task_list_header') || 'Task list'}</h1>
									<p class="text-gray-600" data-translate="director.task_list_description">${t('director.task_list_description') || 'Manage and track all your tasks'}</p>
								</div>
								<div class="flex items-center space-x-2">
									<div class="flex items-center space-x-2">
										<button id="dirTasksSortToggle" class="p-2 rounded-lg bg-gray-100 text-gray-600 transition-colors" title="Toggle Sort">
											<i class="fas fa-sort-alpha-down" id="dirTasksSortIcon"></i>
										</button>
										<button id="dirViewModeCards" class="p-2 rounded-lg transition-colors bg-gray-100 text-gray-600" title="Cards View">
											<i class="fas fa-border-all"></i>
										</button>
										<button id="dirViewModeList" class="p-2 rounded-lg transition-colors" title="List View">
											<i class="fas fa-list"></i>
										</button>
									</div>
								</div>
							</div>
						</div>
						<div id="directorMyTasksList" class="p-6 w-full"></div>
						
						<!-- Pagination Controls -->
						<div id="directorMyTasksPagination" class="flex justify-center items-center space-x-4 mt-6 px-6">
							<button id="dirTasksPrevBtn" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
								<i class="fas fa-chevron-left mr-2"></i>
								<span data-translate="common.previous">${t('common.previous')}</span>
							</button>
							<span id="dirTasksPageInfo" class="text-sm text-gray-600">
								Page <span id="dirTasksCurrentPage">1</span> of <span id="dirTasksTotalPages">1</span>
							</span>
							<button id="dirTasksNextBtn" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
								<span data-translate="common.next">${t('common.next')}</span>
								<i class="fas fa-chevron-right ml-2"></i>
							</button>
						</div>
						</div>
					</section>
				</div>
			`;
			function applyDirTasksFilters() {
				const q = (document.getElementById('dirTasksSearch')?.value || '').toLowerCase();
				const st = document.getElementById('dirTasksStatus')?.value || '';
				const ty = document.getElementById('dirTasksType')?.value || '';
				const pr = document.getElementById('dirTasksPriority')?.value || '';
				let filtered = (mine || []).filter(t => {
					if (st && t.status !== st) return false;
					if (ty && t.type !== ty) return false;
					if (pr && t.priority !== pr) return false;
					if (!q) return true;
					const assigneesNames = (t.assignees || []).map(a => `${(a.first_name || '').toLowerCase()} ${(a.last_name || '').toLowerCase()}`).join(' ');
					return (t.title || '').toLowerCase().includes(q) || (t.description || '').toLowerCase().includes(q) || assigneesNames.includes(q);
				});

				// Apply sorting
				filtered = sortTasksByLanguage(filtered);
				renderDirTasksList(filtered);
				updateDirKPIs(filtered);
				updateTaskPagination(filtered.length);
			}
			function updateDirKPIs(list) {
				const total = list.length; 
				const comp = list.filter(t => t.status === 'Completed').length; 
				const prog = list.filter(t => t.status === 'In Progress').length; 
				const pend = list.filter(t => t.status === 'Pending').length; 
				const ov = list.filter(isOverdue).length;
				
				// Update main KPI cards instead of removed elements
				const completedEl = document.getElementById('kpiMyCompleted'); if (completedEl) completedEl.textContent = comp;
				const activeEl = document.getElementById('kpiMyActive'); if (activeEl) activeEl.textContent = prog;
				const pendingEl = document.getElementById('kpiMyPending'); if (pendingEl) pendingEl.textContent = pend;
				
				// Keep the old elements for backward compatibility if they exist elsewhere
				const totalEl = document.getElementById('dirKpiTotalText'); if (totalEl) totalEl.textContent = total;
				const completedOldEl = document.getElementById('dirKpiCompletedText'); if (completedOldEl) completedOldEl.textContent = comp;
				const progressEl = document.getElementById('dirKpiProgressText'); if (progressEl) progressEl.textContent = prog;
				const overdueEl = document.getElementById('dirKpiOverdueText'); if (overdueEl) overdueEl.textContent = ov;
				const overdueMetric = document.getElementById('dirKpiOverdueMetric');
				if (overdueMetric) {
					const span = overdueMetric.querySelector('.dir-table-subtle');
					if (ov > 0) {
						overdueMetric.classList.add('alert');
						if (span) {
							span.setAttribute('data-translate', 'director.needs_attention');
							span.textContent = tSafe('director.needs_attention');
						}
					} else {
						overdueMetric.classList.remove('alert');
						if (span) {
							span.setAttribute('data-translate', 'director.on_schedule');
							span.textContent = tSafe('director.on_schedule');
						}
					}
				}
			}
			function renderDirTasksList(list) {
				const listEl = document.getElementById('directorMyTasksList');
				const source = (list && list.length ? list : []);

				if (!listEl) return;

				if (!source.length) {
					listEl.innerHTML = `<div class="p-16 text-center text-slate-400" data-translate="director.no_tasks_found">${tSafe('director.no_tasks_found')}</div>`;
					return;
				}

				const paginatedList = getPaginatedTasks(source);

				if (currentViewMode === 'list') {
					listEl.innerHTML = `
						<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden w-full">
							<table class="min-w-full divide-y divide-gray-200 w-full">
								<thead class="bg-gray-50">
									<tr>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.title">${tSafe('director.title')}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.status">${tSafe('director.status')}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="tasks.due">${tSafe('tasks.due')}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="tasks.priority">${tSafe('tasks.priority')}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.assigned">${tSafe('director.assigned')}</th>
										<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.actions">${tSafe('director.actions')}</th>
									</tr>
								</thead>
								<tbody class="bg-white divide-y divide-gray-200">
									${paginatedList.map(task => {
						const assignees = Array.isArray(task.assignees) ? task.assignees : [];
						const names = assignees.length ? assignees.map(a => (a.first_name || '') + ' ' + (a.last_name || '')).filter(n => n.trim()).join(', ') : t('common.none');
						return `
											<tr class="hover:bg-gray-50">
												<td class="px-6 py-4 whitespace-nowrap">
													<div class="text-sm font-medium text-gray-900">${task.title || t('director.no_title')}</div>
													<div class="text-sm text-gray-500">${task.description || t('director.no_description')}</div>
												</td>
												<td class="px-6 py-4 whitespace-nowrap">
													<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadge(task.status)}">
														${translateStatusValue(task.status || 'Pending')}
													</span>
												</td>
												<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(task.due_date)}</td>
												<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${translatePriorityValue(task.priority || 'Medium')}</td>
												<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${names}">${names}</td>
												<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
													<div class="flex justify-end gap-2">
														<button class="dir-table-action" onclick="dirShowTaskDetails('${task.id}')" title="${t('common.view')}"><i class="fas fa-eye"></i></button>
														<button class="dir-table-action primary" onclick="openDirectorEditTask('${task.id}')" title="${t('common.edit')}"><i class="fas fa-pen"></i></button>
														<button class="dir-table-action" onclick="dirDeleteMyTask('${task.id}')" title="${t('common.delete')}"><i class="fas fa-trash"></i></button>
													</div>
												</td>
											</tr>
										`;
					}).join('')}
									</tbody>
								</table>
						</div>
					`;
					return;
				}

				listEl.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${paginatedList.map(task => {
					const assignees = Array.isArray(task.assignees) ? task.assignees : [];
					const names = assignees.length ? assignees.map(a => (a.first_name || '') + ' ' + (a.last_name || '')).filter(n => n.trim()).join(', ') : tSafe('common.none');
					const overdueClass = isOverdue(task) ? 'border-red-300' : '';
					return `
					<div class="timetable-card ${overdueClass}" style="padding: 24px;">
						<div style="display: flex; flex-direction: column; gap: 20px;">
							<!-- Header Section -->
							<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
								<div style="flex: 1; min-width: 0;">
									<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
										<span style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: #64748b;">${translateTaskTypeValue(task.type || 'Special')}</span>
										${isOverdue(task) ? `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fecaca; border-radius: 999px; font-size: 0.7rem; font-weight: 700; color: #dc2626;" data-translate="director.overdue"><i class="fas fa-exclamation-triangle"></i>${tSafe('director.overdue')}</span>` : ''}
									</div>
									<h4 style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin: 0 0 8px 0; line-height: 1.3;">${task.title || t('director.no_title')}</h4>
									<p style="font-size: 0.9rem; color: #64748b; line-height: 1.5; margin: 0;">${task.description || tSafe('director.no_description')}</p>
								</div>
								<span style="display: inline-block; padding: 6px 14px; font-size: 0.75rem; font-weight: 600; border-radius: 999px; white-space: nowrap;" class="${getStatusBadge(task.status)}">${translateStatusValue(task.status || 'Pending')}</span>
							</div>
							
							<!-- Info Grid -->
							<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
								<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 14px;">
									<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
										<i class="fas fa-users" style="font-size: 1rem;"></i>
									</div>
									<div style="flex: 1; min-width: 0;">
										<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #3B82F6; margin: 0 0 4px 0; font-weight: 600;" data-translate="director.assigned">${tSafe('director.assigned')}</p>
										<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${names}">${names}</p>
									</div>
								</div>
								<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.04)); border: 1px solid rgba(124, 58, 237, 0.2); border-radius: 14px;">
									<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #7C3AED, #6D28D9); display: flex; align-items: center; justify-center; color: white; flex-shrink: 0;">
										<i class="fas fa-bolt" style="font-size: 1rem;"></i>
									</div>
									<div style="flex: 1; min-width: 0;">
										<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #7C3AED; margin: 0 0 4px 0; font-weight: 600;" data-translate="tasks.priority">${tSafe('tasks.priority')}</p>
										<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${translatePriorityValue(task.priority || 'Medium')}</p>
									</div>
								</div>
								<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.04)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 14px;">
									<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #10B981, #059669); display: flex; align-items: center; justify-center; color: white; flex-shrink: 0;">
										<i class="fas fa-calendar" style="font-size: 1rem;"></i>
									</div>
									<div style="flex: 1; min-width: 0;">
										<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #10B981; margin: 0 0 4px 0; font-weight: 600;" data-translate="tasks.due">${t('tasks.due')}</p>
										<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${formatDate(task.due_date)}</p>
									</div>
								</div>
							</div>
							
							<!-- Actions -->
							<div style="display: flex; justify-content: flex-end; gap: 8px; padding-top: 16px; border-top: 1px solid rgba(148, 163, 184, 0.15);">
								<button class="dir-table-action" onclick="dirShowTaskDetails('${task.id}')" title="${t('common.view')}"><i class="fas fa-eye"></i><span data-translate="common.view">${t('common.view')}</span></button>
								<button class="dir-table-action primary" onclick="openDirectorEditTask('${task.id}')" title="${t('common.edit')}"><i class="fas fa-pen"></i><span data-translate="common.edit">${t('common.edit')}</span></button>
								<button class="dir-table-action" onclick="dirDeleteMyTask('${task.id}')" title="${t('common.delete')}"><i class="fas fa-trash"></i><span data-translate="common.delete">${t('common.delete')}</span></button>
							</div>
						</div>
					</div>
				`;
				}).join('')}</div>`;
			}

			function updateViewModeButtons() {
				const btnCards = document.getElementById('dirViewModeCards');
				const btnList = document.getElementById('dirViewModeList');
				if (!btnCards || !btnList) return;

				if (currentViewMode === 'cards') {
					btnCards.classList.add('bg-blue-600', 'text-white');
					btnCards.classList.remove('bg-gray-100', 'text-gray-600');
					btnList.classList.add('bg-gray-100', 'text-gray-600');
					btnList.classList.remove('bg-blue-600', 'text-white');
				} else {
					btnList.classList.add('bg-blue-600', 'text-white');
					btnList.classList.remove('bg-gray-100', 'text-gray-600');
					btnCards.classList.add('bg-gray-100', 'text-gray-600');
					btnCards.classList.remove('bg-blue-600', 'text-white');
				}
			}

			// Sort state - initialize before any sorting functions
			let taskSortOrder = 'asc'; // 'asc' or 'desc'
			
			// Pagination state
			let taskCurrentPage = 1;
			let taskCurrentView = 'cards'; // 'cards' or 'list'

			const btnCards = document.getElementById('dirViewModeCards');
			const btnList = document.getElementById('dirViewModeList');
			const sortBtn = document.getElementById('dirTasksSortToggle');
			const sortIcon = document.getElementById('dirTasksSortIcon');

			if (btnCards && btnList) {
				const updateViewMode = (mode) => {
					currentViewMode = mode;
					taskCurrentView = mode;
					taskCurrentPage = 1; // Reset page when switching views
					updateViewModeButtons();
					applyDirTasksFilters();
				};
				btnCards.addEventListener('click', () => updateViewMode('cards'));
				btnList.addEventListener('click', () => updateViewMode('list'));
				updateViewModeButtons();
			}

			// Sort toggle event listener
			if (sortBtn) {
				sortBtn.addEventListener('click', () => {
					taskSortOrder = taskSortOrder === 'asc' ? 'desc' : 'asc';
					updateSortIcon(sortIcon, taskSortOrder);
					applyDirTasksFilters();
				});
			}

			// Pagination event listeners
			const tasksPrevBtn = document.getElementById('dirTasksPrevBtn');
			const tasksNextBtn = document.getElementById('dirTasksNextBtn');
			
			if (tasksPrevBtn) {
				tasksPrevBtn.addEventListener('click', () => {
					if (taskCurrentPage > 1) {
						taskCurrentPage--;
						applyDirTasksFilters();
					}
				});
			}
			
			if (tasksNextBtn) {
				tasksNextBtn.addEventListener('click', () => {
					const filtered = (mine || []).filter(t => {
						const st = document.getElementById('dirTasksStatus')?.value || '';
						const ty = document.getElementById('dirTasksType')?.value || '';
						const pr = document.getElementById('dirTasksPriority')?.value || '';
						const q = (document.getElementById('dirTasksSearch')?.value || '').toLowerCase();
						
						if (st && t.status !== st) return false;
						if (ty && t.type !== ty) return false;
						if (pr && t.priority !== pr) return false;
						if (!q) return true;
						const assigneesNames = (t.assignees || []).map(a => `${(a.first_name || '').toLowerCase()} ${(a.last_name || '').toLowerCase()}`).join(' ');
						return (t.title || '').toLowerCase().includes(q) || (t.description || '').toLowerCase().includes(q) || assigneesNames.includes(q);
					});
					
					const sortedFiltered = sortTasksByLanguage(filtered);
					const itemsPerPage = taskCurrentView === 'cards' ? 10 : 20;
					const totalPages = Math.ceil(sortedFiltered.length / itemsPerPage);
					
					if (taskCurrentPage < totalPages) {
						taskCurrentPage++;
						applyDirTasksFilters();
					}
				});
			}

			function updateSortIcon(icon, order) {
				if (order === 'asc') {
					icon.className = 'fas fa-sort-alpha-down';
					if (icon.id.includes('Tasks')) {
						sortBtn.classList.remove('bg-blue-600', 'text-white');
						sortBtn.classList.add('bg-gray-100', 'text-gray-600');
					}
				} else {
					icon.className = 'fas fa-sort-alpha-up';
					if (icon.id.includes('Tasks')) {
						sortBtn.classList.add('bg-blue-600', 'text-white');
						sortBtn.classList.remove('bg-gray-100', 'text-gray-600');
					}
				}
			}

			function sortTasksByLanguage(items) {
				const currentLang = typeof currentLanguage !== 'undefined' ? currentLanguage : (window.currentLanguage || 'en');

				return [...items].sort((a, b) => {
					const textA = a.title || '';
					const textB = b.title || '';

					let comparison = 0;

					// Arabic sorting
					if (currentLang === 'ar') {
						comparison = textA.localeCompare(textB, 'ar', { sensitivity: 'base' });
					}
					// French sorting
					else if (currentLang === 'fr') {
						comparison = textA.localeCompare(textB, 'fr', { sensitivity: 'base', ignorePunctuation: true });
					}
					// English sorting (default)
					else {
						comparison = textA.localeCompare(textB, 'en', { sensitivity: 'base' });
					}

					return taskSortOrder === 'asc' ? comparison : -comparison;
				});
			}

			function getPaginatedTasks(items) {
				const itemsPerPage = taskCurrentView === 'cards' ? 10 : 20;
				const startIndex = (taskCurrentPage - 1) * itemsPerPage;
				const endIndex = startIndex + itemsPerPage;
				return items.slice(startIndex, endIndex);
			}

			function updateTaskPagination(totalItems) {
				const itemsPerPage = taskCurrentView === 'cards' ? 10 : 20;
				const totalPages = Math.ceil(totalItems / itemsPerPage);
				
				const prevBtn = document.getElementById('dirTasksPrevBtn');
				const nextBtn = document.getElementById('dirTasksNextBtn');
				const currentPageSpan = document.getElementById('dirTasksCurrentPage');
				const totalPagesSpan = document.getElementById('dirTasksTotalPages');
				const paginationDiv = document.getElementById('directorMyTasksPagination');
				
				if (!paginationDiv) return;
				
				// Show/hide pagination
				if (totalItems === 0) {
					paginationDiv.classList.add('hidden');
					return;
				} else {
					paginationDiv.classList.remove('hidden');
				}
				
				// Update page info
				if (currentPageSpan) currentPageSpan.textContent = taskCurrentPage;
				if (totalPagesSpan) totalPagesSpan.textContent = totalPages;
				
				// Update button states
				if (prevBtn) {
					prevBtn.disabled = taskCurrentPage === 1;
				}
				if (nextBtn) {
					nextBtn.disabled = taskCurrentPage >= totalPages;
				}
			}

			['dirTasksSearch', 'dirTasksStatus', 'dirTasksType', 'dirTasksPriority'].forEach(id => {
				const el = document.getElementById(id);
				if (el) {
					el.addEventListener('input', applyDirTasksFilters);
					el.addEventListener('change', applyDirTasksFilters);
				}
			});

			// Clear filters button
			const clearDirTasksFiltersBtn = document.getElementById('clearDirTasksFilters');
			if (clearDirTasksFiltersBtn) {
				clearDirTasksFiltersBtn.addEventListener('click', () => {
					document.getElementById('dirTasksSearch').value = '';
					document.getElementById('dirTasksStatus').value = '';
					document.getElementById('dirTasksType').value = '';
					document.getElementById('dirTasksPriority').value = '';
					applyDirTasksFilters();
				});
			}

			renderDirTasksList(mine);
			updateDirKPIs(mine);
			if (typeof updatePageTranslations === 'function') {
				updatePageTranslations();
			}
		}

		// ---- Edit/Delete handlers for Director's My Tasks ----
		async function openDirectorEditTask(taskId) {
			try {
				const task = (allTasks || []).find(t => String(t.id) === String(taskId));
				if (!task) { alert('Tï¿½che introuvable'); return; }
				dirEditingTaskId = taskId;
				// Open modal and ensure task tab active
				const modal = document.getElementById('directorTaskModal');
				if (modal) { modal.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
				// Ensure other modals are closed so they don't overlay and block input
				(function () {
					const m1 = document.getElementById('employeeDetailsModal'); if (m1) m1.classList.add('hidden');
					const m2 = document.getElementById('taskDetailsModalDir'); if (m2) { m2.classList.add('hidden'); m2.classList.remove('flex'); }
					const m3 = document.getElementById('dirSmallModal'); if (m3) { m3.classList.add('hidden'); m3.classList.remove('flex'); }
				})();
				const tabTask = document.getElementById('tabAddTask'); const tabInstr = document.getElementById('tabAddInstruction');
				const formTask = document.getElementById('directorAddTaskForm'); const formInstr = document.getElementById('directorAddInstructionForm');
				if (tabTask && tabInstr && formTask && formInstr) {
					tabTask.click();
				}
				await prepareDirectorModal();
				// Prefill fields
				document.getElementById('dirTaskTitle').value = task.title || '';
				document.getElementById('dirTaskDescription').value = task.description || '';
				document.getElementById('dirTaskType').value = task.type || 'Special';
				document.getElementById('dirTaskPriority').value = task.priority || 'Medium';
				document.getElementById('dirTaskDueDate').value = task.due_date ? String(task.due_date).split('T')[0] : '';
				// Preselect assignees
				dirSelectedEmployeeIds = new Set(((task.assignees || []).map(a => String(a.id))));
				renderDirEmployees(dirCurrentFilteredEmployees && dirCurrentFilteredEmployees.length ? dirCurrentFilteredEmployees : dirAllEmployeesCache);
				// Update submit label
				const submitBtn = document.querySelector('#directorAddTaskForm button[type="submit"]'); if (submitBtn) submitBtn.textContent = 'Mettre ï¿½ jour';
				// Focus first input for immediate typing
				setTimeout(() => { try { document.getElementById('dirTaskTitle')?.focus(); } catch (_) { } }, 0);
			} catch (e) { console.error('openDirectorEditTask error', e); }
		}

		async function dirDeleteMyTask(taskId) {
			try {
				if (window.__openSmallModal) {
					window.__openSmallModal({
						title: t('common.confirm'),
						bodyHTML: `<div class="text-sm">${t('director.delete_task_confirm')}</div>`,
						primaryLabel: t('common.delete'),
						onPrimary: async () => {
							try {
								const resp = await fetch(`${API}/tasks/${encodeURIComponent(taskId)}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
								const data = await resp.json();
								if (!resp.ok || (data && data.success === false)) {
									throw new Error((data && data.error) || `HTTP ${resp.status}`);
								}
								if (window.__openSmallModal) {
									window.__openSmallModal({ title: t('common.success'), bodyHTML: `<div class="text-sm">${t('director.task_deleted')}</div>` });
								}
								await loadCore();
								await buildEmployeeDeptIndex();
								updateKPIs();
								renderDirectorMyTasksView();
							} catch (err) {
								console.error('dirDeleteMyTask', err);
								if (window.__openSmallModal) {
									window.__openSmallModal({ title: t('common.error'), bodyHTML: `<div class="text-sm text-red-700">${(err && err.message) || t('director.unknown_error')}</div>` });
								}
							}
						}
					});
					return;
				}
				// Fallback simple confirm
				if (!confirm(t('director.delete_task_confirm'))) return;
				const resp = await fetch(`${API}/tasks/${encodeURIComponent(taskId)}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
				const data = await resp.json(); if (!resp.ok || (data && data.success === false)) { throw new Error((data && data.error) || `HTTP ${resp.status}`); }
				await loadCore(); await buildEmployeeDeptIndex(); updateKPIs(); renderDirectorMyTasksView();
			} catch (err) { console.error('dirDeleteMyTask', err); }
		}

		// ---- Mes Instructions (crï¿½ï¿½es par le directeur) ----
		async function renderDirectorMyInstructionsView() {
			const content = document.getElementById('dynamicContent');
			const myId = getDirectorEmployeeId();
			content.innerHTML = `
				<div class="max-w-7xl mx-auto p-6">
					<!-- Page Header -->
					<div class="mb-6">
						<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6" dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
							<div>
								<h2 class="text-2xl font-bold text-gray-900" data-translate="director.my_instructions">${t('director.my_instructions')}</h2>
							</div>
							<div class="flex flex-wrap gap-2">
								<button id="dirInstrSortToggle" class="p-2 rounded-lg bg-gray-100 text-gray-600 transition-colors" title="Toggle Sort">
									<i class="fas fa-sort-alpha-down" id="dirInstrSortIcon"></i>
								</button>
								<button id="dirInstrViewGrid" class="p-2 rounded-lg bg-blue-600 text-white transition-colors" title="Grid View">
									<i class="fas fa-th-large"></i>
								</button>
								<button id="dirInstrViewList" class="p-2 rounded-lg bg-gray-100 text-gray-600 transition-colors" title="List View">
									<i class="fas fa-list"></i>
								</button>
							</div>
						</div>
					</div>

					<!-- Instructions Grid -->
					<div id="directorMyInstrGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
						<!-- Instruction cards will be loaded here -->
					</div>

					<!-- Instructions List (Table View) -->
					<div id="directorMyInstrList" class="hidden">
						<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
							<table class="w-full divide-y divide-gray-200">
								<thead class="bg-gray-50">
									<tr>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.instruction">${t('director.instruction')}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="tasks.priority">${t('tasks.priority')}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.recipients">${t('director.recipients')}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="tasks.due">${t('tasks.due')}</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="director.status">${t('director.status')}</th>
									</tr>
								</thead>
								<tbody id="directorMyInstrTableBody" class="bg-white divide-y divide-gray-200">
									<!-- Table rows will be loaded here -->
								</tbody>
							</table>
						</div>
					</div>

					<!-- Pagination Controls -->
					<div id="directorMyInstrPagination" class="flex justify-center items-center space-x-4 mt-6">
						<button id="dirInstrPrevBtn" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
							<i class="fas fa-chevron-left mr-2"></i>
							<span data-translate="common.previous">${t('common.previous')}</span>
						</button>
						<span id="dirInstrPageInfo" class="text-sm text-gray-600">
							Page <span id="dirInstrCurrentPage">1</span> of <span id="dirInstrTotalPages">1</span>
						</span>
						<button id="dirInstrNextBtn" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
							<span data-translate="common.next">${t('common.next')}</span>
							<i class="fas fa-chevron-right ml-2"></i>
						</button>
					</div>

					<!-- Empty State -->
					<div id="directorMyInstrEmpty" class="text-center py-12 hidden">
						<div class="mx-auto h-24 w-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
							<i class="fas fa-bullhorn text-gray-400 text-3xl"></i>
						</div>
						<h3 class="text-lg font-medium text-gray-900 mb-2" data-translate="director.no_instructions">${t('director.no_instructions')}</h3>
						<p class="text-gray-500 mb-4" data-translate="director.create_first_instruction">${t('director.create_first_instruction')}</p>
					</div>
				</div>
			`;

			// Charger les instructions crÃ©Ã©es via la nouvelle API
			let instructions = [];
			try {
				const resp = await fetch(`${API}/api/instructions/created-by/${myId}`);
				const data = await resp.json();
				instructions = (data && data.success && Array.isArray(data.instructions)) ? data.instructions : [];
			} catch (_) { instructions = []; }

			const gridView = document.getElementById('directorMyInstrGrid');
			const listView = document.getElementById('directorMyInstrList');
			const tableViewBody = document.getElementById('directorMyInstrTableBody');
			const emptyState = document.getElementById('directorMyInstrEmpty');

			// Sort state - initialize before any sorting functions
			let instructionSortOrder = 'asc'; // 'asc' or 'desc'
			
			// Pagination state
			let instructionCurrentPage = 1;
			let instructionCurrentView = 'grid'; // 'grid' or 'list'

			// Show/hide empty state
			if (instructions.length === 0) {
				gridView.classList.add('hidden');
				listView.classList.add('hidden');
				emptyState.classList.remove('hidden');
			} else {
				gridView.classList.remove('hidden');
				emptyState.classList.add('hidden');
				renderInstructionViews();
			}

			// View toggle functionality
			const gridBtn = document.getElementById('dirInstrViewGrid');
			const listBtn = document.getElementById('dirInstrViewList');
			const sortBtn = document.getElementById('dirInstrSortToggle');
			const sortIcon = document.getElementById('dirInstrSortIcon');

			gridBtn.addEventListener('click', () => switchInstructionView('grid'));
			listBtn.addEventListener('click', () => switchInstructionView('list'));
			sortBtn.addEventListener('click', () => toggleInstructionSort());

			// Pagination event listeners
			const prevBtn = document.getElementById('dirInstrPrevBtn');
			const nextBtn = document.getElementById('dirInstrNextBtn');
			
			if (prevBtn) {
				prevBtn.addEventListener('click', () => {
					if (instructionCurrentPage > 1) {
						instructionCurrentPage--;
						renderInstructionViews();
					}
				});
			}
			
			if (nextBtn) {
				nextBtn.addEventListener('click', () => {
					const sortedInstructions = sortInstructionsByLanguage(instructions);
					const itemsPerPage = instructionCurrentView === 'grid' ? 10 : 20;
					const totalPages = Math.ceil(sortedInstructions.length / itemsPerPage);
					
					if (instructionCurrentPage < totalPages) {
						instructionCurrentPage++;
						renderInstructionViews();
					}
				});
			}

			function toggleInstructionSort() {
				instructionSortOrder = instructionSortOrder === 'asc' ? 'desc' : 'asc';
				updateSortIcon(sortIcon, instructionSortOrder);
				renderInstructionViews();
			}

			function updateSortIcon(icon, order) {
				if (order === 'asc') {
					icon.className = 'fas fa-sort-alpha-down';
					sortBtn.classList.remove('bg-blue-600', 'text-white');
					sortBtn.classList.add('bg-gray-100', 'text-gray-600');
				} else {
					icon.className = 'fas fa-sort-alpha-up';
					sortBtn.classList.add('bg-blue-600', 'text-white');
					sortBtn.classList.remove('bg-gray-100', 'text-gray-600');
				}
			}

			function sortInstructionsByLanguage(items) {
				const currentLang = typeof currentLanguage !== 'undefined' ? currentLanguage : (window.currentLanguage || 'en');

				return [...items].sort((a, b) => {
					const textA = a.body || '';
					const textB = b.body || '';

					let comparison = 0;

					// Arabic sorting
					if (currentLang === 'ar') {
						comparison = textA.localeCompare(textB, 'ar', { sensitivity: 'base' });
					}
					// French sorting
					else if (currentLang === 'fr') {
						comparison = textA.localeCompare(textB, 'fr', { sensitivity: 'base', ignorePunctuation: true });
					}
					// English sorting (default)
					else {
						comparison = textA.localeCompare(textB, 'en', { sensitivity: 'base' });
					}

					return instructionSortOrder === 'asc' ? comparison : -comparison;
				});
			}

			function switchInstructionView(view) {
				instructionCurrentView = view;
				instructionCurrentPage = 1; // Reset page when switching views
				if (view === 'grid') {
					gridBtn.classList.add('bg-blue-600', 'text-white');
					gridBtn.classList.remove('bg-gray-100', 'text-gray-600');
					listBtn.classList.remove('bg-blue-600', 'text-white');
					listBtn.classList.add('bg-gray-100', 'text-gray-600');
					gridView.classList.remove('hidden');
					listView.classList.add('hidden');
				} else {
					listBtn.classList.add('bg-blue-600', 'text-white');
					listBtn.classList.remove('bg-gray-100', 'text-gray-600');
					gridBtn.classList.remove('bg-blue-600', 'text-white');
					gridBtn.classList.add('bg-gray-100', 'text-gray-600');
					listView.classList.remove('hidden');
					gridView.classList.add('hidden');
				}
				renderInstructionViews();
			}

			function renderInstructionViews() {
				const sortedInstructions = sortInstructionsByLanguage(instructions);
				renderInstructionGrid(sortedInstructions);
				renderInstructionList(sortedInstructions);
				updateInstructionPagination(sortedInstructions.length);
			}

			function updateInstructionPagination(totalItems) {
				const itemsPerPage = instructionCurrentView === 'grid' ? 10 : 20;
				const totalPages = Math.ceil(totalItems / itemsPerPage);
				
				const prevBtn = document.getElementById('dirInstrPrevBtn');
				const nextBtn = document.getElementById('dirInstrNextBtn');
				const currentPageSpan = document.getElementById('dirInstrCurrentPage');
				const totalPagesSpan = document.getElementById('dirInstrTotalPages');
				const paginationDiv = document.getElementById('directorMyInstrPagination');
				
				if (!paginationDiv) return;
				
				// Show/hide pagination
				if (totalItems === 0) {
					paginationDiv.classList.add('hidden');
					return;
				} else {
					paginationDiv.classList.remove('hidden');
				}
				
				// Update page info
				if (currentPageSpan) currentPageSpan.textContent = instructionCurrentPage;
				if (totalPagesSpan) totalPagesSpan.textContent = totalPages;
				
				// Update button states
				if (prevBtn) {
					prevBtn.disabled = instructionCurrentPage === 1;
				}
				if (nextBtn) {
					nextBtn.disabled = instructionCurrentPage >= totalPages;
				}
			}

			function getPaginatedInstructions(items) {
				const itemsPerPage = instructionCurrentView === 'grid' ? 10 : 20;
				const startIndex = (instructionCurrentPage - 1) * itemsPerPage;
				const endIndex = startIndex + itemsPerPage;
				return items.slice(startIndex, endIndex);
			}

			function renderInstructionGrid(sortedInstructions = instructions) {
				const paginatedInstructions = getPaginatedInstructions(sortedInstructions);
				gridView.innerHTML = paginatedInstructions.map(i => {
					const recips = Array.isArray(i.recipients) ? i.recipients : [];

					return `
						<div class="timetable-card" style="padding: 24px;">
							<div style="display: flex; flex-direction: column; gap: 20px;">
								<!-- Header Section -->
								<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
									<div style="flex: 1; min-width: 0;">
										<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
											<span style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: #64748b;" data-translate="director.instruction">${t('director.instruction')}</span>
										</div>
										<h4 style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin: 0 0 8px 0; line-height: 1.3;">${i.body || t('director.instruction')}</h4>
										<p style="font-size: 0.9rem; color: #64748b; line-height: 1.5; margin: 0;">${i.body ? (i.body.length > 120 ? i.body.slice(0, 120) + '...' : i.body) : t('director.no_instruction_body')}</p>
									</div>
								</div>
								
								<!-- Info Grid -->
								<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
									<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 14px;">
										<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #3B82F6, #2563EB); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
											<i class="fas fa-users" style="font-size: 1rem;"></i>
										</div>
										<div style="flex: 1; min-width: 0;">
											<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #3B82F6; margin: 0 0 4px 0; font-weight: 600;" data-translate="director.recipients">${t('director.recipients')}</p>
											<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${recips.length}</p>
										</div>
									</div>
									<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.04)); border: 1px solid rgba(124, 58, 237, 0.2); border-radius: 14px;">
										<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #7C3AED, #6D28D9); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
											<i class="fas fa-signal" style="font-size: 1rem;"></i>
										</div>
										<div style="flex: 1; min-width: 0;">
											<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #7C3AED; margin: 0 0 4px 0; font-weight: 600;" data-translate="tasks.priority">${t('tasks.priority')}</p>
											<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${translatePriorityValue(i.priority || 'Normal')}</p>
										</div>
									</div>
									<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.04)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 14px;">
										<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, #10B981, #059669); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
											<i class="fas fa-link" style="font-size: 1rem;"></i>
										</div>
										<div style="flex: 1; min-width: 0;">
											<p style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: #10B981; margin: 0 0 4px 0; font-weight: 600;" data-translate="director.status">${t('director.status')}</p>
											<p style="font-size: 0.85rem; font-weight: 600; color: #0f172a; margin: 0;">${translateStatusValue(i.status || 'Active')}</p>
										</div>
									</div>
								</div>
							</div>
						</div>
					`;
				}).join('');
			}

			function renderInstructionList(sortedInstructions = instructions) {
				const paginatedInstructions = getPaginatedInstructions(sortedInstructions);
				tableViewBody.innerHTML = paginatedInstructions.map(i => {
					const recips = Array.isArray(i.recipients) ? i.recipients : [];
					const priorityColors = {
						'High': 'bg-red-100 text-red-800',
						'Medium': 'bg-yellow-100 text-yellow-800',
						'Normal': 'bg-green-100 text-green-800',
						'Low': 'bg-gray-100 text-gray-800'
					};
					const statusColors = {
						'Active': 'bg-green-100 text-green-800',
						'Completed': 'bg-blue-100 text-blue-800',
						'Pending': 'bg-yellow-100 text-yellow-800',
						'Cancelled': 'bg-red-100 text-red-800'
					};

					return `
						<tr class="hover:bg-gray-50">
							<td class="px-6 py-4">
								<div class="text-sm font-medium text-gray-900 max-w-xs truncate">${i.body || t('director.instruction')}</div>
							</td>
							<td class="px-6 py-4 whitespace-nowrap">
								<span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${priorityColors[i.priority] || priorityColors['Normal']}">
									${translatePriorityValue(i.priority || 'Normal')}
								</span>
							</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${recips.length}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${i.due_at ? new Date(i.due_at).toLocaleDateString() : '-'}</td>
							<td class="px-6 py-4 whitespace-nowrap">
								<span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${statusColors[i.status] || statusColors['Active']}">
									${translateStatusValue(i.status || 'Active')}
								</span>
							</td>
						</tr>
					`;
				}).join('');
			}

			if (typeof updatePageTranslations === 'function') {
				updatePageTranslations();
			}
		}

		// Commentaires pour instruction (modal simplifi)
		let dirInstrCurrentTaskId = null;
		async function openInstructionComments(taskId) {
			try {
				dirInstrCurrentTaskId = taskId;
				let list = [];
				const r = await fetch(`${API} /tasks/${taskId}/comments`);
				if (r.ok) {
					const data = await r.json();
					list = (data && data.success && Array.isArray(data.comments)) ? data.comments : [];
				}

				const html = `
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; max-width: 600px; width: 90%; margin: 0 auto;">
                
                <!-- Header simplifiï¿½ -->
                <div style="background: #f8fafc; padding: 20px; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">
                            <i class="fas fa-comments" style="margin-right: 8px; color: #6b7280;"></i>
                            ${t('director.comments')}
                        </h3>
                        <span style="background: #e5e7eb; color: #374151; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                            ${list.length}
                        </span>
                    </div>
                </div>

                <!-- Liste des commentaires -->
                <div style="max-height: 400px; overflow-y: auto;">
                    ${list.length ? list.map(c => `
                        <div style="padding: 16px 20px; border-bottom: 1px solid #f3f4f6;">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: #9ca3af; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <span style="color: white; font-weight: 600; font-size: 14px;">${(c.author_name || c.first_name || 'U').charAt(0).toUpperCase()}</span>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">${c.author_name || (c.first_name ? `${c.first_name} ${c.last_name}` : t('common.unknown'))}</div>
                                            <div style="color: #6b7280; font-size: 12px; margin-top: 2px;">${c.created_at ? new Date(c.created_at).toLocaleString(getCurrentLanguage()) : t('director.unknown_date')}</div>
                                        </div>
                                        ${String(c.employee_id) === String(getDirectorEmployeeId()) ? `
                                        <div style="display: flex; gap: 6px;">
                                            <button style="background: none; color: #6b7280; border: none; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onclick="window.dirPromptEditInstructionComment('${c.id}')" onmouseover="this.style.color='#374151'; this.style.background='#f3f4f6'" onmouseout="this.style.color='#6b7280'; this.style.background='none'">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button style="background: none; color: #dc2626; border: none; padding: 6px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s;" onclick="window.dirDeleteInstructionComment('${c.id}')" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>` : ''}
                                    </div>
                                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
                                        <p id="instr-comment-text-${c.id}" style="margin: 0; color: #374151; line-height: 1.4; font-size: 13px;">${c.text || c.comment || t('director.no_comments')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('') : `
                        <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                            <i class="fas fa-comment-slash" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>
                            <p style="margin: 0; font-size: 14px;">${t('director.no_comments')}</p>
                        </div>
                    `}
                </div>

                <!-- Zone d'ajout -->
                <div style="background: #f8fafc; padding: 16px 20px; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="dirInstrNewComment" placeholder="${t('director.add_comment')}" style="flex: 1; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; background: white; font-size: 13px; outline: none;" />
                        <button onclick="dirAddInstructionComment()" style="background: #4f46e5; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; transition: background-color 0.2s;" onmouseover="this.style.background='#4338ca'" onmouseout="this.style.background='#4f46e5'">
                            <i class="fas fa-paper-plane" style="margin-right: 6px;"></i>${t('director.send')}
                        </button>
                    </div>
                </div>
            </div>
        `;

				document.getElementById('modalTitle').textContent = '';
				document.getElementById('modalContent').innerHTML = html;

				const modal = document.getElementById('employeeDetailsModal');
				modal.style.background = 'rgba(249, 250, 251, 0.10)'; // #f9fafb avec transparence
				modal.style.backdropFilter = 'none';

				modal.classList.remove('hidden');
				document.body.classList.add('overflow-hidden');

			} catch (_) {
				console.warn('openInstructionComments failed');
			}
		}

		// Modal d'ï¿½dition simplifiï¿½
		window.dirPromptEditInstructionComment = function (commentId) {
			const el = document.getElementById(`instr-comment-text-${commentId}`);
			const current = el ? el.textContent : '';

			const editModalHTML = `
		<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: ''; z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
			<div style="background: white; border-radius: 10px; width: 100%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;" onclick="event.stopPropagation()">
				
				<div style="padding: 20px; border-bottom: 1px solid #f3f4f6;">
					<h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #1f2937;">
						<i class="fas fa-edit" style="margin-right: 8px; color: #6b7280;"></i>
						${t('director.edit_comment')}
					</h3>
				</div>
				
				<div style="padding: 20px;">
					<textarea id="dirEditInstrText" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit; outline: none; min-height: 80px;" rows="3" placeholder="${t('director.add_comment')}">${current.replace(/"/g, '&quot;')}</textarea>
				</div>
				
				<div style="padding: 16px 20px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #f3f4f6; background: #f9fafb;">
					<button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: #e5e7eb; color: #374151; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;" onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">
						${t('common.cancel')}
					</button>
					<button onclick="saveEditComment('${commentId}')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
						${t('common.save')}
					</button>
				</div>
			</div>
		</div>
	`;

			document.body.insertAdjacentHTML('beforeend', editModalHTML);
			document.getElementById('dirEditInstrText').focus();
		}

		// Fonction pour sauvegarder l'ï¿½dition
		window.saveEditComment = async function (commentId) {
			const val = (document.getElementById('dirEditInstrText')?.value || '').trim();
			if (!val) return;
			await window.dirEditInstructionComment(commentId, val);
			document.querySelector('[style*="position: fixed"]').remove();
		}

		window.dirEditInstructionComment = async function (commentId, newText) {
			try {
				if (!newText) return;
				const employeeId = getDirectorEmployeeId();
				const resp = await fetch(`${API}/comments/${commentId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ comment: newText, employee_id: employeeId }) });
				const data = await resp.json();
				if (!resp.ok || !data.success) throw new Error(data.error || `HTTP ${resp.status}`);
				await openInstructionComments(dirInstrCurrentTaskId);
			} catch (err) { console.error('dirEditInstructionComment', err); }
		}

		// Modal de suppression simplifiï¿½
		window.dirDeleteInstructionComment = async function (commentId) {
			const deleteModalHTML = `
		<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: ''; z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
			<div style="background: white; border-radius: 10px; width: 100%; max-width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;" onclick="event.stopPropagation()">
				
				<div style="padding: 20px; text-align: center;">
					<div style="width: 48px; height: 48px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
						<i class="fas fa-trash" style="font-size: 18px; color: #dc2626;"></i>
					</div>
					<h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #1f2937;">${t('director.delete_comment')}</h3>
					<p style="margin: 0; font-size: 13px; color: #6b7280; line-height: 1.4;">
						${t('director.delete_comment_confirm')}
					</p>
				</div>
				
				<div style="padding: 16px 20px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #f3f4f6; background: #f9fafb;">
					<button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: #e5e7eb; color: #374151; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;" onmouseover="this.style.background='#d1d5db'" onmouseout="this.style.background='#e5e7eb'">
						${t('common.cancel')}
					</button>
					<button onclick="confirmDeleteComment('${commentId}')" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
						${t('common.delete')}
					</button>
				</div>
			</div>
		</div>
	`;

			document.body.insertAdjacentHTML('beforeend', deleteModalHTML);
		}

		// Fonction pour confirmer la suppression
		window.confirmDeleteComment = async function (commentId) {
			try {
				const employeeId = getDirectorEmployeeId();
				const resp = await fetch(`${API}/comments/${commentId}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ employee_id: employeeId }) });
				const data = await resp.json();
				if (!resp.ok || !data.success) throw new Error(data.error || `HTTP ${resp.status}`);
				document.querySelector('[style*="position: fixed"]').remove();
				await openInstructionComments(dirInstrCurrentTaskId);
			} catch (err) {
				console.error('dirDeleteInstructionComment', err);
				document.querySelector('[style*="position: fixed"]').remove();
			}
		}

		async function dirAddInstructionComment() {
			try {
				const input = document.getElementById('dirInstrNewComment');
				if (!input) return;
				const text = (input.value || '').trim();
				if (!text || !dirInstrCurrentTaskId) return;
				const employeeId = getDirectorEmployeeId();
				const resp = await fetch(`${API}/tasks/${dirInstrCurrentTaskId}/comments`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ comment: text, employee_id: employeeId }) });
				const data = await resp.json();
				if (!resp.ok || !data.success) throw new Error(data.error || `HTTP ${resp.status}`);
				input.value = '';
				await openInstructionComments(dirInstrCurrentTaskId);
			} catch (err) { console.error('dirAddInstructionComment', err); }
		}
	</script>
	<script src="enhanced-kpi-stats.js"></script>
</body>

</html>
</body>

</html>
