<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="report.title">Rapports - Interface Employ√©</title>
    <meta name="google" content="notranslate">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="tailwind.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Translations Script - Using relative path to frontend -->
    <script src="../../../frontend/assets/js/translations.js"></script>
    <!-- Auth Script -->
    <script src="auth.js"></script>
    <style>
        .filter-button {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .filter-button:hover {
            background-color: #f9fafb;
        }
        .filter-button.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .report-card {
            transition: all 0.3s ease;
        }
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .modal {
            backdrop-filter: blur(4px);
        }
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-scroll {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 8px;
        }
        .modal-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .modal-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        .modal-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .modal-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Style pour le modal des d√©tails */
#reportDetailsModal {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.recipient-selector {
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    max-height: 200px;
    overflow-y: auto;
    background-color: #f9fafb;
}
.recipient-option {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}
.recipient-option:hover {
    background-color: #e5e7eb;
}
.recipient-option.selected {
    background-color: #dbeafe;
    color: #1d4ed8;
}
.selected-recipients {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
}
.recipient-tag {
    background-color: #3b82f6;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.recipient-tag button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 14px;
    padding: 0;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.selected-employee-badge {
    transition: all 0.2s ease;
}

.selected-employee-badge:hover {
    background-color: #3b82f6 !important;
    color: white !important;
}

.employee-checkbox:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

#employeesCheckboxContainer::-webkit-scrollbar {
    width: 6px;
}

#employeesCheckboxContainer::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

#employeesCheckboxContainer::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

#employeesCheckboxContainer::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Main Content -->
    <!-- Language Selector -->
    <div class="max-w-7xl mx-auto px-6 pt-6">
        <select id="languageSelector" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ml-auto block">
            <option value="en">English</option>
            <option value="fr">Fran√ßais</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
    </div>
    <main class="max-w-7xl mx-auto p-6">
        <!-- Vue Employ√© -->
        <div id="employeeInterface" class="space-y-6">
            <!-- Statistiques personnelles -->
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Remplacer les cartes de statistiques -->
<div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-blue-500">
    <div class="flex items-center">
        <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-file-alt text-blue-600 text-xl"></i>
        </div>
        <div class="ml-4">
            <p class="text-sm text-gray-600" data-translate="report.my_reports">Mes Rapports</p>
            <p id="totalReports" class="text-2xl font-bold text-gray-900">0</p>
        </div>
    </div>
</div>
<div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-green-500">
    <div class="flex items-center">
        <div class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
        </div>
        <div class="ml-4">
            <p class="text-sm text-gray-600" data-translate="report.acknowledged">Accus√©s</p>
            <p id="acknowledgedReports" class="text-2xl font-bold text-gray-900">0</p>
        </div>
    </div>
</div>
<div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-yellow-500">
    <div class="flex items-center">
        <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-clock text-yellow-600 text-xl"></i>
        </div>
        <div class="ml-4">
            <p class="text-sm text-gray-600" data-translate="report.pending">En Attente</p>
            <p id="pendingReports" class="text-2xl font-bold text-gray-900">0</p>
        </div>
    </div>
</div>
<div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-purple-500">
    <div class="flex items-center">
        <div class="h-12 w-12 bg-purple-100 rounded-lg flex items-center justify-center">
            <i class="fas fa-calendar-day text-purple-600 text-xl"></i>
        </div>
        <div class="ml-4">
            <p class="text-sm text-gray-600" data-translate="report.today">Aujourd'hui</p>
            <p id="todayReports" class="text-2xl font-bold text-gray-900">0</p>
        </div>
    </div>
</div>
            </div>


            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900" data-translate="report.actions">Actions</h2>
                </div>
                <div class="flex gap-4">
                    <button id="generateReportBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        <span data-translate="report.generate_new">G√©n√©rer Nouveau Rapport</span>
                    </button>
                </div>
            </div>

            <!-- Filtres -->
            <div class="bg-white rounded-lg shadow-sm p-6">
  <h3 class="text-lg font-semibold text-gray-900 mb-4" data-translate="report.filters">Filtres</h3>
  
  <!-- Flex responsive -->
  <div class="flex flex-col md:flex-row md:justify-between gap-4">
    
    <!-- Groupe Status -->
    <!-- Remplacer cette section -->
<div class="flex flex-wrap gap-2">
  <button class="filter-button active" data-status="all" data-translate="common.all">Tous</button>
  <button class="filter-button" data-status="pending" data-translate="report.pending">En Attente</button>
  <button class="filter-button" data-status="acknowledged" data-translate="report.acknowledged">Accus√©s</button>
</div>
    
    <!-- Groupe Period -->
    <div class="flex flex-wrap gap-2">
      <button class="filter-button active" data-period="all" data-translate="report.all_periods">Toutes P√©riodes</button>
      <button class="filter-button" data-period="today" data-translate="report.today">Aujourd'hui</button>
      <button class="filter-button" data-period="week" data-translate="report.this_week">Cette Semaine</button>
      <button class="filter-button" data-period="month" data-translate="report.this_month">Ce Mois</button>
    </div>

    <!-- P√©riode personnalis√©e -->
    <div class="flex flex-wrap items-center gap-2">
      <input id="customStart" type="date" class="px-2 py-1 text-sm border border-gray-300 rounded" />
      <span class="text-gray-500">‚Üí</span>
      <input id="customEnd" type="date" class="px-2 py-1 text-sm border border-gray-300 rounded" />
      <button id="applyCustomDate" type="button" class="filter-button" data-translate="common.apply">Appliquer</button>
    </div>
    
  </div>

  <!-- Barre de recherche (ligne s√©par√©e) -->
  <div class="mt-6">
    <input id="textSearch" type="text" data-translate-placeholder="report.search_placeholder" placeholder="Rechercher (titre, objet, destinataire, contenu)" class="w-full px-3 py-2 text-sm border border-gray-300 rounded" />
  </div>
</div>


            <!-- Liste des rapports -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold text-gray-900" data-translate="report.my_reports">Mes Rapports</h3>
                </div>
                <div id="reportsList" class="p-6">
                    <div class="flex justify-center items-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="ml-3 text-gray-600" data-translate="report.loading">Chargement des rapports...</span>
                    </div>
                </div>
            </div>

            
        </div>

        <!-- Vue Responsable (masqu√©e pour le moment) -->
        <div id="responsibleInterface" class="hidden space-y-6">
            <div class="text-center py-12">
                <i class="fas fa-user-tie text-6xl text-gray-300 mb-4"></i>
                <h2 class="text-2xl font-semibold text-gray-600 mb-2">Vue Responsable</h2>
                <p class="text-gray-500">Cette vue sera impl√©ment√©e prochainement</p>
            </div>
        </div>

        <!-- Vue Directeur (masqu√©e pour le moment) -->
        <div id="directorInterface" class="hidden space-y-6">
            <div class="text-center py-12">
                <i class="fas fa-crown text-6xl text-gray-300 mb-4"></i>
                <h2 class="text-2xl font-semibold text-gray-600 mb-2">Vue Directeur</h2>
                <p class="text-gray-500">Cette vue sera impl√©ment√©e prochainement</p>
            </div>
        </div>
    </main>

    <!-- Modal de g√©n√©ration de rapport -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col modal-content">
            <div class="p-4 border-b flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900" data-translate="report.generate">G√©n√©rer un Rapport</h3>
                    <button id="closeModal" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
            </div>
            <div class="modal-scroll p-4">
                <form id="reportForm" class="space-y-4">
                    <!-- En-t√™te du rapport -->
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h4 class="font-semibold text-gray-900 mb-2 text-sm" data-translate="report.header">En-t√™te du Rapport</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1" data-translate="common.date">Date</label>
                                <input type="date" id="reportDate" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1" data-translate="report.time">Heure</label>
                                <input type="time" id="reportTime" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                    </div>

                    <!-- Destinataire -->
                   <div>
    <label class="block text-xs font-medium text-gray-700 mb-1" data-translate="report.recipients">Destinataires</label>
    <p class="text-[11px] text-gray-500 mb-2" data-translate="report.recipients_info">Le Directeur re√ßoit automatiquement tous les rapports. Vous pouvez envoyer au Directeur seul, ou √† votre responsable de d√©partement.</p>
    <div class="space-y-2">
       
        
        <!-- S√©lection du mode d'envoi -->
        <div class="space-y-2">
            <label class="flex items-center gap-2">
                <input type="radio" name="recipientMode" value="director" class="text-blue-600" checked onchange="onRecipientModeChange()">
                <span class="text-sm" data-translate="report.director_only">Directeur uniquement</span>
            </label>
            <label class="flex items-center gap-2">
                <input type="radio" name="recipientMode" value="responsible" class="text-blue-600" onchange="onRecipientModeChange()">
                <span class="text-sm"><span data-translate="report.my_responsible">Mon responsable</span>: <span id="employeeResponsibleName" class="font-medium text-gray-800">‚Äî</span></span>
            </label>
            <div id="noResponsibleHint" class="hidden text-xs text-red-600" data-translate="report.no_responsible">Aucun responsable trouv√© pour votre d√©partement</div>
        </div>
        
        <!-- Champ cach√© pour validation -->
        <input type="hidden" id="recipientIds" required>
    </div>
</div>

                    <!-- Titre du rapport -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1" data-translate="report.title_label">Titre du rapport</label>
                        <input type="text" id="reportTitle" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" data-translate-placeholder="report.title" placeholder="Titre" required>
                    </div>

                    <!-- Objet du rapport -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1" data-translate="report.subject">Objet du rapport</label>
                        <input type="text" id="reportSubject" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" data-translate-placeholder="report.title_label" placeholder="Titre du rapport" required>
                    </div>

                    <!-- Contenu du rapport (unique) -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1" data-translate="report.content">Contenu du rapport</label>
                        <textarea id="reportContent" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500" rows="8" data-translate-placeholder="report.content_placeholder" placeholder="Saisissez ici le contenu du rapport..." required></textarea>
                    </div>
                </form>
            </div>
            <!-- Boutons d'action -->
            <div class="flex justify-end gap-3 p-4 border-t flex-shrink-0">
                <button type="button" id="cancelReport" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300 transition-colors">
                    <span data-translate="common.cancel">Annuler</span>
                </button>
                <button type="submit" form="reportForm" class="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i>
                    <span data-translate="report.generate_pdf">G√©n√©rer PDF</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // API base URL - hr_tasks server runs on port 3020 (TASK_SERVICE_PORT)
        const API = (function() {
            // Check if there's a parent window with API services
            try {
                if (window.parent && window.parent.API_SERVICES) {
                    const parentAPI = window.parent.API_SERVICES.hr_tasks || window.parent.API_SERVICES.reports;
                    if (parentAPI) return parentAPI;
                }
            } catch(e) {}
            
            // Try to detect from current origin - if we're on a different port, use that
            const currentOrigin = location.origin;
            // If we're on port 5508 (Live Server) or similar, try to use port 3020 for API
            if (currentOrigin && (/^https?:\/\/(127\.0\.0\.1|localhost):(550[0-9]|551[0-9])/i.test(currentOrigin) || 
                new URLSearchParams(window.location.search).get('embed') === '1')) {
                // Replace port with the API server port (3020)
                return 'http://localhost:3020';
            }
            
            // Fallback to common ports
            if (currentOrigin && /^https?:\/\//i.test(currentOrigin)) {
                return currentOrigin;
            }
            // Default fallback - use port 3020 (TASK_SERVICE_PORT)
            return 'http://localhost:3020';
        })();
        console.log('üîç API Base URL:', API);
        let currentUser = null;
        let reports = [];
        let employees = [];
        let departments = [];
        let selectedRecipients = [];
let availableResponsibles = [];
let allEmployees = [];
let selectedEmployeeIds = [];

        // Initialize translations
        function initializeTranslations() {
            // Wait for translations to load
            function waitForTranslations(callback, maxAttempts = 20) {
                let attempts = 0;
                const checkTranslations = setInterval(function() {
                    attempts++;
                    if (typeof window.translations !== 'undefined' && 
                        typeof window.updatePageTranslations === 'function' &&
                        typeof window.setLanguage === 'function') {
                        clearInterval(checkTranslations);
                        callback();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkTranslations);
                        callback();
                    }
                }, 50);
            }
            
            waitForTranslations(function() {
                const languageSelector = document.getElementById('languageSelector');
                let savedLanguage = localStorage.getItem('language') || localStorage.getItem('lang') || 'fr';
                
                if (languageSelector) {
                    languageSelector.value = savedLanguage;
                    
                    if (typeof window.setLanguage === 'function') {
                        window.setLanguage(savedLanguage);
                    }
                    
                    languageSelector.addEventListener('change', function() {
                        const newLang = this.value;
                        if (typeof window.setLanguage === 'function') {
                            window.setLanguage(newLang);
                        }
                        setTimeout(function() {
                            if (typeof window.updatePageTranslations === 'function') {
                                window.updatePageTranslations();
                            }
                        }, 50);
                    });
                }
                
                // Apply translations multiple times to ensure they load
                function applyTranslations() {
                    if (typeof window.setLanguage === 'function' && savedLanguage) {
                        window.setLanguage(savedLanguage);
                    }
                    if (typeof window.updatePageTranslations === 'function') {
                        window.updatePageTranslations();
                    }
                }
                
                applyTranslations();
                setTimeout(applyTranslations, 100);
                setTimeout(applyTranslations, 500);
            });
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            initializeTranslations();
            await loadInitialData();
            setupEventListeners();
            loadReports();
        });

        // Charger les donn√©es initiales
        async function loadInitialData() {
    try {
        // Check authentication first
        if (typeof authManager === 'undefined' || !authManager.isAuthenticated()) {
            console.warn('Not authenticated, redirecting to login...');
            // Redirect to login page
            if (window.location.pathname.includes("/pages/")) {
                window.location.href = "../index.html";
            } else if (window.location.pathname.includes("/hr_tasks/")) {
                window.location.href = "../../frontend/index.html";
            } else {
                window.location.href = "../../frontend/index.html";
            }
            return;
        }

        // Get user from authentication
        const authUser = authManager.getUser();
        if (!authUser) {
            console.error('No user found in authentication');
            window.location.href = "../../frontend/index.html";
            return;
        }

        // Create currentUser from authenticated user
        // Check if employee_id exists in authUser (could be employeeId or employee_id)
        const employeeId = authUser.employeeId || authUser.employee_id || authUser.id;
        
        currentUser = {
            id: authUser.id || employeeId || '1',
            employee_id: employeeId,
            user_id: authUser.id,
            username: authUser.username || 'User',
            first_name: authUser.firstName || authUser.first_name || 'User',
            last_name: authUser.lastName || authUser.last_name || 'User',
            department: 'Non sp√©cifi√©', // Will be updated from API
            role: authUser.role || 'Employee'
        };
        
        console.log('Current user from authentication:', currentUser);

        // Helper: simple UUID check
        const isUuid = (v) => typeof v === 'string' && /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(v);

        // Si employee_id manquant OU invalide mais user_id pr√©sent, tenter de le r√©soudre c√¥t√© backend
        if ((!currentUser.employee_id || !isUuid(currentUser.employee_id)) && currentUser.user_id) {
            try {
                // Try to resolve employee_id from user_id via API
                const r = await fetch(`${API}/api/rapportemp/employees/by-user/${currentUser.user_id}`).catch(() => null);
                if (r && r.ok) {
                    const data = await r.json();
                    if (data && data.success && data.employee) {
                        currentUser.employee_id = data.employee.id;
                        currentUser.department = data.employee.department_name || currentUser.department;
                        currentUser.first_name = data.employee.first_name || currentUser.first_name;
                        currentUser.last_name = data.employee.last_name || currentUser.last_name;
                    }
                }
            } catch (err) {
                console.warn('Could not resolve employee_id from user_id:', err);
            }
        }
        
        // Log warning if employee_id is still missing after all attempts
        if (!currentUser.employee_id || !isUuid(currentUser.employee_id)) {
            console.warn('‚ö†Ô∏è Employee ID is missing or invalid. Cannot load reports without valid employee_id.');
            // Show error message but don't redirect - let user see the error
        }

        // Charger les d√©tails de l'employ√© connect√©
        // Note: /api/rapportemp/employees and /api/rapportemp/departments endpoints don't exist
        // These endpoints are not needed for the employee interface - employees and departments arrays remain empty
        employees = []; // Initialize as empty - not needed for employee interface
        departments = []; // Initialize as empty - not needed for employee interface
        
        // Load employee details if employee_id is available
        if (currentUser.employee_id && isUuid(currentUser.employee_id)) {
            try {
                const employeeDetailsRes = await fetch(`${API}/api/rapportemp/employees/${currentUser.employee_id}/details`).catch(() => null);
                if (employeeDetailsRes && employeeDetailsRes.ok) {
                    const result = await employeeDetailsRes.json();
                    if (result.success && result.employee) {
                        currentUser.department = result.employee.department_name || currentUser.department || 'Non sp√©cifi√©';
                        // Ajouter d'autres informations si n√©cessaire
                        currentUser.position = result.employee.position_id;
                        currentUser.email = result.employee.email;
                        if (result.employee.first_name) currentUser.first_name = result.employee.first_name;
                        if (result.employee.last_name) currentUser.last_name = result.employee.last_name;
                    }
                }
            } catch (err) {
                console.warn('Could not load employee details:', err);
            }
        }

        // Mettre √† jour l'affichage de l'utilisateur (removed header, so skip currentUser update)
        // Note: currentUser element was in the header which was removed
        
        // Remplir la liste des employ√©s dans le formulaire
        populateEmployeesList();

    } catch (error) {
        console.error('Erreur lors du chargement des donn√©es:', error);
        // Note: currentUser element was in the header which was removed
    }
}
// Charger les employ√©s et initialiser l'interface
// plus de chargement d'employ√©s pour ce formulaire

// Remplir les checkboxes d'employ√©s
function populateEmployeeCheckboxes(employees) {
    const container = document.getElementById('employeesCheckboxContainer');
    if (!container) return;

    container.innerHTML = `
        <div class="space-y-2">
            ${employees.map(employee => `
                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input 
                        type="checkbox" 
                        value="${employee.id}" 
                        class="employee-checkbox rounded text-blue-600 focus:ring-blue-500"
                        onchange="toggleEmployeeSelection('${employee.id}', '${employee.first_name} ${employee.last_name}', this.checked)"
                    >
                    <span class="ml-2 text-sm">${employee.first_name} ${employee.last_name}</span>
                </label>
            `).join('')}
        </div>
    `;
}

// Filtrer les employ√©s selon la recherche
function filterEmployees() {
    const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
    const filteredEmployees = allEmployees.filter(employee => 
        `${employee.first_name} ${employee.last_name}`.toLowerCase().includes(searchTerm)
    );
    populateEmployeeCheckboxes(filteredEmployees);
    
    // Re-check les employ√©s d√©j√† s√©lectionn√©s
    selectedEmployeeIds.forEach(id => {
        const checkbox = document.querySelector(`.employee-checkbox[value="${id}"]`);
        if (checkbox) checkbox.checked = true;
    });
}

// G√©rer la s√©lection/d√©s√©lection d'un employ√©
function toggleEmployeeSelection(id, name, isChecked) {
    if (isChecked) {
        if (!selectedEmployeeIds.includes(id)) {
            selectedEmployeeIds.push(id);
            addSelectedEmployeeBadge(id, name);
        }
    } else {
        selectedEmployeeIds = selectedEmployeeIds.filter(empId => empId !== id);
        removeSelectedEmployeeBadge(id);
    }
    
    // Afficher/masquer le container des s√©lections
    const selectedContainer = document.getElementById('selectedEmployees');
    selectedContainer.style.display = selectedEmployeeIds.length > 0 ? 'flex' : 'none';
}

// Ajouter un badge pour un employ√© s√©lectionn√©
function addSelectedEmployeeBadge(id, name) {
    const container = document.getElementById('selectedEmployees');
    const badge = document.createElement('div');
    badge.className = 'selected-employee-badge bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs flex items-center';
    badge.innerHTML = `
        ${name}
        <button type="button" onclick="removeEmployee('${id}')" class="ml-1 text-blue-600 hover:text-blue-800">
            <i class="fas fa-times"></i>
        </button>
    `;
    badge.dataset.employeeId = id;
    container.appendChild(badge);
}

// Retirer un badge d'employ√© s√©lectionn√©
function removeSelectedEmployeeBadge(id) {
    const badge = document.querySelector(`.selected-employee-badge[data-employee-id="${id}"]`);
    if (badge) badge.remove();
}

// Retirer un employ√© de la s√©lection
function removeEmployee(id) {
    // D√©cocher la checkbox
    const checkbox = document.querySelector(`.employee-checkbox[value="${id}"]`);
    if (checkbox) checkbox.checked = false;
    
    // Retirer de la liste des s√©lectionn√©s
    selectedEmployeeIds = selectedEmployeeIds.filter(empId => empId !== id);
    removeSelectedEmployeeBadge(id);
    
    // Cacher le container si vide
    const selectedContainer = document.getElementById('selectedEmployees');
    selectedContainer.style.display = selectedEmployeeIds.length > 0 ? 'flex' : 'none';
}

// R√©cup√©rer les employ√©s s√©lectionn√©s pour le formulaire
function getSelectedEmployees() {
    return [];
}

// R√©initialiser la s√©lection quand le modal est ferm√©
function resetEmployeeSelection() {
    selectedEmployeeIds = [];
    const container = document.getElementById('selectedEmployees');
    if (container) {
        container.innerHTML = '';
        container.style.display = 'none';
    }
    document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    const search = document.getElementById('employeeSearch');
    if (search) {
        search.value = '';
    }
}
async function loadResponsibles() {
    try {
        // R√©cup√©rer seulement le responsable du d√©partement de l'employ√© connect√©
        if (!currentUser || !currentUser.employee_id) {
            console.warn('Employee ID not available, skipping responsibles load');
            setEmployeeResponsibleName(true);
            return false;
        }
        const response = await fetch(`${API}/api/rapportemp/responsibles/by-employee/${currentUser.employee_id}`);
        if (!response.ok) {
            throw new Error('Impossible de charger le responsable');
        }
        const data = await response.json();
        if (!data.success || !data.responsibles) {
            throw new Error('Format de r√©ponse invalide');
        }
        availableResponsibles = data.responsibles;
        setEmployeeResponsibleName();
        return true;
    } catch (error) {
        console.error('Erreur chargement responsable:', error);
        setEmployeeResponsibleName(true);
        return false;
    }
}

function setEmployeeResponsibleName(isError = false) {
    const nameEl = document.getElementById('employeeResponsibleName');
    const noResp = document.getElementById('noResponsibleHint');
    if (!nameEl || !noResp) return;
    if (isError || availableResponsibles.length === 0) {
        nameEl.textContent = '‚Äî';
        noResp.classList.remove('hidden');
        return;
    }
    const resp = availableResponsibles[0];
    nameEl.textContent = `${resp.first_name} ${resp.last_name}${resp.department_name ? ' (' + resp.department_name + ')' : ''}`;
    noResp.classList.add('hidden');
}

function onRecipientModeChange() {
    // Rien √† faire visuellement pour l‚Äôinstant; la soumission lit la valeur choisie
}

// S√©lectionner le responsable du d√©partement
// Plus de s√©lection manuelle; radio contr√¥le la cible

// Basculer l'affichage du s√©lecteur
function toggleRecipientSelector() {
    const selector = document.getElementById('recipientSelector');
    const isVisible = selector.style.display !== 'none';
    selector.style.display = isVisible ? 'none' : 'block';
}

// S√©lectionner/d√©s√©lectionner un destinataire
function toggleRecipientSelection(id, type, name, department) {
    const existingIndex = selectedRecipients.findIndex(r => r.id === id);
    
    if (existingIndex > -1) {
        // D√©s√©lectionner
        selectedRecipients.splice(existingIndex, 1);
    } else {
        // S√©lectionner
        selectedRecipients.push({
            id: id,
            type: type,
            name: name,
            department: department
        });
    }
    
    updateRecipientDisplay();
    updateRecipientCheckboxes();
}

// S√©lectionner un type de destinataire (directeur)
function selectRecipientType(type) {
    if (type === 'director') {
        const existingDirector = selectedRecipients.find(r => r.type === 'director');
        if (!existingDirector) {
            selectedRecipients.push({
                id: null,
                type: 'director',
                name: 'Directeur G√©n√©ral',
                department: ''
            });
            updateRecipientDisplay();
        }
    }
}

// Effacer tous les destinataires
function clearAllRecipients() {
    selectedRecipients = [];
    updateRecipientDisplay();
    updateRecipientCheckboxes();
}

// Mettre √† jour l'affichage des destinataires s√©lectionn√©s
function updateRecipientDisplay() {
    const container = document.getElementById('selectedRecipients');
    const hiddenInput = document.getElementById('recipientIds');
    
    if (!container || !hiddenInput) return;
    
    // Mettre √† jour les tags visuels
    container.innerHTML = selectedRecipients.map((recipient, index) => `
        <div class="recipient-tag">
            <span>${recipient.name}${recipient.department ? ` (${recipient.department})` : ''}</span>
            <button type="button" onclick="removeRecipient(${index})" title="Supprimer">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
    
    // Mettre √† jour le champ cach√© pour validation
    const recipientIds = selectedRecipients
        .filter(r => r.id) // Exclure le directeur g√©n√©ral qui n'a pas d'ID
        .map(r => r.id);
    hiddenInput.value = recipientIds.length > 0 || selectedRecipients.some(r => r.type === 'director') ? 'valid' : '';
}

// Supprimer un destinataire
function removeRecipient(index) {
    selectedRecipients.splice(index, 1);
    updateRecipientDisplay();
    updateRecipientCheckboxes();
}

// Mettre √† jour les cases √† cocher
function updateRecipientCheckboxes() {
    document.querySelectorAll('.recipient-option').forEach(option => {
        const id = option.dataset.id;
        const checkbox = option.querySelector('.recipient-checkbox');
        const isSelected = selectedRecipients.some(r => r.id === id);
        
        checkbox.checked = isSelected;
        option.classList.toggle('selected', isSelected);
    });
}
        // Remplir la liste des employ√©s et responsables
        // Remplir la liste des employ√©s et responsables
// Remplir la liste des employ√©s et responsables
async function populateEmployeesList() {
    const select = document.getElementById('concernedEmployees');
    if (select) {
        select.innerHTML = employees.map(emp => 
            `<option value="${emp.id}">${emp.first_name} ${emp.last_name}</option>`
        ).join('');
    }

    // Charger les responsables
    await loadResponsibles();
}
        // Configuration des √©v√©nements
        function setupEventListeners() {
            // Navigation entre les vues (removed header, so check if elements exist)
            const employeeView = document.getElementById('employeeView');
            const responsibleView = document.getElementById('responsibleView');
            const directorView = document.getElementById('directorView');
            
            if (employeeView) {
                employeeView.addEventListener('click', () => switchView('employee'));
            }
            if (responsibleView) {
                responsibleView.addEventListener('click', () => switchView('responsible'));
            }
            if (directorView) {
                directorView.addEventListener('click', () => switchView('director'));
            }

            // Boutons d'action
            document.getElementById('generateReportBtn').addEventListener('click', openReportModal);

            // Modal
            document.getElementById('closeModal').addEventListener('click', closeReportModal);
            document.getElementById('cancelReport').addEventListener('click', closeReportModal);
            document.getElementById('reportForm').addEventListener('submit', generateReport);

            // Filtres
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Retirer la classe active de tous les boutons du m√™me groupe
                    const group = this.closest('.flex');
                    group.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
                    // Ajouter la classe active au bouton cliqu√©
                    this.classList.add('active');
                    // Appliquer le filtre
                    applyFilters();
                });
            });

            // Appliquer la p√©riode personnalis√©e
            const applyBtn = document.getElementById('applyCustomDate');
            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    // D√©sactiver les boutons p√©riode pr√©d√©finie
                    document.querySelectorAll('.filter-button[data-period]').forEach(b => b.classList.remove('active'));
                    applyFilters();
                });
            }

            // Recherche texte
            const searchEl = document.getElementById('textSearch');
            if (searchEl) {
                searchEl.addEventListener('input', () => applyFilters());
            }

            // Fermer le modal en cliquant √† l'ext√©rieur
            document.getElementById('reportModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeReportModal();
                }
            });
        }

        // Changer de vue
        function switchView(view) {
            // Masquer toutes les interfaces
            document.getElementById('employeeInterface').classList.add('hidden');
            document.getElementById('responsibleInterface').classList.add('hidden');
            document.getElementById('directorInterface').classList.add('hidden');

            // Afficher l'interface s√©lectionn√©e
            document.getElementById(`${view}Interface`).classList.remove('hidden');

            // Mettre √† jour les boutons de navigation
            document.querySelectorAll('[id$="View"]').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(`${view}View`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`${view}View`).classList.add('bg-blue-600', 'text-white');
        }

        // Ouvrir le modal de g√©n√©ration de rapport
        function openReportModal() {
            // Remplir la date et l'heure actuelles
            const now = new Date();
            document.getElementById('reportDate').value = now.toISOString().split('T')[0];
            document.getElementById('reportTime').value = now.toTimeString().slice(0, 5);
            
            document.getElementById('reportModal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeReportModal() {
    document.getElementById('reportModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
    document.getElementById('reportForm').reset();
     resetEmployeeSelection();
    
    // R√©initialiser les destinataires s√©lectionn√©s
    selectedRecipients = [];
    updateRecipientDisplay();
    updateRecipientCheckboxes();
    
    // Masquer le s√©lecteur
    const selector = document.getElementById('recipientSelector');
    if (selector) {
        selector.style.display = 'none';
    }
}

        // Charger les rapports
        async function loadReports() {
            try {
                console.log('üîç loadReports - currentUser:', currentUser);
                
                // Try to resolve employee_id if missing
                if (currentUser && !currentUser.employee_id && currentUser.user_id) {
                    console.log('üîç Trying to resolve employee_id from user_id:', currentUser.user_id);
                    try {
                        const r = await fetch(`${API}/api/rapportemp/employees/by-user/${currentUser.user_id}`).catch(() => null);
                        if (r && r.ok) {
                            const data = await r.json();
                            if (data && data.success && data.employee) {
                                currentUser.employee_id = data.employee.id;
                                console.log('‚úÖ Resolved employee_id:', currentUser.employee_id);
                            }
                        }
                    } catch (err) {
                        console.warn('Could not resolve employee_id:', err);
                    }
                }
                
                if (!currentUser || !currentUser.employee_id) {
                    console.warn('‚ö†Ô∏è Utilisateur non identifi√© - employee_id manquant. Les rapports ne peuvent pas √™tre charg√©s.');
                    console.warn('   currentUser:', currentUser);
                    // Show user-friendly message instead of just logging error
                    const reportsList = document.getElementById('reportsList');
                    if (reportsList) {
                        const messageKey = 'report.missing_employee_id';
                        const exampleKey = 'report.url_example';
                        const translatedMessage = typeof window.translate === 'function' ? 
                            window.translate(messageKey) : 
                            'Veuillez acc√©der √† cette page avec les param√®tres appropri√©s dans l\'URL.';
                        const translatedExample = typeof window.translate === 'function' ? 
                            window.translate(exampleKey) : 
                            'Exemple: ?employee_id=xxx&first=John&last=Doe';
                        
                        reportsList.innerHTML = `
                            <div class="text-center py-12">
                                <p class="text-gray-600" data-translate="report.missing_employee_id">${translatedMessage}</p>
                                <p class="text-sm text-gray-500 mt-2" data-translate="report.url_example">${translatedExample}</p>
                            </div>
                        `;
                        
                        // Apply translations if available
                        if (typeof window.updatePageTranslations === 'function') {
                            setTimeout(() => window.updatePageTranslations(), 100);
                        }
                    }
                    return;
                }

                console.log('üîç Loading reports for employee_id:', currentUser.employee_id);
                // R√©cup√©rer les rapports depuis l'API
                const response = await fetch(`${API}/api/rapportemp/employee/${currentUser.employee_id}/reports`);
                console.log('üîç Reports API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Reports API error:', response.status, errorText);
                    throw new Error(`Erreur lors du chargement des rapports: ${response.status}`);
                }

                const data = await response.json();
                console.log('üîç Reports data received:', data);
                reports = data.reports || [];
                console.log('üîç Processed reports count:', reports.length);

                updateStatistics();
                displayReports();
            } catch (error) {
                console.error('Erreur lors du chargement des rapports:', error);
                document.getElementById('reportsList').innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Erreur lors du chargement des rapports</p>
                    </div>
                `;
            }
        }

// Mettre √† jour les statistiques
       // Mettre √† jour les statistiques
async function updateStatistics() {
    try {
        if (!currentUser || !currentUser.employee_id) return;

        const response = await fetch(`${API}/api/rapportemp/employee/${currentUser.employee_id}/stats`);
        if (!response.ok) return;

        const data = await response.json();
        const stats = data.stats;

        document.getElementById('totalReports').textContent = stats.total || 0;
        document.getElementById('acknowledgedReports').textContent = stats.acknowledged || 0;
        document.getElementById('pendingReports').textContent = stats.pending || 0;

        // Calcul local pour Aujourd'hui bas√© sur la liste "reports" d√©j√† charg√©e
        const todayCount = Array.isArray(reports)
            ? reports.filter(r => {
                const d = new Date(r.created_at);
                const now = new Date();
                return d.toDateString() === now.toDateString();
              }).length
            : 0;
        const todayEl = document.getElementById('todayReports');
        if (todayEl) todayEl.textContent = todayCount;
    } catch (error) {
        console.error('Erreur statistiques:', error);
    }
}

        // Fonction pour r√©cup√©rer le nom d'un responsable par son ID
async function getResponsibleName(responsibleId) {
    try {
        const response = await fetch(`${API}/api/rapportemp/responsible/${responsibleId}/name`);
        if (response.ok) {
            const data = await response.json();
            return data.name || 'Responsable inconnu';
        }
    } catch (error) {
        console.error('Erreur r√©cup√©ration nom responsable:', error);
    }
    return `Responsable (ID: ${responsibleId})`;
}

        // Afficher les rapports
        // Afficher les rapports (adapt√© √† la nouvelle structure)
// Afficher les rapports avec formatage am√©lior√©
// Afficher les rapports avec formatage am√©lior√©
function displayReports() {
  console.log('üîç displayReports called - reports array:', reports);
  console.log('üîç Total reports:', reports ? reports.length : 0);
  
  const filteredReports = getFilteredReports();
  console.log('üîç Filtered reports:', filteredReports.length);
  
  const reportsList = document.getElementById('reportsList');
  if (!reportsList) {
    console.error('‚ùå reportsList element not found!');
    return;
  }

  if (filteredReports.length === 0) {
    console.log('‚ö†Ô∏è No reports to display (filtered or empty)');
    reportsList.innerHTML = `
      <div class="text-center py-12 text-gray-500">
        <i class="fas fa-file-alt text-4xl mb-4"></i>
        <p>Aucun rapport trouv√©</p>
      </div>
    `;
    return;
  }
  
  console.log('‚úÖ Rendering', filteredReports.length, 'reports');

  reportsList.innerHTML = filteredReports.map(report => {
    const recipientDisplay = report.remarks 
      ? report.remarks.split('|')[0].trim()
      : 'Non sp√©cifi√©';

    return `
    <div class="report-card bg-white border border-gray-200 rounded-lg p-4 mb-3 cursor-pointer hover:shadow-md transition"
         onclick="viewReportDetails('${report.id}')">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <h4 class="text-base font-semibold text-gray-900">${report.title || 'Rapport'}</h4>
          <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(report.status)}">
            ${getStatusText(report.status)}
          </span>
          <div class="text-sm text-gray-600 space-y-1 mt-2">
            <p><i class="fas fa-calendar mr-2"></i>Date: ${formatDateTime(report.created_at)}</p>
            <p><i class="fas fa-user mr-2"></i>${recipientDisplay}</p>
            ${report.subject ? `<p><i class="fas fa-tag mr-2"></i>Sujet: ${report.subject}</p>` : ''}
          </div>
        </div>
        ${report.pdf_url ? `
          <a href="${report.pdf_url}" target="_blank"
             class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
             onclick="event.stopPropagation()">
            <i class="fas fa-download mr-1"></i>T√©l√©charger
          </a>
        ` : ''}
      </div>
    </div>
    `;
  }).join('');
}

// Formater la date et l'heure
function formatDateTime(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
// Nouvelle fonction pour formater l'affichage du destinataire
// Nouvelle fonction pour formater l'affichage du destinataire
function formatRecipientDisplay(remarks) {
    if (!remarks) return 'Non sp√©cifi√©';
    
    // Si les remarques contiennent le format "Destinataire: Nom (ID: ...)"
    if (remarks.includes('Destinataire:') && remarks.includes('(')) {
        // Extraire le nom du responsable depuis les remarques
        const match = remarks.match(/Destinataire: ([^(]+)/);
        if (match && match[1]) {
            return match[1].trim();
        }
    }
    
    // Fallback pour les anciens formats
    if (remarks.startsWith('Destinataire:')) {
        return remarks.replace('Destinataire:', '').split('(')[0].trim();
    }
    
    return remarks;
}
// Voir les d√©tails d'un rapport
async function viewReportDetails(reportId) {
  try {
    const res = await fetch(`${API}/rapportemp/${reportId}/acknowledgements`);
    const data = await res.json();

    // Construire le HTML
    const list = data.map(emp => `
      <li class="flex justify-between py-1">
        <span>${emp.first_name} ${emp.last_name}</span>
        ${emp.acknowledged 
          ? `<span class="text-green-600">‚úî Re√ßu le ${emp.acknowledged_at ? new Date(emp.acknowledged_at).toLocaleString() : ''}</span>` 
          : `<span class="text-red-600">‚úò Pas encore</span>`}
      </li>
    `).join('');

    // Afficher dans une modal
    document.getElementById('detailsModalContent').innerHTML = `
      <h3 class="text-lg font-semibold mb-2">Accus√©s de r√©ception</h3>
      <ul>${list}</ul>
    `;
    document.getElementById('detailsModal').classList.remove('hidden');
  } catch (err) {
    console.error(err);
    showToast("Impossible de charger les d√©tails", 'error');
  }
}

// Voir les d√©tails d'un rapport avec les accus√©s de r√©ception
async function viewReportDetails(reportId) {
    try {
        // R√©cup√©rer les d√©tails du rapport
        const response = await fetch(`${API}/api/rapportemp/${reportId}`);
        if (!response.ok) {
            throw new Error('Rapport non trouv√©');
        }

        const result = await response.json();
        const report = result.report;

        // R√©cup√©rer les accus√©s de r√©ception
        const acknowledgementsResponse = await fetch(`${API}/api/rapportemp/${reportId}/acknowledgements`);
        let acknowledgementsData = { acknowledgements: [] };
        
        if (acknowledgementsResponse.ok) {
            acknowledgementsData = await acknowledgementsResponse.json();
        }

        const acknowledgements = acknowledgementsData.acknowledgements || [];
        const acknowledgedCount = acknowledgements.filter(a => a.acknowledged).length;
        const totalRecipients = acknowledgements.length;

        // Cr√©er le contenu du modal
        const modalContent = document.getElementById('acknowledgementsContent');
        modalContent.innerHTML = `
            <div class="mb-4">
                <h4 class="font-semibold mb-2">D√©tails du rapport</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><strong>Titre:</strong> ${report.title || 'Non sp√©cifi√©'}</div>
                    <div><strong>Date:</strong> ${formatDate(report.created_at)}</div>
                    <div><strong>Statut:</strong> <span class="${getStatusClass(report.status)} px-2 py-1 rounded">${getStatusText(report.status)}</span></div>
                    <div><strong>De:</strong> ${report.first_name} ${report.last_name}</div>
                </div>
            </div>
            
            <div class="border-t pt-4">
                <h4 class="font-semibold mb-3">Accus√©s de r√©ception</h4>
                <div class="bg-gray-50 p-4 rounded">
                    ${acknowledgements.length > 0 ? `
                        <p class="text-sm mb-3"><strong>Statistique:</strong> ${acknowledgedCount} sur ${totalRecipients} destinataires ont accus√© r√©ception</p>
                        <div class="space-y-2">
                            ${acknowledgements.map(ack => `
                                <div class="flex items-center justify-between p-2 bg-white rounded border">
                                    <div>
                                        <div class="font-medium">${ack.first_name} ${ack.last_name}</div>
                                        <div class="text-xs text-gray-500">${ack.department_name || 'D√©partement non sp√©cifi√©'}</div>
                                    </div>
                                    <div class="text-right">
                                        <span class="${ack.acknowledged ? 'text-green-600' : 'text-yellow-600'} font-medium text-sm">
                                            ${ack.acknowledged ? '‚úî Re√ßu' : '‚è≥ En attente'}
                                        </span>
                                        ${ack.acknowledged_at ? `
                                            <div class="text-xs text-gray-500 mt-1">
                                                ‚úîÔ∏è Accus√© le ${formatDateTime(ack.acknowledged_at)}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-4 text-sm text-gray-700">
                            ${report.include_director ? 'Envoy√© au Directeur uniquement' : 'Aucun destinataire sp√©cifi√© pour ce rapport'}
                        </div>
                    `}
                </div>
            </div>
        `;

        // Afficher le modal
        document.getElementById('acknowledgementsModal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

    } catch (error) {
        console.error('Erreur lors du chargement des d√©tails:', error);
        showToast('Impossible de charger les d√©tails du rapport: ' + error.message, 'error');
    }
}

// Fermer le modal des accus√©s
function closeAcknowledgementsModal() {
    document.getElementById('acknowledgementsModal').classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
}

// Ajouter aux fonctions globales
window.viewReportDetails = viewReportDetails;
window.closeAcknowledgementsModal = closeAcknowledgementsModal;
// Formater la date compl√®te
function formatDateTime(dateString) {
    return new Date(dateString).toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Obtenir la classe CSS du statut
function getStatusClass(status) {
    const classes = {
        'acknowledged': 'bg-green-100 text-green-800',
        'pending': 'bg-yellow-100 text-yellow-800',
        'approved': 'bg-blue-100 text-blue-800',
        'rejected': 'bg-red-100 text-red-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

// Obtenir le texte du statut
function getStatusText(status) {
    const texts = {
        'acknowledged': 'Accus√© de r√©ception',
        'pending': 'En attente',
        'approved': 'Approuv√©',
        'rejected': 'Rejet√©'
    };
    return texts[status] || 'Inconnu';
}

// Fermer le modal des d√©tails
function closeReportDetails() {
    const modal = document.getElementById('reportDetailsModal');
    if (modal) {
        modal.remove();
        document.body.classList.remove('overflow-hidden');
    }
}

// Ajoutez cette fonction aux fonctions globales
window.viewReportDetails = viewReportDetails;
window.closeReportDetails = closeReportDetails;

        // Obtenir les rapports filtr√©s
       // Obtenir les rapports filtr√©s (corrig√© pour la nouvelle structure)
function getFilteredReports() {
    console.log('üîç getFilteredReports - input reports:', reports ? reports.length : 0);
    let filtered = [...reports];

    // Filtre par statut
    const statusFilter = document.querySelector('.filter-button[data-status].active')?.dataset.status;
    console.log('üîç Status filter:', statusFilter);
    if (statusFilter && statusFilter !== 'all') {
        filtered = filtered.filter(r => r.status === statusFilter);
        console.log('üîç After status filter:', filtered.length);
    }

    // Filtre par p√©riode
    const periodFilter = document.querySelector('.filter-button[data-period].active')?.dataset.period;
    if (periodFilter && periodFilter !== 'all') {
        const now = new Date();
        filtered = filtered.filter(r => {
            const reportDate = new Date(r.created_at);   // CORRIG√â: utiliser created_at au lieu de date
            switch (periodFilter) {
                case 'today':
                    return reportDate.toDateString() === now.toDateString();
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return reportDate >= weekAgo;
                case 'month':
                    return reportDate.getMonth() === now.getMonth() && reportDate.getFullYear() === now.getFullYear();
                default:
                    return true;
            }
        });
    }

    // Filtre par p√©riode personnalis√©e (client-side)
    const startVal = document.getElementById('customStart')?.value;
    const endVal = document.getElementById('customEnd')?.value;
    if (startVal || endVal) {
        const start = startVal ? new Date(startVal) : null;
        const end = endVal ? new Date(endVal) : null;
        if (end) {
            end.setHours(23, 59, 59, 999);
        }
        filtered = filtered.filter(r => {
            const d = new Date(r.created_at);
            if (start && d < start) return false;
            if (end && d > end) return false;
            return true;
        });
    }

    // Filtre par recherche texte
    const term = document.getElementById('textSearch')?.value?.trim().toLowerCase();
    if (term) {
        filtered = filtered.filter(r => {
            const recipientDisplay = r.remarks ? r.remarks.split('|')[0].trim() : '';
            const haystack = [
                r.title,
                r.subject,
                recipientDisplay,
                r.remarks,
                r.content,
                r.employee_name,
                r.department_name
            ]
            .filter(Boolean)
            .join(' ') 
            .toLowerCase();
            return haystack.includes(term);
        });
    }

    return filtered;
}

        // Appliquer les filtres
        function applyFilters() {
            displayReports();
        }

        // Obtenir la classe CSS du statut
       // Obtenir la classe CSS du statut
function getStatusClass(status) {
    const classes = {
        'acknowledged': 'bg-green-100 text-green-800',
        'pending': 'bg-yellow-100 text-yellow-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

// Obtenir le texte du statut
function getStatusText(status) {
    const texts = {
        'acknowledged': 'Accus√© de r√©ception',
        'pending': 'En attente'
    };
    return texts[status] || 'Inconnu';
}
        // Formater la date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }
debugSelectedRecipients();


        // G√©n√©rer un rapport
async function generateReport(e) {
  e.preventDefault();
  
  if (!currentUser || !currentUser.employee_id) {
    showToast('Utilisateur non identifi√©', 'error');
    return;
  }

  // Construire les destinataires selon le mode choisi
  const mode = (document.querySelector('input[name="recipientMode"]:checked')?.value) || 'director';
  let responsibleIds = [];
  if (mode === 'responsible') {
    if (!availableResponsibles || availableResponsibles.length === 0) {
      showToast('Aucun responsable trouv√© pour votre d√©partement', 'warning');
      return;
    }
    responsibleIds = [availableResponsibles[0].id];
  }
  const hasDirector = true; // Directeur auto-inclus (et c√¥t√© serveur)

  const reportData = {
    employee_id: currentUser.employee_id,
    title: document.getElementById('reportTitle').value,
    subject: document.getElementById('reportSubject').value,
    content: document.getElementById('reportContent').value,
    recipients: responsibleIds,
    include_director: hasDirector,
    concerned_employees: []
  };

  // Le reste du code reste inchang√©...
  try {
    const response = await fetch(`${API}/api/rapportemp/create`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(reportData)
    });

    let result;
    try {
      result = await response.json();
    } catch (_) {
      result = {};
    }

    if (!response.ok) {
      const serverMsg = result.details || result.error;
      throw new Error(serverMsg || `Erreur HTTP ${response.status}`);
    }

    if (result.success) {
      showToast('Rapport g√©n√©r√© avec succ√®s !', 'success');
      closeReportModal();
      loadReports();
      selectedRecipients = [];
      updateRecipientDisplay();
    } else {
      showToast('Erreur: ' + (result.error || 'Impossible de g√©n√©rer le rapport'), 'error');
    }
    
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration du rapport:', error);
    const message = (error && error.message) || 'Inconnue';
    showToast('Erreur lors de la g√©n√©ration du rapport: ' + message, 'error');
  }
}
// FONCTION DE DEBUG - √Ä ajouter temporairement pour v√©rifier les donn√©es
function debugSelectedRecipients() {
    console.log('üîç DEBUG - Destinataires actuellement s√©lectionn√©s:');
    console.log('selectedRecipients:', selectedRecipients);
    console.log('Responsables IDs:', selectedRecipients.filter(r => r.type === 'responsible').map(r => r.id));
    console.log('Include director:', selectedRecipients.some(r => r.type === 'director'));
}

// Aide UI: toasts simples
function showToast(msg, type = 'info') {
  const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
  const div = document.createElement('div');
  div.className = `fixed top-4 right-4 ${colors[type] || colors.info} text-white px-4 py-2 rounded shadow z-50`;
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(() => { div.remove(); }, 3500);
}

// Appeler cette fonction de debug juste avant generateReport pour v√©rifier
// debugSelectedRecipients();

        // Voir un rapport
        function viewReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (report) {
                showToast(`Ouverture du rapport: ${report.subject}`, 'info');
                // Ici, vous pourriez ouvrir un modal avec les d√©tails du rapport
                viewReportDetails(reportId);
            }
             
        }

        // Fonctions globales pour les boutons inline
        window.viewReport = viewReport;
        window.toggleRecipientSelector = toggleRecipientSelector;
window.toggleRecipientSelection = toggleRecipientSelection;
window.selectRecipientType = selectRecipientType;
window.clearAllRecipients = clearAllRecipients;
window.removeRecipient = removeRecipient;
// selectDepartmentResponsible function not needed for employee interface
// window.selectDepartmentResponsible = selectDepartmentResponsible;
    </script>
    <!-- Modal pour les d√©tails des accus√©s de r√©ception -->
<div id="acknowledgementsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold" data-translate="report.acknowledgements">Accus√©s de r√©ception</h3>
            <button onclick="closeAcknowledgementsModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="acknowledgementsContent" class="p-6 overflow-y-auto max-h-[60vh]">
            <!-- Contenu charg√© dynamiquement -->
        </div>
        <div class="p-4 border-t flex justify-end">
            <button onclick="closeAcknowledgementsModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                <span data-translate="common.close">Fermer</span>
            </button>
        </div>
    </div>
</div>
</body>
</html>
