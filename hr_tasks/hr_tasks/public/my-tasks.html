<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <title data-translate="tasks.title">Tasks - HR Operations Platform</title>
    
    <link rel="stylesheet" href="tailwind.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="../../../frontend/assets/css/rtl.css">
    <style>
    /* Toast notifications */
    .toast-container { position: fixed; top: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { display: flex; align-items: flex-start; gap: 10px; min-width: 260px; max-width: 380px; padding: 12px 14px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); background: #ffffff; animation: toast-in 200ms ease-out; }
    .toast-title { font-weight: 600; color: #0f172a; font-size: 14px; }
    .toast-body { color: #334155; font-size: 13px; margin-top: 2px; }
    .toast-success { border-color: #86efac; background: linear-gradient(0deg, #f0fdf4 0%, #ffffff 100%); }
    .toast-error { border-color: #fecaca; background: linear-gradient(0deg, #fef2f2 0%, #ffffff 100%); }
    .toast-warning { border-color: #fde68a; background: linear-gradient(0deg, #fffbeb 0%, #ffffff 100%); }
    .toast-icon { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .toast-success .toast-icon { background: #22c55e; color: #ffffff; }
    .toast-error .toast-icon { background: #ef4444; color: #ffffff; }
    .toast-warning .toast-icon { background: #f59e0b; color: #ffffff; }
    .toast-close { margin-left: auto; color: #94a3b8; cursor: pointer; border: none; background: transparent; padding: 4px; border-radius: 6px; }
    .toast-close:hover { background: rgba(15,23,42,0.06); color: #475569; }
    .toast-progress { height: 3px; background: rgba(0,0,0,0.06); border-radius: 999px; overflow: hidden; margin-top: 10px; }
    .toast-progress > span { display: block; height: 100%; background: currentColor; transform-origin: left; animation: toast-progress 3.2s linear forwards; }
    .toast-success .toast-progress > span { color: #22c55e; }
    .toast-error .toast-progress > span { color: #ef4444; }
    .toast-warning .toast-progress > span { color: #f59e0b; }
    @keyframes toast-in { from { opacity: 0; transform: translateY(-8px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes toast-out { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-8px) scale(0.98); } }
    @keyframes toast-progress { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    /* Tab styles - Modern Design */
    .tab-active { 
        border-bottom: 3px solid #3b82f6; 
        color: #3b82f6; 
        font-weight: 600;
        background: linear-gradient(to bottom, rgba(59, 130, 246, 0.05), transparent);
    }
    
    /* Modern Tab Container */
    .modern-tab-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }
    
    .modern-tab-nav {
        background: linear-gradient(to bottom, #f8fafc, #ffffff);
        border-bottom: 2px solid #e5e7eb;
        padding: 0;
    }
    
    .modern-tab-button {
        position: relative;
        padding: 16px 24px;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        border: none;
        background: transparent;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-bottom: 3px solid transparent;
    }
    
    .modern-tab-button:hover {
        color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
    }
    
    .modern-tab-button.tab-active {
        color: #3b82f6;
        font-weight: 600;
        border-bottom-color: #3b82f6;
        background: linear-gradient(to bottom, rgba(59, 130, 246, 0.08), transparent);
    }
    
    .modern-tab-button i {
        margin-right: 8px;
        font-size: 16px;
    }
    
    /* Tab Panel Content */
    .tab-panel-content {
        padding: 32px;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Enhanced Statistics Cards */
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-left: 4px solid transparent;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .stat-card.blue { border-left-color: #3b82f6; }
    .stat-card.green { border-left-color: #10b981; }
    .stat-card.yellow { border-left-color: #f59e0b; }
    .stat-card.red { border-left-color: #ef4444; }
    
    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    /* Exceptions Sub-tabs */
    .exceptions-sub-tabs {
        background: #f9fafb;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 24px;
    }
    
    .exceptions-sub-tab {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
        border: none;
        background: transparent;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .exceptions-sub-tab:hover {
        color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
    }
    
    .exceptions-sub-tab.active {
        color: #3b82f6;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-weight: 600;
    }
    
    .badge-count {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 6px;
    }
    
    /* Badge in tab button */
    .modern-tab-button .badge-count {
        margin-left: 8px;
    }
    </style>
    
</head>

<body class="bg-gray-50">
    <div id="toastRoot" class="toast-container" aria-live="polite" aria-atomic="true"></div>
    <div class="flex h-screen">
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Page Header -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900 mb-2" data-translate="tasks.my_tasks">My Tasks</h1>
                                <p class="text-gray-600 text-lg" data-translate="tasks.description">View and manage your assigned tasks and instructions</p>
                            </div>
                            <div id="taskActions" class="flex space-x-2">
                                <!-- Language Selector -->
                                <select id="languageSelector" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                                    <option value="en">English</option>
                                    <option value="fr">Fran√ßais</option>
                                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                                </select>
                                <!-- Task actions will be populated based on user role -->
                            </div>
                        </div>
                    </div>

                    <!-- Tasks Content (No Tabs) -->
                    <div>
                        <!-- Tasks Tab Panel -->
                        <div id="panel-tasks" class="tab-panel-content">
                            <!-- Task Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card blue">
                            <div class="flex items-center">
                                <div class="stat-icon bg-blue-100 text-blue-600">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium" data-translate="tasks.total_tasks">Total Tasks</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1" id="totalTasks">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card green">
                            <div class="flex items-center">
                                <div class="stat-icon bg-green-100 text-green-600">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium" data-translate="status.completed">Completed</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1" id="completedTasks">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card yellow">
                            <div class="flex items-center">
                                <div class="stat-icon bg-yellow-100 text-yellow-600">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium" data-translate="status.in_progress">In Progress</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1" id="inProgressTasks">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card red">
                            <div class="flex items-center">
                                <div class="stat-icon bg-red-100 text-red-600">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600 font-medium" data-translate="tasks.overdue">Overdue</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1" id="overdueTasks">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters and Search -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                            <div class="flex-1 max-w-md">
                                <div class="relative">
                                    <input type="text" id="searchInput" data-translate-placeholder="common.search_tasks" placeholder="Search tasks..." 
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="" data-translate="common.all_status">All Status</option>
                                    <option value="Pending" data-translate="status.pending">Pending</option>
                                    <option value="In Progress" data-translate="status.in_progress">In Progress</option>
                                    <option value="Completed" data-translate="status.completed">Completed</option>
                                    <option value="Overdue" data-translate="tasks.overdue">Overdue</option>
                                </select>
                                <select id="typeFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="" data-translate="common.all_types">All Types</option>
                                    <option value="Daily" data-translate="tasks.daily">Daily</option>
                                    <option value="Special" data-translate="tasks.special">Special</option>
                                </select>
                                <select id="priorityFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="" data-translate="common.all_priorities">All Priorities</option>
                                    <option value="High" data-translate="tasks.high">High</option>
                                    <option value="Medium" data-translate="tasks.medium">Medium</option>
                                    <option value="Low" data-translate="tasks.low">Low</option>
                                </select>
                               <select id="assignedByFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
    <option value="" data-translate="common.assigned_by_all">Assigned By (All)</option>
    <option value="Director" data-translate="common.director">Director</option>
    <option value="Others" data-translate="common.others">Others</option>
</select>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks List -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-medium text-gray-900" data-translate="tasks.title">Tasks</h3>
                                <div class="flex gap-2">
                                    <button id="tasksToggleBtn" class="px-3 py-1 text-xs rounded bg-blue-600 text-white" data-translate="tasks.title">Tasks</button>
                                    <button id="instrToggleBtn" class="px-3 py-1 text-xs rounded bg-gray-200 text-gray-800" data-translate="tasks.instructions">Instructions</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tasksList" class="divide-y divide-gray-200">
                            <!-- Tasks will be loaded here -->
                        </div>
                        
                        <!-- Loading State -->
                        <div id="loadingState" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
                            <p class="text-gray-600 mt-2">Loading tasks...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="emptyState" class="text-center py-12 hidden">
                            <i class="fas fa-tasks text-gray-400 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks found</h3>
                            <p class="text-gray-600">Tasks will appear here once assigned</p>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
            </main>
            <div id="reportsContainer" class="hidden flex-1 overflow-y-auto p-6"></div>

        </div>
    </div>

    <!-- Task Details Modal -->

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 id="modalTitle" class="text-lg font-semibold">Add Task</h3>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="taskForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                    <input type="text" id="taskTitle" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="taskDescription" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select id="taskType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Daily">Daily </option>
                            <option value="Special">Special </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="taskPriority" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                    <input type="date" id="taskDueDate" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div id="assigneeSection">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Assign To</label>
                    
                    <!-- Barre de recherche -->
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="employeeSearch" placeholder="Search employees..." 
                               class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- Liste des employ√©s avec cases √† cocher -->
                    <div class="employee-list-container" id="employeeList">
                        <!-- Les employ√©s seront charg√©s ici dynamiquement -->
                    </div>
                    
                    <!-- Employ√©s s√©lectionn√©s -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Selected Employees</label>
                        <div class="selected-employees-container" id="selectedEmployees">
                            <!-- Les employ√©s s√©lectionn√©s appara√Ætront ici -->
                            <p class="text-gray-500 text-sm p-2" id="noSelectionText">No employees selected</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2 mt-6">
                <button type="button" id="cancelBtn" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Task
                </button>
            </div>
        </form>
    </div>
</div>

  <!-- Task Details Modal -->
<div id="taskDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 id="detailsTitle" class="text-lg font-semibold">Task Details</h3>
                <button id="closeDetailsModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="taskDetailsContent">
                <!-- Task details will be populated here -->
            </div>
            
            <div class="mt-6">
                <h4 class="text-sm font-medium text-gray-900 mb-3">Comments</h4>
                <div id="taskComments" class="space-y-3 max-h-40 overflow-y-auto mb-4">
                    <!-- Comments will be loaded here -->
                </div>
                
                <div class="flex space-x-2">
                    <input type="text" id="newComment" placeholder="Add a comment..." 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="addCommentBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
<!-- Popup d'√©dition -->
<div id="editModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-4">
    <h2 class="text-lg font-semibold mb-3">Modifier votre commentaire</h2>
    <textarea id="editCommentInput" 
              class="w-full border border-gray-300 rounded-lg p-2 text-sm"
              rows="3"></textarea>
    <div class="flex justify-end space-x-3 mt-4">
      <button onclick="closeEditModal()" 
              class="px-3 py-1 text-gray-600 font-medium hover:underline">
        Annuler
      </button>
      <button id="saveEditBtn" 
              class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
        Enregistrer
      </button>
    </div>
  </div>
</div>

<!-- Exception Details Modal -->
<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900" id="modalTitle">Exception Details</h3>
                <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <div id="modalContent" class="p-6">
            <!-- Modal content will be populated here -->
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg max-w-md w-full mx-4">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div id="confirmIcon" class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center mr-4">
                    <i id="confirmIconClass" class="text-xl"></i>
                </div>
                <div>
                    <h3 id="confirmTitle" class="text-lg font-medium text-gray-900"></h3>
                    <p id="confirmMessage" class="text-sm text-gray-500"></p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeConfirmModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button id="confirmAction" class="px-4 py-2 rounded-lg text-white transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

    
    <script src="../../../frontend/assets/js/translations.js"></script>
    <script src="auth.js"></script>
    <script src="../../../frontend/components/api.js"></script>
    <!-- Socket.IO will be loaded dynamically by the fallback mechanism -->
    <!-- <script src="/socket.io/socket.io.js"></script> -->
    <script>
      // Toasts (success / error / warning) ‚Äì same API as director.html
      (function(){
        function createToast(type, title, message, duration){
          try{
            const root = document.getElementById('toastRoot'); if(!root) return;
            const el = document.createElement('div');
            const cls = type==='error' ? 'toast-error' : (type==='warning' ? 'toast-warning' : 'toast-success');
            const icon = type==='error' ? 'fa-times' : (type==='warning' ? 'fa-exclamation' : 'fa-check');
            el.className = 'toast ' + cls;
            el.setAttribute('role','status');
            el.innerHTML = `
              <div class="toast-icon"><i class="fas ${icon}"></i></div>
              <div class="min-w-0">
                <div class="toast-title">${title||''}</div>
                ${message?`<div class="toast-body">${message}</div>`:''}
                <div class="toast-progress"><span></span></div>
              </div>
              <button class="toast-close" aria-label="Close"><i class="fas fa-times"></i></button>
            `;
            root.appendChild(el);
            const closeBtn = el.querySelector('.toast-close');
            let timer = setTimeout(()=>dismiss(), Math.max(2000, duration||3200));
            function dismiss(){ try{ el.style.animation = 'toast-out 180ms ease-in forwards'; setTimeout(()=>{ el.remove(); }, 170); }catch(_){} }
            if(closeBtn){ closeBtn.addEventListener('click', ()=>{ clearTimeout(timer); dismiss(); }); }
            return el;
          }catch(_){/* noop */}
        }
        window.showToast = function(optsOrType, title, message, duration){
          if (typeof optsOrType === 'string') return createToast(optsOrType, title, message, duration);
          const o = optsOrType||{}; return createToast(o.type, o.title, o.message, o.duration);
        };
      })();

      // Bridge Utils.showNotification -> showToast to unify UI
      (function(){
        function titleFor(type){
          switch((type||'').toLowerCase()){
            case 'error': return "Erreur";
            case 'warning': return "Attention";
            default: return "Succ√®s";
          }
        }
        function typeFor(type){
          switch((type||'').toLowerCase()){
            case 'error': return 'error';
            case 'warning': return 'warning';
            case 'success': return 'success';
            default: return 'success';
          }
        }
        try{
          window.Utils = window.Utils || {};
          window.Utils.showNotification = function(message, type){
            try{ window.showToast({ type: typeFor(type), title: titleFor(type), message: message }); }catch(_){ /* fallback ignored */ }
          };
          window.Utils.formatDate = function(dateString) {
            if (!dateString) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
              const [y, m, d] = dateString.split('-').map(Number);
              const local = new Date(y, m - 1, d);
              return local.toLocaleDateString();
            }
            return new Date(dateString).toLocaleDateString();
          };
          window.Utils.formatDateTime = function(dateTimeString) {
            if (!dateTimeString) return '';
            return new Date(dateTimeString).toLocaleString();
          };
        }catch(_){/* noop */}
      })();
      // Define safe globals before main.js to prevent ReferenceError from early bindings
      (function(){
        // Define API_BASE; always prefer the task service (3020) over the static origin (5511)
        try{
          if (!window.API_BASE){
            const fromParent = (window.parent && window.parent.API_SERVICES && window.parent.API_SERVICES.hr_tasks) 
              ? window.parent.API_SERVICES.hr_tasks 
              : null;
            window.API_BASE = fromParent || 'http://localhost:3020';
          }
        }catch(_){ window.API_BASE = 'http://localhost:3020'; }
        if (typeof window.editComment !== 'function') {
          window.editComment = function(commentId, currentText) {
            if (typeof openEditModal === 'function') {
              openEditModal(commentId, currentText || '');
            }
          };
        }
        if (typeof window.deleteComment !== 'function') {
          window.deleteComment = function(commentId) {
            if (typeof window.closeEditModal === 'function') {
              // no-op fallback; main will override with real delete
            }
          };
        }
        if (typeof window.openEditModal !== 'function') {
          window.openEditModal = function(){ /* stub until main defines it */ };
        }
        // Add showToast function if not already defined
        if (typeof window.showToast !== 'function') {
          window.showToast = function(type, message) {
            const typeMap = {
              'success': 'success',
              'error': 'error',
              'warning': 'warning',
              'info': 'success'
            };
            const titleMap = {
              'success': 'Success',
              'error': 'Error',
              'warning': 'Warning',
              'info': 'Info'
            };
            try {
              if (typeof createToast === 'function') {
                createToast(typeMap[type] || 'success', titleMap[type] || 'Notification', message, 3000);
              } else if (typeof window.createToast === 'function') {
                window.createToast(typeMap[type] || 'success', titleMap[type] || 'Notification', message, 3000);
              }
            } catch (e) {
              console.error('Toast error:', e);
            }
          };
        }
      })();
    </script>
    <script src="./main.js"></script>
    <script src="./repports.js"></script>
    <script src="genererR.js"></script>

    <script>
        // Translation helper function
        function t(key, fallback = '') {
            try {
                // Check for translate function from translations.js
                if (typeof window !== 'undefined' && typeof window.translate === 'function') {
                    const translated = window.translate(key);
                    return translated && translated !== key ? translated : (fallback || key);
                }
                if (typeof window !== 'undefined' && typeof translate === 'function') {
                    const translated = translate(key);
                    return translated && translated !== key ? translated : (fallback || key);
                }
                return fallback || key;
            } catch (e) {
                console.warn('Translation error for key:', key, e);
                return fallback || key;
            }
        }
        
        // Helper to translate status
        function translateStatus(status) {
            const statusMap = {
                'Pending': 'status.pending',
                'In Progress': 'status.in_progress',
                'Completed': 'status.completed',
                'Overdue': 'tasks.overdue'
            };
            return t(statusMap[status] || '', status);
        }
        
        // Helper to translate priority
        function translatePriority(priority) {
            const priorityMap = {
                'High': 'tasks.high',
                'Medium': 'tasks.medium',
                'Low': 'tasks.low'
            };
            return t(priorityMap[priority] || '', priority);
        }
        
        // Helper to translate type
        function translateType(type) {
            const typeMap = {
                'Daily': 'tasks.daily',
                'Special': 'tasks.special',
                'Instruction': 'tasks.instructions'
            };
            return t(typeMap[type] || '', type);
        }
        
        let tasks = [];
        let employees = [];
        let currentUser = null;
        let currentTaskId = null;
        let currentEditId = null;
let currentOriginalText = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Dev mode: allow bypassing auth with URL params (e.g., ?dev=1&role=Department_Responsible&first=Dev&last=User)
            const urlParams = new URLSearchParams(window.location.search);
            const isDevMode = urlParams.get('dev') === '1';
            if (isDevMode) {
                // R√©cup√©ration compl√®te des infos depuis l'URL pour le mode dev
                let employeeIdFromUrl = urlParams.get('employee_id') || urlParams.get('user_id');
                // Sanitize: remove any invalid suffix like :1, :2, etc.
                if (employeeIdFromUrl && employeeIdFromUrl.includes(':')) {
                    employeeIdFromUrl = employeeIdFromUrl.split(':')[0];
                }
                currentUser = {
                    first_name: urlParams.get('first') || 'Dev',
                    last_name: urlParams.get('last') || 'User',
                    role: urlParams.get('role') || 'Department_Responsible',
                    // Important: fournir un id utilisable par les filtres backend
                    id: employeeIdFromUrl || null,
                    employee_id: employeeIdFromUrl || null,
                    username: urlParams.get('username') || 'dev.user'
                };
            }

            // Check authentication
            if (!authManager.isAuthenticated() && !isDevMode) {
                // Only redirect to login if not already on login page
                if (!window.location.pathname.includes("index.html")) {
                    if (window.location.pathname.includes("/pages/")) {
                        window.location.href = "../index.html";
                    } else {
                        window.location.href = "index.html";
                    }
                }
                return;
            }

            // Ensure correct role for this page
            const userRole = isDevMode ? currentUser.role : authManager.getUserRole();
            if (userRole !== 'HR_Manager' && userRole !== 'Employee' && userRole !== 'Department_Responsible') {
                Utils.showNotification('Access denied. Insufficient permissions.', 'error');
                if (!isDevMode) authManager.redirectToDashboard();
                return;
            }

            // Initialize page
            if (!isDevMode) {
                currentUser = authManager.getUser();
                // Make sure we have user data
                if (!currentUser || !currentUser.first_name) {
                    // Try to get fresh user data
                    try {
                        const userFromAuth = authManager.getUser();
                        if (userFromAuth) {
                            currentUser = userFromAuth;
                        }
                    } catch (e) {
                        console.warn('Could not get user from authManager:', e);
                    }
                }
                // Ensure role and id are set from authManager
                if (currentUser && !currentUser.role) {
                    currentUser.role = authManager.getUserRole();
                }
                // Ensure id is set (could be id, user_id, or employee_id)
                // Also check for employeeId (camelCase from auth service)
                if (currentUser) {
                    // Set employee_id from employeeId if available (auth service uses camelCase)
                    if (currentUser.employeeId && !currentUser.employee_id) {
                        currentUser.employee_id = currentUser.employeeId;
                    }
                    if (!currentUser.id) {
                        currentUser.id = currentUser.user_id || currentUser.employee_id || currentUser.employeeId || currentUser.id;
                    }
                }
                // Allow URL role override for embed/testing without requiring dev=1
                try {
                    const roleFromUrl = new URLSearchParams(window.location.search).get('role');
                    if (roleFromUrl) {
                        currentUser.role = roleFromUrl;
                    }
                } catch(_) {}
            }
            
            initializePage();
            
            // Update user name again after a short delay to ensure data is loaded
            setTimeout(() => {
                updateUserDisplayName().catch(e => console.warn('Error updating user name:', e));
            }, 100);
            
            // CORRECTION: Charger les donn√©es dans le bon ordre pour √©viter les race conditions
            initializeDataSequentially().then(() => {
                // After employees are loaded, try to get user name from employee list
                updateUserDisplayName().catch(e => console.warn('Error updating user name:', e));
            }).catch(error => {
                console.error('‚ùå Error in data initialization:', error);
            });
            
            // Initialiser les notifications depuis le localStorage
            initializeNotificationsFromStorage();
            setupEmpNotificationsUI();
            
            // D√©layer la connexion Socket.IO jusqu'√† ce que les donn√©es soient pr√™tes
            setTimeout(() => {
                setupSocketNotifications();
            }, 1000); // Attendre 1 seconde pour que les donn√©es soient charg√©es

            // Event listeners
            // Ensure Add Task button works even if dynamic setup is skipped
            const addBtn = document.getElementById('addTaskBtn');
            if (addBtn) {
                addBtn.addEventListener('click', openAddModal);
            }
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('taskForm').addEventListener('submit', handleSubmit);
            document.getElementById('closeDetailsModal').addEventListener('click', closeDetailsModal);
            document.getElementById('addCommentBtn').addEventListener('click', addComment);
            document.getElementById('searchInput').addEventListener('input', filterTasks);
            document.getElementById('statusFilter').addEventListener('change', filterTasks);
            document.getElementById('typeFilter').addEventListener('change', filterTasks);
            document.getElementById('priorityFilter').addEventListener('change', filterTasks);
            const assignedByFilter = document.getElementById('assignedByFilter');
            if (assignedByFilter) assignedByFilter.addEventListener('change', filterTasks);

            // Tab switching removed - only Tasks tab now

            // Language selector
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector) {
                const savedLang = localStorage.getItem('language') || localStorage.getItem('lang') || 'en';
                languageSelector.value = savedLang;
                
                languageSelector.addEventListener('change', function(e) {
                    const newLang = e.target.value;
                    console.log('[tasks.html] Language selector changed to:', newLang);
                    
                    // Force update immediately
                    if (typeof window !== 'undefined') {
                        window.currentLanguage = newLang;
                    }
                    if (typeof localStorage !== 'undefined') {
                        localStorage.setItem('language', newLang);
                        localStorage.setItem('lang', newLang);
                    }
                    
                    // Use window.setLanguage if available, otherwise try global setLanguage
                    const setLangFunc = window.setLanguage || (typeof setLanguage !== 'undefined' ? setLanguage : null);
                    if (setLangFunc) {
                        try {
                            setLangFunc(newLang);
                            console.log('[tasks.html] setLanguage called successfully');
                        } catch (err) {
                            console.error('[tasks.html] Error calling setLanguage:', err);
                        }
                    } else {
                        console.error('[tasks.html] setLanguage function not found! Available:', {
                            windowSetLanguage: typeof window.setLanguage,
                            globalSetLanguage: typeof setLanguage
                        });
                        // Fallback: manually update language
                        if (typeof document !== 'undefined') {
                            document.documentElement.setAttribute('dir', newLang === 'ar' ? 'rtl' : 'ltr');
                            document.documentElement.setAttribute('lang', newLang);
                            if (document.body) {
                                if (newLang === 'ar') {
                                    document.body.classList.add('rtl');
                                } else {
                                    document.body.classList.remove('rtl');
                                }
                            }
                        }
                    }
                    
                    // Force update translations multiple times
                    const updateFunc = window.updatePageTranslations || (typeof updatePageTranslations !== 'undefined' ? updatePageTranslations : null);
                    if (updateFunc) {
                        updateFunc(); // Call immediately
                        setTimeout(() => {
                            updateFunc();
                            console.log('[tasks.html] updatePageTranslations called (delayed)');
                        }, 50);
                        setTimeout(() => {
                            updateFunc();
                            console.log('[tasks.html] updatePageTranslations called (delayed 2)');
                        }, 200);
                    } else {
                        console.error('[tasks.html] updatePageTranslations not found!');
                    }
                    
                    // Reload task cards when language changes
                    setTimeout(() => {
                        if (tasks && tasks.length > 0) {
                            filterTasks();
                        }
                        // Force another translation update after tasks render
                        if (updateFunc) {
                            updateFunc();
                        }
                    }, 300);
                });
                
                // Listen for languageChanged event from translations.js
                document.addEventListener('languageChanged', function(e) {
                    console.log('Language changed event received:', e.detail);
                    setTimeout(() => {
                        if (typeof updatePageTranslations === 'function') {
                            updatePageTranslations();
                        }
                        if (tasks && tasks.length > 0) {
                            filterTasks();
                        }
                    }, 100);
                });
            }
            
            // Initialize translations - try multiple ways
            const initTranslations = () => {
                const updateFunc = window.updatePageTranslations || (typeof updatePageTranslations !== 'undefined' ? updatePageTranslations : null);
                if (updateFunc) {
                    updateFunc();
                    console.log('[tasks.html] Initial translations applied');
                } else {
                    console.warn('[tasks.html] updatePageTranslations not available');
                }
            };
            
            // Try immediately and after delays to ensure DOM is ready
            initTranslations();
            setTimeout(initTranslations, 100);
            setTimeout(initTranslations, 500);

            // View toggles wiring (header of list)
            (function(){
              const btnA = document.getElementById('tasksToggleBtn');
              const btnB = document.getElementById('instrToggleBtn');
              if (btnA && btnB) {
                const setMode = (mode) => {
                  window.__tasksViewMode = mode;
                  if (mode === 'tasks') {
                    btnA.classList.add('bg-blue-600','text-white');
                    btnB.classList.remove('bg-blue-600','text-white');
                    btnB.classList.add('bg-gray-200','text-gray-800');
                  } else {
                    btnB.classList.add('bg-blue-600','text-white');
                    btnA.classList.remove('bg-blue-600','text-white');
                    btnA.classList.add('bg-gray-200','text-gray-800');
                  }
                  renderTasks();
                  updateTaskStatistics();
                };
                btnA.addEventListener('click', () => setMode('tasks'));
                btnB.addEventListener('click', () => setMode('instructions'));
              }
            })();
        });
        
        // Notifications temps r√©el via Socket.IO (sans polling)
        window.__empNotifications = window.__empNotifications || [];
        // Protection contre les clics multiples rapides
        window.__notificationClickInProgress = false;
        // Local storage helpers to persist across refresh (no polling; socket is source of truth)
        function loadEmpNotifsFromStorage(){ 
            try{ 
                const raw=localStorage.getItem('emp_notifications'); 
                const data=raw?JSON.parse(raw):[]; 
                return Array.isArray(data)?data:[]; 
            }catch(_){ return []; } 
        }
        
        function saveEmpNotifsToStorage(list){ 
            try{ 
                localStorage.setItem('emp_notifications', JSON.stringify(Array.isArray(list)?list:[])); 
            }catch(_){ /* noop */ } 
        }
        
        // Charger les notifications depuis le localStorage au d√©marrage (seulement si Socket.IO pas encore connect√©)
        function initializeNotificationsFromStorage() {
            try {
                // Ne charger depuis le localStorage que si Socket.IO n'est pas encore connect√©
                if (window.__empSocket && window.__empSocket.connected) {
                    console.log('üîå Socket.IO already connected, skipping localStorage load');
                    return;
                }
                
                const stored = loadEmpNotifsFromStorage();
                if (stored.length > 0) {
                    window.__empNotifications = stored;
                    updateEmpNotifBadge();
                    console.log('üíæ Loaded', stored.length, 'notifications from storage (fallback)');
                    
                    // Appliquer le statut lu depuis le localStorage
                    window.__empNotifications = applyReadStatusFromStorage(window.__empNotifications);
                } else {
                    console.log('üì≠ No notifications in localStorage');
                }
            } catch(e) {
                console.error('‚ùå Error loading notifications from storage:', e);
            }
        }
        
        // Sauvegarder le statut lu des notifications (d√©sactiv√©, g√©r√© par le serveur)
        function saveNotificationReadStatus(notificationId, isRead) { /* no-op: persisted in DB */ }
        
        // Charger le statut lu des notifications
        function loadNotificationReadStatus(notificationId) {
            try {
                const readStatus = JSON.parse(localStorage.getItem('notification_read_status') || '{}');
                return readStatus[notificationId] || false;
            } catch(_) { return false; }
        }
        
        // Appliquer le statut lu depuis le localStorage (d√©sactiv√©)
        function applyReadStatusFromStorage(notifications) { return notifications; }
        function setupSocketNotifications(){
            try{
                console.log('üîå Setting up Socket.IO connection...');
                
                // √âviter les connexions multiples
                if (window.__empSocket && window.__empSocket.connected) {
                    console.log('[WS] Socket already connected, skipping setup');
                    return;
                }
                
                // Nettoyer les anciennes connexions
                if (window.__empSocket) {
                    try {
                        window.__empSocket.disconnect();
                    } catch(_) {}
                    window.__empSocket = null;
                }
                
                // ensure io is available even on file:// by loading from API_BASE
                if (typeof io === 'undefined'){
                    console.log('üì¶ Loading Socket.IO library...');
                    const s = document.createElement('script');
                    s.src = (window.API_BASE||'http://localhost:3020') + '/socket.io/socket.io.js';
                    s.async = false;
                    s.onload = () => { 
                        console.log('‚úÖ Socket.IO library loaded, retrying setup...');
                        try { setupSocketNotifications(); } catch(e){
                            console.error('‚ùå Error in socket setup retry:', e);
                        }
                    };
                    document.head.appendChild(s);
                    return;
                }
                
                console.log('üîó Creating Socket.IO connection...');
                const socket = io(window.API_BASE || undefined, {
                    transports: ['websocket', 'polling'],
                    timeout: 20000,
                    forceNew: true
                });
                
                window.__empSocket = socket;
                
                socket.on('connect', ()=>{
                    try{
                        console.log('‚úÖ [WS] Connected to server');
                        
                        // Attendre un peu pour s'assurer que getCurrentEmployeeId fonctionne
                        setTimeout(() => {
                            const url = new URLSearchParams(window.location.search);
                            const uidEmp = getCurrentEmployeeId();
                            const uidAlt = url.get('user_id');
                            
                            console.log('üë§ [WS] Resolved IDs - uidEmp:', uidEmp, 'uidAlt:', uidAlt);
                            
                            // Ne s'enregistrer que si on a un ID valide
                            const toRegister = Array.from(new Set([uidEmp, uidAlt].filter(Boolean)));
                            
                            if (toRegister.length === 0) {
                                console.warn('‚ö†Ô∏è [WS] No valid user ID found, skipping registration');
                                return;
                            }
                            
                            toRegister.forEach(id => { 
                                try{ 
                                    socket.emit('register', id); 
                                    console.log('‚úÖ [WS] Registered user:', id);
                                }catch(e){
                                    console.error('‚ùå [WS] Error registering user:', id, e);
                                } 
                            });
                            
                            // Ask server to send current notifications snapshot via socket
                            toRegister.forEach(id => { 
                                try{ 
                                    socket.emit('notifications:list', { user_id: id }); 
                                    console.log('üìã [WS] Requested notifications for user:', id);
                                }catch(e){
                                    console.error('‚ùå [WS] Error requesting notifications:', id, e);
                                } 
                            });
                        }, 500); // Attendre 500ms pour que les donn√©es soient pr√™tes
                        
                    }catch(e){
                        console.error('‚ùå [WS] Error in connect handler:', e);
                    }
                });
                
                socket.on('disconnect', ()=>{
                    console.log('[WS] Disconnected from server');
                });
                
                socket.on('notification:new', (n)=>{
                    try{
                        if (n && n.id){
                            // V√©rifier si la notification existe d√©j√† pour √©viter les doublons
                            const exists = window.__empNotifications.some(notif => notif.id === n.id);
                            if (!exists) {
                                window.__empNotifications = [n].concat(window.__empNotifications||[]);
                                saveEmpNotifsToStorage(window.__empNotifications);
                                // SUPPRIM√â: Toast automatique - on garde seulement le modal au clic
                                // Toujours mettre √† jour badge + liste ouverte
                                updateEmpNotifBadge();
                                const dd = document.getElementById('empNotifDropdown');
                                if (dd && !dd.classList.contains('hidden')) renderEmpNotificationsList(window.__empNotifications);
                            } else {
                                console.log('Notification duplicate prevented:', n.id);
                            }
                        }
                    }catch(_){/* noop */}
                });
                
                socket.on('notifications:list', (payload)=>{
                    try{
                        const list = Array.isArray(payload) ? payload : Array.isArray(payload?.notifications) ? payload.notifications : [];
                        console.log('üìã [WS] Received notifications from server:', list.length);
                        
                        // CORRECTION: Remplacer compl√®tement les notifications du serveur
                        // Le serveur est la source de v√©rit√©, pas le localStorage
                        if (list.length > 0) {
                            console.log('üîÑ [WS] Replacing notifications with server data');
                            window.__empNotifications = list;
                            saveEmpNotifsToStorage(window.__empNotifications);
                            updateEmpNotifBadge();
                            
                            const dd = document.getElementById('empNotifDropdown');
                            if (dd && !dd.classList.contains('hidden')) {
                                renderEmpNotificationsList(window.__empNotifications);
                            }
                        } else {
                            console.log('üì≠ [WS] No notifications from server, keeping current state');
                        }
                    }catch(e){
                        console.error('‚ùå [WS] Error handling notifications:list:', e);
                    }
                });
                
                // Accept instruction events as notifications for responsables
                socket.on('instruction:new', (n)=>{
                    try{
                        if (n && n.id){
                            // V√©rifier si la notification existe d√©j√† pour √©viter les doublons
                            const exists = window.__empNotifications.some(notif => notif.id === n.id);
                            if (!exists) {
                                window.__empNotifications = [n].concat(window.__empNotifications||[]);
                                saveEmpNotifsToStorage(window.__empNotifications);
                                updateEmpNotifBadge();
                                const dd = document.getElementById('empNotifDropdown');
                                if (dd && !dd.classList.contains('hidden')) renderEmpNotificationsList(window.__empNotifications);
                            }
                        }
                    }catch(_){/* noop */}
                });
            }catch(e){
                console.error('[WS] Setup error:', e);
            }
        }

        // Socket-only hydration: server should emit 'notifications:list'

        function setupEmpNotificationsUI(){
    try{
        const bell = document.getElementById('empNotifBell');
        const dd = document.getElementById('empNotifDropdown');
        const markAll = document.getElementById('empNotifMarkAll');
        const clearAll = document.getElementById('empNotifClearAll');
        
        if (bell && dd){
            bell.addEventListener('click', (e)=>{
                e.stopPropagation();
                
                // Fermer d'autres dropdowns ouverts si n√©cessaire
                const allDropdowns = document.querySelectorAll('.notification-dropdown');
                allDropdowns.forEach(dropdown => {
                    if (dropdown !== dd && !dropdown.classList.contains('hidden')) {
                        dropdown.classList.add('hidden');
                        dropdown.classList.remove('opacity-100', 'translate-y-0');
                        dropdown.classList.add('translate-y-2');
                    }
                });
                
                // Basculer l'affichage de la dropdown actuelle
                if (dd.classList.contains('hidden')) {
                    // Ouvrir la dropdown
                    dd.classList.remove('hidden');
                    // Forcer le reflow pour l'animation
                    void dd.offsetWidth;
                    setTimeout(() => {
                        dd.classList.remove('opacity-0', 'translate-y-2');
                        dd.classList.add('opacity-100', 'translate-y-0');
                    }, 10);
                    
                    renderEmpNotificationsList(window.__empNotifications||[]);
                } else {
                    // Fermer la dropdown
                    dd.classList.remove('opacity-100', 'translate-y-0');
                    dd.classList.add('translate-y-2');
                    setTimeout(() => {
                        dd.classList.add('hidden');
                    }, 200);
                }
            });
            
            document.addEventListener('click', (e)=>{
                if (!dd.contains(e.target) && e.target !== bell && !bell.contains(e.target)){ 
                    dd.classList.remove('opacity-100', 'translate-y-0');
                    dd.classList.add('translate-y-2');
                    setTimeout(() => {
                        dd.classList.add('hidden');
                    }, 200);
                }
            });
        }
        
        if (markAll){
            markAll.addEventListener('click', async ()=>{
                const uid = getCurrentEmployeeId(); 
                if (!uid) return;
                
                try{ 
                    await fetch(`${window.API_BASE||''}/notifications/mark-all-read?user_id=${encodeURIComponent(uid)}`, { 
                        method:'PUT' 
                    }); 
                } catch(_){ }
                
                window.__empNotifications = (window.__empNotifications||[]).map(n => ({ 
                    ...n, 
                    is_read: true 
                }));
                updateEmpNotifBadge();
                renderEmpNotificationsList(window.__empNotifications);
            });
        }
        
        if (clearAll){
            clearAll.addEventListener('click', async ()=>{
                const uid = getCurrentEmployeeId(); 
                if (!uid) return;
                
                try{ 
                    const response = await fetch(`${window.API_BASE||''}/notifications?user_id=${encodeURIComponent(uid)}`, { 
                        method:'DELETE' 
                    }); 
                    console.log('Clear all notifications response:', response.status);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Clear all notifications failed:', errorData);
                        alert('Erreur lors de la suppression des notifications');
                        return;
                    }
                    
                    const result = await response.json();
                    console.log('All notifications cleared successfully:', result);
                } catch(e){ 
                    console.error('Error clearing notifications:', e);
                    alert('Erreur lors de la suppression des notifications');
                }
                
                // Vider compl√®tement le localStorage des notifications seulement si la suppression a r√©ussi
                try {
                    localStorage.removeItem('emp_notifications');
                    localStorage.removeItem('notification_read_status');
                } catch(_) {}
                
                // Mettre √† jour l'interface seulement si la suppression a r√©ussi
                window.__empNotifications = [];
                updateEmpNotifBadge();
                renderEmpNotificationsList(window.__empNotifications);
            });
        }
    } catch(error){
        console.error('Error setting up notification UI:', error);
    }
}

function updateEmpNotifBadge() {
    const badge = document.getElementById('empNotifBadge');
    if (!badge) return;
    
    const cnt = (window.__empNotifications || []).filter(n => !n.is_read).length;
    if (cnt > 0) {
        badge.textContent = cnt > 99 ? '99+' : String(cnt);
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

        function renderEmpNotificationsList(list) {
    const wrap = document.getElementById('empNotifList');
    if (!wrap) return;
    
    const items = Array.isArray(list) ? list : [];
    
    if (items.length === 0) {
        wrap.innerHTML = `
            <div class="p-4 text-center text-sm text-gray-500">
                <i class="fas fa-bell text-gray-300 text-lg mb-2 block"></i>
                <span>Aucune notification</span>
            </div>
        `;
        return;
    }
    
    // G√©n√©rer le HTML
    const html = items.map(n => {
        const isUnread = !n.is_read;
        const timeAgo = formatEmpTimeAgo(n.created_at);
        
        return `
            <div class="w-full p-3 mb-2 ${isUnread ? 'bg-gray-50 border-l-2 border-indigo-200' : 'bg-white'} hover:bg-gray-50 transition-colors rounded-lg border border-gray-200 shadow-sm">
                <div class="flex items-start gap-3">
                    <div class="relative flex-shrink-0 mt-0.5">
                        <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                            <i class="fas ${empNotifTypeIcon(n.type)} text-white text-xs"></i>
                        </div>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <button class="group w-full text-left" data-open-emp-notif data-notif-id="${n.id}" data-notif-type="${n.type||''}" data-ref-type="${n.ref_type||''}" data-ref-id="${n.ref_id||''}" data-notif-title="${(n.title||'').replace(/\"/g,'&quot;')}" data-notif-body="${(n.body||'').replace(/\"/g,'&quot;')}">
                            <div class="flex justify-between items-start mb-1">
                                <div class="text-sm font-bold text-gray-900 group-hover:text-gray-700 truncate pr-2">${n.title||''}</div>
                                <span class="text-xs text-gray-400 whitespace-nowrap flex-shrink-0">${timeAgo}</span>
                            </div>
                            
                            ${n.body ? `<div class="text-xs text-gray-600 mb-1 line-clamp-2">${n.body}</div>` : ''}
                        </button>
                    </div>
                    
                    <button class="opacity-80 hover:opacity-100 text-gray-400 hover:text-gray-600 p-1 rounded self-start flex-shrink-0 transition-colors" 
                            title="Supprimer" data-del-emp-notif="${n.id}">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');

    // Remplacer le contenu en une seule fois
    wrap.innerHTML = html;
    
    // Wire open events - UNE SEULE FOIS
    Array.from(wrap.querySelectorAll('[data-open-emp-notif]')).forEach(item => {
        item.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Protection contre les clics multiples rapides
            if (window.__notificationClickInProgress) {
                console.log('Notification click already in progress, ignoring...');
                return;
            }
            window.__notificationClickInProgress = true;
            
            try {
            const id = item.getAttribute('data-notif-id');
            const refType = item.getAttribute('data-ref-type');
            const refId = item.getAttribute('data-ref-id');
            const type = item.getAttribute('data-notif-type');
            const title = item.getAttribute('data-notif-title') || '';
            const body = item.getAttribute('data-notif-body') || '';
            
                console.log('Notification clicked:', { id, refType, refId, type });
                
                // Fermer la dropdown imm√©diatement
                const dd = document.getElementById('empNotifDropdown');
                if (dd) {
                    dd.classList.add('hidden');
                    dd.classList.remove('opacity-100', 'translate-y-0');
                    dd.classList.add('opacity-0', 'translate-y-2');
                }
                
                // Marquer comme lu
            if (id) { 
                try { 
                    await fetch(`${window.API_BASE||''}/notifications/${id}/read`, { method: 'PUT' }); 
                } catch(_) { }
                
                // Sauvegarder le statut lu dans le localStorage
                saveNotificationReadStatus(id, true);
                
                window.__empNotifications = (window.__empNotifications||[]).map(x => 
                    x.id === id ? {...x, is_read: true} : x
                );
                updateEmpNotifBadge();
            }
                
                // Ouvrir les d√©tails de la t√¢che
                console.log('Debug notification data:', { refType, refId, type, title, body });
                
                if ((refType === 'task' || type === 'task_created' || type === 'comment_added') && refId) {
                    console.log('Opening task details for ID:', refId);
                    await openTaskFromNotification(refId);
                } else {
                    // Fallback pour autres types de notifications - SUPPRIM√â le toast
                    console.log('Fallback notification - no action taken');
                }
            } finally {
                // R√©initialiser le flag apr√®s un d√©lai
                setTimeout(() => {
                    window.__notificationClickInProgress = false;
                }, 1000);
            }
        });
    });
    
    // Wire delete events
    Array.from(wrap.querySelectorAll('[data-del-emp-notif]')).forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const id = btn.getAttribute('data-del-emp-notif');
            if (!id) return;
            
            try { 
                const response = await fetch(`${window.API_BASE||''}/notifications/${id}`, { method: 'DELETE' }); 
                console.log('Delete notification response:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Delete notification failed:', errorData);
                    Utils.showNotification('Erreur lors de la suppression de la notification', 'error');
                    return;
                }
                
                // Supprimer du localStorage
            try {
                const readStatus = JSON.parse(localStorage.getItem('notification_read_status') || '{}');
                delete readStatus[id];
                localStorage.setItem('notification_read_status', JSON.stringify(readStatus));
            } catch(_) {}
            
                // Mettre √† jour l'interface
            window.__empNotifications = (window.__empNotifications||[]).filter(x => x.id !== id);
            saveEmpNotifsToStorage(window.__empNotifications);
            updateEmpNotifBadge();
            renderEmpNotificationsList(window.__empNotifications);
                
                Utils.showNotification('Notification supprim√©e', 'success');
                
            } catch(e) { 
                console.error('Error deleting notification:', e);
                Utils.showNotification('Erreur lors de la suppression de la notification', 'error');
            }
        });
    });
}

function getEmpNotificationColor(type) {
    switch(type) {
        case 'task_created': return 'bg-indigo-500';
        case 'comment_added': return 'bg-green-500';
        case 'task_completed': return 'bg-emerald-500';
        case 'urgent': return 'bg-red-500';
        default: return 'bg-gray-500';
    }
}

function empNotifTypeIcon(t) {
    switch(t) {
        case 'task_created': return 'fa-clipboard-list';
        case 'comment_added': return 'fa-comment';
        case 'task_completed': return 'fa-check-circle';
        case 'urgent': return 'fa-exclamation';
        default: return 'fa-bell';
    }
}
        function formatEmpTimeAgo(d){
            try{ const now=new Date(); const dt=new Date(d); const diff=(now-dt)/1000;
                if (diff<60) return '√† l‚Äôinstant'; if (diff<3600) return `${Math.floor(diff/60)} min`; if (diff<86400) return `${Math.floor(diff/3600)} h`; return dt.toLocaleDateString('fr-FR');
            }catch(_){ return ''; }
        }
        // Fonction simplifi√©e pour ouvrir les d√©tails de t√¢che depuis une notification
        async function openTaskFromNotification(taskId) {
            try {
                console.log('openTaskFromNotification called with taskId:', taskId);
                
                        // S'assurer que les t√¢ches sont charg√©es
                        if (!tasks || tasks.length === 0) {
                            console.log('Loading tasks first...');
                            await loadTasks();
                        }
                        
                        // V√©rifier si la t√¢che existe dans le tableau
                const task = tasks.find(t => t.id == taskId);
                console.log('Task found in local array:', !!task);
                
                        if (task) {
                    console.log('Opening task details for existing task:', taskId);
                    await showTaskDetails(taskId);
                        } else {
                            console.log('Task not found in local array, fetching from server...');
                    const response = await fetch(`${window.API_BASE||''}/tasks/${taskId}`);
                            if (response.ok) {
                                const taskData = await response.json();
                                tasks.push(taskData);
                        console.log('Task fetched from server, opening details:', taskId);
                        await showTaskDetails(taskId);
                            } else {
                        throw new Error('Task not found on server');
                    }
                }
            } catch (error) {
                console.error('Error opening task details:', error);
                Utils.showNotification(`Erreur lors de l'ouverture de la t√¢che: ${error.message}`, 'error');
            }
        }
function openReports() {
  // Cacher le contenu principal
  document.querySelector("main").classList.add("hidden");

  // Afficher les rapports
  const container = document.getElementById("reportsContainer");
  container.innerHTML = createReportsHTML();
  container.classList.remove("hidden");

  // Initialiser les rapports dans ce conteneur
  initializeReports(window);
}
function closeReports() {
  // Cacher la section rapports
  document.getElementById("reportsContainer").classList.add("hidden");

  // R√©-afficher le dashboard
  document.querySelector("main").classList.remove("hidden");
}


        // Function to update user display name
        async function updateUserDisplayName() {
            const userDisplayNameEl = document.getElementById('userDisplayName');
            if (!userDisplayNameEl) return;
            
            // Helper to extract name from user object (handles both camelCase and snake_case)
            function getName(user) {
                if (!user) return null;
                
                // Try snake_case first
                let firstName = user.first_name || '';
                let lastName = user.last_name || '';
                
                // Skip if values are placeholder text (like "prenom", "nom")
                if (firstName.toLowerCase() === 'prenom' || lastName.toLowerCase() === 'nom') {
                    firstName = '';
                    lastName = '';
                }
                
                // Fallback to camelCase
                if (!firstName && !lastName) {
                    firstName = user.firstName || '';
                    lastName = user.lastName || '';
                    // Skip placeholder text in camelCase too
                    if (firstName.toLowerCase() === 'prenom' || lastName.toLowerCase() === 'nom') {
                        firstName = '';
                        lastName = '';
                    }
                }
                
                const fullName = (firstName + ' ' + lastName).trim();
                // Only return if we have a real name (not placeholder)
                return fullName && fullName !== 'prenom nom' && fullName !== 'firstName lastName' ? fullName : null;
            }
            
            // Try currentUser first
            if (currentUser) {
                const fullName = getName(currentUser);
                if (fullName) {
                    userDisplayNameEl.textContent = fullName;
                    return;
                }
            }
            
            // Final fallback: try to find user in employees list if available
            try {
                if (Array.isArray(employees) && employees.length > 0) {
                    const employeeId = getCurrentEmployeeId();
                    const userId = currentUser?.id;
                    
                    const employee = employees.find(emp => 
                        (employeeId && (emp.id === employeeId || emp.employee_id === employeeId)) ||
                        (userId && emp.user_id === userId)
                    );
                    
                    if (employee) {
                        const fullName = getName(employee);
                        if (fullName) {
                            userDisplayNameEl.textContent = fullName;
                            // Update currentUser with employee data, preserving role and id
                            if (!currentUser) currentUser = {};
                            const preservedRole = currentUser.role;
                            const preservedId = currentUser.id || currentUser.user_id || currentUser.employee_id;
                            currentUser.first_name = employee.first_name || '';
                            currentUser.last_name = employee.last_name || '';
                            // Preserve role and id
                            if (preservedRole) currentUser.role = preservedRole;
                            if (preservedId) currentUser.id = preservedId;
                            // Also set from authManager if not preserved
                            if (!currentUser.role && typeof authManager !== 'undefined') {
                                currentUser.role = authManager.getUserRole();
                            }
                            return;
                        }
                    }
                }
            } catch (e) {
                console.warn('Could not get user from employees list:', e);
            }
            
            // Try fetching from profile API (like profile page does)
            try {
                if (typeof authManager !== 'undefined' && authManager.isAuthenticated()) {
                    // Profile endpoint is on users service, not tasks service
                    // Check multiple sources for users service URL
                    let usersApiBase = null;
                    
                    // 1. Check if API_SERVICES is defined (from main.js)
                    if (typeof window !== 'undefined') {
                        if (window.API_SERVICES && window.API_SERVICES.users) {
                            usersApiBase = window.API_SERVICES.users;
                        } else if (window.parent && window.parent.API_SERVICES && window.parent.API_SERVICES.users) {
                            usersApiBase = window.parent.API_SERVICES.users;
                        }
                    }
                    
                    // 2. Fallback to default users service port
                    if (!usersApiBase) {
                        usersApiBase = 'http://localhost:3002';
                    }
                    
                    const token = authManager.getToken();
                    
                    if (token && usersApiBase) {
                        const response = await fetch(`${usersApiBase}/profile`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            const profile = await response.json();
                            const fullName = getName(profile);
                            if (fullName) {
                                userDisplayNameEl.textContent = fullName;
                                // Update currentUser with profile data, preserving role and id
                                if (!currentUser) currentUser = {};
                                const preservedRole = currentUser.role;
                                const preservedId = currentUser.id || currentUser.user_id || currentUser.employee_id;
                                currentUser.first_name = profile.first_name || '';
                                currentUser.last_name = profile.last_name || '';
                                // Preserve role and id
                                if (preservedRole) currentUser.role = preservedRole;
                                if (preservedId) currentUser.id = preservedId;
                                // Also set from authManager if not preserved
                                if (!currentUser.role && typeof authManager !== 'undefined') {
                                    currentUser.role = authManager.getUserRole();
                                }
                                if (!currentUser.id && profile.id) {
                                    currentUser.id = profile.id;
                                }
                                if (!currentUser.id && profile.user_id) {
                                    currentUser.id = profile.user_id;
                                }
                                return;
                            }
                        }
                    }
                }
            } catch (e) {
                console.warn('Could not fetch profile:', e);
            }
            
            // Fallback: try to get from authManager if available (but skip placeholders)
            try {
                if (typeof authManager !== 'undefined' && authManager.isAuthenticated()) {
                    const user = authManager.getUser();
                    if (user) {
                        const fullName = getName(user);
                        if (fullName) {
                            userDisplayNameEl.textContent = fullName;
                            // Update currentUser for future use (normalize to snake_case), preserving role and id
                            if (!currentUser) currentUser = {};
                            const preservedRole = currentUser.role;
                            const preservedId = currentUser.id || currentUser.user_id || currentUser.employee_id;
                            currentUser.first_name = user.first_name || user.firstName || '';
                            currentUser.last_name = user.last_name || user.lastName || '';
                            // Preserve role and id
                            if (preservedRole) currentUser.role = preservedRole;
                            if (preservedId) currentUser.id = preservedId;
                            // Also set from user object if available
                            if (user.role && !currentUser.role) {
                                currentUser.role = user.role;
                            }
                            if (!currentUser.role && typeof authManager !== 'undefined') {
                                currentUser.role = authManager.getUserRole();
                            }
                            if (user.id && !currentUser.id) {
                                currentUser.id = user.id;
                            }
                            if (user.user_id && !currentUser.id) {
                                currentUser.id = user.user_id;
                            }
                            return;
                        }
                    }
                }
            } catch (e) {
                console.warn('Could not get user from authManager:', e);
            }
            
            // Final fallback
            userDisplayNameEl.textContent = 'User';
        }

        function initializePage() {
            // Update user display name (async, don't wait)
            updateUserDisplayName().catch(e => console.warn('Error updating user name:', e));

            setupNavigation();
            setupTaskActions();
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const taskDueDateEl = document.getElementById('taskDueDate');
            if (taskDueDateEl) {
                taskDueDateEl.value = tomorrow.toISOString().split('T')[0];
            }
        }

        // Helper function to ensure currentUser is properly initialized with role and id
        function ensureCurrentUserInitialized() {
            if (!currentUser) {
                if (typeof authManager !== 'undefined' && authManager.isAuthenticated()) {
                    currentUser = authManager.getUser() || {};
                } else {
                    currentUser = {};
                }
            }
            
            // Ensure role is set
            if (!currentUser.role && typeof authManager !== 'undefined') {
                currentUser.role = authManager.getUserRole();
            }
            
            // Ensure id is set (could be id, user_id, or employee_id)
            if (!currentUser.id) {
                currentUser.id = currentUser.user_id || currentUser.employee_id || currentUser.id;
            }
            
            // For Department_Responsible, ensure employee_id is set
            if (currentUser.role === 'Department_Responsible' && !currentUser.employee_id) {
                const employeeId = getCurrentEmployeeId();
                if (employeeId) {
                    currentUser.employee_id = employeeId;
                    // Also set id to employee_id if not already set
                    if (!currentUser.id) {
                        currentUser.id = employeeId;
                    }
                }
            }
            
            // Debug logging (can be removed later)
            if (currentUser.role === 'Department_Responsible') {
                console.log('üîç [DEBUG] currentUser initialized:', {
                    role: currentUser.role,
                    id: currentUser.id,
                    user_id: currentUser.user_id,
                    employee_id: currentUser.employee_id,
                    first_name: currentUser.first_name,
                    getCurrentEmployeeId: getCurrentEmployeeId()
                });
            }
        }

        // NOUVELLE FONCTION: Initialisation s√©quentielle pour √©viter les race conditions
        async function initializeDataSequentially() {
            try {
                console.log('üîÑ Starting sequential data initialization...');
                
                // 1. Charger les employ√©s en premier (n√©cessaire pour getCurrentEmployeeId)
                console.log('üìã Loading employees...');
                await loadEmployees();
                console.log('‚úÖ Employees loaded:', employees.length);
                
                // 2. V√©rifier que getCurrentEmployeeId fonctionne maintenant
                const employeeId = getCurrentEmployeeId();
                console.log('üë§ Current employee ID resolved:', employeeId);
                
                // 3. Charger les t√¢ches (d√©pend des employ√©s pour le filtrage)
                console.log('üìù Loading tasks...');
                await loadTasks();
                console.log('‚úÖ Tasks loaded:', tasks.length);
                
                // 4. Afficher la notice de d√©partement (d√©pend de getCurrentEmployeeId)
                console.log('üè¢ Showing department notice...');
                await showResponsibleDepartmentNotice();
                
                console.log('üéâ Sequential initialization completed successfully');
                
            } catch (error) {
                console.error('‚ùå Error during sequential initialization:', error);
                // En cas d'erreur, essayer quand m√™me de charger les t√¢ches
                try {
                    await loadTasks();
                } catch (e) {
                    console.error('‚ùå Failed to load tasks as fallback:', e);
                }
            }
        }
        // Fonction pour afficher la liste des employ√©s avec cases √† cocher
function renderEmployeeList(employees, selectedIds = []) {
    const container = document.getElementById('employeeList');
    
    if (!employees || employees.length === 0) {
        container.innerHTML = '<p class="text-gray-500 p-2">No employees available</p>';
        return;
    }
    
    container.innerHTML = employees.map(employee => `
        <div class="employee-item flex items-center ${selectedIds.includes(employee.id) ? 'selected' : ''}">
            <input type="checkbox" value="${employee.id}" 
                   class="employee-checkbox mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                   ${selectedIds.includes(employee.id) ? 'checked' : ''}>
            <div>
                <p class="font-medium">${employee.first_name} ${employee.last_name}</p>
                <p class="text-xs text-gray-500">${employee.department || 'No department'}</p>
            </div>
        </div>
    `).join('');
    
    // Ajouter les √©couteurs d'√©v√©nements
    const checkboxes = container.querySelectorAll('.employee-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', handleEmployeeSelection);
    });
}

// G√©rer la s√©lection/d√©s√©lection d'un employ√©
function handleEmployeeSelection(event) {
    const employeeId = event.target.value;
    const isChecked = event.target.checked;
    
    if (isChecked) {
        addToSelection(employeeId);
    } else {
        removeFromSelection(employeeId);
    }
}

// Ajouter un employ√© √† la s√©lection
function addToSelection(employeeId) {
    const employee = employees.find(emp => emp.id == employeeId);
    if (!employee) return;
    
    // Cr√©er l'√©l√©ment pour l'employ√© s√©lectionn√©
    const selectedElem = document.createElement('div');
    selectedElem.className = 'selected-employee';
    selectedElem.dataset.id = employeeId;
    selectedElem.innerHTML = `
        <span>${employee.first_name} ${employee.last_name}</span>
        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeSelectedEmployee('${employeeId}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Cacher le message "no selection" s'il est visible
    document.getElementById('noSelectionText').style.display = 'none';
    
    // Ajouter √† la liste des s√©lectionn√©s
    document.getElementById('selectedEmployees').appendChild(selectedElem);
}

// Supprimer un employ√© de la s√©lection
function removeFromSelection(employeeId) {
    // Retirer de l'affichage
    const selectedElem = document.querySelector(`.selected-employee[data-id="${employeeId}"]`);
    if (selectedElem) {
        selectedElem.remove();
    }
    
    // D√©cocher la checkbox correspondante
    const checkbox = document.querySelector(`.employee-checkbox[value="${employeeId}"]`);
    if (checkbox) {
        checkbox.checked = false;
        checkbox.closest('.employee-item').classList.remove('selected');
    }
    
    // Afficher le message "no selection" si plus aucun employ√© n'est s√©lectionn√©
    const selectedCount = document.querySelectorAll('.selected-employee').length;
    if (selectedCount === 0) {
        document.getElementById('noSelectionText').style.display = 'block';
    }
}

// Fonction pour supprimer un employ√© s√©lectionn√© (appel√©e depuis le bouton)
function removeSelectedEmployee(employeeId) {
    removeFromSelection(employeeId);
}

// Filtrer la liste des employ√©s
function filterEmployeeList() {
    const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
    const employeeItems = document.querySelectorAll('.employee-item');
    
    employeeItems.forEach(item => {
        const employeeName = item.querySelector('p').textContent.toLowerCase();
        if (employeeName.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}
    // Fonction pour filtrer les options du select
function filterAssigneeOptions(searchTerm) {
    const select = document.getElementById('taskAssignee');
    const options = select.options;
    
    for (let i = 0; i < options.length; i++) {
        const option = options[i];
        if (option.value === "") continue; // Garder l'option par d√©faut
        
        const text = option.textContent.toLowerCase();
        if (text.includes(searchTerm.toLowerCase())) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    }
}

// √âcouteur d'√©v√©nement pour la recherche en temps r√©el

        function setupNavigation() {
            // Navigation removed - sidebar was removed from HTML
            // This function is kept to prevent errors but does nothing now
        }

        async function showResponsibleDepartmentNotice() {
            try {
                if (currentUser?.role !== 'Department_Responsible') return;
                const responsibleId = getCurrentEmployeeId();
                if (!responsibleId) return;
                // Use hr_tasks service (port 3020) for this endpoint, not departments service
                const apiBase = (window.parent && window.parent.API_SERVICES && window.parent.API_SERVICES.hr_tasks) 
                  ? window.parent.API_SERVICES.hr_tasks 
                  : (window.API_BASE || window.TASKS_API || 'http://localhost:3020');
                const url = `${apiBase}/responsibles/${encodeURIComponent(responsibleId)}/departments`;
                const res = (typeof authManager !== 'undefined' && authManager?.makeAuthenticatedRequest)
                    ? await authManager.makeAuthenticatedRequest(url)
                    : await fetch(url, {
                        headers: (typeof authManager !== 'undefined' && authManager?.getToken?.()) ? { 'Authorization': `Bearer ${authManager.getToken()}` } : {}
                    });
                if (!res.ok) return;
                const data = await res.json();
                const names = (data.departments || []).map(d => d.name);
                const deptText = names.length ? names.join(', ') : 'Aucun d√©partement';
                // Sidebar removed - department notice functionality disabled
                console.log(`Department notice: ${deptText}`);
            } catch (e) {
                console.warn('Failed to show department notice', e);
            }
        }

        function setupTaskActions() {
            const actions = document.getElementById('taskActions');
            const rawRole = (currentUser?.role || '').toString();
            const normalizedRole = rawRole.trim().toLowerCase().replace(/\s+/g, '_');
            const isDepartmentResponsible = (
                normalizedRole === 'department_responsible' ||
                normalizedRole === 'responsible' ||
                normalizedRole === 'responsable' ||
                normalizedRole === 'dept_responsible' ||
                normalizedRole === 'departmentresponsible'
            );

            if (isDepartmentResponsible) {
                actions.innerHTML = `
                    <button id="addTaskBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        <span data-translate="tasks.add_task">Add Task</span>
                    </button>
                `;
                document.getElementById('addTaskBtn').addEventListener('click', openAddModal);
            } else {
                const assigneeSectionEl = document.getElementById('assigneeSection');
                if (assigneeSectionEl) assigneeSectionEl.style.display = 'none';
            }
        }
    async function loadEmployees() {
    try {
        // R√©cup√©rer la liste des employ√©s, filtr√©e si responsable de d√©partement
        let list = [];
        const role = currentUser?.role;
        if (role === 'Department_Responsible') {
            const responsibleId = getCurrentEmployeeId();
            if (responsibleId) {
                const apiBase = (window.parent && window.parent.API_SERVICES && window.parent.API_SERVICES.users) 
                  ? window.parent.API_SERVICES.users 
                  : (window.API_BASE || window.TASKS_API || 'http://localhost:3020');
                const url = `${apiBase}/employees?responsible_id=${encodeURIComponent(responsibleId)}`;
                const res = (typeof authManager !== 'undefined' && authManager?.makeAuthenticatedRequest)
                    ? await authManager.makeAuthenticatedRequest(url)
                    : await fetch(url, {
                        headers: (typeof authManager !== 'undefined' && authManager?.getToken?.()) ? { 'Authorization': `Bearer ${authManager.getToken()}` } : {}
                    });
                if (res.ok) {
                    list = await res.json();
                    // IMPORTANT: ne pas fallback sur la liste compl√®te pour un responsable
                } else {
                    console.warn('Employee filter by responsible failed (HTTP), no fallback for DR');
                }
            } else {
                console.warn('No responsibleId resolved for DR; no fallback to full list');
            }
        } else {
            // Non-responsable roles ‚Üí liste compl√®te
            try {
                const APIServiceRef = window.APIService || APIService;
                if (!APIServiceRef) {
                    throw new Error('APIService is not available');
                }
                list = await APIServiceRef.getEmployees();
            } catch (_) {
                // ignore, will default to []
            }
        }
        if (Array.isArray(list) && list.length) {
            employees = list;
        } else {
            employees = []; // Aucun employ√© trouv√©
        }

        populateAssigneeOptions();
    } catch (error) {
        console.error('Error loading employees:', error);
        employees = []; // En cas d'erreur, garder la liste vide
        populateAssigneeOptions();
    }
}
async function loadTasks() {
    try {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('tasksList').innerHTML = '';

        // Ensure APIService is available
        const APIServiceRef = window.APIService || APIService;
        if (!APIServiceRef) {
            throw new Error('APIService is not available. Please ensure main.js is loaded.');
        }

        // Charger les t√¢ches ET les instructions en parall√®le
        // For Employee role, pass employee_id as query parameter to ensure backend filtering
        const employeeId = getCurrentEmployeeId();
        const tasksParams = {};
        if (currentUser?.role === 'Employee' && employeeId) {
            tasksParams.employee_id = employeeId;
            console.log('üîç [Employee] Passing employee_id to backend:', employeeId);
        }
        
         const [tasksResponse, instructionsResponse] = await Promise.all([
             APIServiceRef.getTasks(tasksParams),
             loadInstructions() // Nouvelle fonction pour charger les instructions
         ]);
        
        // Traiter les t√¢ches
        let tasksList = Array.isArray(tasksResponse) ? tasksResponse : [];
        if (!Array.isArray(tasksResponse) && tasksResponse && tasksResponse.tasks) {
            tasksList = Array.isArray(tasksResponse.tasks) ? tasksResponse.tasks : [];
        }

        // Traiter les instructions et les convertir au format t√¢che
        let instructionsList = [];
         if (instructionsResponse && instructionsResponse.success) {
             instructionsList = (instructionsResponse.instructions || [])
               .sort((a,b)=>{
                 const ad = a.due_at || a.created_at || '';
                 const bd = b.due_at || b.created_at || '';
                 return new Date(bd) - new Date(ad); // Newest first
               })
               .map(instruction => ({
                 id: instruction.id,
                 title: `Instruction: ${instruction.body.substring(0, 50)}${instruction.body.length > 50 ? '...' : ''}`,
                 description: instruction.body,
                 type: 'Instruction',
                 priority: instruction.priority ? instruction.priority.charAt(0).toUpperCase() + instruction.priority.slice(1) : 'Normal',
                 status: instruction.status === 'active' ? 'Pending' : instruction.status,
                 due_date: instruction.due_at,
                 created_at: instruction.created_at,
                 updated_at: instruction.updated_at,
                 assigned_by: instruction.created_by_employee_id,
                 assigned_by_first_name: instruction.created_by_first_name || 'Direction',
                 assigned_by_last_name: instruction.created_by_last_name || '',
                 assignees: Array.isArray(instruction.recipients) ? instruction.recipients.map(r=>({ id: r.employee_id, first_name: r.first_name, last_name: r.last_name })) : [],
                 isInstruction: true
               }));
         }

        // Combiner t√¢ches et instructions
        tasks = [...tasksList, ...instructionsList];

        // Filtrer selon le r√¥le utilisateur
        // Note: Backend should filter, but we also filter on frontend as safety
        if (currentUser?.role === 'Employee') {
            const employeeId = getCurrentEmployeeId();
            console.log('üîç [Employee Filter] Current employee ID:', employeeId);
            console.log('üîç [Employee Filter] Current user ID:', currentUser.id);
            console.log('üîç [Employee Filter] Current user employeeId:', currentUser.employeeId);
            console.log('üîç [Employee Filter] Total tasks from backend:', tasksList.length);
            
            // Log first task's assignees for debugging
            if (tasksList.length > 0) {
                console.log('üîç [Employee Filter] First task sample:', {
                    taskId: tasksList[0].id,
                    taskTitle: tasksList[0].title,
                    assignees: tasksList[0].assignees
                });
            }
            
            // Filter tasks where current employee is in assignees
            const filteredTasks = tasksList.map(task => {
                // Clean up assignees array - filter out nulls
                if (task.assignees && Array.isArray(task.assignees)) {
                    task.assignees = task.assignees.filter(a => a && a.id);
                } else if (!task.assignees) {
                    task.assignees = [];
                }
                return task;
            }).filter(task => {
                // If backend filtered correctly, all tasks should have current employee in assignees
                // But we double-check here
                if (!task.assignees || task.assignees.length === 0) {
                    return false;
                }
                
                // Check if current employee is in assignees
                const normalizeId = (id) => String(id || '').trim().toLowerCase();
                const employeeIdNorm = normalizeId(employeeId);
                const userIdNorm = normalizeId(currentUser.id);
                const userEmployeeIdNorm = normalizeId(currentUser.employeeId || currentUser.employee_id);
                
                const isAssigned = task.assignees.some(assignee => {
                    if (!assignee || !assignee.id) return false;
                    const assigneeIdNorm = normalizeId(assignee.id);
                    return assigneeIdNorm === employeeIdNorm || 
                           assigneeIdNorm === userIdNorm ||
                           assigneeIdNorm === userEmployeeIdNorm;
                });
                
                return isAssigned;
            });
            
            console.log('‚úÖ [Employee Filter] Tasks after filtering:', filteredTasks.length);

            // Pour les instructions, v√©rifier si l'employ√© est destinataire
            const filteredInstructions = instructionsList.filter(instruction => {
                // Cette v√©rification sera faite c√¥t√© serveur
                return true; // Temporairement accepter toutes les instructions
            });

            tasks = [...filteredTasks, ...filteredInstructions];
        }

        // Update translations before rendering
        if (typeof updatePageTranslations === 'function') {
            updatePageTranslations();
        }
        renderTasks();
        updateTaskStatistics();
    } catch (error) {
        console.error('Error loading tasks and instructions:', error);
        tasks = [];
        if (typeof updatePageTranslations === 'function') {
            updatePageTranslations();
        }
        renderTasks();
        updateTaskStatistics();
        Utils.showNotification('Error loading tasks and instructions: ' + error.message, 'error');
    } finally {
        document.getElementById('loadingState').style.display = 'none';
    }
}

// Nouvelle fonction pour charger les instructions pour l'employ√© courant
async function loadInstructions() {
    try {
        const employeeId = getCurrentEmployeeId();
        if (!employeeId) {
            console.warn('No employee ID available for loading instructions');
            return { success: true, instructions: [] };
        }

        const response = await fetch(`${window.API_BASE || ''}/api/instructions/employee/${employeeId}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        return await response.json();
    } catch (error) {
        console.error('Error loading instructions:', error);
        return { success: true, instructions: [] };
    }
}
   
function getEmployeeNameById(id) {
    if (!id) return 'Unassigned';
    const emp = employees.find(e => e.id === id);
    return emp ? `${emp.first_name} ${emp.last_name}` : 'Unknown';
}


 function populateAssigneeOptions() {
    // Initialiser la recherche
    document.getElementById('employeeSearch').addEventListener('input', filterEmployeeList);
    
    // Afficher la liste des employ√©s
    renderEmployeeList(employees);
}


        // Helper to get current employee UUID (assigned_by)
        let currentEmployeeIdCache = null;
        function isUuidLike(v){
          return typeof v === 'string' && /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v);
        }
        function getCurrentEmployeeId() {
          try {
            // 1. V√©rifier le cache en premier
            if (currentEmployeeIdCache && isUuidLike(currentEmployeeIdCache)) {
              console.log('‚úÖ getCurrentEmployeeId: using cached ID:', currentEmployeeIdCache);
              return currentEmployeeIdCache;
            }

            // 2. V√©rifier l'URL (priorit√© haute)
            const urlParams = new URLSearchParams(window.location.search);
            let fromUrl = urlParams.get('employee_id') || urlParams.get('user_id');
            // Sanitize: remove any invalid suffix like :1, :2, etc. that might be appended
            if (fromUrl && fromUrl.includes(':')) {
              fromUrl = fromUrl.split(':')[0];
              console.log('‚ö†Ô∏è getCurrentEmployeeId: sanitized URL ID by removing suffix:', fromUrl);
            }
            if (isUuidLike(fromUrl)) { 
              currentEmployeeIdCache = fromUrl; 
              console.log('‚úÖ getCurrentEmployeeId: using URL ID:', fromUrl);
              return currentEmployeeIdCache; 
            }

            // 3. V√©rifier currentUser (priorit√© moyenne)
            if (currentUser) {
              // Prefer employeeId (from auth service) or employee_id
              const employeeId = currentUser.employeeId || currentUser.employee_id;
              if (isUuidLike(employeeId)) { 
                currentEmployeeIdCache = employeeId; 
                console.log('‚úÖ getCurrentEmployeeId: using currentUser.employeeId/employee_id:', employeeId);
                return currentEmployeeIdCache; 
              }
              // If we have user_id but not employee_id, try to resolve it via API
              if (isUuidLike(currentUser.id) || isUuidLike(currentUser.user_id)) {
                const userId = currentUser.id || currentUser.user_id;
                console.log('‚ö†Ô∏è getCurrentEmployeeId: have user_id but not employee_id, trying to resolve:', userId);
                // Try to resolve via API (async, but we'll cache it for next time)
                // For now, cache the user_id and let backend resolve it
                currentEmployeeIdCache = userId;
                return currentEmployeeIdCache;
              }
            }

            // 4. Fallback: chercher dans la liste des employ√©s par nom (priorit√© basse)
            if (Array.isArray(employees) && employees.length && currentUser && (currentUser.first_name || currentUser.last_name)){
              const match = employees.find(e => {
                const empName = `${e.first_name||''} ${e.last_name||''}`.trim().toLowerCase();
                const userName = `${currentUser.first_name||''} ${currentUser.last_name||''}`.trim().toLowerCase();
                return empName === userName && empName !== '';
              });
              
              if (match && isUuidLike(match.id)) { 
                currentEmployeeIdCache = match.id; 
                console.log('‚úÖ getCurrentEmployeeId: using employees list match:', match.id);
                return currentEmployeeIdCache; 
              }
            }

            // 5. Si toujours pas trouv√©, essayer de r√©cup√©rer depuis l'API
            console.warn('‚ö†Ô∏è getCurrentEmployeeId: unable to resolve UUID, will retry later');
            return null;
          } catch (e) {
            console.error('‚ùå getCurrentEmployeeId error', e);
            return null;
          }
        }

        function renderTasks() {
  // Ensure currentUser is properly initialized before rendering
  ensureCurrentUserInitialized();

  const container = document.getElementById('tasksList');
  const emptyState = document.getElementById('emptyState');

  const mode = window.__tasksViewMode || 'tasks';
  const isInstr = (t) => (t.title||'').startsWith('Instruction:') || t.isInstruction === true;
  const viewTasks = Array.isArray(tasks) ? tasks.filter(t => mode==='instructions' ? isInstr(t) : !isInstr(t)) : [];

  if (!Array.isArray(viewTasks) || viewTasks.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }

  emptyState.style.display = 'none';

  console.log('üîç [DEBUG] renderTasks called:', {
    totalTasks: tasks.length,
    viewTasks: viewTasks.length,
    currentUserRole: currentUser?.role,
    currentEmployeeId: getCurrentEmployeeId(),
    mode: mode
  });

  container.innerHTML = viewTasks.map(task => {
    // Use getCurrentEmployeeId() instead of currentUser.id since task.assigned_by is an employee ID
    const currentEmployeeId = getCurrentEmployeeId();
    const isOwnedByCurrent = String(task.assigned_by) === String(currentEmployeeId || (currentUser&&currentUser.id)||'');
    const isDR = (function(r){ if(!r) return false; const n=r.toString().trim().toLowerCase().replace(/\s+/g,'_'); return n==='department_responsible'||n==='responsible'||n==='responsable'||n==='dept_responsible'||n==='departmentresponsible'; })(currentUser?.role);
    const isForeignForDR = isDR && !isOwnedByCurrent;
    const isInstruction = (task.title||'').startsWith('Instruction:') || task.isInstruction === true;
    
    // Debug logging for Department_Responsible users
    if (isDR) {
        console.log('üîç [DEBUG renderTasks] Task ownership check:', {
            taskId: task.id,
            taskTitle: task.title,
            taskAssignedBy: task.assigned_by,
            currentEmployeeId: currentEmployeeId,
            currentUserId: currentUser?.id,
            currentUserEmployeeId: currentUser?.employee_id,
            isOwnedByCurrent: isOwnedByCurrent,
            isDR: isDR,
            willShowButtons: isDR && isOwnedByCurrent
        });
    }
    
    // Pour les instructions, ne pas afficher les assign√©s
    const assigneesList = isInstruction 
      ? 'Confidentiel' 
      : (task.assignees && task.assignees.length > 0 
          ? task.assignees.map(a => `${a.first_name} ${a.last_name}`).join(', ')
          : 'Unassigned');

    // Use employee ID for matching since assignee.id is an employee ID, not a user ID
    const currentEmployeeIdForMatching = getCurrentEmployeeId();
    
    // Try multiple matching strategies
    const currentUserAssignee = task.assignees ? task.assignees.find(
      assignee => {
        // Strategy 1: Direct employee ID match
        if (currentEmployeeIdForMatching && String(assignee.id) === String(currentEmployeeIdForMatching)) {
          return true;
        }
        // Strategy 2: Name match (fallback)
        const assigneeName = `${assignee.first_name || ''} ${assignee.last_name || ''}`.trim().toLowerCase();
        const userName = `${currentUser?.first_name || ''} ${currentUser?.last_name || ''}`.trim().toLowerCase();
        if (assigneeName && userName && assigneeName === userName) {
          return true;
        }
        return false;
      }
    ) : null;

    const currentUserIsAssignee = !!currentUserAssignee;
    const isCompleted = currentUserAssignee?.status === 'Completed';
    
    // Debug: Log task assignment data to see what we're getting from backend
    console.log('üìã [Task Data]', {
      taskId: task.id,
      taskTitle: task.title,
      assigned_by: task.assigned_by,
      assigned_by_role: task.assigned_by_role,
      assigned_by_first_name: task.assigned_by_first_name,
      assigned_by_last_name: task.assigned_by_last_name,
      roleValue: typeof task.assigned_by_role,
      roleString: String(task.assigned_by_role)
    });
    
    // Debug logging for director-assigned tasks
    const isDirectorTask = isAssignedByDirector(task);
    const showDirectorBadge = isDirectorTask; // Show badge for all users when task is assigned by director

    return `
      <div class="p-6 ${isForeignForDR?'bg-indigo-50':''} ${isInstruction?'bg-yellow-50 border-l-4 border-yellow-400':''} hover:bg-gray-50 transition-colors cursor-pointer" onclick="showTaskDetails('${task.id}')">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center space-x-3 mb-2">
              <h4 class="text-lg font-semibold text-gray-900">${task.title}</h4>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}">
                ${translateStatus(task.status)}
              </span>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(task.priority)}">
                ${translatePriority(task.priority)}
              </span>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getTypeClass(task.type)}">
                ${task.type ? translateType(task.type) : (isInstruction ? t('tasks.instructions', 'Instruction') : t('tasks.title', 'Task'))}
              </span>
              ${showDirectorBadge ? `<span class="inline-flex px-2 py-1 text-[11px] font-bold rounded-full bg-purple-100 text-purple-800 border-2 border-purple-300 shadow-sm">
                <i class="fas fa-crown mr-1 text-purple-600"></i>
                ${t('tasks.assigned_by_director', 'Assigned by Director')}
              </span>` : ''}
            </div>
            
            <p class="text-gray-600 mb-3">${task.description}</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
              <div class="flex items-center">
                <i class="fas fa-calendar mr-2 text-blue-600"></i>
                ${t('tasks.due', 'Due')}: ${Utils.formatDate(task.due_date)}
              </div>
              ${!isInstruction ? `
                <div class="flex items-center">
                  <i class="fas fa-users mr-2 text-blue-600"></i>
                  ${t('tasks.assigned_to_label', 'Assigned to')}: ${assigneesList}
                </div>
              ` : ''}
              <div class="flex items-center">
                <i class="fas fa-user-tie mr-2 text-blue-600"></i>
                ${t('tasks.by', 'By')}: ${task.assigned_by_first_name || t('common.director', 'Direction')} ${task.assigned_by_last_name || ''}
                ${showDirectorBadge ? `<i class="fas fa-crown ml-1 text-purple-600" title="${t('common.director', 'Director')}"></i>` : ''}
              </div>
              <div class="flex items-center">
                <i class="fas fa-clock mr-2 text-blue-600"></i>
                ${Utils.formatDateTime(task.created_at)}
              </div>
            </div>
          </div>
          
          <div class="flex flex-col space-y-2 ml-4 items-end">
          ${!isInstruction ? `
            ${currentUserIsAssignee ? (
  isCompleted 
    ? `<div id="task-actions-${task.id}" class="flex flex-col items-center space-y-1">
         <span class="text-green-600 font-semibold text-sm">${t('tasks.completed', 'Completed')} ‚úÖ</span>
         <button onclick=\"event.stopPropagation(); openReportModal('${task.id}')\" 
                 class=\"w-9 h-9 flex items-center justify-center rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50\" 
                 title=\"${t('report.add_report', 'Add Report')}\">
           <i class=\"fas fa-file-alt\"></i>
         </button>
       </div>`
    : `<div id="task-actions-${task.id}">
         <button onclick=\"event.stopPropagation(); completeMyAssignment('${task.id}')\" 
                 class=\"w-9 h-9 flex items-center justify-center rounded-lg border border-green-600 text-green-600 hover:bg-green-50\" 
                 title=\"${t('tasks.mark_as_complete', 'Mark as Complete')}\">
           <i class=\"fas fa-check\"></i>
         </button>
       </div>`
) : ''}

            ${isDR ? (
              isOwnedByCurrent
                ? `
                  <button onclick=\"event.stopPropagation(); editTask('${task.id}')\" 
                          class=\"text-blue-600 hover:text-blue-800\" title=\"Edit\">
                    <i class=\"fas fa-edit\"></i>
                  </button>
                  <button onclick=\"event.stopPropagation(); deleteTask('${task.id}')\" 
                          class=\"text-red-600 hover:text-red-800\" title=\"Delete\">
                    <i class=\"fas fa-trash\"></i>
                  </button>
                  <button onclick=\"event.stopPropagation(); loadReports('${task.id}')\" 
                          class=\"text-purple-600 hover:text-purple-800\" title=\"Rapports\">
                    <i class=\"fas fa-file-alt\"></i>
                  </button>
                  <button onclick=\"event.stopPropagation(); showTaskDetails('${task.id}')\" 
                          class=\"px-2 py-1 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50\" title=\"Details\">Details</button>
                `
                : ''
            ) : ''}
          ` : `
            <!-- Pour les instructions, afficher uniquement un bouton de lecture -->
            <div class="flex flex-col space-y-2">
              <button onclick=\"event.stopPropagation(); showTaskDetails('${task.id}')\" 
                      class=\"px-3 py-1 text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200\" title=\"Lire l'instruction\">
                <i class=\"fas fa-eye mr-1\"></i> Lire
              </button>
              ${currentUser?.role === 'Employee' ? `
                <button onclick=\"event.stopPropagation(); acknowledgeInstruction('${task.id}')\" 
                        class=\"px-3 py-1 text-green-700 bg-green-100 rounded-lg hover:bg-green-200\" title=\"Marquer comme lu\">
                  <i class=\"fas fa-check mr-1\"></i> Lu
                </button>
              ` : ''}
            </div>
          `}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Fonction pour marquer une instruction comme lue
async function acknowledgeInstruction(instructionId) {
  try {
    const employeeId = getCurrentEmployeeId();
    if (!employeeId) {
      Utils.showNotification('Cannot identify current employee', 'error');
      return;
    }

    const response = await fetch(`${window.API_BASE || ''}/api/instructions/${instructionId}/acknowledge`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        employee_id: employeeId
      })
    });

    const result = await response.json();
    
    if (result.success) {
      Utils.showNotification('Instruction marqu√©e comme lue', 'success');
      // Optionnel: recharger les t√¢ches pour mettre √† jour l'affichage
      // loadTasks();
    } else {
      throw new Error(result.error || 'Failed to acknowledge instruction');
    }
  } catch (error) {
    console.error('Error acknowledging instruction:', error);
    Utils.showNotification('Erreur lors du marquage: ' + error.message, 'error');
  }
}
      function updateTaskStatistics() {
  // Ensure tasks is an array
  if (!Array.isArray(tasks)) {
    tasks = [];
  }
  
  const mode = window.__tasksViewMode || 'tasks';
  const isInstr = (t) => (t.title||'').startsWith('Instruction:');
  const baseTasks = tasks.filter(t => mode==='instructions' ? isInstr(t) : !isInstr(t));
  let total = 0;
  let completed = 0;
  let inProgress = 0;
  let overdue = 0;
  
  // Si l'utilisateur est un employ√©, compter selon son statut personnel
  if (currentUser?.role === 'Employee') {
    const currentEmployeeId = getCurrentEmployeeId();
    
    baseTasks.forEach(task => {
      // Trouver l'assignation de l'employ√© courant dans cette t√¢che
      const currentUserAssignee = task.assignees ? task.assignees.find(
        assignee => assignee.id == currentEmployeeId ||
          `${assignee.first_name} ${assignee.last_name}` === `${currentUser.first_name} ${currentUser.last_name}`
      ) : null;
      
      // Si l'employ√© est assign√© √† cette t√¢che
      if (currentUserAssignee) {
        total++;
        
        // Compter selon le statut personnel de l'employ√©
        if (currentUserAssignee.status === 'Completed') {
          completed++;
        } else {
          // V√©rifier si la t√¢che est en retard
          if (new Date(task.due_date) < new Date()) {
            overdue++;
          } else {
            inProgress++;
          }
        }
      }
    });
  } else {
    // Pour HR_Manager et Department_Responsible, compter par t√¢che (statut global)
    total = baseTasks.length;
    completed = baseTasks.filter(t => t.status === 'Completed').length;
    
    // Compter les t√¢ches en cours (statut global pas "Completed")
    inProgress = baseTasks.filter(t => 
      t.status === 'In Progress' || 
      (t.status === 'Pending' && new Date(t.due_date) >= new Date())
    ).length;
    
    // Compter les t√¢ches en retard (statut global pas "Completed" et date d√©pass√©e)
    overdue = baseTasks.filter(t => 
      t.status !== 'Completed' && 
      new Date(t.due_date) < new Date()
    ).length;
  }

  // Mettre √† jour l'affichage
  document.getElementById('totalTasks').textContent = total;
  document.getElementById('completedTasks').textContent = completed;
  document.getElementById('inProgressTasks').textContent = inProgress;
  document.getElementById('overdueTasks').textContent = overdue;
}

        function getStatusClass(status) {
           switch (status) {
        case 'Completed':
            return 'bg-green-100 text-green-800 border border-green-300';
                case 'In Progress':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Pending':
                    return 'bg-gray-100 text-gray-800';
                case 'Overdue':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'High':
                    return 'bg-red-100 text-red-800';
                case 'Medium':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Low':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getTypeClass(type) {
            switch (type) {
                case 'Daily':
                    return 'bg-blue-100 text-blue-800';
                case 'Special':
                    return 'bg-purple-100 text-purple-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }
       // Helper to detect tasks assigned by Director
       // Helper to detect tasks assigned by Director
       function isAssignedByDirector(task) {
    if (!task) return false;

    // Always log for debugging when checking director tasks
    const roleField = (task.assigned_by_role || '').toString().toLowerCase().trim();
    const first = (task.assigned_by_first_name || '').toLowerCase();
    const last = (task.assigned_by_last_name || '').toLowerCase();
    const full = (first + ' ' + last).trim();
    
    // Log what we're checking
    console.log('üîç [isAssignedByDirector] Checking:', {
        taskId: task.id,
        title: task.title,
        assigned_by_role: task.assigned_by_role,
        roleField: roleField,
        assigned_by_first_name: task.assigned_by_first_name,
        assigned_by_last_name: task.assigned_by_last_name,
        assigned_by: task.assigned_by,
        fullName: full
    });
    
    // 1) Check explicit role field on task (maintenant inclus dans la r√©ponse backend)
    if (roleField === 'director') {
        console.log('‚úÖ [isAssignedByDirector] Detected via assigned_by_role:', roleField);
        return true;
    }

    // 2) Fallback: check role field on task
    const taskRoleField = (task.role || '').toString().toLowerCase().trim();
    if (taskRoleField === 'director') {
        console.log('‚úÖ [isAssignedByDirector] Detected via task.role:', taskRoleField);
        return true;
    }

    // 3) Check if assigned_by is null (director tasks might not have assigned_by set)
    if (!task.assigned_by || task.assigned_by === null) {
        console.log('‚úÖ [isAssignedByDirector] Detected via null assigned_by');
        return true;
    }

    // 4) Check if assigner name contains "director" terms
    const nameMatch = /(director|directeur|direction)/i.test(full);
    if (nameMatch) {
        console.log('‚úÖ [isAssignedByDirector] Detected via name match:', full);
        return true;
    }
    
    // 5) Check if name is empty (common pattern for director tasks)
    if (!task.assigned_by_first_name && !task.assigned_by_last_name) {
        console.log('‚úÖ [isAssignedByDirector] Detected via empty name');
        return true;
    }
    
    // 6) Check if name shows "Direction" (common pattern for director tasks)
    if (full.toLowerCase().includes('direction')) {
        console.log('‚úÖ [isAssignedByDirector] Detected via "direction" in name:', full);
        return true;
    }
    
    // Only log failures if we expected it to be a director task (e.g., empty name or specific role check)
    if (!task.assigned_by_first_name && !task.assigned_by_last_name && task.assigned_by) {
        console.log('‚ùå [isAssignedByDirector] Task with empty name but NOT detected as director:', {
            taskId: task.id,
            title: task.title,
            assigned_by_role: task.assigned_by_role,
            assigned_by: task.assigned_by
        });
    }
    return false;
}

        // Fonction pour filtrer les t√¢ches (UNIFI√âE)
function filterTasks() {
    const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const typeFilter = document.getElementById('typeFilter')?.value || '';
    const priorityFilter = document.getElementById('priorityFilter')?.value || '';
    const assignedByFilter = document.getElementById('assignedByFilter') ? document.getElementById('assignedByFilter').value : '';

    const mode = window.__tasksViewMode || 'tasks';
    
    // Ensure translations are updated before rendering
    if (typeof updatePageTranslations === 'function') {
        updatePageTranslations();
    }
    const isInstr = (t) => (t.title||'').startsWith('Instruction:');
    const filteredTasks = (Array.isArray(tasks)?tasks:[]).filter(task => {
        if (mode === 'instructions' && !isInstr(task)) return false;
        if (mode === 'tasks' && isInstr(task)) return false;

        const title = (task.title||'').toLowerCase();
        const description = (task.description||'').toLowerCase();
        const type = (task.type||'').toLowerCase();
        const priority = (task.priority||'').toLowerCase();
        const status = (task.status||'').toLowerCase();
        const assignedToName = (getEmployeeNameById(task.assigned_to)||'').toLowerCase();
        const assignedByName = (getEmployeeNameById(task.assigned_by)||'').toLowerCase();

        const matchesSearch =
            title.includes(searchTerm) ||
            description.includes(searchTerm) ||
            type.includes(searchTerm) ||
            priority.includes(searchTerm) ||
            status.includes(searchTerm) ||
            assignedToName.includes(searchTerm) ||
            assignedByName.includes(searchTerm);

        const matchesStatus = !statusFilter || task.status === statusFilter;
        const matchesType = !typeFilter || task.type === typeFilter;
        const matchesPriority = !priorityFilter || task.priority === priorityFilter;

        let matchesAssignedBy = true;
        if (assignedByFilter) {
            if (assignedByFilter === 'Director') {
                matchesAssignedBy = isAssignedByDirector(task);
            } else if (assignedByFilter === 'Others') {
                matchesAssignedBy = !isAssignedByDirector(task);
            }
        }

        return matchesSearch && matchesStatus && matchesType && matchesPriority && matchesAssignedBy;
    });

    renderFilteredTasks(filteredTasks);
}

        function renderFilteredTasks(filteredTasks) {
    const container = document.getElementById('tasksList');
    const emptyState = document.getElementById('emptyState');

    // Ensure currentUser is properly initialized before rendering
    ensureCurrentUserInitialized();

    if (filteredTasks.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';
    
    container.innerHTML = filteredTasks.map(task => {
        const isInstruction = (task.title||'').startsWith('Instruction:') || task.isInstruction === true;
        // Use getCurrentEmployeeId() instead of currentUser.id since task.assigned_by is an employee ID
        const currentEmployeeId = getCurrentEmployeeId();
        const isOwnedByCurrent = String(task.assigned_by) === String(currentEmployeeId || (currentUser&&currentUser.id)||'');
        const isDR = (function(r){ if(!r) return false; const n=r.toString().trim().toLowerCase().replace(/\s+/g,'_'); return n==='department_responsible'||n==='responsible'||n==='responsable'||n==='dept_responsible'||n==='departmentresponsible'; })(currentUser?.role);
        const isForeignForDR = isDR && !isOwnedByCurrent;
        
        // Debug logging for Department_Responsible users
        if (isDR) {
            console.log('üîç [DEBUG] Task ownership check:', {
                taskId: task.id,
                taskTitle: task.title,
                taskAssignedBy: task.assigned_by,
                currentEmployeeId: currentEmployeeId,
                currentUserId: currentUser?.id,
                currentUserEmployeeId: currentUser?.employee_id,
                isOwnedByCurrent: isOwnedByCurrent,
                isDR: isDR,
                willShowButtons: isDR && isOwnedByCurrent
            });
        }
        
        // Pour les instructions, masquer les assign√©s - afficher "Confidentiel"
        const assigneesList = isInstruction 
            ? 'Confidentiel'
            : (task.assignees && task.assignees.length > 0 
                ? task.assignees.map(a => `${a.first_name} ${a.last_name}`).join(', ')
                : 'Unassigned');

        // Use employee ID for matching since assignee.id is an employee ID, not a user ID
        const currentEmployeeIdForMatching = getCurrentEmployeeId();
        
        // Try multiple matching strategies
        const currentUserAssignee = task.assignees ? task.assignees.find(
          assignee => {
            // Strategy 1: Direct employee ID match
            if (currentEmployeeIdForMatching && String(assignee.id) === String(currentEmployeeIdForMatching)) {
              return true;
            }
            // Strategy 2: Name match (fallback)
            const assigneeName = `${assignee.first_name || ''} ${assignee.last_name || ''}`.trim().toLowerCase();
            const userName = `${currentUser?.first_name || ''} ${currentUser?.last_name || ''}`.trim().toLowerCase();
            if (assigneeName && userName && assigneeName === userName) {
              return true;
            }
            return false;
          }
        ) : null;

        const currentUserIsAssignee = !!currentUserAssignee;
        const isCompleted = currentUserAssignee?.status === 'Completed';

        // Badge directeur - condition am√©lior√©e
        const isDirectorTask = isAssignedByDirector(task);
        const showDirectorBadge = isDirectorTask; // Show badge for all users when task is assigned by director

        return `
            <div class="p-6 ${isForeignForDR?'bg-indigo-50':''} ${isInstruction?'bg-yellow-50 border-l-4 border-yellow-400':''} hover:bg-gray-50 transition-colors cursor-pointer" onclick="showTaskDetails('${task.id}')">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2 flex-wrap">
                            <h4 class="text-lg font-semibold text-gray-900">${task.title}</h4>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}">
                                ${translateStatus(task.status)}
                            </span>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(task.priority)}">
                                ${translatePriority(task.priority)}
                            </span>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getTypeClass(task.type)}">
                                ${task.type ? translateType(task.type) : (isInstruction ? t('tasks.instructions', 'Instruction') : t('tasks.title', 'Task'))}
                            </span>
                            ${showDirectorBadge ? `
                                <span class="inline-flex px-2 py-1 text-[11px] font-bold rounded-full bg-purple-100 text-purple-800 border-2 border-purple-300 shadow-sm">
                                    <i class="fas fa-crown mr-1 text-purple-600"></i>
                                    ${t('tasks.assigned_by_director', 'Assigned by Director')}
                                </span>
                            ` : ''}
                        </div>
                        
                        <p class="text-gray-600 mb-3">${task.description}</p>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                            <div class="flex items-center">
                                <i class="fas fa-calendar mr-2 text-blue-600"></i>
                                ${t('tasks.due', 'Due')}: ${Utils.formatDate(task.due_date)}
                            </div>
                            ${!isInstruction ? `
                                <div class="flex items-center">
                                    <i class="fas fa-users mr-2 text-blue-600"></i>
                                    ${t('tasks.assigned_to_label', 'Assigned to')}: ${assigneesList}
                                </div>
                            ` : ''}
                            <div class="flex items-center">
                                <i class="fas fa-user-tie mr-2 text-blue-600"></i>
                                ${t('tasks.by', 'By')}: ${task.assigned_by_first_name || t('common.director', 'Direction')} ${task.assigned_by_last_name || ''}
                                ${showDirectorBadge ? `<i class="fas fa-crown ml-1 text-purple-600" title="${t('common.director', 'Director')}"></i>` : ''}
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-2 text-blue-600"></i>
                                ${Utils.formatDateTime(task.created_at)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col space-y-2 ml-4 items-end">
                        ${!isInstruction ? `
                        ${currentUserIsAssignee ? (
                            isCompleted 
                                ? '<span class="text-green-600 font-semibold text-sm">Task Completed</span>'
                                : `<div id="task-actions-${task.id}">
                                    <button onclick=\"event.stopPropagation(); completeMyAssignment('${task.id}')\" 
                                            class=\"w-9 h-9 flex items-center justify-center rounded-lg border border-green-600 text-green-600 hover:bg-green-50\" 
                                            title=\"${t('tasks.mark_as_complete', 'Mark as Complete')}\">
                                        <i class=\"fas fa-check\"></i>
                                    </button>
                                   </div>`
                        ) : ''}

                        ${isDR ? (
                          isOwnedByCurrent
                            ? `
                              <button onclick=\"event.stopPropagation(); editTask('${task.id}')\" 
                                      class=\"text-blue-600 hover:text-blue-800\" title=\"Edit\">
                                <i class=\"fas fa-edit\"></i>
                              </button>
                              <button onclick=\"event.stopPropagation(); deleteTask('${task.id}')\" 
                                      class=\"text-red-600 hover:text-red-800\" title=\"Delete\">
                                <i class=\"fas fa-trash\"></i>
                              </button>
                              <button onclick=\"event.stopPropagation(); loadReports('${task.id}')\" 
                                      class=\"text-purple-600 hover:text-purple-800\" title=\"Rapport\">
                                <i class=\"fas fa-file-alt\"></i>
                              </button>
                              <button onclick=\"event.stopPropagation(); showTaskDetails('${task.id}')\" 
                                      class=\"px-2 py-1 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50\" title=\"Details\">Details</button>
                            `
                            : ''
                        ) : ''}
                        ` : `
                        <!-- Pour les instructions, afficher uniquement des boutons de lecture -->
                        <div class="flex flex-col space-y-2">
                            <button onclick=\"event.stopPropagation(); showTaskDetails('${task.id}')\" 
                                    class=\"px-3 py-1 text-blue-700 bg-blue-100 rounded-lg hover:bg-blue-200\" title=\"Lire l'instruction\">
                                <i class=\"fas fa-eye mr-1\"></i> Lire
                            </button>
                            ${currentUser?.role === 'Employee' ? `
                                <button onclick=\"event.stopPropagation(); acknowledgeInstruction('${task.id}')\" 
                                        class=\"px-3 py-1 text-green-700 bg-green-100 rounded-lg hover:bg-green-200\" title=\"Marquer comme lu\">
                                    <i class=\"fas fa-check mr-1\"></i> Lu
                                </button>
                            ` : ''}
                        </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Am√©liorer aussi la fonction filterTasks pour inclure la recherche + Assigned By et respecter le mode
function filterTasks() {
    const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const typeFilter = document.getElementById('typeFilter')?.value || '';
    const priorityFilter = document.getElementById('priorityFilter')?.value || '';
    const assignedByFilter = document.getElementById('assignedByFilter') ? document.getElementById('assignedByFilter').value : '';

    const mode = window.__tasksViewMode || 'tasks';
    const isInstr = (t) => (t.title||'').startsWith('Instruction:');

    const filteredTasks = (Array.isArray(tasks)?tasks:[]).filter(task => {
        if (mode === 'instructions' && !isInstr(task)) return false;
        if (mode === 'tasks' && isInstr(task)) return false;

        const title = (task.title||'').toLowerCase();
        const description = (task.description||'').toLowerCase();
        const type = (task.type||'').toLowerCase();
        const priority = (task.priority||'').toLowerCase();
        const status = (task.status||'').toLowerCase();
        const assignedByName = (((task.assigned_by_first_name||'')+' '+(task.assigned_by_last_name||'')).trim()).toLowerCase();
        const assigneesNames = (task.assignees||[]).map(a => `${(a.first_name||'').toLowerCase()} ${(a.last_name||'').toLowerCase()}`).join(' ');

        const matchesSearch =
            title.includes(searchTerm) ||
            description.includes(searchTerm) ||
            type.includes(searchTerm) ||
            priority.includes(searchTerm) ||
            status.includes(searchTerm) ||
            assignedByName.includes(searchTerm) ||
            assigneesNames.includes(searchTerm);

        const matchesStatus = !statusFilter || task.status === statusFilter;
        const matchesType = !typeFilter || task.type === typeFilter;
        const matchesPriority = !priorityFilter || task.priority === priorityFilter;

        let matchesAssignedBy = true;
        if (assignedByFilter) {
            if (assignedByFilter === 'Director') {
                matchesAssignedBy = isAssignedByDirector(task);
            } else if (assignedByFilter === 'Others') {
                matchesAssignedBy = !isAssignedByDirector(task);
            }
        }

        return matchesSearch && matchesStatus && matchesType && matchesPriority && matchesAssignedBy;
    });

    renderFilteredTasks(filteredTasks);
}

        function openAddModal() {
    currentTaskId = null; // S'assurer qu'on est en mode cr√©ation
    document.getElementById('modalTitle').textContent = 'Add Task';
    document.getElementById('taskForm').reset();
    
    // Vider la s√©lection d'employ√©s
    document.getElementById('selectedEmployees').innerHTML = 
        '<p class="text-gray-500 text-sm p-2" id="noSelectionText">No employees selected</p>';
    renderEmployeeList(employees);
    
    // Set default due date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('taskDueDate').value = tomorrow.toISOString().split('T')[0];
    
    document.getElementById('taskModal').classList.remove('hidden');
    document.getElementById('taskModal').classList.add('flex');
}
function openEditModal(commentId, currentText) {
  currentEditId = commentId;
  currentOriginalText = currentText;

  const modal = document.getElementById('editModal');
  const textarea = document.getElementById('editCommentInput');

  textarea.value = currentText;
  modal.classList.remove('hidden');
}

function closeEditModal() {
  const modal = document.getElementById('editModal');
  modal.classList.add('hidden');
  currentEditId = null;
  currentOriginalText = null;
}

document.getElementById('saveEditBtn').addEventListener('click', async () => {
  const newText = document.getElementById('editCommentInput').value;

  if (!newText.trim()) {
    Utils.showNotification('Le commentaire ne peut pas √™tre vide', 'error');
    return;
  }
  if (newText.trim() === currentOriginalText.trim()) {
    closeEditModal();
    return;
  }

  try {
    const employeeId = getCurrentEmployeeId();
    if (!employeeId) {
      Utils.showNotification('Cannot identify current employee', 'error');
      return;
    }

    const response = await fetch(`http://localhost:3020/comments/${currentEditId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        comment: newText.trim(),
        employeeId: employeeId
      })
    });

    const data = await response.json();

    if (!response.ok) throw new Error(data.error || `HTTP ${response.status}`);

    if (data.success) {
      const commentElement = document.querySelector(`.comment[data-comment-id="${currentEditId}"] .comment-text`);
      if (commentElement) {
        commentElement.textContent = newText.trim();
      }
      Utils.showNotification('Commentaire modifi√© avec succ√®s', 'success');
      closeEditModal();
    } else {
      throw new Error(data.error || 'Failed to update comment');
    }
  } catch (error) {
    console.error('Error updating comment:', error);
    Utils.showNotification('Erreur lors de la modification: ' + error.message, 'error');
  }
});
       function editTask(id) {
    const task = tasks.find(t => t.id == id); // Utiliser == pour g√©rer string/number
    if (!task) {
        Utils.showNotification('Task not found', 'error');
        return;
    }

    // Stocker l'ID de la t√¢che en cours d'√©dition
    currentTaskId = id;
    
    document.getElementById('modalTitle').textContent = 'Edit Task';
    document.getElementById('taskTitle').value = task.title || '';
    document.getElementById('taskDescription').value = task.description || '';
    document.getElementById('taskType').value = task.type || 'Daily';
    document.getElementById('taskPriority').value = task.priority || 'Low';
    document.getElementById('taskDueDate').value = task.due_date || '';
    
    // Pr√©-s√©lectionner les employ√©s assign√©s
    const assignedEmployeeIds = [];
    if (task.assignees && Array.isArray(task.assignees)) {
        task.assignees.forEach(assignee => {
            if (assignee.id) {
                assignedEmployeeIds.push(assignee.id.toString());
            }
        });
    }
    
    // Afficher la liste des employ√©s avec pr√©-s√©lection
    renderEmployeeList(employees, assignedEmployeeIds);
    
    // Vider et repeupler la zone de s√©lection
    const selectedContainer = document.getElementById('selectedEmployees');
    selectedContainer.innerHTML = '<p class="text-gray-500 text-sm p-2" id="noSelectionText">No employees selected</p>';
    
    // Ajouter les employ√©s pr√©-s√©lectionn√©s √† la zone de s√©lection
    assignedEmployeeIds.forEach(id => {
        addToSelection(id);
    });
    
    document.getElementById('taskModal').classList.remove('hidden');
    document.getElementById('taskModal').classList.add('flex');
}


        function closeModal() {
    document.getElementById('taskModal').classList.add('hidden');
    document.getElementById('taskModal').classList.remove('flex');
    currentTaskId = null; // R√©initialiser l'ID
}

        function closeDetailsModal() {
            document.getElementById('taskDetailsModal').classList.add('hidden');
            document.getElementById('taskDetailsModal').classList.remove('flex');
        }
 async function updateTaskWithAssignees(taskId, formData) {
    const response = await fetch(`http://localhost:3020/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    });
    
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `HTTP ${response.status}`);
    }
    
    return await response.json();
}
        async function handleSubmit(e) {
    e.preventDefault();
    
    // R√©cup√©rer les IDs des employ√©s s√©lectionn√©s
    const selectedElements = document.querySelectorAll('.selected-employee');
    const assignedToIds = Array.from(selectedElements).map(el => el.dataset.id);
    
    if (assignedToIds.length === 0) {
        Utils.showNotification('Please select at least one employee', 'error');
        return;
    }

    const formData = {
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        type: document.getElementById('taskType').value,
        priority: document.getElementById('taskPriority').value,
        due_date: document.getElementById('taskDueDate').value,
        assigned_to: assignedToIds
    };

    try {
        if (currentTaskId) {
            // Mode √©dition
            await updateTaskWithAssignees(currentTaskId, formData);
            Utils.showNotification('Task updated successfully', 'success');
        } else {
            // Mode cr√©ation
            const assignedById = getCurrentEmployeeId();
            console.log('üîç Task creation - currentUser:', currentUser);
            console.log('üîç Task creation - assignedById from getCurrentEmployeeId():', assignedById);
            if (!assignedById) {
                Utils.showNotification('Cannot identify current employee', 'error');
                return;
            }
            formData.assigned_by = assignedById;
            console.log('üîç Task creation - sending assigned_by:', assignedById);
            
            const APIServiceRef = window.APIService || APIService;
            if (!APIServiceRef) {
                throw new Error('APIService is not available');
            }
            await APIServiceRef.createTask(formData);
            Utils.showNotification('Task created successfully', 'success');
        }
        
        closeModal();
        loadTasks();
        
    } catch (error) {
        console.error('Error saving task:', error);
        Utils.showNotification('Error saving task: ' + error.message, 'error');
    }
}
async function loadTaskComments(taskId) {
  try {
    const APIServiceRef = window.APIService || APIService;
    if (!APIServiceRef) {
        throw new Error('APIService is not available');
    }
    const response = await APIServiceRef.getTaskComments(taskId);
    return response.comments || [];
  } catch (error) {
    console.error('Error loading comments:', error);
    return [];
  }
}
async function addComment() {
  const input = document.getElementById('newComment');
  const commentText = input.value.trim();
  
  if (!commentText) return;

  try {
    const taskId = currentTaskId; // Vous devez stocker l'ID de la t√¢che courante
    const employeeId = getCurrentEmployeeId();
    
    const APIServiceRef = window.APIService || APIService;
    if (!APIServiceRef) {
        throw new Error('APIService is not available');
    }
    const response = await APIServiceRef.addComment(taskId, commentText, employeeId);
    
    if (response.success) {
      // Ajouter le commentaire √† l'affichage
      const commentsContainer = document.getElementById('taskComments');
      const comment = response.comment;
      
      commentsContainer.innerHTML = `
        <div class="bg-gray-50 rounded-lg p-3">
          <div class="flex items-center justify-between mb-1">
            <span class="text-sm font-medium text-gray-900">${comment.first_name} ${comment.last_name}</span>
            <span class="text-xs text-gray-500">${Utils.formatDateTime(comment.created_at)}</span>
          </div>
          <p class="text-sm text-gray-600">${comment.comment}</p>
        </div>
      ` + commentsContainer.innerHTML;
      
      input.value = '';
      Utils.showNotification('Comment added successfully', 'success');
    }
  } catch (error) {
    console.error('Error adding comment:', error);
    Utils.showNotification('Error adding comment: ' + error.message, 'error');
  }
}
// Modifier la fonction renderTasks pour afficher tous les assign√©s
// AJOUTER CE CODE TEMPORAIREMENT dans renderTasks() pour d√©bugger
function renderTasks() {
  // Ensure currentUser is properly initialized before rendering
  ensureCurrentUserInitialized();

  const container = document.getElementById('tasksList');
  const emptyState = document.getElementById('emptyState');

  const mode = window.__tasksViewMode || 'tasks';
  const isInstr = (t) => (t.title||'').startsWith('Instruction:') || t.isInstruction === true;
  const viewTasks = Array.isArray(tasks) ? tasks.filter(t => mode==='instructions' ? isInstr(t) : !isInstr(t)) : [];

  if (!Array.isArray(viewTasks) || viewTasks.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }

  emptyState.style.display = 'none';

  console.log('üîç [DEBUG] renderTasks (global) called:', {
    totalTasks: tasks.length,
    viewTasks: viewTasks.length,
    currentUserRole: currentUser?.role,
    currentEmployeeId: getCurrentEmployeeId(),
    mode: mode
  });

  container.innerHTML = viewTasks.map(task => {
    // Use getCurrentEmployeeId() instead of currentUser.id since task.assigned_by is an employee ID
    const currentEmployeeId = getCurrentEmployeeId();
    const isOwnedByCurrent = String(task.assigned_by) === String(currentEmployeeId || (currentUser&&currentUser.id)||'');
    const isDR = (function(r){ if(!r) return false; const n=r.toString().trim().toLowerCase().replace(/\s+/g,'_'); return n==='department_responsible'||n==='responsible'||n==='responsable'||n==='dept_responsible'||n==='departmentresponsible'; })(currentUser?.role);
    const isForeignForDR = isDR && !isOwnedByCurrent;
    const isInstruction = (task.title||'').startsWith('Instruction:') || task.isInstruction === true;
    
    // Debug logging for Department_Responsible users
    if (isDR) {
        console.log('üîç [DEBUG renderTasks global] Task ownership check:', {
            taskId: task.id,
            taskTitle: task.title,
            taskAssignedBy: task.assigned_by,
            currentEmployeeId: currentEmployeeId,
            currentUserId: currentUser?.id,
            currentUserEmployeeId: currentUser?.employee_id,
            isOwnedByCurrent: isOwnedByCurrent,
            isDR: isDR,
            willShowButtons: isDR && isOwnedByCurrent
        });
    }
    
    // Pour les instructions, ne pas afficher les assign√©s
    const assigneesList = isInstruction 
      ? 'Confidentiel' 
      : (task.assignees && task.assignees.length > 0 
          ? task.assignees.map(a => `${a.first_name} ${a.last_name}`).join(', ')
          : 'Unassigned');

    // Use employee ID for matching since assignee.id is an employee ID, not a user ID
    const currentEmployeeIdForMatching = getCurrentEmployeeId();
    
    // Try multiple matching strategies
    const currentUserAssignee = task.assignees ? task.assignees.find(
      assignee => {
        // Strategy 1: Direct employee ID match
        if (currentEmployeeIdForMatching && String(assignee.id) === String(currentEmployeeIdForMatching)) {
          return true;
        }
        // Strategy 2: Name match (fallback)
        const assigneeName = `${assignee.first_name || ''} ${assignee.last_name || ''}`.trim().toLowerCase();
        const userName = `${currentUser?.first_name || ''} ${currentUser?.last_name || ''}`.trim().toLowerCase();
        if (assigneeName && userName && assigneeName === userName) {
          return true;
        }
        return false;
      }
    ) : null;

    const currentUserIsAssignee = !!currentUserAssignee;
    const isCompleted = currentUserAssignee?.status === 'Completed';

    // Debug: Log task assignment data to see what we're getting from backend
    console.log('üìã [Task Data - Global Render]', {
      taskId: task.id,
      taskTitle: task.title,
      assigned_by: task.assigned_by,
      assigned_by_role: task.assigned_by_role,
      assigned_by_first_name: task.assigned_by_first_name,
      assigned_by_last_name: task.assigned_by_last_name,
      roleValue: typeof task.assigned_by_role,
      roleString: String(task.assigned_by_role)
    });
    
    // Badge directeur - condition am√©lior√©e
    const isDirectorTask = isAssignedByDirector(task);
    const showDirectorBadge = isDirectorTask; // Show badge for all users when task is assigned by director

    return `
      <div class="p-6 ${isForeignForDR?'bg-indigo-50':''} ${isInstruction?'bg-yellow-50 border-l-4 border-yellow-400':''} hover:bg-gray-50 transition-colors cursor-pointer" onclick="showTaskDetails('${task.id}')">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center space-x-3 mb-2 flex-wrap">
              <h4 class="text-lg font-semibold text-gray-900">${task.title}</h4>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}">
                ${task.status}
              </span>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(task.priority)}">
                ${task.priority}
              </span>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getTypeClass(task.type)}">
                ${task.type || (isInstruction ? 'Instruction' : 'Task')}
              </span>
              ${showDirectorBadge ? `
                <span class="inline-flex px-2 py-1 text-[11px] font-bold rounded-full bg-purple-100 text-purple-800 border-2 border-purple-300 shadow-sm">
                 
                  Assign√©e par Directeur
                </span>
              ` : ''}
            </div>
            
            <p class="text-gray-600 mb-3">${task.description}</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
              <div class="flex items-center">
                <i class="fas fa-calendar mr-2 text-blue-600"></i>
                Due: ${Utils.formatDate(task.due_date)}
              </div>
              ${!isInstruction ? `
                <div class="flex items-center">
                  <i class="fas fa-users mr-2 text-blue-600"></i>
                  Assigned to: ${assigneesList}
                </div>
              ` : ''}
              <div class="flex items-center">
                <i class="fas fa-user-tie mr-2 text-blue-600"></i>
                By: ${task.assigned_by_first_name || 'Direction'} ${task.assigned_by_last_name || ''}
                ${showDirectorBadge ? '<i class="fas fa-crown ml-1 text-purple-600" title="Directeur"></i>' : ''}
              </div>
              <div class="flex items-center">
                <i class="fas fa-clock mr-2 text-blue-600"></i>
                ${Utils.formatDateTime(task.created_at)}
              </div>
            </div>
          </div>
          
          <div class="flex flex-col space-y-2 ml-4 items-end">
          ${!isInstruction ? `
            ${currentUserIsAssignee ? (
  isCompleted 
    ? `<div id="task-actions-${task.id}" class="flex flex-col items-center space-y-1">
         <span class="text-green-600 font-semibold text-sm">${t('tasks.completed', 'Completed')} ‚úÖ</span>
         <button onclick=\"event.stopPropagation(); openReportModal('${task.id}')\" 
                 class=\"w-9 h-9 flex items-center justify-center rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50\" 
                 title=\"${t('report.add_report', 'Add Report')}\">
           <i class=\"fas fa-file-alt\"></i>
         </button>
       </div>`
    : `<div id="task-actions-${task.id}">
         <button onclick=\"event.stopPropagation(); completeMyAssignment('${task.id}')\" 
                 class=\"w-9 h-9 flex items-center justify-center rounded-lg border border-green-600 text-green-600 hover:bg-green-50\" 
                 title=\"${t('tasks.mark_as_complete', 'Mark as Complete')}\">
           <i class=\"fas fa-check\"></i>
         </button>
       </div>`
) : ''}

            ${isDR ? (
              isOwnedByCurrent
                ? `
                  <button onclick=\"event.stopPropagation(); editTask('${task.id}')\" 
                          class=\"text-blue-600 hover:text-blue-800\" title=\"Edit\">
                    <i class=\"fas fa-edit\"></i>
                  </button>
                  <button onclick=\"event.stopPropagation(); deleteTask('${task.id}')\" 
                          class=\"text-red-600 hover:text-red-800\" title=\"Delete\">
                    <i class=\"fas fa-trash\"></i>
                  </button>
                  <button onclick=\"event.stopPropagation(); loadReports('${task.id}')\" 
                          class=\"text-purple-600 hover:text-purple-800\" title=\"Rapports\">
                    <i class=\"fas fa-file-alt\"></i>
                  </button>
                  <button onclick=\"event.stopPropagation(); showTaskDetails('${task.id}')\" 
                          class=\"px-2 py-1 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50\" title=\"Details\">Details</button>
                `
                : ''
            ) : ''}
          ` : `
            <!-- Pour les instructions, afficher uniquement un bouton de lecture -->
           
          `}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Note: getCurrentEmployeeId is defined earlier with URL param + user fallbacks

// NOUVEAU CODE
async function completeMyAssignment(taskId) {
  try {
    const employeeId = getCurrentEmployeeId();
    if (!employeeId) {
      Utils.showNotification('Cannot identify current employee', 'error');
      return;
    }

    const buttonContainer = document.getElementById(`task-actions-${taskId}`);
    if (buttonContainer) {
      buttonContainer.innerHTML = `
        <span class="text-yellow-600 text-sm">Processing...</span>
      `;
    }

    // 1. Update backend
    await updateAssigneeStatus(taskId, employeeId, 'Completed');

    // 2. Update local state
    const task = tasks.find(t => t.id == taskId);
    if (task && task.assignees) {
      const assignee = task.assignees.find(a => a.id == employeeId);
      if (assignee) {
        assignee.status = 'Completed';
        assignee.completed_at = new Date().toISOString();

        // ‚úÖ Afficher Completed + Ajouter un rapport (pas de bouton Complete)
        if (buttonContainer) {
          buttonContainer.innerHTML = `
            <div class="flex flex-col items-center space-y-1">
              <span class="text-green-600 font-semibold text-sm">Completed ‚úÖ</span>
              <button onclick="event.stopPropagation(); openReportModal('${taskId}')" 
                      class="w-9 h-9 flex items-center justify-center rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50" 
                      title="Ajouter un rapport">
                <i class="fas fa-file-alt"></i>
              </button>
            </div>
          `;
        }
      }

      // V√©rifier si toutes les affectations sont finies
      const allCompleted = task.assignees.every(a => a.status === 'Completed');
      if (allCompleted) {
        task.status = 'Completed';
        task.completed_at = new Date().toISOString();
      }
    }

    updateTaskStatistics();
    Utils.showNotification('Task marked as completed!', 'success');

  } catch (error) {
    console.error('Error completing assignment:', error);

    const buttonContainer = document.getElementById(`task-actions-${taskId}`);
    if (buttonContainer) {
      // En cas d'erreur ‚Üí remettre le bouton Complete
      buttonContainer.innerHTML = `
        <button onclick="event.stopPropagation(); completeMyAssignment('${taskId}')" 
                class="w-9 h-9 flex items-center justify-center rounded-lg border border-green-600 text-green-600 hover:bg-green-50" 
                title="Mark as Complete">
          <i class="fas fa-check"></i>
        </button>
      `;
    }

    Utils.showNotification('Error completing task: ' + (error.message || 'Unknown error'), 'error');
  }
}


        async function updateTaskStatus(id, status) {
    try {
        const task = tasks.find(t => t.id === id);
        if (task) {
            task.status = status;
            if (status === 'Completed') {
                task.completed_at = new Date().toISOString();
                
                // Afficher un message de confirmation
                Utils.showNotification('Task marked as completed!', 'success');
                
                // Recharger les t√¢ches pour mettre √† jour l'affichage
                setTimeout(() => {
                    loadTasks();
                }, 1000);
            }
            renderTasks();
            updateTaskStatistics();
        }
    } catch (error) {
        console.error('Error updating task:', error);
        Utils.showNotification('Error updating task: ' + error.message, 'error');
    }
}

       async function deleteTask(id) {
    if (!confirm('Are you sure you want to delete this task?')) return;

    try {
        const response = await fetch(`http://localhost:3020/tasks/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        Utils.showNotification('Task deleted successfully', 'success');
        loadTasks(); // Recharger la liste
        
    } catch (error) {
        console.error('Error deleting task:', error);
        Utils.showNotification('Error deleting task: ' + error.message, 'error');
    }
}

      // NOUVEAU CODE CORRIG√â
async function updateAssigneeStatus(taskId, employeeId, status) {
  try {
    const apiUrl = 'http://localhost:3020';
    
    console.log('üì§ Sending request to backend...');
    
    const response = await fetch(`${apiUrl}/tasks/${taskId}/assignees/${employeeId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ status })
    });

    const responseData = await response.json();
    
    if (!response.ok) {
      throw new Error(responseData.error || `HTTP ${response.status}`);
    }

    console.log('‚úÖ Backend response:', responseData);
    
    // Supprimer cette ligne pour √©viter la double notification
    // Utils.showNotification('‚úÖ Task status updated on server!', 'success');
    
    return responseData;

  } catch (error) {
    console.error('‚ùå Error updating status:', error);
    throw error; // Relancer l'erreur pour que completeMyAssignment puisse la g√©rer
  }
}

// Ajoutez async devant la fonction
// Remplacez votre fonction showTaskDetails existante par cette version corrig√©e :

async function showTaskDetails(id) {
  const task = tasks.find(t => t.id == id);
  if (!task) return;
  
  // Stocker l'ID pour les commentaires
  currentTaskId = id;
  
  document.getElementById('detailsTitle').textContent = task.title;
  
  const assigneesHtml = task.assignees && task.assignees.length > 0 
    ? task.assignees.map(assignee => {
        const isCurrentUser = assignee.id === currentUser.id;
        return `
          <div class="flex items-center justify-between py-2 border-b">
            <div>
              <p class="font-medium">${assignee.first_name} ${assignee.last_name}</p>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(assignee.status)}">
                ${assignee.status}
              </span>
              ${assignee.completed_at ? `
                <p class="text-xs text-gray-500 mt-1">
                  Completed: ${Utils.formatDateTime(assignee.completed_at)}
                </p>
              ` : ''}
            </div>
            ${isCurrentUser && assignee.status !== 'Completed' ? `
              <button onclick="completeMyAssignment('${task.id}')" 
                      class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">
                Mark as Complete
              </button>
            ` : ''}
          </div>
        `;
      }).join('')
    : '<p class="text-gray-500">No assignees</p>';

  const content = document.getElementById('taskDetailsContent');
  content.innerHTML = `
    <div class="space-y-4">
      <div>
        <h4 class="text-sm font-medium text-gray-900">Description</h4>
        <p class="text-gray-600">${task.description}</p>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <h4 class="text-sm font-medium text-gray-900">Task Status</h4>
          <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}">
            ${task.status}
          </span>
        </div>
        <div>
          <h4 class="text-sm font-medium text-gray-900">Priority</h4>
          <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityClass(task.priority)}">
            ${task.priority}
          </span>
        </div>
        <div>
          <h4 class="text-sm font-medium text-gray-900">Type</h4>
          <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getTypeClass(task.type)}">
            ${task.type}
          </span>
        </div>
        <div>
          <h4 class="text-sm font-medium text-gray-900">Due Date</h4>
          <p class="text-gray-600">${Utils.formatDate(task.due_date)}</p>
        </div>
        <div>
          <h4 class="text-sm font-medium text-gray-900">Assigned By</h4>
          <p class="text-gray-600">${task.assigned_by_first_name} ${task.assigned_by_last_name}</p>
        </div>
        ${task.completed_at ? `
          <div>
            <h4 class="text-sm font-medium text-gray-900">Completed At</h4>
            <p class="text-gray-600">${Utils.formatDateTime(task.completed_at)}</p>
          </div>
        ` : ''}
      </div>
      
      <div>
        <h4 class="text-sm font-medium text-gray-900 mb-2">Assignees</h4>
        <div class="bg-gray-50 rounded-lg p-3">
          ${assigneesHtml}
        </div>
      </div>
    </div>
  `;

  // Charger les commentaires
  await loadAndDisplayTaskComments(id);

  document.getElementById('taskDetailsModal').classList.remove('hidden');
  document.getElementById('taskDetailsModal').classList.add('flex');
}
async function editComment(commentId, currentText) {
  // √âchapper les guillemets simples pour √©viter les erreurs
  const escapedText = currentText.replace(/'/g, "\\'").replace(/"/g, '\\"');
  const newText = prompt('Modifier votre commentaire:', escapedText);
  
  if (newText === null) return; // Annulation
  if (newText.trim() === currentText.trim()) return; // Texte identique
  
  if (!newText.trim()) {
    Utils.showNotification('Le commentaire ne peut pas √™tre vide', 'error');
    return;
  }
  
  try {
    const employeeId = getCurrentEmployeeId();
    if (!employeeId) {
      Utils.showNotification('Cannot identify current employee', 'error');
      return;
    }
    
    const response = await fetch(`http://localhost:3020/comments/${commentId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ 
        comment: newText.trim(),
        employeeId: employeeId
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || `HTTP ${response.status}`);
    }
    
    if (data.success) {
      // Mettre √† jour l'affichage du commentaire
      const commentElement = document.querySelector(`.comment[data-comment-id="${commentId}"] .comment-text`);
      if (commentElement) {
        commentElement.textContent = newText.trim();
      }
      Utils.showNotification('Commentaire modifi√© avec succ√®s', 'success');
    } else {
      throw new Error(data.error || 'Failed to update comment');
    }
  } catch (error) {
    console.error('Error updating comment:', error);
    Utils.showNotification('Erreur lors de la modification: ' + error.message, 'error');
  }
}

// Fonction pour supprimer un commentaire (CORRIG√âE)
async function deleteComment(commentId) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce commentaire?')) return;
  
  try {
    const employeeId = getCurrentEmployeeId();
    if (!employeeId) {
      Utils.showNotification('Cannot identify current employee', 'error');
      return;
    }
    
    const response = await fetch(`http://localhost:3020/comments/${commentId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ employeeId: employeeId })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || `HTTP ${response.status}`);
    }
    
    if (data.success) {
      // Supprimer l'√©l√©ment du commentaire de l'interface
      const commentElement = document.querySelector(`.comment[data-comment-id="${commentId}"]`);
      if (commentElement) {
        commentElement.remove();
      }
      
      // V√©rifier s'il reste des commentaires
      const commentsContainer = document.getElementById('taskComments');
      if (commentsContainer.children.length === 0) {
        commentsContainer.innerHTML = '<p class="text-gray-500 text-sm">No comments yet</p>';
      }
      
      Utils.showNotification('Commentaire supprim√© avec succ√®s', 'success');
    } else {
      throw new Error(data.error || 'Failed to delete comment');
    }
  } catch (error) {
    console.error('Error deleting comment:', error);
    Utils.showNotification('Erreur lors de la suppression: ' + error.message, 'error');
  }
}
// Fonction corrig√©e pour charger et afficher les commentaires
async function loadAndDisplayTaskComments(taskId) {
  try {
    const commentsContainer = document.getElementById('taskComments');
    commentsContainer.innerHTML = '<p class="text-gray-500 text-sm">Loading comments...</p>';
    
    const response = await fetch(`http://localhost:3020/tasks/${taskId}/comments`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const currentEmployeeId = getCurrentEmployeeId();
    
    if (data.success && data.comments && data.comments.length > 0) {
     commentsContainer.innerHTML = data.comments.map(comment => {
  const isCurrentUserComment = comment.employee_id == currentEmployeeId;
  const escapedComment = comment.comment.replace(/"/g, '&quot;').replace(/'/g, "&#39;");
  
  return `
    <div class="comment bg-gray-50 rounded-lg p-3 mb-2" data-comment-id="${comment.id}">
      <div class="flex items-center justify-between mb-1">
        <div class="flex items-center">
          <span class="text-sm font-medium text-gray-900">${comment.first_name} ${comment.last_name}</span>
        </div>
        <span class="text-xs text-gray-500">${Utils.formatDateTime(comment.created_at)}</span>
      </div>
      <p class="text-sm text-gray-600 comment-text">${comment.comment}</p>

      ${isCurrentUserComment ? `
        <div class="mt-2 text-sm">
          <button onclick="openEditModal('${comment.id}', '${escapedComment}')"
  style="all:unset; cursor:pointer; font-size:1rem; font-weight:600; color:#111827 !important; margin-right:20px !important;"
  onmouseover="this.style.textDecoration='underline'"
  onmouseout="this.style.textDecoration='none'">
  Edit
</button>
          <button onclick="deleteComment('${comment.id}')"
            style="all:unset; cursor:pointer; font-size:1rem; font-weight:600; color:#111827 !important;"
            onmouseover="this.style.textDecoration='underline'"
            onmouseout="this.style.textDecoration='none'">
            Delete
          </button>
        </div>
      ` : ''}
    </div>
  `;
}).join('');




    } else {
      commentsContainer.innerHTML = '<p class="text-gray-500 text-sm">No comments yet</p>';
    }
  } catch (error) {
    console.error('Error loading comments:', error);
    commentsContainer.innerHTML = '<p class="text-red-500 text-sm">Error loading comments</p>';
  }
}





       async function addComment() {
  const input = document.getElementById('newComment');
  const commentText = input.value.trim();
  
  if (!commentText) {
    Utils.showNotification('Please enter a comment', 'warning');
    return;
  }

  if (!currentTaskId) {
    Utils.showNotification('No task selected', 'error');
    return;
  }

  try {
    const employeeId = getCurrentEmployeeId();
    if (!employeeId) {
      Utils.showNotification('Cannot identify current employee', 'error');
      return;
    }
    
    // Disable button during submission
    const button = document.getElementById('addCommentBtn');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    const response = await fetch(`http://localhost:3020/tasks/${currentTaskId}/comments`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ 
        comment: commentText, 
        employee_id: employeeId  // ‚Üê Changed from employeeId to employee_id
      })
    });

    const data = await response.json();
    
    if (data.success) {
      // Clear input
      input.value = '';
      
      // Reload comments
      await loadAndDisplayTaskComments(currentTaskId);
      
      Utils.showNotification('Comment added successfully', 'success');
    } else {
      throw new Error(data.error || 'Failed to add comment');
    }
    
  } catch (error) {
    console.error('Error adding comment:', error);
    Utils.showNotification('Error adding comment: ' + error.message, 'error');
  } finally {
    // Re-enable button
    const button = document.getElementById('addCommentBtn');
    button.disabled = false;
    button.innerHTML = '<i class="fas fa-paper-plane"></i>';
  }
}

// Expose handlers globally to avoid ReferenceErrors if referenced by templates loaded earlier
if (typeof window !== 'undefined') {
  if (typeof openEditModal === 'function') window.openEditModal = openEditModal;
  if (typeof deleteComment === 'function') window.deleteComment = deleteComment;
  if (typeof editComment === 'function') window.editComment = editComment;
}

// Tab switching functions
function bindMainTabs() {
    const tabs = ['tasks', 'reports', 'pending', 'history'];
    const buttons = document.querySelectorAll('#managementTabs [data-tab]');
    
    buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const tab = btn.getAttribute('data-tab');
            
            // Update tab styles
            buttons.forEach(b => {
                const isActive = b.getAttribute('data-tab') === tab;
                if (isActive) {
                    b.classList.add('tab-active');
                } else {
                    b.classList.remove('tab-active');
                }
            });
            
            // Show/hide panels
            tabs.forEach(t => {
                const panel = document.getElementById(`panel-${t}`);
                if (panel) {
                    panel.classList.toggle('hidden', t !== tab);
                }
            });
            
            // Load content for active tab
            if (tab === 'reports') {
                loadReportsTab();
            } else if (tab === 'pending') {
                loadPendingExceptions();
            } else if (tab === 'history') {
                loadExceptionHistory();
            }
        });
    });
}

// Load Reports tab content
async function loadReportsTab() {
    const reportsContent = document.getElementById('reportsContent');
    if (!reportsContent) return;
    
    try {
        // Load reportres.html content via iframe
        reportsContent.innerHTML = `
            <iframe src="reportres.html" class="w-full border-0 rounded-lg" style="width: 100%; height: 100vh; border: none;"></iframe>
        `;
    } catch (error) {
        console.error('Error loading reports:', error);
        reportsContent.innerHTML = `
            <div class="text-center py-12 text-red-600">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p>Error loading reports</p>
            </div>
        `;
    }
}

// Load Exceptions tab content
let exceptionsCurrentTab = 'pending';
let exceptionsCurrentPage = 1;
let _lastLoadedPending = [];
let allInvitations = [];
let filteredInvitations = [];
let invitationsCurrentPage = 1;
const itemsPerPage = 10;

// Get department IDs for Department_Responsible user
let responsibleDepartmentIds = null;

async function getResponsibleDepartmentIds() {
    if (responsibleDepartmentIds !== null) {
        return responsibleDepartmentIds;
    }
    
    if (currentUser?.role !== 'Department_Responsible') {
        responsibleDepartmentIds = [];
        return [];
    }
    
    try {
        const responsibleId = getCurrentEmployeeId();
        console.log('üîç [Department Filter] Getting departments for responsible:', responsibleId);
        if (!responsibleId) {
            console.warn('‚ö†Ô∏è [Department Filter] No responsible ID found');
            responsibleDepartmentIds = [];
            return [];
        }
        
        // Query departments API and filter by responsible_id client-side
        if (typeof API === 'undefined') {
            console.error('‚ùå [Department Filter] API service not available');
            responsibleDepartmentIds = [];
            return [];
        }
        
        const result = await API.getDepartments();
        console.log('‚úÖ [Department Filter] Received all departments:', result);
        
        // Filter departments where responsible_id matches the current employee ID
        const departments = Array.isArray(result) ? result : (result.departments || []);
        const deptIds = departments
            .filter(dept => dept.responsible_id === responsibleId)
            .map(dept => dept.id);
        
        console.log('‚úÖ [Department Filter] Department IDs for responsible:', deptIds);
        console.log('‚úÖ [Department Filter] Department names:', departments.filter(dept => dept.responsible_id === responsibleId).map(d => d.name));
        
        responsibleDepartmentIds = deptIds;
        return deptIds;
    } catch (error) {
        console.error('‚ùå [Department Filter] Error fetching responsible departments:', error);
        responsibleDepartmentIds = [];
        return [];
    }
}

async function loadPendingExceptions() {
    const content = document.getElementById('pendingExceptions');
    if (!content) return;
    
    try {
        showPendingLoading();

        const params = {
            page: 1,
            limit: 50
        };

        // For Department_Responsible, automatically filter by their department(s) - built-in filter
        if (currentUser?.role === 'Department_Responsible') {
            const deptIds = await getResponsibleDepartmentIds();
            console.log('üîç [Pending Exceptions] Department IDs for responsible:', deptIds);
            if (deptIds.length > 0) {
                // Always filter by their department(s) - built-in, cannot be changed
                params.departmentId = deptIds[0];
                console.log('‚úÖ [Pending Exceptions] Filtering by department ID:', params.departmentId);
                // Hide the department filter dropdown since filtering is automatic
                const deptFilter = document.getElementById('pendingDepartmentFilter');
                if (deptFilter) {
                    deptFilter.style.display = 'none';
                }
            } else {
                console.warn('‚ö†Ô∏è [Pending Exceptions] No department IDs found for responsible');
            }
        } else {
            // For other roles, allow manual filtering
            const departmentId = document.getElementById('pendingDepartmentFilter')?.value;
            if (departmentId) {
                params.departmentId = departmentId;
            }
        }

        console.log('üîç [Pending Exceptions] API params:', params);

        const otParams = {};
        if (params.departmentId) otParams.departmentId = params.departmentId;

        // Check if API is available
        if (typeof API === 'undefined') {
            throw new Error('API service not available');
        }

        const [excResult, otResult] = await Promise.all([
            API.getPendingExceptions(params),
            API.getPendingOvertime(otParams)
        ]);

        const excList = excResult && excResult.success ? (excResult.data || excResult.exceptions || []) : [];
        const otList = otResult && otResult.success ? (otResult.data || []) : [];

        console.log('‚úÖ [Pending Exceptions] Received exceptions:', excList.length, 'overtime:', otList.length);
        console.log('‚úÖ [Pending Exceptions] Sample exception:', excList[0]);

        // Merge and deduplicate by ID
        const mergedMap = new Map();
        
        // Add exceptions
        excList.forEach(e => {
            const key = e.id || `${e.employee_id}_${e.date}_${e.type}`;
            if (!mergedMap.has(key)) {
                mergedMap.set(key, { ...e, _source: 'exception' });
            }
        });
        
        // Add overtime requests
        otList.forEach(o => {
            const key = o.id || `${o.employee_id}_${o.date}_overtime`;
            if (!mergedMap.has(key)) {
                mergedMap.set(key, {
                    ...o,
                    _source: 'overtime',
                    type: 'ExtraHours',
                    description: o.description || `${o.requested_hours} hours requested`
                });
            }
        });

        const merged = Array.from(mergedMap.values());
        
        // Additional client-side filtering for Department_Responsible (ALWAYS apply this filter)
        let finalList = merged;
        if (currentUser?.role === 'Department_Responsible') {
            const deptIds = await getResponsibleDepartmentIds();
            // Also get department names for matching
            let departmentNames = [];
            try {
                if (typeof API !== 'undefined') {
                    const result = await API.getDepartments();
                    const departments = Array.isArray(result) ? result : (result.departments || []);
                    departmentNames = departments
                        .filter(dept => dept.responsible_id === getCurrentEmployeeId())
                        .map(dept => dept.name);
                    console.log('‚úÖ [Pending Exceptions] Responsible department names:', departmentNames);
                }
            } catch (e) {
                console.warn('Could not fetch department names:', e);
            }
            
            console.log('üîç [Pending Exceptions] Filtering with deptIds:', deptIds, 'departmentNames:', departmentNames);
            console.log('üîç [Pending Exceptions] Total items before filter:', merged.length);
            
            // ALWAYS filter - even if empty arrays, we still want to filter
            finalList = merged.filter(item => {
                    // Filter by department ID if available (convert to string for comparison)
                    if (item.department_id) {
                        const itemDeptId = String(item.department_id);
                        if (deptIds.some(id => String(id) === itemDeptId)) {
                            return true;
                        }
                    }
                    // Filter by department name if available (case-insensitive match)
                    if (item.department_name && departmentNames.length > 0) {
                        const itemDeptName = (item.department_name || '').trim();
                        if (departmentNames.some(name => name.trim() === itemDeptName)) {
                            return true;
                        }
                    }
                    // If neither ID nor name matches, exclude
                    return false;
                });
            console.log('üîç [Pending Exceptions] After client-side filter:', finalList.length, 'of', merged.length);
            if (finalList.length > 0) {
                console.log('‚úÖ [Pending Exceptions] Filtered list sample:', {
                    employee: finalList[0].employee_name,
                    department: finalList[0].department_name
                });
            } else if (merged.length > 0) {
                console.warn('‚ö†Ô∏è [Pending Exceptions] No items passed the filter!');
                console.warn('‚ö†Ô∏è [Pending Exceptions] Sample unfiltered item:', {
                    employee: merged[0].employee_name,
                    department: merged[0].department_name,
                    department_id: merged[0].department_id
                });
            }
        }

        displayPendingExceptions(finalList);
        // Store the list for view details function
        _lastLoadedPending = finalList;
        
        // Update badge count
        const pendingCountEl = document.getElementById('pendingCount');
        if (pendingCountEl) pendingCountEl.textContent = finalList.length;
        
    } catch (error) {
        console.error('Load pending exceptions error:', error);
        const content = document.getElementById('pendingExceptions');
        if (content) {
            content.innerHTML = `
                <div class="text-center py-12 text-red-600">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p>Error loading pending exceptions</p>
                    <p class="text-sm mt-2">${error.message}</p>
                </div>
            `;
        }
        showPendingEmpty();
    } finally {
        hidePendingLoading();
    }
}

async function loadExceptionHistory() {
    const tbody = document.getElementById('historyTableBody');
    if (!tbody) return;
    
    try {
        showHistoryLoading();

        const params = {
            page: exceptionsCurrentPage,
            limit: 50,
            startDate: document.getElementById('historyStartDate')?.value || '',
            endDate: document.getElementById('historyEndDate')?.value || ''
        };

        // For Department_Responsible, automatically filter by their department(s) - built-in filter
        if (currentUser?.role === 'Department_Responsible') {
            const deptIds = await getResponsibleDepartmentIds();
            console.log('üîç [History] Department IDs for responsible:', deptIds);
            if (deptIds.length > 0) {
                // Always filter by their department(s) - built-in, cannot be changed
                params.departmentId = deptIds[0];
                console.log('‚úÖ [History] Filtering by department ID:', params.departmentId);
                // Hide the department filter dropdown since filtering is automatic
                const deptFilter = document.getElementById('historyDepartmentFilter');
                const deptFilterContainer = document.getElementById('historyDepartmentFilterContainer');
                if (deptFilterContainer) {
                    deptFilterContainer.style.display = 'none';
                    // Adjust grid to 4 columns when department filter is hidden
                    const filtersGrid = document.getElementById('historyFiltersGrid');
                    if (filtersGrid) {
                        filtersGrid.className = 'grid grid-cols-1 md:grid-cols-4 gap-4';
                    }
                }
            } else {
                console.warn('‚ö†Ô∏è [History] No department IDs found for responsible');
            }
        } else {
            // For other roles, allow manual filtering
            const departmentId = document.getElementById('historyDepartmentFilter')?.value;
            if (departmentId) {
                params.departmentId = departmentId;
            }
        }

        console.log('üîç [History] API params:', params);

        const status = document.getElementById('historyStatusFilter')?.value;
        if (status) {
            params.status = status;
        }

        const type = document.getElementById('historyTypeFilter')?.value;
        if (type) {
            params.type = type;
        }

        if (typeof API === 'undefined') {
            throw new Error('API service not available');
        }

        const result = await API.getExceptionHistory(params);

        if (result.success) {
            let exceptions = result.exceptions || [];
            
            console.log('‚úÖ [History] Received exceptions:', exceptions.length);
            
            // Additional client-side filtering for Department_Responsible (ALWAYS apply this filter)
            if (currentUser?.role === 'Department_Responsible') {
                const deptIds = await getResponsibleDepartmentIds();
                // Also get department names for matching
                let departmentNames = [];
                try {
                    if (typeof API !== 'undefined') {
                        const result = await API.getDepartments();
                        const departments = Array.isArray(result) ? result : (result.departments || []);
                        departmentNames = departments
                            .filter(dept => dept.responsible_id === getCurrentEmployeeId())
                            .map(dept => dept.name);
                        console.log('‚úÖ [History] Responsible department names:', departmentNames);
                    }
                } catch (e) {
                    console.warn('Could not fetch department names:', e);
                }
                
                console.log('üîç [History] Filtering with deptIds:', deptIds, 'departmentNames:', departmentNames);
                console.log('üîç [History] Total items before filter:', exceptions.length);
                
                // ALWAYS filter - even if empty arrays, we still want to filter
                const originalCount = exceptions.length;
                exceptions = exceptions.filter(item => {
                        // Filter by department ID if available (convert to string for comparison)
                        if (item.department_id) {
                            const itemDeptId = String(item.department_id);
                            if (deptIds.some(id => String(id) === itemDeptId)) {
                                return true;
                            }
                        }
                        // Filter by department name if available (case-insensitive match)
                        if (item.department_name && departmentNames.length > 0) {
                            const itemDeptName = (item.department_name || '').trim();
                            if (departmentNames.some(name => name.trim() === itemDeptName)) {
                                return true;
                            }
                        }
                        // If neither ID nor name matches, exclude
                        return false;
                    });
                console.log('üîç [History] After client-side filter:', exceptions.length, 'of', originalCount);
                if (exceptions.length === 0 && originalCount > 0) {
                    console.warn('‚ö†Ô∏è [History] No items passed the filter!');
                    console.warn('‚ö†Ô∏è [History] Sample unfiltered item:', {
                        employee: result.exceptions[0]?.employee_name,
                        department: result.exceptions[0]?.department_name,
                        department_id: result.exceptions[0]?.department_id
                    });
                }
            }
            
            displayExceptionHistory(exceptions);
            displayHistoryPagination(result.pagination);
        } else {
            throw new Error(result.error || 'Failed to load exception history');
        }
    } catch (error) {
        console.error('Load exception history error:', error);
        const tbody = document.getElementById('historyTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading exception history</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </td>
                </tr>
            `;
        }
        showHistoryEmpty();
    } finally {
        hideHistoryLoading();
    }
}

async function loadAllInvitations() {
    const tbody = document.getElementById('invitationsTableBody');
    if (!tbody) return;
    
    try {
        showInvitationsLoading();
        
        if (typeof API === 'undefined') {
            throw new Error('API service not available');
        }
        
        const data = await API.getAllInvitations();
        allInvitations = Array.isArray(data) ? data : (data.data || []);
        
        // Load teachers for filter
        await loadTeachersForFilter();
        
        // Apply current filters
        applyInvitationFilters();
        
        // Update statistics
        updateInvitationStatistics();
        
    } catch (error) {
        console.error('Error loading invitations:', error);
        const tbody = document.getElementById('invitationsTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-12 text-red-600">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading invitations</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </td>
                </tr>
            `;
        }
        showInvitationsEmpty();
    }
}

// Helper functions for exceptions
function showPendingLoading() {
    const loading = document.getElementById('pendingLoading');
    const empty = document.getElementById('pendingEmpty');
    if (loading) loading.classList.remove('hidden');
    if (empty) empty.classList.add('hidden');
}

function hidePendingLoading() {
    const loading = document.getElementById('pendingLoading');
    if (loading) loading.classList.add('hidden');
}

function showPendingEmpty() {
    const loading = document.getElementById('pendingLoading');
    const empty = document.getElementById('pendingEmpty');
    if (loading) loading.classList.add('hidden');
    if (empty) empty.classList.remove('hidden');
}

function hidePendingEmpty() {
    const empty = document.getElementById('pendingEmpty');
    if (empty) empty.classList.add('hidden');
}

function showHistoryLoading() {
    const loading = document.getElementById('historyLoading');
    const empty = document.getElementById('historyEmpty');
    if (loading) loading.classList.remove('hidden');
    if (empty) empty.classList.add('hidden');
}

function hideHistoryLoading() {
    const loading = document.getElementById('historyLoading');
    if (loading) loading.classList.add('hidden');
}

function showHistoryEmpty() {
    const loading = document.getElementById('historyLoading');
    const empty = document.getElementById('historyEmpty');
    if (loading) loading.classList.add('hidden');
    if (empty) empty.classList.remove('hidden');
}

function hideHistoryEmpty() {
    const empty = document.getElementById('historyEmpty');
    if (empty) empty.classList.add('hidden');
}

function showInvitationsLoading() {
    const loading = document.getElementById('invitationsLoading');
    const empty = document.getElementById('invitationsEmpty');
    if (loading) loading.classList.remove('hidden');
    if (empty) empty.classList.add('hidden');
}

function showInvitationsEmpty() {
    const loading = document.getElementById('invitationsLoading');
    const empty = document.getElementById('invitationsEmpty');
    if (loading) loading.classList.add('hidden');
    if (empty) empty.classList.remove('hidden');
}

function formatDate(dateString) {
    if (!dateString) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
        const [y, m, d] = dateString.split('-').map(Number);
        const local = new Date(y, m - 1, d);
        return local.toLocaleDateString();
    }
    return new Date(dateString).toLocaleDateString();
}

function formatDateTime(dateTimeString) {
    if (!dateTimeString) return '';
    return new Date(dateTimeString).toLocaleString();
}

function formatExceptionType(type) {
    switch (type) {
        case 'MissingPunchFix': return 'Missing Punch Fix';
        case 'LeaveRequest': return 'Leave Request';
        case 'HolidayAssignment': return 'Holiday Assignment';
        case 'ExtraHours': return 'Extra Hours (Overtime)';
        default: return type;
    }
}

function formatOverrideType(value) {
    if (!value) return '';
    switch (String(value)) {
        case 'full': return 'Full Override';
        case 'half': return 'Half Day Override';
        case 'partial_decline': return 'Decline Partial Case';
        case 'full_decline': return 'Decline Full Case';
        default: return value;
    }
}

function getStatusClass(status) {
    switch ((status || '').toLowerCase()) {
        case 'approved': return 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-200';
        case 'rejected': return 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800 border border-red-200';
        default: return 'inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200';
    }
}

function displayPendingExceptions(exceptions) {
    const container = document.getElementById('pendingExceptions');
    if (!container) return;
    
    if (exceptions.length === 0) {
        showPendingEmpty();
        return;
    }

    _lastLoadedPending = exceptions;
    container.innerHTML = exceptions.map((exception, index) => {
        const escapedDesc = (exception.description || '').replace(/`/g, '\\`').replace(/\$/g, '\\$');
        // Escape for HTML attributes (both single and double quotes)
        const escapedName = String(exception.employee_name || 'N/A')
            .replace(/&/g, '&amp;')
            .replace(/'/g, '&#39;')
            .replace(/"/g, '&quot;');
        const escapedId = String(exception.id || '')
            .replace(/&/g, '&amp;')
            .replace(/'/g, '&#39;')
            .replace(/"/g, '&quot;');
        const escapedSource = String(exception._source || 'exception')
            .replace(/&/g, '&amp;')
            .replace(/'/g, '&#39;')
            .replace(/"/g, '&quot;');
        return `
            <div class="p-6 hover:bg-gray-50 transition-colors border-b border-gray-200 last:border-b-0">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="flex items-center mb-2 flex-wrap gap-2">
                            <h4 class="text-lg font-semibold text-gray-900">${exception.employee_name || 'N/A'}</h4>
                            <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">
                                ${exception.employee_number || 'N/A'}
                            </span>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200">
                                <i class="fas fa-clock mr-1"></i>${exception.status || 'Pending'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">
                            <i class="fas fa-building text-gray-400 mr-1"></i>${exception.department_name || 'No Department'}
                        </p>
                        <p class="text-sm text-gray-500">
                            <i class="fas fa-calendar-alt text-gray-400 mr-1"></i>Submitted ${formatDateTime(exception.created_at)} by ${exception.submitted_by || 'Unknown'}
                        </p>
                    </div>
                </div>
                <div class="mb-4 bg-gray-50 rounded-lg p-4 border border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-tag text-blue-600 text-sm"></i>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 block">Type</span>
                                <span class="text-sm font-medium text-gray-900">${formatExceptionType(exception.type)}</span>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-calendar text-purple-600 text-sm"></i>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 block">Date</span>
                                <span class="text-sm font-medium text-gray-900">${formatDate(exception.date)}${exception.end_date ? ` - ${formatDate(exception.end_date)}` : ''}</span>
                            </div>
                        </div>
                        ${exception.override_type ? `
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-exchange-alt text-orange-600 text-sm"></i>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 block">Override</span>
                                <span class="text-sm font-medium text-gray-900">${formatOverrideType(exception.override_type)}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <span class="text-xs text-gray-500 block mb-1">
                            <i class="fas fa-align-left text-gray-400 mr-1"></i>Description
                        </span>
                        <p class="text-sm text-gray-900">${escapedDesc}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                    <button onclick="viewExceptionDetails('${escapedId}', '${escapedSource}')" 
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium hover:bg-blue-50 px-3 py-1.5 rounded-lg transition-colors">
                        <i class="fas fa-eye mr-1"></i>View Details
                    </button>
                    <div class="flex space-x-2">
                        <button onclick="showConfirmation('reject', '${escapedId}', '${escapedName}', '${escapedSource}')" 
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm font-medium shadow-sm hover:shadow-md">
                            <i class="fas fa-times mr-2"></i>Reject
                        </button>
                        <button onclick="showConfirmation('approve', '${escapedId}', '${escapedName}', '${escapedSource}')" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium shadow-sm hover:shadow-md">
                            <i class="fas fa-check mr-2"></i>Approve
                        </button>
                        ${exception._source !== 'overtime' ? `
                        <button onclick="showConfirmation('deleteException', '${escapedId}', '${escapedName}', 'exception')" 
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm font-medium shadow-sm hover:shadow-md">
                            <i class="fas fa-trash mr-2"></i>Delete
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    hidePendingEmpty();
}

function displayExceptionHistory(exceptions) {
    const tbody = document.getElementById('historyTableBody');
    if (!tbody) return;
    
    if (exceptions.length === 0) {
        showHistoryEmpty();
        return;
    }

    tbody.innerHTML = exceptions.map(exception => {
        const reason = (() => {
            try {
                const p = typeof exception.payload === 'string' ? JSON.parse(exception.payload) : exception.payload;
                return p?.reason || p?.justification_reason || p?.absence_reason || '';
            } catch (e) {
                return '';
            }
        })();
        
        return `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-blue-600 text-sm"></i>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${exception.employee_name || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${exception.position_name || exception.job_title || exception.position || 'N/A'}</div>
                            <div class="text-xs text-gray-400">${exception.department_name || 'No Department'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-tag text-purple-600 text-xs"></i>
                        </div>
                        <div>
                            <div class="text-sm text-gray-900 font-medium">${formatExceptionType(exception.type)}</div>
                            ${exception.override_type ? `<div class="text-xs text-gray-600">${formatOverrideType(exception.override_type)}</div>` : ''}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-calendar text-indigo-600 text-xs"></i>
                        </div>
                        <div>
                            <div class="text-sm text-gray-900 font-medium">${formatDate(exception.date)}</div>
                            ${exception.end_date ? `<div class="text-xs text-gray-500">to ${formatDate(exception.end_date)}</div>` : ''}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 max-w-xs truncate" title="${reason}">${reason || '‚Äî'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${exception.document_url ? `
                    <button onclick="downloadAttachment('${exception.id}')" class="inline-flex items-center text-blue-600 hover:text-blue-800 text-sm font-medium hover:bg-blue-50 px-2 py-1 rounded-lg transition-colors">
                        <i class="fas fa-paperclip mr-1"></i>Attachment
                    </button>
                    ` : '<span class="text-gray-400">‚Äî</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="${getStatusClass(exception.status)}">
                        ${exception.status || 'Pending'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex items-center space-x-3">
                        <button onclick="viewExceptionDetails('${exception.id}')" class="text-blue-600 hover:text-blue-900 hover:bg-blue-50 px-2 py-1 rounded-lg transition-colors">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                        <button onclick="showConfirmation('deleteException', '${exception.id}', '${(exception.employee_name || '').replace(/'/g, "\\'")}', 'exception')" class="text-red-600 hover:text-red-900 hover:bg-red-50 px-2 py-1 rounded-lg transition-colors">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    hideHistoryEmpty();
}

function displayHistoryPagination(pagination) {
    const container = document.getElementById('historyPagination');
    if (!container) return;
    
    if (pagination.pages <= 1) {
        container.innerHTML = '';
        return;
    }

    const prevDisabled = pagination.page <= 1;
    const nextDisabled = pagination.page >= pagination.pages;

    container.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Showing ${((pagination.page - 1) * pagination.limit) + 1} to ${Math.min(pagination.page * pagination.limit, pagination.total)} of ${pagination.total} results
            </div>
            <div class="flex space-x-2">
                <button onclick="changeHistoryPage(${pagination.page - 1})" 
                        ${prevDisabled ? 'disabled' : ''} 
                        class="px-3 py-1 border border-gray-300 rounded text-sm ${prevDisabled ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-50'}">
                    Previous
                </button>
                <span class="px-3 py-1 text-sm text-gray-700">
                    Page ${pagination.page} of ${pagination.pages}
                </span>
                <button onclick="changeHistoryPage(${pagination.page + 1})" 
                        ${nextDisabled ? 'disabled' : ''} 
                        class="px-3 py-1 border border-gray-300 rounded text-sm ${nextDisabled ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-50'}">
                    Next
                </button>
            </div>
        </div>
    `;
}

function changeHistoryPage(page) {
    exceptionsCurrentPage = page;
    loadExceptionHistory();
}

async function loadDepartments() {
    try {
        if (typeof API === 'undefined') return;
        
        // For Department_Responsible, skip loading departments since filtering is automatic
        if (currentUser?.role === 'Department_Responsible') {
            return;
        }
        
        // For other roles, load all departments and show the filter
        const result = await API.getDepartments();
        if (result.success) {
            const pendingFilter = document.getElementById('pendingDepartmentFilter');
            const historyFilter = document.getElementById('historyDepartmentFilter');
            const historyLabel = document.getElementById('historyDepartmentLabel');
            
            // Show filters for non-Department_Responsible users
            if (pendingFilter) {
                pendingFilter.style.display = 'block';
            }
            const historyDeptContainer = document.getElementById('historyDepartmentFilterContainer');
            if (historyDeptContainer) {
                historyDeptContainer.style.display = 'block';
                // Adjust grid back to 5 columns when department filter is shown
                const filtersGrid = document.getElementById('historyFiltersGrid');
                if (filtersGrid) {
                    filtersGrid.className = 'grid grid-cols-1 md:grid-cols-5 gap-4';
                }
            }
            
            const selects = [pendingFilter, historyFilter].filter(Boolean);
            
            selects.forEach(select => {
                result.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            });
        }
    } catch (error) {
        console.error('Load departments error:', error);
    }
}

async function loadTeachersForFilter() {
    try {
        if (typeof API === 'undefined') return;
        const data = await API.getEmployees();
        const employees = Array.isArray(data) ? data : (data.data || []);
        const teacherFilter = document.getElementById('invitationTeacherFilter');
        if (!teacherFilter) return;
        teacherFilter.innerHTML = '<option value="">All Teachers</option>';
        employees.forEach(emp => {
            if (emp.position_name && emp.position_name.toLowerCase().includes('teacher')) {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.first_name} ${emp.last_name}`;
                teacherFilter.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Error loading teachers:', error);
    }
}

function applyInvitationFilters() {
    const statusFilter = document.getElementById('invitationStatusFilter')?.value || '';
    const dateFilter = document.getElementById('invitationDateFilter')?.value || '';
    const teacherFilter = document.getElementById('invitationTeacherFilter')?.value || '';

    filteredInvitations = allInvitations.filter(invitation => {
        const statusMatch = !statusFilter || invitation.status === statusFilter;
        const dateMatch = !dateFilter || invitation.date === dateFilter;
        const teacherMatch = !teacherFilter || invitation.candidate_employee_id === teacherFilter;
        return statusMatch && dateMatch && teacherMatch;
    });

    invitationsCurrentPage = 1;
    renderInvitationsTable(filteredInvitations);
    updatePagination();
}

function updateInvitationStatistics() {
    const stats = { pending: 0, accepted: 0, taught: 0, denied: 0, dropped: 0 };
    allInvitations.forEach(invitation => {
        const status = invitation.status || 'pending';
        if (stats.hasOwnProperty(status)) stats[status]++;
    });
    const pendingEl = document.getElementById('invPendingCount');
    const acceptedEl = document.getElementById('invAcceptedCount');
    const taughtEl = document.getElementById('invTaughtCount');
    const deniedEl = document.getElementById('invDeniedCount');
    if (pendingEl) pendingEl.textContent = stats.pending;
    if (acceptedEl) acceptedEl.textContent = stats.accepted;
    if (taughtEl) taughtEl.textContent = stats.taught;
    if (deniedEl) deniedEl.textContent = stats.denied;
}

function updatePagination() {
    const groupedInvitations = groupInvitationsBySlot(filteredInvitations);
    const totalGroups = Object.keys(groupedInvitations).length;
    const totalPages = Math.ceil(totalGroups / itemsPerPage);
    const start = (invitationsCurrentPage - 1) * itemsPerPage + 1;
    const end = Math.min(invitationsCurrentPage * itemsPerPage, totalGroups);
    const startEl = document.getElementById('invitationsStart');
    const endEl = document.getElementById('invitationsEnd');
    const totalEl = document.getElementById('invitationsTotal');
    if (startEl) startEl.textContent = start;
    if (endEl) endEl.textContent = end;
    if (totalEl) totalEl.textContent = totalGroups;
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    if (prevBtn) prevBtn.disabled = invitationsCurrentPage === 1;
    if (nextBtn) nextBtn.disabled = invitationsCurrentPage === totalPages;
}

function groupInvitationsBySlot(invitations) {
    const groups = {};
    invitations.forEach(invitation => {
        const key = `${invitation.date}-${invitation.start_time}-${invitation.end_time}-${invitation.absent_teacher_id || invitation.absent_employee_id}`;
        if (!groups[key]) {
            groups[key] = {
                date: invitation.date,
                start_time: invitation.start_time,
                end_time: invitation.end_time,
                absent_teacher_name: invitation.absent_teacher_name,
                absent_teacher_id: invitation.absent_teacher_id || invitation.absent_employee_id,
                total_minutes: invitation.total_minutes || invitation.minutes || 0,
                grade_level: invitation.grade_level,
                education_level: invitation.education_level,
                invitations: []
            };
        }
        groups[key].invitations.push(invitation);
    });
    return groups;
}

function getOverallStatus(statusCounts) {
    if (statusCounts.accepted > 0) return 'accepted';
    if (statusCounts.taught > 0) return 'taught';
    if (statusCounts.denied > 0 && statusCounts.pending === 0) return 'denied';
    if (statusCounts.dropped > 0 && statusCounts.pending === 0) return 'dropped';
    if (statusCounts.pending > 0) return 'pending';
    return 'unknown';
}

function getStatusBadge(status) {
    const badges = {
        pending: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>',
        accepted: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Accepted</span>',
        taught: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Taught</span>',
        denied: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Denied</span>',
        dropped: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800"><i class="fas fa-ban mr-1"></i>Dropped</span>',
        disabled: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600"><i class="fas fa-lock mr-1"></i>Slot Taken</span>'
    };
    return badges[status] || badges.pending;
}

function toggleInvitationGroup(subId, btn) {
    const row = document.getElementById(subId);
    const icon = btn.querySelector('i');
    const nowHidden = row.classList.contains('hidden');
    row.classList.toggle('hidden');
    if (icon) icon.className = `fas ${nowHidden ? 'fa-chevron-down' : 'fa-chevron-right'}`;
}

function renderInvitationsTable(invitations) {
    const tbody = document.getElementById('invitationsTableBody');
    const empty = document.getElementById('invitationsTableEmpty');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    if (!invitations || invitations.length === 0) {
        if (empty) empty.classList.remove('hidden');
        tbody.innerHTML = '';
        return;
    }

    if (empty) empty.classList.add('hidden');
    const loading = document.getElementById('invitationsLoading');
    const emptyState = document.getElementById('invitationsEmpty');
    if (loading) loading.classList.add('hidden');
    if (emptyState) emptyState.classList.add('hidden');
    
    const groupedInvitations = groupInvitationsBySlot(invitations);
    const startIndex = (invitationsCurrentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageGroups = Object.values(groupedInvitations).slice(startIndex, endIndex);
    
    pageGroups.forEach((group, groupIndex) => {
        const groupId = `invitation-group-${groupIndex}`;
        const subId = `invitation-sub-${groupIndex}`;
        const statusCounts = group.invitations.reduce((acc, inv) => {
            acc[inv.status] = (acc[inv.status] || 0) + 1;
            return acc;
        }, {});
        const overallStatus = getOverallStatus(statusCounts);
        const statusBadge = getStatusBadge(overallStatus);
        const timeRange = `${group.start_time} - ${group.end_time}`;
        const duration = `${(group.total_minutes / 60).toFixed(1)}h (${group.total_minutes}m)`;
        
        const mainRow = document.createElement('tr');
        mainRow.className = 'expandable-row hover:bg-gray-50';
        mainRow.innerHTML = `
            <td class="px-6 py-3">
                <button class="expand-button text-gray-600 hover:text-blue-600 mr-2" title="Expand" onclick="toggleInvitationGroup('${subId}', this)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </td>
            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="font-medium">${group.date}</div>
                <div class="text-gray-500 text-xs">${timeRange}</div>
            </td>
            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                    <i class="fas fa-user-circle text-blue-600 mr-2"></i>
                    <span class="font-medium">${group.absent_teacher_name || 'N/A'}</span>
                </div>
            </td>
            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex flex-wrap gap-1">
                    ${group.grade_level ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">Grade ${group.grade_level}</span>` : ''}
                    ${group.education_level ? `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">${group.education_level}</span>` : ''}
                    ${!group.grade_level && !group.education_level ? '<span class="text-gray-400 text-xs">No level info</span>' : ''}
                </div>
            </td>
            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2">
                        ${group.invitations.length}
                    </span>
                    <span>teacher${group.invitations.length !== 1 ? 's' : ''} invited</span>
                </div>
            </td>
            <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${duration}</td>
            <td class="px-6 py-3 whitespace-nowrap">${statusBadge}</td>
            <td class="px-6 py-3 whitespace-nowrap text-sm font-medium">
                <button onclick="viewInvitationGroupDetails('${groupId}')" class="text-blue-600 hover:text-blue-900 mr-3">
                    <i class="fas fa-eye"></i> View All
                </button>
            </td>
        `;
        tbody.appendChild(mainRow);
        
        const subRow = document.createElement('tr');
        subRow.id = subId;
        subRow.className = 'hidden';
        subRow.innerHTML = `
            <td colspan="8" class="px-6 py-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-medium text-gray-900">Invited Teachers</h3>
                        <div class="text-sm text-gray-500">${group.date} - ${timeRange}</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teacher</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Response Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${group.invitations.map(invitation => {
                                    const invStatusBadge = getStatusBadge(invitation.status);
                                    const responseDate = invitation.responded_at ? 
                                        new Date(invitation.responded_at).toLocaleDateString() : '-';
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                                                <div class="flex items-center">
                                                    <i class="fas fa-user text-gray-400 mr-2"></i>
                                                    <span>${invitation.candidate_teacher_name || 'N/A'}</span>
                                                </div>
                                            </td>
                                            <td class="px-4 py-2 whitespace-nowrap">${invStatusBadge}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${responseDate}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                                                <button onclick="viewInvitationDetails('${invitation.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                <button onclick="deleteInvitation('${invitation.id}')" class="text-red-600 hover:text-red-900">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(subRow);
    });
}

function viewInvitationGroupDetails(groupId) {
    console.log('View group details:', groupId);
}

async function deleteInvitation(invitationId) {
    if (!confirm('Are you sure you want to delete this invitation? This will remove it from the teacher\'s view.')) {
        return;
    }
    try {
        if (typeof API === 'undefined') throw new Error('API service not available');
        await API.deleteInvitation(invitationId);
        allInvitations = allInvitations.filter(inv => inv.id !== invitationId);
        filteredInvitations = filteredInvitations.filter(inv => inv.id !== invitationId);
        renderInvitationsTable(filteredInvitations);
        updatePagination();
        updateInvitationStatistics();
        showToast('success', 'Invitation deleted successfully');
    } catch (error) {
        console.error('Error deleting invitation:', error);
        showToast('error', 'Failed to delete invitation: ' + error.message);
    }
}

function viewInvitationDetails(invitationId) {
    const invitation = allInvitations.find(inv => inv.id === invitationId);
    if (!invitation) return;
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Invitation Details</h3>
                <div class="space-y-3">
                    <div><strong>Date:</strong> ${invitation.date}</div>
                    <div><strong>Time:</strong> ${invitation.start_time} - ${invitation.end_time}</div>
                    <div><strong>Absent Teacher:</strong> ${invitation.absent_teacher_name || 'N/A'}</div>
                    <div><strong>Invited Teacher:</strong> ${invitation.candidate_teacher_name || 'N/A'}</div>
                    <div><strong>Status:</strong> <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(invitation.status)}">${invitation.status}</span></div>
                    <div><strong>Duration:</strong> ${invitation.total_minutes} minutes</div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Exception details and confirmation modals functions
// Note: _lastLoadedPending is already declared earlier in the file

function closeDetailsModal() {
    const modal = document.getElementById('detailsModal');
    if (modal) modal.classList.add('hidden');
}

function closeConfirmModal() {
    const modal = document.getElementById('confirmModal');
    if (modal) modal.classList.add('hidden');
}

async function viewExceptionDetails(exceptionId, source = 'exception') {
    try {
        if (source === 'overtime') {
            const item = (_lastLoadedPending || []).find(x => x.id === exceptionId);
            if (!item) throw new Error('Overtime request not found');
            displayOvertimeDetails(item);
        } else {
            if (typeof API === 'undefined') {
                throw new Error('API service not available');
            }
            const result = await API.getExceptionDetails(exceptionId);
            if (result.success) {
                displayExceptionDetails(result.exception);
            } else {
                throw new Error(result.error || 'Failed to load exception details');
            }
        }
    } catch (error) {
        console.error('Load exception details error:', error);
        showToast('error', error.message || 'Failed to load exception details');
    }
}

function displayOvertimeDetails(item) {
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    if (!modalTitle || !modalContent) return;
    
    modalTitle.textContent = `Overtime Request - ${item.employee_name}`;
    modalContent.innerHTML = `
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Employee Information</h4>
                    <div class="space-y-2 text-sm">
                        <div><span class="text-gray-500">Name:</span> <span class="font-medium">${item.employee_name}</span></div>
                        <div><span class="text-gray-500">Employee ID:</span> <span class="font-medium">${item.employee_number || 'N/A'}</span></div>
                        <div><span class="text-gray-500">Department:</span> <span class="font-medium">${item.department_name || 'N/A'}</span></div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Overtime Information</h4>
                    <div class="space-y-2 text-sm">
                        <div><span class="text-gray-500">Date:</span> <span class="font-medium">${formatDate(item.date)}</span></div>
                        <div><span class="text-gray-500">Requested Hours:</span> <span class="font-medium">${item.requested_hours}</span></div>
                        <div><span class="text-gray-500">Status:</span> <span class="${getStatusClass(item.status)}">${item.status}</span></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-3">Description</h4>
                <p class="text-sm text-gray-700">${item.description || ''}</p>
            </div>
        </div>
    `;
    document.getElementById('detailsModal').classList.remove('hidden');
}

function displayExceptionDetails(exception) {
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    if (!modalTitle || !modalContent) return;
    
    modalTitle.textContent = `Exception Details - ${exception.employee_name}`;
    
    const attachmentSection = exception.document_url ? `
        <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="font-medium text-gray-900 mb-3">Attachment</h4>
            <button onclick="downloadAttachment('${exception.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                <i class="fas fa-download mr-2"></i>Download attachment
            </button>
        </div>
    ` : '';

    modalContent.innerHTML = `
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Employee Information</h4>
                    <div class="space-y-2 text-sm">
                        <div><span class="text-gray-500">Name:</span> <span class="font-medium">${exception.employee_name}</span></div>
                        <div><span class="text-gray-500">Employee ID:</span> <span class="font-medium">${exception.employee_number || 'N/A'}</span></div>
                        <div><span class="text-gray-500">Department:</span> <span class="font-medium">${exception.department_name || 'N/A'}</span></div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Exception Information</h4>
                    <div class="space-y-2 text-sm">
                        <div><span class="text-gray-500">Type:</span> <span class="font-medium">${formatExceptionType(exception.type)}</span></div>
                        <div><span class="text-gray-500">Date:</span> <span class="font-medium">${formatDate(exception.date)}</span></div>
                        ${exception.end_date ? `<div><span class="text-gray-500">End Date:</span> <span class="font-medium">${formatDate(exception.end_date)}</span></div>` : ''}
                        <div><span class="text-gray-500">Status:</span> <span class="${getStatusClass(exception.status)}">${exception.status}</span></div>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-3">Description</h4>
                <p class="text-sm text-gray-700">${exception.description || ''}</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-medium text-gray-900 mb-3">Submission Information</h4>
                <div class="space-y-2 text-sm">
                    <div><span class="text-gray-500">Submitted by:</span> <span class="font-medium">${exception.submitted_by || 'Unknown'}</span></div>
                    <div><span class="text-gray-500">Submitted at:</span> <span class="font-medium">${formatDateTime(exception.created_at)}</span></div>
                    ${exception.reviewed_by ? `
                        <div><span class="text-gray-500">Reviewed by:</span> <span class="font-medium">${exception.reviewed_by}</span></div>
                        <div><span class="text-gray-500">Reviewed at:</span> <span class="font-medium">${formatDateTime(exception.reviewed_at)}</span></div>
                    ` : ''}
                </div>
            </div>

            ${attachmentSection}
        </div>
    `;
    
    document.getElementById('detailsModal').classList.remove('hidden');
}

async function downloadAttachment(exceptionId) {
    try {
        if (typeof API === 'undefined') {
            throw new Error('API service not available');
        }
        const { blob, filename } = await API.downloadExceptionDocument(exceptionId);
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    } catch (error) {
        showToast('error', `Failed to download: ${error.message}`);
    }
}

function showConfirmation(action, exceptionId, employeeName, source = 'exception') {
    const modal = document.getElementById('confirmModal');
    const icon = document.getElementById('confirmIcon');
    const iconClass = document.getElementById('confirmIconClass');
    const title = document.getElementById('confirmTitle');
    const message = document.getElementById('confirmMessage');
    const actionBtn = document.getElementById('confirmAction');
    
    if (!modal || !icon || !iconClass || !title || !message || !actionBtn) {
        console.error('Modal elements not found');
        return;
    }
    
    // Find or create override controls container
    const contentContainer = modal.querySelector('.p-6');
    let overrideControls = contentContainer.querySelector('#overrideControls');
    if (!overrideControls) {
        overrideControls = document.createElement('div');
        overrideControls.id = 'overrideControls';
        overrideControls.className = 'mt-4';
        const actionContainer = contentContainer.querySelector('.flex.justify-end');
        if (actionContainer) {
            contentContainer.insertBefore(overrideControls, actionContainer);
        }
    }
    
    if (action === 'approve') {
        icon.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-4';
        iconClass.className = 'fas fa-check text-xl text-green-600';
        title.textContent = source === 'overtime' ? 'Approve Overtime' : 'Approve Exception';
        message.textContent = `Are you sure you want to approve this ${source === 'overtime' ? 'overtime' : 'exception'} request for ${employeeName}?`;
        actionBtn.className = 'px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white transition-colors';
        actionBtn.textContent = 'Approve';
        overrideControls.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 mb-1">Override Type</label>
            <select id="overrideTypeSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="full">Full Override</option>
                <option value="half">Half Day Override</option>
            </select>
        `;
        actionBtn.onclick = () => {
            const overrideType = document.getElementById('overrideTypeSelect')?.value || 'full';
            processException(exceptionId, 'approve', source, { override_type: overrideType });
        };
    } else if (action === 'deleteException') {
        icon.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-4';
        iconClass.className = 'fas fa-trash text-xl text-red-600';
        title.textContent = 'Delete Exception';
        message.textContent = `Are you sure you want to delete this exception for ${employeeName}? This will also remove any linked overrides.`;
        actionBtn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white transition-colors';
        actionBtn.textContent = 'Delete';
        overrideControls.innerHTML = '';
        actionBtn.onclick = async () => {
            try {
                closeConfirmModal();
                if (typeof API === 'undefined') {
                    throw new Error('API service not available');
                }
                const result = await API.deleteException(exceptionId);
                if (result.success) {
                    showToast('success', 'Exception deleted successfully');
                    await loadPendingExceptions();
                } else {
                    throw new Error(result.error || 'Failed to delete exception');
                }
            } catch (error) {
                showToast('error', error.message);
            }
        };
    } else {
        icon.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-4';
        iconClass.className = 'fas fa-times text-xl text-red-600';
        title.textContent = source === 'overtime' ? 'Reject Overtime' : 'Reject Exception';
        message.textContent = `Are you sure you want to reject this ${source === 'overtime' ? 'overtime' : 'exception'} request for ${employeeName}?`;
        actionBtn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white transition-colors';
        actionBtn.textContent = 'Reject';
        overrideControls.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 mb-1">Decline Type</label>
            <select id="declineTypeSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="partial_decline">Decline Partial Case</option>
                <option value="full_decline">Decline Full Case</option>
            </select>
        `;
        actionBtn.onclick = () => {
            const declineType = document.getElementById('declineTypeSelect')?.value || 'full_decline';
            processException(exceptionId, 'reject', source, { override_type: declineType });
        };
    }
    
    modal.classList.remove('hidden');
}

async function processException(exceptionId, action, source = 'exception', extra = {}) {
    try {
        closeConfirmModal();
        
        if (typeof API === 'undefined') {
            throw new Error('API service not available');
        }

        let result;
        if (source === 'overtime') {
            result = action === 'approve'
                ? await API.approveOvertimeRequest(exceptionId)
                : await API.declineOvertimeRequest(exceptionId);
        } else {
            result = action === 'approve'
                ? await API.approveException(exceptionId, extra)
                : await API.rejectException(exceptionId, extra);
        }

        if (result.success) {
            const label = source === 'overtime' ? 'Overtime' : 'Exception';
            showToast('success', `${label} ${action}d successfully`);
            await loadPendingExceptions();
        } else {
            const label = source === 'overtime' ? 'overtime' : 'exception';
            throw new Error(result.error || `Failed to ${action} ${label}`);
        }
    } catch (error) {
        console.error(`${action} exception error:`, error);
        showToast('error', error.message);
    }
}

// Initialize exceptions when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load departments for filters
    loadDepartments();
    
    // Set default date range for history (last 30 days)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    const historyStartDate = document.getElementById('historyStartDate');
    const historyEndDate = document.getElementById('historyEndDate');
    if (historyStartDate) historyStartDate.value = startDate.toISOString().split('T')[0];
    if (historyEndDate) historyEndDate.value = endDate.toISOString().split('T')[0];
});

    </script>
</body>
</html>