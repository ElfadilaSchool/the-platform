
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="meetings.title">Meetings - HR Operations Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- The reusable navbar will be automatically inserted here -->
    
    <!-- Main Content -->
    <div class="main-content flex-1 overflow-y-auto">

            <!-- Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Page Header -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-2" data-translate="meetings.title">Meetings</h1>
                                <p class="text-gray-600" data-translate="meetings.description">Schedule and manage your meetings</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <!-- Language Selector -->
                                <select id="languageSelector" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="en">English</option>
                                    <option value="fr">Français</option>
                                    <option value="ar">العربية</option>
                                </select>
                                
                                <button id="addMeetingBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span data-translate="meetings.add_meeting">Schedule Meeting</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                        <div class="flex items-center justify-between">
                             <div class="flex space-x-2">
                                <input type="date" id="dateFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button id="filterBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" data-translate="common.filter">Filter</button>
                            </div>
                        </div>
                    </div>

                    <!-- Meetings List -->
                    <div id="meetingsListContainer" class="space-y-4">
                        <!-- Meetings will be loaded here -->
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
                        <p class="text-gray-600 mt-2" data-translate="common.loading">Loading meetings...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-12 hidden">
                        <i class="fas fa-calendar-alt text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2" data-translate="message.no_data">No meetings found</h3>
                        <p class="text-gray-600 mb-4" data-translate="meetings.empty_message">Get started by scheduling your first meeting or adjust your filters.</p>
                        <button id="addMeetingFromEmpty" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            <span data-translate="meetings.add_meeting">Schedule Meeting</span>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Meeting Modal -->
    <div id="meetingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modalTitle" class="text-lg font-semibold" data-translate="meetings.add_meeting">Schedule Meeting</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="meetingForm">
                <input type="hidden" id="meetingId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="meetings.title_label">Meeting Title</label>
                        <input type="text" id="meetingTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" data-translate-placeholder="meetings.title_placeholder">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="meetings.description_label">Description</label>
                        <textarea id="meetingDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="meetings.start_time">Start Time</label>
                            <input type="datetime-local" id="startTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="meetings.end_time">End Time</label>
                            <input type="datetime-local" id="endTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="common.notes">Notes</label>
                        <textarea id="meetingNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="meetings.attendees">Attendees</label>
                        <div id="attendeesList" class="max-h-32 overflow-y-auto border border-gray-300 rounded-lg p-2">
                            <!-- Attendees checkboxes will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" id="cancelBtn" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50" data-translate="common.cancel">Cancel</button>
                    <button type="submit" id="submitBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" data-translate="meetings.add_meeting">Schedule Meeting</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../assets/js/translations.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        let allMeetings = [];
        let allEmployees = [];
        let isEditing = false;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!requireAuth()) return;

            await initializePage();

            // Event listeners
            document.getElementById('addMeetingBtn').addEventListener('click', openAddModal);
            document.getElementById('addMeetingFromEmpty').addEventListener('click', openAddModal);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('meetingForm').addEventListener('submit', handleSubmit);
            document.getElementById('filterBtn').addEventListener('click', loadMeetings);

            const languageSelector = document.getElementById('languageSelector');
            languageSelector.value = currentLanguage;
            languageSelector.addEventListener('change', (e) => {
                setLanguage(e.target.value);
                updatePageTranslations();
            });
            updatePageTranslations();
        });

        async function initializePage() {
            try {
                const user = authManager.getUser();
                if (user) {
                    // Try to get employee data for more complete user info
                    try {
                        const employees = await APIService.getEmployees({ user_id: user.id });
                        const employee = employees.find(emp => emp.user_id === user.id);
                        
                        const nameEl = document.getElementById('userDisplayName');
                        if (nameEl) {
                            if (employee) {
                                nameEl.textContent = `${employee.first_name} ${employee.last_name}`;
                            } else {
                                nameEl.textContent = user.username;
                            }
                        }
                    } catch (error) {
                        // Fallback to basic user info
                        const nameEl = document.getElementById('userDisplayName');
                        if (nameEl) {
                            nameEl.textContent = user.username;
                        }
                    }
                }
                
                await loadInitialData();
            } catch (error) {
                console.error('Error initializing page:', error);
                Utils.showNotification('Error initializing page: ' + error.message, 'error');
            }
        }

        async function loadInitialData() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('meetingsListContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            try {
                // Fetch employees first to map attendees later
                allEmployees = await APIService.getEmployees();
                populateAttendeesList();
                
                await loadMeetings();

            } catch (error) {
                console.error('Error initializing page:', error);
                Utils.showNotification('Error loading page data: ' + error.message, 'error');
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        async function loadMeetings() {
            document.getElementById('loadingState').style.display = 'block';
            try {
                const dateFilter = document.getElementById('dateFilter').value;
                const params = {};
                if (dateFilter) {
                    params.start_date = new Date(dateFilter).toISOString();
                }
                
                allMeetings = await APIService.getMeetings(params);
                renderMeetings();
            } catch (error) {
                console.error('Error loading meetings:', error);
                Utils.showNotification('Error loading meetings: ' + error.message, 'error');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function populateAttendeesList() {
            const container = document.getElementById('attendeesList');
            container.innerHTML = allEmployees.map(employee => `
                <label class="flex items-center space-x-2 p-1">
                    <input type="checkbox" value="${employee.id}" class="attendee-checkbox">
                    <span class="text-sm">${employee.first_name} ${employee.last_name}</span>
                </label>
            `).join('');
        }

        function renderMeetings() {
            const container = document.getElementById('meetingsListContainer');
            
            if (allMeetings.length === 0) {
                container.style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            container.style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            container.innerHTML = allMeetings.map(meeting => {
                const attendeeNames = meeting.attendees ? meeting.attendees.map(attId => {
                    const emp = allEmployees.find(e => e.id === attId);
                    return emp ? `${emp.first_name} ${emp.last_name}` : 'Unknown';
                }).join(', ') : 'No attendees';

                return `
                <div class="border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900">${meeting.title}</h4>
                            <p class="text-gray-600 mb-3">${meeting.description || ''}</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-clock mr-2 text-blue-600"></i>
                                    ${Utils.formatDateTime(meeting.start_time)} - ${Utils.formatTime(meeting.end_time)}
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-user-tie mr-2 text-blue-600"></i>
                                    Scheduled by: ${meeting.scheduled_by_first_name} ${meeting.scheduled_by_last_name}
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <span class="text-sm text-gray-600">Attendees: </span>
                                <span class="text-sm text-gray-900">${attendeeNames}</span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2 ml-4">
                            <button onclick="openEditModal('${meeting.id}')" class="text-blue-600 hover:text-blue-800 p-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMeeting('${meeting.id}')" class="text-red-600 hover:text-red-800 p-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function openAddModal() {
            isEditing = false;
            document.getElementById('modalTitle').textContent = 'Schedule Meeting';
            document.getElementById('submitBtn').textContent = 'Schedule Meeting';
            document.getElementById('meetingForm').reset();
            document.getElementById('meetingId').value = '';
            
            // Clear attendee checkboxes
            document.querySelectorAll('.attendee-checkbox').forEach(cb => cb.checked = false);
            
            document.getElementById('meetingModal').classList.remove('hidden');
            document.getElementById('meetingModal').classList.add('flex');
        }

        async function openEditModal(meetingId) {
            try {
                isEditing = true;
                const meeting = await APIService.getMeetingById(meetingId);
                
                document.getElementById('modalTitle').textContent = 'Edit Meeting';
                document.getElementById('submitBtn').textContent = 'Update Meeting';
                
                document.getElementById('meetingId').value = meeting.id;
                document.getElementById('meetingTitle').value = meeting.title;
                document.getElementById('meetingDescription').value = meeting.description || '';
                document.getElementById('startTime').value = Utils.formatDateTimeForInput(meeting.start_time);
                document.getElementById('endTime').value = Utils.formatDateTimeForInput(meeting.end_time);
                document.getElementById('meetingNotes').value = meeting.notes || '';
                
                // Set attendee checkboxes
                document.querySelectorAll('.attendee-checkbox').forEach(cb => {
                    cb.checked = meeting.attendees && meeting.attendees.includes(cb.value);
                });
                
                document.getElementById('meetingModal').classList.remove('hidden');
                document.getElementById('meetingModal').classList.add('flex');
            } catch (error) {
                console.error('Error loading meeting for edit:', error);
                Utils.showNotification('Error loading meeting details: ' + error.message, 'error');
            }
        }

        function closeModal() {
            document.getElementById('meetingModal').classList.add('hidden');
            document.getElementById('meetingModal').classList.remove('flex');
            document.getElementById('meetingForm').reset();
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('meetingTitle').value,
                description: document.getElementById('meetingDescription').value,
                start_time: document.getElementById('startTime').value,
                end_time: document.getElementById('endTime').value,
                notes: document.getElementById('meetingNotes').value,
                attendees: Array.from(document.querySelectorAll('.attendee-checkbox:checked')).map(cb => cb.value)
            };

            try {
                if (isEditing) {
                    const meetingId = document.getElementById('meetingId').value;
                    await APIService.updateMeeting(meetingId, formData);
                    Utils.showNotification('Meeting updated successfully', 'success');
                } else {
                    await APIService.createMeeting(formData);
                    Utils.showNotification('Meeting scheduled successfully', 'success');
                }
                
                closeModal();
                await loadMeetings();
            } catch (error) {
                console.error('Error saving meeting:', error);
                Utils.showNotification('Error saving meeting: ' + error.message, 'error');
            }
        }

        async function deleteMeeting(meetingId) {
            if (!confirm('Are you sure you want to delete this meeting?')) {
                return;
            }

            try {
                await APIService.deleteMeeting(meetingId);
                Utils.showNotification('Meeting deleted successfully', 'success');
                await loadMeetings();
            } catch (error) {
                console.error('Error deleting meeting:', error);
                Utils.showNotification('Error deleting meeting: ' + error.message, 'error');
            }
        }
    </script>
    <script src="../assets/js/simple-nav.js"></script>
</body>
</html>
