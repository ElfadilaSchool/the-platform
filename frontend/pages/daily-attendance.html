<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title data-translate="attendance.daily.title">Daily Attendance - HR Operations Platform</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<link href="../assets/css/style.css" rel="stylesheet">
	<style>
		.embed-container {
			height: 100vh;
		}

		.embed-frame {
			width: 100%;
			height: 100%;
			border: 0;
			background: #fff;
		}
	</style>
</head>

<body class="bg-gray-50">

	<main class="min-h-screen">
		<div class="embed-container">
			<iframe id="dailyAttendanceFrame" class="embed-frame" title="Daily Attendance"></iframe>
		</div>
	</main>

	<script src="../assets/js/auth.js"></script>
	<script src="../assets/js/translations.js"></script>
	<script src="../assets/js/main.js"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			if (!requireAuth()) return;
			initializeCollapsibleSidebar();

			// Get URL parameters and pass them to the iframe
			const urlParams = new URLSearchParams(window.location.search);
			const employeeId = urlParams.get('employeeId');
			const year = urlParams.get('year');
			const month = urlParams.get('month');

			console.log('[WRAPPER] URL params received:', { employeeId, year, month });

			// Build the iframe URL
			const currentLang = localStorage.getItem('language') || localStorage.getItem('lang') || 'en';
			let iframeUrl = 'http://localhost:3000/daily-attendance.html?embed=1&lang=' + currentLang;

			if (employeeId) iframeUrl += '&employeeId=' + employeeId;
			if (year) iframeUrl += '&year=' + year;
			if (month) iframeUrl += '&month=' + month;

			console.log('[WRAPPER] Constructed iframe URL:', iframeUrl);

			// Load the Daily Attendance service inside an iframe in embed mode
			var frame = document.getElementById('dailyAttendanceFrame');
			frame.src = iframeUrl;

			// Initialize translations
			if (typeof updatePageTranslations === 'function') {
				updatePageTranslations();
			}

			// Function to send language to iframe
			function sendLanguageToIframe(lang) {
				try {
					if (frame && frame.contentWindow) {
						frame.contentWindow.postMessage({
							type: 'languageChange',
							language: lang
						}, 'http://localhost:3000');
						console.log('[daily-attendance.html] Sent language to iframe:', lang);
					}
				} catch (e) {
					console.warn('[daily-attendance.html] Could not send language to iframe:', e);
				}
			}

			// Send initial language when iframe loads
			frame.addEventListener('load', function () {
				const currentLang = localStorage.getItem('language') || localStorage.getItem('lang') || 'en';
				sendLanguageToIframe(currentLang);
			});

			// Listen for language changes from the parent page
			document.addEventListener('languageChanged', function (event) {
				const lang = event.detail ? event.detail.language : (localStorage.getItem('language') || localStorage.getItem('lang') || 'en');
				sendLanguageToIframe(lang);
			});

			// Also listen for localStorage changes (in case language is changed elsewhere)
			window.addEventListener('storage', function (e) {
				if (e.key === 'language' || e.key === 'lang') {
					const lang = e.newValue || localStorage.getItem('language') || localStorage.getItem('lang') || 'en';
					sendLanguageToIframe(lang);
				}
			});

			// Poll for language changes (fallback method)
			let lastLanguage = localStorage.getItem('language') || localStorage.getItem('lang') || 'en';
			setInterval(function () {
				const currentLang = localStorage.getItem('language') || localStorage.getItem('lang') || 'en';
				if (currentLang !== lastLanguage) {
					lastLanguage = currentLang;
					sendLanguageToIframe(currentLang);
				}
			}, 500);

			// Listen for navigation messages from iframe
			window.addEventListener('message', function (event) {
				// Verify origin for security (allow localhost:3000)
				if (event.origin !== 'http://localhost:3000' && !event.origin.includes('localhost:3000') && !event.origin.includes('127.0.0.1:3000')) {
					return;
				}

				if (event.data && event.data.type === 'navigateBackToAttendance') {
					console.log('[daily-attendance.html] Received back navigation request');

					// Get current page base URL
					const currentUrl = window.location.href;
					const urlObj = new URL(currentUrl);
					const basePath = urlObj.pathname.substring(0, urlObj.pathname.lastIndexOf('/') + 1);
					const targetUrl = `${urlObj.protocol}//${urlObj.host}${basePath}attendance.html`;

					console.log('[daily-attendance.html] Navigating back to:', targetUrl);
					window.location.href = targetUrl;
				}
			});
		});
	</script>
</body>

</html>