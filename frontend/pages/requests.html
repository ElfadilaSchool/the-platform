<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="requests.title">Requests - HR Operations Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet">
    
</head>
<body class="bg-gray-50">
    <!-- The reusable navbar will be automatically inserted here -->
    
    <!-- Main Content -->
    <div class="main-content flex-1 flex flex-col overflow-hidden">

            <!-- Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Page Header -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900" data-translate="requests.header">Request Management</h1>
                                <p class="text-gray-600" data-translate="requests.description">Submit and manage permission requests</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <!-- Language Selector -->
                                <select id="languageSelector" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="en">English</option>
                                    <option value="fr">Français</option>
                                    <option value="ar">العربية</option>
                                </select>
                                <div id="requestActions" class="flex space-x-2">
                                    <!-- Request actions will be populated based on user role -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Request Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-paper-plane text-blue-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600" data-translate="requests.total">Total Requests</p>
                                    <p class="text-2xl font-bold text-gray-900" id="totalRequests">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600" data-translate="common.status">Pending</p>
                                    <p class="text-2xl font-bold text-gray-900" id="pendingRequests">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600" data-translate="common.approved">Approved</p>
                                    <p class="text-2xl font-bold text-gray-900" id="approvedRequests">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center">
                                <div class="h-12 w-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-times-circle text-red-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600" data-translate="common.rejected">Rejected</p>
                                    <p class="text-2xl font-bold text-gray-900" id="rejectedRequests">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters and Search -->
                    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                            <div class="flex-1 max-w-md">
                                <div class="relative">
                                    <input type="text" id="searchInput" data-translate-placeholder="common.search" placeholder="Search requests..." 
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">All Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                                <select id="typeFilter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">All Types</option>
                                    <option value="Vacation">Vacation</option>
                                    <option value="Sick Leave">Sick Leave</option>
                                    <option value="Personal Leave">Personal Leave</option>
                                    <option value="Day Off">Day Off</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Requests List -->
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900" data-translate="requests.title">Requests</h3>
                        </div>
                        
                        <div id="requestsList" class="divide-y divide-gray-200">
                            <!-- Requests will be loaded here -->
                        </div>
                        
                        <!-- Loading State -->
                        <div id="loadingState" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
                            <p class="text-gray-600 mt-2">Loading requests...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="emptyState" class="text-center py-12 hidden">
                            <i class="fas fa-paper-plane text-gray-400 text-4xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No requests found</h3>
                            <p class="text-gray-600">Requests will appear here once submitted</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Request Modal -->
    <div id="requestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modalTitle" class="text-lg font-semibold">Submit Request</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="requestForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Request Type</label>
                        <select id="requestType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Type</option>
                            <option value="Vacation">Vacation</option>
                            <option value="Sick Leave">Sick Leave</option>
                            <option value="Personal Leave">Personal Leave</option>
                            <option value="Day Off">Day Off</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="startDate" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="endDate" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                        <textarea id="requestReason" rows="4" required 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Please provide a detailed reason for your request..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Supporting Documents</label>
                        <input type="file" id="supportingDocs" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max 5MB each)</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Emergency Contact (if applicable)</label>
                        <input type="text" id="emergencyContact" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Name and phone number">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" id="cancelBtn" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Submit Request
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div id="requestDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 id="detailsTitle" class="text-lg font-semibold">Request Details</h3>
                <button id="closeDetailsModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="requestDetailsContent">
                <!-- Request details will be populated here -->
            </div>
            
            <div id="approvalActions" class="mt-6 hidden">
                <div class="flex justify-end space-x-2">
                    <button id="rejectBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        <i class="fas fa-times mr-2"></i>
                        Reject
                    </button>
                    <button id="approveBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-check mr-2"></i>
                        Approve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/translations.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        let requests = [];
        let currentUser = null;
        let currentRequestId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!authManager.isAuthenticated()) {
                // Only redirect to login if not already on login page
                if (!window.location.pathname.includes("index.html")) {
                    if (window.location.pathname.includes("/pages/")) {
                        window.location.href = "../index.html";
                    } else {
                        window.location.href = "index.html";
                    }
                }
                return;
            }

            // Initialize page
            currentUser = authManager.getUser();
            
            // Ensure user role is in localStorage for sidebar initialization
            if (currentUser && currentUser.role) {
                localStorage.setItem('userRole', currentUser.role);
            }
            
            // Re-initialize sidebar if it wasn't created (main.js might have loaded before auth was ready)
            setTimeout(() => {
                if (!document.getElementById('collapsibleSidebar')) {
                    // Try to call initializeCollapsibleSidebar if available
                    if (typeof window.initializeCollapsibleSidebar === 'function') {
                        window.initializeCollapsibleSidebar();
                    } else if (typeof initializeCollapsibleSidebar === 'function') {
                        initializeCollapsibleSidebar();
                    }
                    
                    // Set up navigation handlers
                    if (document.getElementById('collapsibleSidebar')) {
                        if (typeof window.handleSidebarNavigation === 'function') {
                            window.handleSidebarNavigation();
                        } else if (typeof handleSidebarNavigation === 'function') {
                            handleSidebarNavigation();
                        }
                    }
                }
            }, 100);
            
            initializePage();
            loadRequests();

            // Event listeners
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('requestForm').addEventListener('submit', handleSubmit);
            document.getElementById('closeDetailsModal').addEventListener('click', closeDetailsModal);
            document.getElementById('searchInput').addEventListener('input', filterRequests);
            document.getElementById('statusFilter').addEventListener('change', filterRequests);
            document.getElementById('typeFilter').addEventListener('change', filterRequests);

            // Language selector
            const languageSelector = document.getElementById('languageSelector');
            languageSelector.value = currentLanguage;
            languageSelector.addEventListener('change', (e) => {
                setLanguage(e.target.value);
                applyTranslations();
            });
            applyTranslations();
        });

        function initializePage() {
            if (currentUser) {
                document.getElementById('userDisplayName').textContent = currentUser.first_name + ' ' + currentUser.last_name;
                document.getElementById('userRoleDisplay').textContent = currentUser.role?.replace('_', ' ') || 'Employee';
            }

            setupNavigation();
            setupRequestActions();
            
            // Set default start date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('startDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('endDate').value = tomorrow.toISOString().split('T')[0];
        }

        function setupNavigation() {
            const nav = document.getElementById('sidebarNav');
            const role = currentUser?.role;
            
            let navItems = [];
            
            if (role === 'HR_Manager') {
                navItems = [
                    { href: 'hr-dashboard.html', icon: 'fa-tachometer-alt', text: 'Dashboard' },
                    { href: 'employees.html', icon: 'fa-users', text: 'Employees' },
                    { href: 'departments.html', icon: 'fa-building', text: 'Departments' },
                    { href: 'payments.html', icon: 'fa-money-bill-wave', text: 'Payments' },
                    { href: 'meetings.html', icon: 'fa-calendar-alt', text: 'Meetings' },
                    { href: 'profile.html', icon: 'fa-user', text: 'Profile' }
                ];
            } else if (role === 'Department_Responsible') {
                navItems = [
                    { href: 'responsible-dashboard.html', icon: 'fa-tachometer-alt', text: 'Dashboard' },
                    { href: 'tasks.html', icon: 'fa-tasks', text: 'Tasks' },
                    { href: 'meetings.html', icon: 'fa-calendar-alt', text: 'Meetings' },
                    { href: 'requests.html', icon: 'fa-paper-plane', text: 'Requests', active: true },
                    { href: 'attendance-overview.html', icon: 'fa-clock', text: 'Attendance Overview' },
                    { href: 'profile.html', icon: 'fa-user', text: 'Profile' }
                ];
            } else {
                navItems = [
                    { href: 'employee-dashboard.html', icon: 'fa-tachometer-alt', text: 'Dashboard' },
                    { href: 'tasks.html', icon: 'fa-tasks', text: 'Tasks' },
                    { href: 'meetings.html', icon: 'fa-calendar-alt', text: 'Meetings' },
                    { href: 'payments.html', icon: 'fa-money-bill-wave', text: 'Payments' },
                    { href: 'requests.html', icon: 'fa-paper-plane', text: 'Requests', active: true },
                    { href: 'profile.html', icon: 'fa-user', text: 'Profile' }
                ];
            }

            nav.innerHTML = navItems.map(item => `
                <a href="${item.href}" class="sidebar-item flex items-center px-6 py-3 ${item.active ? 'text-blue-600' : 'text-gray-700 hover:text-blue-600'}">
                    <i class="fas ${item.icon} mr-3"></i>
                    <span data-translate="nav.${item.text.toLowerCase()}">${item.text}</span>
                </a>
            `).join('') + `
                <a href="#" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-red-600" data-action="logout">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span data-translate="nav.logout">Logout</span>
                </a>
            `;
        }

        function setupRequestActions() {
            const actions = document.getElementById('requestActions');
            const role = currentUser?.role;
            
            if (role === 'Employee') {
                actions.innerHTML = `
                    <button id="addRequestBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        <span data-translate="requests.submit_request">Submit Request</span>
                    </button>
                `;
                document.getElementById('addRequestBtn').addEventListener('click', openAddModal);
            }
        }

        async function loadRequests() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('requestsList').innerHTML = '';

                // Mock data for now - replace with actual API call
                requests = [
                    {
                        id: 1,
                        type: 'Vacation',
                        start_date: '2024-08-01',
                        end_date: '2024-08-05',
                        reason: 'Family vacation to the beach',
                        status: 'Pending',
                        employee_name: 'John Doe',
                        employee_id: 1,
                        submitted_at: '2024-07-20T10:00:00Z',
                        reviewed_at: null,
                        reviewed_by: null,
                        emergency_contact: 'Jane Doe - +213 123 456 789',
                        documents: ['vacation_request.pdf']
                    },
                    {
                        id: 2,
                        type: 'Sick Leave',
                        start_date: '2024-07-22',
                        end_date: '2024-07-22',
                        reason: 'Doctor appointment for routine checkup',
                        status: 'Approved',
                        employee_name: 'Jane Smith',
                        employee_id: 2,
                        submitted_at: '2024-07-21T14:00:00Z',
                        reviewed_at: '2024-07-21T16:00:00Z',
                        reviewed_by: 'Admin User',
                        emergency_contact: null,
                        documents: ['medical_certificate.pdf']
                    },
                    {
                        id: 3,
                        type: 'Personal Leave',
                        start_date: '2024-07-25',
                        end_date: '2024-07-25',
                        reason: 'Personal matters that require immediate attention',
                        status: 'Rejected',
                        employee_name: 'Mike Johnson',
                        employee_id: 3,
                        submitted_at: '2024-07-19T09:00:00Z',
                        reviewed_at: '2024-07-20T11:00:00Z',
                        reviewed_by: 'Admin User',
                        emergency_contact: null,
                        documents: []
                    }
                ];

                // Filter requests based on user role
                if (currentUser?.role === 'Employee') {
                    requests = requests.filter(request => request.employee_name === `${currentUser.first_name} ${currentUser.last_name}`);
                }

                renderRequests();
                updateRequestStatistics();
            } catch (error) {
                console.error('Error loading requests:', error);
                Utils.showNotification('Error loading requests: ' + error.message, 'error');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function renderRequests() {
            const container = document.getElementById('requestsList');
            const emptyState = document.getElementById('emptyState');

            if (requests.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            container.innerHTML = requests.map(request => `
                <div class="p-6 hover:bg-gray-50 transition-colors cursor-pointer" onclick="showRequestDetails(${request.id})">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h4 class="text-lg font-semibold text-gray-900">${request.type}</h4>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(request.status)}">
                                    ${request.status}
                                </span>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getTypeClass(request.type)}">
                                    ${getDuration(request.start_date, request.end_date)}
                                </span>
                            </div>
                            
                            <p class="text-gray-600 mb-3">${request.reason}</p>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                                <div class="flex items-center">
                                    <i class="fas fa-calendar mr-2 text-blue-600"></i>
                                    ${Utils.formatDate(request.start_date)} - ${Utils.formatDate(request.end_date)}
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-user mr-2 text-blue-600"></i>
                                    ${request.employee_name}
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-clock mr-2 text-blue-600"></i>
                                    ${Utils.formatDateTime(request.submitted_at)}
                                </div>
                                ${request.documents.length > 0 ? `
                                    <div class="flex items-center">
                                        <i class="fas fa-paperclip mr-2 text-blue-600"></i>
                                        ${request.documents.length} document(s)
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${request.reviewed_at ? `
                                <div class="mt-2 text-sm text-gray-600">
                                    <i class="fas fa-user-check mr-2 text-green-600"></i>
                                    Reviewed by ${request.reviewed_by} on ${Utils.formatDateTime(request.reviewed_at)}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex space-x-2 ml-4">
                            ${currentUser?.role === 'Department_Responsible' && request.status === 'Pending' ? `
                                <button onclick="event.stopPropagation(); approveRequest(${request.id})" class="text-green-600 hover:text-green-800" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="event.stopPropagation(); rejectRequest(${request.id})" class="text-red-600 hover:text-red-800" title="Reject">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateRequestStatistics() {
            const total = requests.length;
            const pending = requests.filter(r => r.status === 'Pending').length;
            const approved = requests.filter(r => r.status === 'Approved').length;
            const rejected = requests.filter(r => r.status === 'Rejected').length;

            document.getElementById('totalRequests').textContent = total;
            document.getElementById('pendingRequests').textContent = pending;
            document.getElementById('approvedRequests').textContent = approved;
            document.getElementById('rejectedRequests').textContent = rejected;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Approved':
                    return 'bg-green-100 text-green-800';
                case 'Pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Rejected':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getTypeClass(type) {
            switch (type) {
                case 'Vacation':
                    return 'bg-blue-100 text-blue-800';
                case 'Sick Leave':
                    return 'bg-red-100 text-red-800';
                case 'Personal Leave':
                    return 'bg-purple-100 text-purple-800';
                case 'Day Off':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays === 1 ? '1 day' : `${diffDays} days`;
        }

        function filterRequests() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            const filteredRequests = requests.filter(request => {
                const matchesSearch = request.type.toLowerCase().includes(searchTerm) ||
                                    request.reason.toLowerCase().includes(searchTerm) ||
                                    request.employee_name.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || request.status === statusFilter;
                const matchesType = !typeFilter || request.type === typeFilter;

                return matchesSearch && matchesStatus && matchesType;
            });

            // Temporarily update requests for rendering
            const originalRequests = requests;
            requests = filteredRequests;
            renderRequests();
            updateRequestStatistics();
            requests = originalRequests;
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Submit Request';
            document.getElementById('requestForm').reset();
            
            // Set default dates
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('startDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('endDate').value = tomorrow.toISOString().split('T')[0];
            
            document.getElementById('requestModal').classList.remove('hidden');
            document.getElementById('requestModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('requestModal').classList.add('hidden');
            document.getElementById('requestModal').classList.remove('flex');
        }

        function closeDetailsModal() {
            document.getElementById('requestDetailsModal').classList.add('hidden');
            document.getElementById('requestDetailsModal').classList.remove('flex');
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (endDate < startDate) {
                Utils.showNotification('End date cannot be before start date', 'error');
                return;
            }

            const formData = {
                type: document.getElementById('requestType').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                reason: document.getElementById('requestReason').value,
                emergency_contact: document.getElementById('emergencyContact').value,
                status: 'Pending'
            };

            // Handle file uploads
            const files = document.getElementById('supportingDocs').files;
            const documents = [];
            for (let i = 0; i < files.length; i++) {
                if (files[i].size > 5 * 1024 * 1024) {
                    Utils.showNotification(`File ${files[i].name} is too large (max 5MB)`, 'error');
                    return;
                }
                documents.push(files[i].name);
            }
            formData.documents = documents;

            try {
                // Mock API call - replace with actual implementation
                console.log('Submitting request:', formData);
                Utils.showNotification('Request submitted successfully', 'success');
                closeModal();
                loadRequests(); // Reload requests
            } catch (error) {
                console.error('Error submitting request:', error);
                Utils.showNotification('Error submitting request: ' + error.message, 'error');
            }
        }

        function showRequestDetails(id) {
            const request = requests.find(r => r.id === id);
            if (!request) return;

            currentRequestId = id;
            document.getElementById('detailsTitle').textContent = `${request.type} Request`;
            
            const content = document.getElementById('requestDetailsContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Request Type</h4>
                            <p class="text-gray-600">${request.type}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Status</h4>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(request.status)}">
                                ${request.status}
                            </span>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Start Date</h4>
                            <p class="text-gray-600">${Utils.formatDate(request.start_date)}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">End Date</h4>
                            <p class="text-gray-600">${Utils.formatDate(request.end_date)}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Duration</h4>
                            <p class="text-gray-600">${getDuration(request.start_date, request.end_date)}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Employee</h4>
                            <p class="text-gray-600">${request.employee_name}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-900">Reason</h4>
                        <p class="text-gray-600">${request.reason}</p>
                    </div>
                    
                    ${request.emergency_contact ? `
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Emergency Contact</h4>
                            <p class="text-gray-600">${request.emergency_contact}</p>
                        </div>
                    ` : ''}
                    
                    ${request.documents.length > 0 ? `
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Supporting Documents</h4>
                            <div class="space-y-2">
                                ${request.documents.map(doc => `
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-file text-blue-600"></i>
                                        <span class="text-sm text-gray-600">${doc}</span>
                                        <button class="text-blue-600 hover:text-blue-800 text-sm">Download</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Submitted At</h4>
                            <p class="text-gray-600">${Utils.formatDateTime(request.submitted_at)}</p>
                        </div>
                        ${request.reviewed_at ? `
                            <div>
                                <h4 class="text-sm font-medium text-gray-900">Reviewed At</h4>
                                <p class="text-gray-600">${Utils.formatDateTime(request.reviewed_at)}</p>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-gray-900">Reviewed By</h4>
                                <p class="text-gray-600">${request.reviewed_by}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Show approval actions for responsible users
            const approvalActions = document.getElementById('approvalActions');
            if (currentUser?.role === 'Department_Responsible' && request.status === 'Pending') {
                approvalActions.classList.remove('hidden');
                document.getElementById('approveBtn').onclick = () => approveRequest(id);
                document.getElementById('rejectBtn').onclick = () => rejectRequest(id);
            } else {
                approvalActions.classList.add('hidden');
            }

            document.getElementById('requestDetailsModal').classList.remove('hidden');
            document.getElementById('requestDetailsModal').classList.add('flex');
        }

        async function approveRequest(id) {
            try {
                const request = requests.find(r => r.id === id);
                if (request) {
                    request.status = 'Approved';
                    request.reviewed_at = new Date().toISOString();
                    request.reviewed_by = `${currentUser.first_name} ${currentUser.last_name}`;
                    renderRequests();
                    updateRequestStatistics();
                    closeDetailsModal();
                    Utils.showNotification('Request approved successfully', 'success');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                Utils.showNotification('Error approving request: ' + error.message, 'error');
            }
        }

        async function rejectRequest(id) {
            if (!confirm('Are you sure you want to reject this request?')) return;

            try {
                const request = requests.find(r => r.id === id);
                if (request) {
                    request.status = 'Rejected';
                    request.reviewed_at = new Date().toISOString();
                    request.reviewed_by = `${currentUser.first_name} ${currentUser.last_name}`;
                    renderRequests();
                    updateRequestStatistics();
                    closeDetailsModal();
                    Utils.showNotification('Request rejected', 'success');
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                Utils.showNotification('Error rejecting request: ' + error.message, 'error');
            }
        }
    </script>
    <script src="../assets/js/navbar.js"></script>
</body>
</html>

