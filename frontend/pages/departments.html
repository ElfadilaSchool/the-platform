

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Department Management - HR Operations Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="bg-white w-64 shadow-lg" id="localSidebar">
            <div class="p-6 border-b">
                <div class="flex items-center">
                    <div class="h-10 w-10 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-school text-white"></i>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-lg font-semibold text-gray-900">HR Platform</h1>
                        <p class="text-sm text-gray-500" data-translate="nav.hr_manager">HR Manager</p>
                    </div>
                </div>
            </div>
            
            <nav class="mt-6">
                <a href="hr-dashboard.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span data-translate="nav.dashboard">Dashboard</span>
                </a>
                <a href="employees-simple.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-users mr-3"></i>
                    <span data-translate="nav.employees">Employees</span>
                </a>
                <a href="departments.html" class="sidebar-item active flex items-center px-6 py-3 text-blue-600">
                    <i class="fas fa-building mr-3"></i>
                    <span data-translate="nav.departments">Departments</span>
                </a>
                <a href="payments.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-money-bill-wave mr-3"></i>
                    <span data-translate="nav.payments">Payments</span>
                </a>
                <a href="timetable-library.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-calendar-alt mr-3"></i>
                    <span data-translate="nav.timetables">Timetables</span>
                </a>
                <a href="employee-assignments.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-user-clock mr-3"></i>
                    <span data-translate="nav.assign_timetables">Assign Timetables</span>
                </a>
                <a href="attendance-logs.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-clock mr-3"></i>
                    <span data-translate="nav.attendance">Attendance</span>
                </a>
                <a href="settings.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-cog mr-3"></i>
                    <span data-translate="nav.settings">Settings</span>
                </a>
                <a href="salary-management.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-money-check-alt mr-3"></i>
                    <span data-translate="nav.salary_overview">Salary Overview</span>
                </a>
                <a href="meetings.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-calendar-alt mr-3"></i>
                    <span data-translate="nav.meetings">Meetings</span>
                </a>
                <a href="profile.html" class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:text-blue-600">
                    <i class="fas fa-user mr-3"></i>
                    <span data-translate="nav.profile">Profile</span>
                </a>
            </nav>
            
            <div class="absolute bottom-0 w-64 p-6 border-t">
                <button onclick="handleLogout()" class="flex items-center text-gray-700 hover:text-red-600 transition-colors">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span data-translate="nav.logout">Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto" id="mainContent" style="opacity: 0; transition: opacity 0.3s ease-in-out;">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b">
                <div class="flex items-center justify-between px-6 py-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900" data-translate="dashboard.welcome">Welcome</h2>
                        <p class="text-gray-600" id="welcomeMessage" data-translate="dashboard.loading">Loading...</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Language Selector -->
                        <select id="languageSelector" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="en">English</option>
                            <option value="fr">Français</option>
                            <option value="ar">العربية</option>
                        </select>
                        
                        <!-- Notifications -->
                        <div class="relative">
                            <button id="notificationButton" class="p-2 text-gray-600 hover:text-blue-600 relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                            </button>
                        </div>
                        
                        <!-- User Profile -->
                        <div class="flex items-center">
                            <img id="headerProfileImage" 
     class="h-8 w-8 rounded-full object-cover" 
     src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2QjcyODAiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSI+CjxjaXJjbGUgY3g9IjgiIGN5PSI2IiByPSIzIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMyAxMkM1IDkgOCA5IDE2IDlDMTYgOSAxOSA5IDIxIDEyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+Cjwvc3ZnPgo=" 
     alt="Profile Picture"
     style="display: block;">
                            <span class="ml-2 text-sm font-medium text-gray-700" id="userDisplayName">HR Manager</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Responsible View (View-Only) -->
                <div id="responsibleView" class="hidden">
                    <!-- Department Info Card -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-lg p-6 mb-6 text-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="h-16 w-16 rounded-full bg-white/20 flex items-center justify-center">
                                    <i class="fas fa-building text-3xl"></i>
                                </div>
                                <div>
                                    <h2 id="deptInfoName" class="text-2xl font-bold mb-1" data-translate="common.loading">Loading...</h2>
                                    <div class="flex flex-wrap gap-4 text-sm">
                                        <span id="deptInfoEmployees" class="flex items-center gap-2">
                                            <i class="fas fa-users"></i>
                                            <span data-translate="common.loading">Loading...</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm opacity-90" data-translate="department.responsible">Department Responsible</div>
                                <div class="text-lg font-semibold" id="deptInfoResponsible" data-translate="common.you">You</div>
                            </div>
                        </div>
                    </div>

                    <!-- Employees Table -->
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="p-6 border-b">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900" data-translate="department.employees">Department Employees</h3>
                                <input type="text" id="employeeSearch" data-translate-placeholder="common.search_employees" placeholder="Search employees..." 
                                       class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="employee.employee">Employee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="employee.position">Position</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="employee.email">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="employee.phone">Phone</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-translate="common.actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeesTableBody" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                            <p data-translate="common.loading_employees">Loading employees...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- HR Manager View (Full Management) -->
                <div id="hrManagerView">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Departments List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-lg shadow-sm">
                                <div class="p-6 border-b">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-semibold text-gray-900" data-translate="nav.departments">Departments</h3>
                                        <button onclick="showAddDepartmentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                            <i class="fas fa-plus mr-2"></i>
                                            <span data-translate="department.add_department">Add Department</span>
                                        </button>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <input type="text" id="departmentSearch" data-translate-placeholder="common.search_departments" placeholder="Search departments..." 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                
                                <div class="p-6">
                                    <div id="departmentsList" class="space-y-4">
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                            <p>Loading departments...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Department Details -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-lg shadow-sm">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-semibold text-gray-900" data-translate="department.details">Department Details</h3>
                                </div>
                                
                                <div id="departmentDetails" class="p-6">
                                    <div class="text-center py-8 text-gray-500">
                                        <i class="fas fa-building text-4xl mb-2"></i>
                                        <p data-translate="department.select_to_view">Select a department to view details</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Department Modal -->
    <div id="addDepartmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900" data-translate="department.add_department">Add New Department</h3>
                        <button onclick="hideAddDepartmentModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <form id="addDepartmentForm" class="p-6 space-y-4">
                    <div>
                        <label for="departmentName" class="block text-sm font-medium text-gray-700 mb-2" data-translate="department.name">Department Name *</label>
                        <input type="text" id="departmentName" name="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="responsibleId" class="block text-sm font-medium text-gray-700 mb-2" data-translate="department.responsible">Department Responsible</label>
                        <select id="responsibleId" name="responsible_id" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" data-translate="common.select_responsible">Select Responsible</option>
                        </select>
                    </div>

                    <div id="addDepartmentError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                        <div class="flex">
                            <i class="fas fa-exclamation-circle mr-2 mt-0.5"></i>
                            <span id="addDepartmentErrorText"></span>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" onclick="hideAddDepartmentModal()" 
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            <span data-translate="common.cancel">Cancel</span>
                        </button>
                        <button type="submit" id="addDepartmentSubmit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            <span data-translate="department.add_department">Add Department</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Department Modal -->
    <div id="editDepartmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900" data-translate="common.edit_department">Edit Department</h3>
                        <button onclick="hideEditDepartmentModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <form id="editDepartmentForm" class="p-6 space-y-4">
                    <input type="hidden" id="editDepartmentId" name="id">
                    <div>
                        <label for="editDepartmentName" class="block text-sm font-medium text-gray-700 mb-2" data-translate="department.name">Department Name *</label>
                        <input type="text" id="editDepartmentName" name="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="editResponsibleId" class="block text-sm font-medium text-gray-700 mb-2" data-translate="department.responsible">Department Responsible</label>
                        <select id="editResponsibleId" name="responsible_id" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" data-translate="common.select_responsible">Select Responsible</option>
                        </select>
                    </div>

                    <div id="editDepartmentError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                        <div class="flex">
                            <i class="fas fa-exclamation-circle mr-2 mt-0.5"></i>
                            <span id="editDepartmentErrorText"></span>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" onclick="hideEditDepartmentModal()" 
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            <span data-translate="common.cancel">Cancel</span>
                        </button>
                        <button type="submit" id="editDepartmentSubmit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            <span data-translate="common.save_changes">Save Changes</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Employee Details Modal -->
    <div id="employeeDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b sticky top-0 bg-white z-10">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900" data-translate="employee.employee_details">Employee Details</h3>
                        <button onclick="hideEmployeeDetailsModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="employeeDetailsContent" class="p-6">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading employee details...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Employee Modal -->
    <div id="assignEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900" data-translate="department.assign_employee">Assign Employee to Department</h3>
                        <button onclick="hideAssignEmployeeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <form id="assignEmployeeForm" class="p-6 space-y-4">
                    <input type="hidden" id="assignDepartmentId" name="department_id">
                    
                    <div>
                        <label for="assignEmployeeId" class="block text-sm font-medium text-gray-700 mb-2" data-translate="employee.select_employee">Select Employee *</label>
                        <select id="assignEmployeeId" name="employee_id" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" data-translate="employee.select_employee">Select Employee</option>
                        </select>
                    </div>

                    <div id="assignEmployeeError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                        <div class="flex">
                            <i class="fas fa-exclamation-circle mr-2 mt-0.5"></i>
                            <span id="assignEmployeeErrorText"></span>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" onclick="hideAssignEmployeeModal()" 
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            <span data-translate="common.cancel">Cancel</span>
                        </button>
                        <button type="submit" id="assignEmployeeSubmit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>
                            <span data-translate="department.assign_employee">Assign Employee</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/translations.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        // Hide local sidebar/header when embedded via org-structure iframe
        (function() {
            try {
                const params = new URLSearchParams(window.location.search);
                if (params.get('embed') === '1') {
                    const sidebar = document.getElementById('localSidebar');
                    if (sidebar) sidebar.style.display = 'none';
                    const header = document.querySelector('header');
                    if (header) header.style.display = 'none';
                    const main = document.getElementById('mainContent');
                    if (main) main.classList.remove('overflow-y-auto');
                }
            } catch (_) {}
        })();
        // Check authentication
        if (!requireAuth()) {
            // Redirect handled by requireAuth
        }

        let departments = [];
        let employees = [];
        let selectedDepartmentId = null;
        let isResponsibleView = false;
        let currentDepartment = null;
        let departmentEmployees = [];

        // Load departments on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const user = authManager.getUser();
            const userRole = authManager.getUserRole();
            const nameEl = document.getElementById('userDisplayName');
            if (nameEl && user && user.firstName && user.lastName) {
                nameEl.textContent = `${user.firstName} ${user.lastName}`;
            }

            // Check if user is a department responsible
            if (userRole === 'Department_Responsible') {
                isResponsibleView = true;
                document.getElementById('responsibleView').classList.remove('hidden');
                document.getElementById('hrManagerView').classList.add('hidden');
                document.getElementById('pageTitle').textContent = 'My Department - HR Operations Platform';
                // Hide edit/add buttons in sidebar if needed
                await loadResponsibleDepartment();
            } else {
                isResponsibleView = false;
                document.getElementById('responsibleView').classList.add('hidden');
                document.getElementById('hrManagerView').classList.remove('hidden');
                await loadDepartments();
                await loadEmployees();
            }
        });

        // Load department for responsible user
        async function loadResponsibleDepartment() {
            try {
                const user = authManager.getUser();
                let employeeId = user.employee_id || user.employeeId;
                
                // If no employee_id, try to get it from user_id
                if (!employeeId && user.id) {
                    try {
                        // Try to get employee by user_id
                        const employees = await APIService.getEmployees({ user_id: user.id });
                        if (employees && employees.length > 0) {
                            employeeId = employees[0].id;
                        } else {
                            // Try alternative API endpoint
                            try {
                                const usersService = (typeof window !== 'undefined' && window.API_SERVICES?.users) || 
                                                   (typeof API_SERVICES !== 'undefined' && API_SERVICES.users) || 
                                                   'http://localhost:3002';
                                const response = await authManager.makeAuthenticatedRequest(
                                    `${usersService}/employees/by-user/${user.id}`
                                );
                                if (response && response.employee) {
                                    employeeId = response.employee.id;
                                }
                            } catch (e) {
                                console.warn('Could not fetch employee by user_id:', e);
                            }
                        }
                    } catch (error) {
                        console.warn('Error fetching employee by user_id:', error);
                    }
                }
                
                if (!employeeId) {
                    console.error('User object:', user);
                    document.getElementById('employeesTableBody').innerHTML = `
                        <tr><td colspan="5" class="px-6 py-8 text-center text-red-500">
                            Error: Could not identify your employee ID. Please contact HR.
                            <br><small class="text-gray-500">User ID: ${user?.id || 'N/A'}</small>
                        </td></tr>
                    `;
                    return;
                }

                console.log('Looking for department with responsible_id:', employeeId);

                // Get all departments and find where this user is responsible
                const allDepartments = await APIService.request('departments', '/departments');
                const deptList = Array.isArray(allDepartments) ? allDepartments : (allDepartments.departments || []);
                
                console.log('All departments:', deptList);
                console.log('Checking responsible_id matches...');
                
                currentDepartment = deptList.find(dept => {
                    const match = String(dept.responsible_id) === String(employeeId);
                    if (match) {
                        console.log('Found matching department:', dept);
                    }
                    return match;
                });

                if (!currentDepartment) {
                    console.warn('No department found for employee_id:', employeeId);
                    console.warn('Available departments and their responsible_ids:', 
                        deptList.map(d => ({ name: d.name, responsible_id: d.responsible_id, responsible_name: `${d.responsible_first_name || ''} ${d.responsible_last_name || ''}`.trim() }))
                    );
                    document.getElementById('deptInfoName').textContent = 'No Department Assigned';
                    document.getElementById('deptInfoEmployees').innerHTML = '<span>0 employees</span>';
                    document.getElementById('employeesTableBody').innerHTML = `
                        <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            You are not assigned as responsible for any department.
                            <br><small class="text-gray-400 mt-2 block">Employee ID: ${employeeId}</small>
                            <br><small class="text-gray-400">Please check the browser console for more details.</small>
                        </td></tr>
                    `;
                    return;
                }

                // Load full department details with employees
                console.log('Loading department details for ID:', currentDepartment.id);
                const departmentDetails = await APIService.request('departments', `/departments/${currentDepartment.id}`);
                console.log('Department details response:', departmentDetails);
                
                currentDepartment = departmentDetails;
                departmentEmployees = departmentDetails.employees || [];
                
                console.log('Department employees:', departmentEmployees);
                console.log('Number of employees:', departmentEmployees.length);

                // Update info card
                document.getElementById('deptInfoName').textContent = currentDepartment.name;
                document.getElementById('deptInfoEmployees').innerHTML = `<span>${departmentEmployees.length} employees</span>`;
                
                // Use responsible name from department if available, otherwise from user
                const responsibleName = currentDepartment.responsible_first_name && currentDepartment.responsible_last_name 
                    ? `${currentDepartment.responsible_first_name} ${currentDepartment.responsible_last_name}`
                    : (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : 'You');
                document.getElementById('deptInfoResponsible').textContent = responsibleName;

                // Render employees table
                renderEmployeesTable(departmentEmployees);

                // Setup employee search
                document.getElementById('employeeSearch').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const filtered = departmentEmployees.filter(emp => {
                        const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.toLowerCase();
                        const position = (emp.position_name || '').toLowerCase();
                        const email = (emp.email || '').toLowerCase();
                        const phone = (emp.phone || '').toLowerCase();
                        return fullName.includes(searchTerm) || position.includes(searchTerm) || 
                               email.includes(searchTerm) || phone.includes(searchTerm);
                    });
                    renderEmployeesTable(filtered);
                });

            } catch (error) {
                console.error('Error loading responsible department:', error);
                document.getElementById('employeesTableBody').innerHTML = `
                    <tr><td colspan="5" class="px-6 py-8 text-center text-red-500">
                        Failed to load department information. Please try again.
                    </td></tr>
                `;
            }
        }

        // Render employees table for responsible view
        function renderEmployeesTable(employeesList) {
            const tbody = document.getElementById('employeesTableBody');
            
            console.log('Rendering employees table with:', employeesList);
            
            if (!employeesList || employeesList.length === 0) {
                const noEmployeesText = typeof translate === 'function' ? translate('department.no_employees_assigned') : 'No employees assigned';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center">
                            <div class="flex flex-col items-center justify-center text-gray-500">
                                <i class="fas fa-users text-4xl mb-3 text-gray-400"></i>
                                <p class="text-lg font-medium mb-1">${noEmployeesText}</p>
                                <p class="text-sm text-gray-400">${noEmployeesText}</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = employeesList.map(emp => {
                const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || '—';
                const position = emp.position_name || emp.position || '—';
                const email = emp.email || '—';
                const phone = emp.phone || '—';
                const isResponsible = currentDepartment && String(emp.id) === String(currentDepartment.responsible_id);

                return `
                    <tr class="hover:bg-gray-50 ${isResponsible ? 'bg-blue-50' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                ${isResponsible ? '<i class="fas fa-user-shield text-blue-600 mr-2"></i>' : ''}
                                <div class="text-sm font-medium text-gray-900">${fullName}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${position}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${email}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${phone}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewEmployeeDetails('${emp.id}')" 
                                    class="text-blue-600 hover:text-blue-900 inline-flex items-center">
                                <i class="fas fa-eye mr-1"></i>${typeof translate === 'function' ? translate('tasks.view_details') : 'View Details'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // View employee details
        async function viewEmployeeDetails(employeeId) {
            try {
                const modal = document.getElementById('employeeDetailsModal');
                const content = document.getElementById('employeeDetailsContent');
                
                modal.classList.remove('hidden');
                const loadingText = typeof translate === 'function' ? translate('common.loading_employee_details') : 'Loading employee details...';
                content.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>${loadingText}</p>
                    </div>
                `;

                // Get employee details
                let employee;
                try {
                    employee = await APIService.getEmployee(employeeId);
                } catch (error) {
                    // Fallback to department employees list if API fails
                    employee = departmentEmployees.find(e => String(e.id) === String(employeeId));
                }
                
                // Render employee details
                if (!employee) {
                    employee = departmentEmployees.find(e => String(e.id) === String(employeeId));
                }
                
                if (!employee) {
                    throw new Error('Employee not found');
                }
                
                const employeeDetail = employee.employee || employee; // Handle wrapped response
                const fullName = `${employeeDetail.first_name || ''} ${employeeDetail.last_name || ''}`.trim() || '—';
                const joinDate = employeeDetail.join_date ? new Date(employeeDetail.join_date).toLocaleDateString() : '—';
                const address = employeeDetail.address || '—';
                const nationality = employeeDetail.nationality || '—';
                const position = employeeDetail.position_name || employeeDetail.position || '—';
                const email = employeeDetail.email || '—';
                const phone = employeeDetail.phone || '—';
                const isResp = currentDepartment && String(employeeDetail.id) === String(currentDepartment.responsible_id);

                // Get translations
                const contactInfoText = typeof translate === 'function' ? translate('employee.contact_information') : 'Contact Information';
                const additionalInfoText = typeof translate === 'function' ? translate('requests.additional_information') : 'Additional Information';
                const emailLabel = typeof translate === 'function' ? translate('employee.email') : 'Email';
                const phoneLabel = typeof translate === 'function' ? translate('employee.phone') : 'Phone';
                const addressLabel = typeof translate === 'function' ? translate('employee.address') : 'Address';
                const joinDateLabel = typeof translate === 'function' ? translate('employee.join_date') : 'Join Date';
                const nationalityLabel = typeof translate === 'function' ? translate('employee.nationality') : 'Nationality';
                const departmentLabel = typeof translate === 'function' ? translate('employee.department') : 'Department';
                const deptResponsibleText = typeof translate === 'function' ? translate('role.department_responsible') : 'Department Responsible';
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <!-- Header -->
                        <div class="flex items-center gap-4 pb-4 border-b">
                            <div class="h-20 w-20 rounded-full bg-blue-100 flex items-center justify-center">
                                <i class="fas fa-user text-3xl text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold text-gray-900">${fullName}</h3>
                                <p class="text-gray-600">${position}</p>
                                ${isResp ? `<span class="inline-flex items-center px-2 py-1 mt-1 text-xs font-medium bg-blue-100 text-blue-800 rounded"><i class="fas fa-user-shield mr-1"></i>${deptResponsibleText}</span>` : ''}
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-900 mb-3 flex items-center">
                                    <i class="fas fa-envelope text-blue-600 mr-2"></i>${contactInfoText}
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-500">${emailLabel}:</span> <span class="font-medium">${email}</span></div>
                                    <div><span class="text-gray-500">${phoneLabel}:</span> <span class="font-medium">${phone}</span></div>
                                    ${address !== '—' ? `<div><span class="text-gray-500">${addressLabel}:</span> <span class="font-medium">${address}</span></div>` : ''}
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-900 mb-3 flex items-center">
                                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>${additionalInfoText}
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-gray-500">${joinDateLabel}:</span> <span class="font-medium">${joinDate}</span></div>
                                    ${nationality !== '—' ? `<div><span class="text-gray-500">${nationalityLabel}:</span> <span class="font-medium">${nationality}</span></div>` : ''}
                                    <div><span class="text-gray-500">${departmentLabel}:</span> <span class="font-medium">${currentDepartment?.name || '—'}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Update translations for dynamically added content
                if (typeof updatePageTranslations === 'function') {
                    setTimeout(() => updatePageTranslations(), 100);
                }
            } catch (error) {
                console.error('Error loading employee details:', error);
                const errorText = typeof translate === 'function' ? translate('common.error_loading_employee') : 'Failed to load employee details. Please try again.';
                document.getElementById('employeeDetailsContent').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>${errorText}</p>
                    </div>
                `;
            }
        }

        window.viewEmployeeDetails = viewEmployeeDetails;

        function hideEmployeeDetailsModal() {
            document.getElementById('employeeDetailsModal').classList.add('hidden');
        }

        window.hideEmployeeDetailsModal = hideEmployeeDetailsModal;

        async function loadDepartments() {
            try {
                departments = await APIService.request('departments', '/departments');
                renderDepartments();
            } catch (error) {
                console.error('Error loading departments:', error);
                Utils.showNotification('Failed to load departments', 'error');
            }
        }

        async function loadEmployees() {
            try {
                employees = await APIService.getEmployees();
                populateResponsibleDropdown();
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        function renderDepartments() {
            const container = document.getElementById('departmentsList');
            
            if (departments.length === 0) {
                const noDeptsText = typeof translate === 'function' ? translate('department.no_departments_found') : 'No departments found';
                const addFirstText = typeof translate === 'function' ? translate('department.add_first') : 'Add your first department';
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-building text-4xl mb-2"></i>
                        <p>${noDeptsText}</p>
                        <button onclick="showAddDepartmentModal()" class="mt-4 text-blue-600 hover:text-blue-800">
                            <i class="fas fa-plus mr-2"></i>
                            ${addFirstText}
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = departments.map(dept => `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer ${selectedDepartmentId === dept.id ? 'ring-2 ring-blue-500 bg-blue-50' : ''}" 
                     onclick="selectDepartment('${dept.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${dept.name}</h4>
                            <p class="text-sm text-gray-600">
                                ${dept.responsible_first_name ? `Responsible: ${dept.responsible_first_name} ${dept.responsible_last_name}` : 'No responsible assigned'}
                            </p>
                            <p class="text-sm text-gray-500">${dept.employee_count || 0} employees</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="event.stopPropagation(); editDepartment('${dept.id}')" 
                                    class="text-blue-600 hover:text-blue-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteDepartment('${dept.id}', '${dept.name}')" 
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // New editDepartment function
        async function editDepartment(id) {
            const department = departments.find(dept => dept.id === id);
            if (!department) {
                Utils.showNotification('Department not found', 'error');
                return;
            }

            // Populate the edit form fields
            document.getElementById('editDepartmentId').value = department.id;
            document.getElementById('editDepartmentName').value = department.name;
            
            // Populate responsible dropdown
            const select = document.getElementById('editResponsibleId');
            const selectText = typeof translate === 'function' ? translate('common.select_responsible') : 'Select Responsible';
            const noPositionText = typeof translate === 'function' ? translate('common.no_position') : 'No position';
            select.innerHTML = `<option value="">${selectText}</option>`;
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.first_name} ${emp.last_name} - ${emp.position_name || noPositionText}`;
                if (emp.id === department.responsible_id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Show the edit modal
            document.getElementById('editDepartmentModal').classList.remove('hidden');
        }

        function hideEditDepartmentModal() {
            document.getElementById('editDepartmentModal').classList.add('hidden');
            document.getElementById('editDepartmentForm').reset();
            document.getElementById('editDepartmentError').classList.add('hidden');
        }

        // Handle edit department form submission
        document.getElementById('editDepartmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = document.getElementById('editDepartmentSubmit');
            const errorDiv = document.getElementById('editDepartmentError');

            submitButton.disabled = true;
            errorDiv.classList.add('hidden');

            try {
                const formData = new FormData(this);
                const id = formData.get('id');
                const data = {
                    name: formData.get('name'),
                    responsible_id: formData.get('responsible_id') || null
                };

                await APIService.request('departments', `/departments/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                Utils.showNotification('Department updated successfully', 'success');
                hideEditDepartmentModal();
                await loadDepartments();

                if (selectedDepartmentId === id) {
                    await selectDepartment(id);
                }
            } catch (error) {
                console.error('Error updating department:', error);
                document.getElementById('editDepartmentErrorText').textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
            }
        });

        async function selectDepartment(id) {
            selectedDepartmentId = id;
            renderDepartments(); // Re-render to show selection
            
            try {
                const department = await APIService.request('departments', `/departments/${id}`);
                renderDepartmentDetails(department);
            } catch (error) {
                console.error('Error loading department details:', error);
                Utils.showNotification('Failed to load department details', 'error');
            }
        }

        function renderDepartmentDetails(department) {
            const container = document.getElementById('departmentDetails');
            
            const responsibleLabel = typeof translate === 'function' ? translate('department.responsible') : 'Responsible';
            const noResponsibleText = typeof translate === 'function' ? translate('department.no_responsible_assigned') : 'No responsible assigned';
            const employeesLabel = typeof translate === 'function' ? translate('department.employees') : 'Employees';
            const assignText = typeof translate === 'function' ? translate('common.assign') : 'Assign';
            const noPositionText = typeof translate === 'function' ? translate('common.no_position') : 'No position';
            const noEmployeesText = typeof translate === 'function' ? translate('department.no_employees_assigned') : 'No employees assigned';
            const removeTitle = typeof translate === 'function' ? translate('department.remove_employee') : 'Remove from department';
            
            container.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-gray-900 text-lg">${department.name}</h4>
                        <p class="text-sm text-gray-600">
                            ${department.responsible_first_name ? `${responsibleLabel}: ${department.responsible_first_name} ${department.responsible_last_name}` : noResponsibleText}
                        </p>
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h5 class="font-medium text-gray-900">${employeesLabel} (${department.employees?.length || 0})</h5>
                            <button onclick="showAssignEmployeeModal('${department.id}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-user-plus mr-1"></i>
                                ${assignText}
                            </button>
                        </div>
                        
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${department.employees?.length > 0 ? 
                                department.employees.map(emp => `
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium text-gray-900 truncate">${emp.first_name} ${emp.last_name}</div>
                                            <div class="text-xs text-gray-500 truncate">${emp.position_name || noPositionText}</div>
                                        </div>
                                        <button onclick="removeEmployeeFromDepartment('${department.id}', '${emp.id}', '${emp.first_name} ${emp.last_name}')" 
                                                class="text-red-600 hover:text-red-800 text-sm ml-2 flex-shrink-0" title="${removeTitle}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `).join('') : 
                                `<p class="text-sm text-gray-500 text-center py-4">${noEmployeesText}</p>`
                            }
                        </div>
                    </div>
                </div>
            `;
            
            // Update translations for dynamically added content
            if (typeof updatePageTranslations === 'function') {
                setTimeout(() => updatePageTranslations(), 100);
            }
        }

        function populateResponsibleDropdown() {
            const select = document.getElementById('responsibleId');
            const selectText = typeof translate === 'function' ? translate('common.select_responsible') : 'Select Responsible';
            const noPositionText = typeof translate === 'function' ? translate('common.no_position') : 'No position';
            select.innerHTML = `<option value="">${selectText}</option>`;
            
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.first_name} ${emp.last_name} - ${emp.position_name || noPositionText}`;
                select.appendChild(option);
            });
        }

        function showAddDepartmentModal() {
            document.getElementById('addDepartmentModal').classList.remove('hidden');
            document.getElementById('departmentName').focus();
        }

        function hideAddDepartmentModal() {
            document.getElementById('addDepartmentModal').classList.add('hidden');
            document.getElementById('addDepartmentForm').reset();
            document.getElementById('addDepartmentError').classList.add('hidden');
        }

        async function showAssignEmployeeModal(departmentId) {
            document.getElementById('assignDepartmentId').value = departmentId;
            
            try {
                const availableEmployees = await APIService.request('departments', `/employees/for-assignment?department_id=${departmentId}`);
                const select = document.getElementById('assignEmployeeId');
                const selectText = typeof translate === 'function' ? translate('employee.select_employee') : 'Select Employee';
                const noPositionText = typeof translate === 'function' ? translate('common.no_position') : 'No position';
                select.innerHTML = `<option value="">${selectText}</option>`;
                
                availableEmployees.forEach(emp => {
                    if (!emp.is_assigned) {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.first_name} ${emp.last_name} - ${emp.position_name || noPositionText}`;
                        select.appendChild(option);
                    }
                });
                
                document.getElementById('assignEmployeeModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading available employees:', error);
                Utils.showNotification('Failed to load available employees', 'error');
            }
        }

        function hideAssignEmployeeModal() {
            document.getElementById('assignEmployeeModal').classList.add('hidden');
            document.getElementById('assignEmployeeForm').reset();
            document.getElementById('assignEmployeeError').classList.add('hidden');
        }

        // Form submissions
        document.getElementById('addDepartmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('addDepartmentSubmit');
            const errorDiv = document.getElementById('addDepartmentError');
            
            submitButton.disabled = true;
            errorDiv.classList.add('hidden');
            
            try {
                const formData = new FormData(this);
                const data = {
                    name: formData.get('name'),
                    responsible_id: formData.get('responsible_id') || null
                };
                
                await APIService.request('departments', '/departments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                Utils.showNotification('Department created successfully', 'success');
                hideAddDepartmentModal();
                await loadDepartments();
            } catch (error) {
                console.error('Error creating department:', error);
                document.getElementById('addDepartmentErrorText').textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
            }
        });

        document.getElementById('assignEmployeeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('assignEmployeeSubmit');
            const errorDiv = document.getElementById('assignEmployeeError');
            
            submitButton.disabled = true;
            errorDiv.classList.add('hidden');
            
            try {
                const formData = new FormData(this);
                const departmentId = formData.get('department_id');
                const employeeId = formData.get('employee_id');
                
                await APIService.request('departments', `/departments/${departmentId}/employees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        employee_id: employeeId
                    })
                });
                
                Utils.showNotification('Employee assigned successfully', 'success');
                hideAssignEmployeeModal();
                await loadDepartments();
                
                if (selectedDepartmentId === departmentId) {
                    await selectDepartment(departmentId);
                }
            } catch (error) {
                console.error('Error assigning employee:', error);
                document.getElementById('assignEmployeeErrorText').textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
            }
        });

        async function removeEmployeeFromDepartment(departmentId, employeeId, employeeName) {
            if (!confirm(`Remove ${employeeName} from this department?`)) {
                return;
            }
            
            try {
                await APIService.request('departments', `/departments/${departmentId}/employees/${employeeId}`, { method: 'DELETE' });
                Utils.showNotification('Employee removed successfully', 'success');
                await loadDepartments();
                
                if (selectedDepartmentId === departmentId) {
                    await selectDepartment(departmentId);
                }
            } catch (error) {
                console.error('Error removing employee:', error);
                Utils.showNotification('Failed to remove employee', 'error');
            }
        }

        async function deleteDepartment(id, name) {
            if (!confirm(`Are you sure you want to delete the department "${name}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                await APIService.request('departments', `/departments/${id}`, { method: 'DELETE' });
                Utils.showNotification('Department deleted successfully', 'success');
                
                if (selectedDepartmentId === id) {
                    selectedDepartmentId = null;
                    document.getElementById('departmentDetails').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-building text-4xl mb-2"></i>
                            <p>Select a department to view details</p>
                        </div>
                    `;
                }
                
                await loadDepartments();
            } catch (error) {
                console.error('Error deleting department:', error);
                Utils.showNotification('Failed to delete department', 'error');
            }
        }

        // Search functionality
        document.getElementById('departmentSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredDepartments = departments.filter(dept => 
                dept.name.toLowerCase().includes(searchTerm) ||
                (dept.responsible_first_name && dept.responsible_first_name.toLowerCase().includes(searchTerm)) ||
                (dept.responsible_last_name && dept.responsible_last_name.toLowerCase().includes(searchTerm))
            );
            
            const container = document.getElementById('departmentsList');
            container.innerHTML = filteredDepartments.map(dept => `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer ${selectedDepartmentId === dept.id ? 'ring-2 ring-blue-500 bg-blue-50' : ''}" 
                     onclick="selectDepartment('${dept.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${dept.name}</h4>
                            <p class="text-sm text-gray-600">
                                ${dept.responsible_first_name ? `Responsible: ${dept.responsible_first_name} ${dept.responsible_last_name}` : 'No responsible assigned'}
                            </p>
                            <p class="text-sm text-gray-500">${dept.employee_count || 0} employees</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="event.stopPropagation(); editDepartment('${dept.id}')" 
                                    class="text-blue-600 hover:text-blue-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteDepartment('${dept.id}', '${dept.name}')" 
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        });
    </script>
    <script src="../assets/js/translations.js"></script>
    <script src="../assets/js/simple-nav.js"></script>
    <script>
        // Language selector and content visibility
        document.addEventListener('DOMContentLoaded', function() {
            const mainContent = document.getElementById('mainContent');
            const languageSelector = document.getElementById('languageSelector');
            
            // Function to show content after translations are ready
            const showContent = () => {
                if (mainContent) {
                    // Apply translations first
                    if (typeof updatePageTranslations === 'function') {
                        updatePageTranslations();
                    }
                    // Then show content with a small delay to ensure translations are applied
                    setTimeout(() => {
                        mainContent.style.opacity = '1';
                    }, 50);
                }
            };
            
            if (languageSelector) {
                languageSelector.value = currentLanguage || 'en';
                languageSelector.addEventListener('change', (e) => {
                    if (typeof setLanguage === 'function') {
                        setLanguage(e.target.value);
                    }
                });
            }
            
            // Wait for translations.js to be fully loaded
            if (typeof translations !== 'undefined' && typeof updatePageTranslations === 'function') {
                showContent();
            } else {
                // If translations aren't ready, wait a bit and try again
                setTimeout(() => {
                    if (typeof updatePageTranslations === 'function') {
                        showContent();
                    } else {
                        // Fallback: show content anyway after a delay
                        setTimeout(() => {
                            if (mainContent) mainContent.style.opacity = '1';
                        }, 300);
                    }
                }, 100);
            }
            
            // Also listen for language initialization from translations.js
            document.addEventListener('languageChanged', function() {
                if (mainContent && mainContent.style.opacity === '0') {
                    setTimeout(() => {
                        mainContent.style.opacity = '1';
                    }, 50);
                }
            });
        });
    </script>
    <!-- Close main content and layout -->
    </main>
    </div>
    </div>
</body>
</html>

